<!DOCTYPE HTML>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="generator" content="Jekyll v4.2.0">
  <link type="application/atom+xml" rel="alternate" href="../../feed.xml" title="Frida • A world-class dynamic instrumentation toolkit" />
  <link rel="alternate" type="application/atom+xml" title="Recent commits to Frida’s master branch" href="https://github.com/frida/frida/commits/master.atom" />
  <link rel="stylesheet" href="../../css/screen.css" />
  <link rel="icon" type="image/png" href="../../favicon.ico" />
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Releases | Frida • A world-class dynamic instrumentation toolkit</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Releases" />
<meta name="author" content="all" />
<meta property="og:locale" content="en" />
<meta name="description" content="Observe and reprogram running programs on Windows, macOS, GNU/Linux, iOS, watchOS, tvOS, Android, FreeBSD, and QNX" />
<meta property="og:description" content="Observe and reprogram running programs on Windows, macOS, GNU/Linux, iOS, watchOS, tvOS, Android, FreeBSD, and QNX" />
<link rel="canonical" href="index.html" />
<meta property="og:url" content="https://frida.re/news/releases/" />
<meta property="og:site_name" content="Frida • A world-class dynamic instrumentation toolkit" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Releases" />
<meta name="twitter:site" content="@fridadotre" />
<meta name="twitter:creator" content="@all" />
<script type="application/ld+json">
{"headline":"Releases","author":{"@type":"Person","name":"all"},"@type":"WebPage","description":"Observe and reprogram running programs on Windows, macOS, GNU/Linux, iOS, watchOS, tvOS, Android, FreeBSD, and QNX","url":"https://frida.re/news/releases/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <script src="../../js/modernizr-2.5.3.min.js"></script>
</head>


<body class="wrap">
  <header>
  <nav class="mobile-nav show-on-mobiles">
    <ul>
  <li class="">
    <a href="../../index.html">Overview</a>
  </li>
  <li class="">
    <a href="../../docs/home/index.html">Docs</span></a>
  </li>
  <li class="current">
    <a href="../index.html">News</a>
  </li>
  <li class="">
    <a href="https://github.com/frida/frida">Code</a>
  </li>
  <li class="">
    <a href="../../contact/index.html">Contact</a>
  </li>
</ul>

  </nav>
  <div class="grid">
    <div class="logotype unit one-third center-on-mobiles">
      <a href="../../index.html">
        <span>FЯIDA</span>
        <img src="../../img/logotype.svg" width="205" height="39" alt="">
      </a>
    </div>
    <nav class="main-nav unit two-thirds hide-on-mobiles">
      <ul>
  <li class="">
    <a href="../../index.html">Overview</a>
  </li>
  <li class="">
    <a href="../../docs/home/index.html">Docs</span></a>
  </li>
  <li class="current">
    <a href="../index.html">News</a>
  </li>
  <li class="">
    <a href="https://github.com/frida/frida">Code</a>
  </li>
  <li class="">
    <a href="../../contact/index.html">Contact</a>
  </li>
</ul>

    </nav>
  </div>
</header>


    <section class="news">
    <div class="grid">

      <div class="docs-nav-mobile unit whole show-on-mobiles">
  <select onchange="if (this.value) window.location.href=this.value">
    <option value="">Navigate the blog…</option>
    <option value="/news/">Home</option>
    <optgroup label="v1.x">
      
      <option value="/news/2023/12/24/frida-16-1-10-released/">Frida 16.1.10 Released</option>
      
      <option value="/news/2023/12/20/frida-16-1-9-released/">Frida 16.1.9 Released</option>
      
      <option value="/news/2023/11/28/frida-16-1-8-released/">Frida 16.1.8 Released</option>
      
      <option value="/news/2023/11/16/frida-16-1-7-released/">Frida 16.1.7 Released</option>
      
      <option value="/news/2023/11/13/frida-16-1-6-released/">Frida 16.1.6 Released</option>
      
      <option value="/news/2023/11/04/frida-16-1-5-released/">Frida 16.1.5 Released</option>
      
      <option value="/news/2023/08/29/frida-16-1-4-released/">Frida 16.1.4 Released</option>
      
      <option value="/news/2023/07/14/frida-16-1-3-released/">Frida 16.1.3 Released</option>
      
      <option value="/news/2023/07/11/frida-16-1-2-released/">Frida 16.1.2 Released</option>
      
      <option value="/news/2023/07/01/frida-16-1-1-released/">Frida 16.1.1 Released</option>
      
      <option value="/news/2023/06/23/frida-16-1-0-released/">Frida 16.1.0 Released</option>
      
      <option value="/news/2023/04/27/frida-16-0-19-released/">Frida 16.0.19 Released</option>
      
      <option value="/news/2023/04/22/frida-16-0-18-released/">Frida 16.0.18 Released</option>
      
      <option value="/news/2023/04/19/frida-16-0-17-released/">Frida 16.0.17 Released</option>
      
      <option value="/news/2023/04/19/frida-16-0-16-released/">Frida 16.0.16 Released</option>
      
      <option value="/news/2023/04/19/frida-16-0-15-released/">Frida 16.0.15 Released</option>
      
      <option value="/news/2023/04/18/frida-16-0-14-released/">Frida 16.0.14 Released</option>
      
      <option value="/news/2023/04/15/frida-16-0-13-released/">Frida 16.0.13 Released</option>
      
      <option value="/news/2023/04/14/frida-16-0-12-released/">Frida 16.0.12 Released</option>
      
      <option value="/news/2023/03/10/frida-16-0-11-released/">Frida 16.0.11 Released</option>
      
      <option value="/news/2023/02/17/frida-16-0-10-released/">Frida 16.0.10 Released</option>
      
      <option value="/news/2023/02/11/frida-16-0-9-released/">Frida 16.0.9 Released</option>
      
      <option value="/news/2022/12/13/frida-16-0-8-released/">Frida 16.0.8 Released</option>
      
      <option value="/news/2022/12/02/frida-16-0-7-released/">Frida 16.0.7 Released</option>
      
      <option value="/news/2022/12/01/frida-16-0-6-released/">Frida 16.0.6 Released</option>
      
      <option value="/news/2022/11/28/frida-16-0-5-released/">Frida 16.0.5 Released</option>
      
      <option value="/news/2022/11/26/frida-16-0-4-released/">Frida 16.0.4 Released</option>
      
      <option value="/news/2022/11/23/frida-16-0-3-released/">Frida 16.0.3 Released</option>
      
      <option value="/news/2022/10/22/frida-16-0-2-released/">Frida 16.0.2 Released</option>
      
      <option value="/news/2022/10/08/frida-16-0-1-released/">Frida 16.0.1 Released</option>
      
      <option value="/news/2022/10/08/frida-16-0-0-released/">Frida 16.0.0 Released</option>
      
      <option value="/news/2022/07/21/frida-15-2-2-released/">Frida 15.2.2 Released</option>
      
      <option value="/news/2022/07/21/frida-15-2-1-released/">Frida 15.2.1 Released</option>
      
      <option value="/news/2022/07/21/frida-15-2-0-released/">Frida 15.2.0 Released</option>
      
      <option value="/news/2022/07/06/frida-15-1-28-released/">Frida 15.1.28 Released</option>
      
      <option value="/news/2022/06/20/frida-15-1-27-released/">Frida 15.1.27 Released</option>
      
      <option value="/news/2022/06/20/frida-15-1-26-released/">Frida 15.1.26 Released</option>
      
      <option value="/news/2022/06/18/frida-15-1-25-released/">Frida 15.1.25 Released</option>
      
      <option value="/news/2022/06/03/frida-15-1-24-released/">Frida 15.1.24 Released</option>
      
      <option value="/news/2022/05/30/frida-15-1-23-released/">Frida 15.1.23 Released</option>
      
      <option value="/news/2022/05/09/frida-15-1-22-released/">Frida 15.1.22 Released</option>
      
      <option value="/news/2022/05/06/frida-15-1-21-released/">Frida 15.1.21 Released</option>
      
      <option value="/news/2022/05/06/frida-15-1-20-released/">Frida 15.1.20 Released</option>
      
      <option value="/news/2022/05/04/frida-15-1-19-released/">Frida 15.1.19 Released</option>
      
      <option value="/news/2022/05/04/frida-15-1-18-released/">Frida 15.1.18 Released</option>
      
      <option value="/news/2022/02/10/frida-15-1-17-released/">Frida 15.1.17 Released</option>
      
      <option value="/news/2022/02/03/frida-15-1-16-released/">Frida 15.1.16 Released</option>
      
      <option value="/news/2022/02/01/frida-15-1-15-released/">Frida 15.1.15 Released</option>
      
      <option value="/news/2021/09/03/frida-15-1-released/">Frida 15.1 Released</option>
      
      <option value="/news/2021/07/18/frida-15-0-released/">Frida 15.0 Released</option>
      
      <option value="/news/2021/02/10/frida-14-2-released/">Frida 14.2 Released</option>
      
      <option value="/news/2020/12/01/frida-14-1-released/">Frida 14.1 Released</option>
      
      <option value="/news/2020/10/28/frida-14-0-released/">Frida 14.0 Released</option>
      
      <option value="/news/2020/07/24/frida-12-11-released/">Frida 12.11 Released</option>
      
      <option value="/news/2020/06/29/frida-12-10-released/">Frida 12.10 Released</option>
      
      <option value="/news/2020/05/19/frida-12-9-released/">Frida 12.9 Released</option>
      
      <option value="/news/2019/12/18/frida-12-8-released/">Frida 12.8 Released</option>
      
      <option value="/news/2019/09/18/frida-12-7-released/">Frida 12.7 Released</option>
      
      <option value="/news/2019/05/28/frida-12-6-released/">Frida 12.6 Released</option>
      
      <option value="/news/2019/05/15/nowsecure-connect-2019/">NowSecure Connect 2019</option>
      
      <option value="/news/2019/05/15/frida-12-5-released/">Frida 12.5 Released</option>
      
      <option value="/news/2018/09/11/frida-12-2-released/">Frida 12.2 Released</option>
      
      <option value="/news/2018/08/25/frida-12-1-released/">Frida 12.1 Released</option>
      
      <option value="/news/2018/07/12/frida-12-0-released/">Frida 12.0 Released</option>
      
      <option value="/news/2018/05/05/frida-11-0-released/">Frida 11.0 Released</option>
      
      <option value="/news/2018/04/28/frida-10-8-released/">Frida 10.8 Released</option>
      
      <option value="/news/2018/03/13/frida-10-7-released/">Frida 10.7 Released</option>
      
      <option value="/news/2017/09/29/frida-10-6-released/">Frida 10.6 Released</option>
      
      <option value="/news/2017/08/25/frida-10-5-released/">Frida 10.5 Released</option>
      
      <option value="/news/2017/08/15/frida-10-4-released/">Frida 10.4 Released</option>
      
      <option value="/news/2017/05/02/frida-10-0-released/">Frida 10.0 Released</option>
      
      <option value="/news/2017/01/09/frida-9-0-released/">Frida 9.0 Released</option>
      
      <option value="/news/2016/10/25/frida-8-1-released/">Frida 8.1 Released</option>
      
      <option value="/news/2016/10/04/frida-8-0-released/">Frida 8.0 Released</option>
      
      <option value="/news/2016/08/15/frida-7-3-released/">Frida 7.3 Released</option>
      
      <option value="/news/2016/06/02/frida-7-2-released/">Frida 7.2 Released</option>
      
      <option value="/news/2016/04/04/frida-7-1-released/">Frida 7.1 Released</option>
      
      <option value="/news/2016/02/24/frida-7-0-released/">Frida 7.0 Released</option>
      
      <option value="/news/2016/02/01/frida-6-2-released/">Frida 6.2 Released</option>
      
      <option value="/news/2016/01/31/frida-fosdem-presentation/">Frida presentation at FOSDEM 2016</option>
      
      <option value="/news/2016/01/14/frida-6-1-released/">Frida 6.1 Released</option>
      
      <option value="/news/2015/11/11/frida-6-0-released/">Frida 6.0 Released</option>
      
      <option value="/news/2015/09/17/frida-5-0-released/">Frida 5.0 Released</option>
      
      <option value="/news/2015/09/10/frida-4-5-released/">Frida 4.5 Released</option>
      
      <option value="/news/2015/07/31/frida-4-4-released/">Frida 4.4 Released</option>
      
      <option value="/news/2015/07/15/frida-4-3-released/">Frida 4.3 Released</option>
      
      <option value="/news/2015/06/18/frida-4-2-released/">Frida 4.2 Released</option>
      
      <option value="/news/2015/06/09/frida-4-1-released/">Frida 4.1 Released</option>
      
      <option value="/news/2015/05/09/frida-4-0-0-released/">Frida 4.0.0 Released</option>
      
      <option value="/news/2015/03/20/frida-3-0-0-released/">Frida 3.0.0 Released</option>
      
      <option value="/news/2015/03/01/frida-2-0-2-released/">Frida 2.0.2 Released</option>
      
      <option value="/news/2015/03/01/frida-2-0-1-released/">Frida 2.0.1 Released</option>
      
      <option value="/news/2015/03/01/frida-2-0-0-released/">Frida 2.0.0 Released</option>
      
      <option value="/news/2015/02/23/frida-1-8-0-released/">Frida 1.8.0 Released</option>
      
      <option value="/news/2014/11/18/frida-1-6-8-released/">Frida 1.6.8 Released</option>
      
      <option value="/news/2014/11/03/frida-1-6-7-released/">Frida 1.6.7 Released</option>
      
      <option value="/news/2014/11/03/frida-1-6-6-released/">Frida 1.6.6 Released</option>
      
      <option value="/news/2014/10/29/frida-1-6-5-released/">Frida 1.6.5 Released</option>
      
      <option value="/news/2014/10/19/frida-1-6-4-released/">Frida 1.6.4 Released</option>
      
      <option value="/news/2014/08/25/frida-1-6-3-released/">Frida 1.6.3 Released</option>
      
      <option value="/news/2014/08/03/frida-1-6-2-released/">Frida 1.6.2 Released</option>
      
      <option value="/news/2014/07/26/frida-1-6-1-released/">Frida 1.6.1 Released</option>
      
      <option value="/news/2014/05/30/frida-1-6-0-released/">Frida 1.6.0 Released</option>
      
      <option value="/news/2014/05/14/frida-1-4-2-released/">Frida 1.4.2 Released</option>
      
      <option value="/news/2014/05/14/frida-1-4-1-released/">Frida 1.4.1 Released</option>
      
      <option value="/news/2014/05/04/frida-1-4-0-released/">Frida 1.4.0 Released</option>
      
      <option value="/news/2014/04/21/frida-1-2-1-released/">Frida 1.2.1 Released</option>
      
      <option value="/news/2014/04/17/frida-1-2-0-released/">Frida 1.2.0 Released</option>
      
      <option value="/news/2014/03/09/frida-1-0-11-released/">Frida 1.0.11 Released</option>
      
      <option value="/news/2014/02/16/frida-1-0-10-released/">Frida 1.0.10 Released</option>
      
      <option value="/news/2014/01/25/frida-1-0-9-released/">Frida 1.0.9 Released</option>
      
      <option value="/news/2014/01/15/frida-1-0-8-released/">Frida 1.0.8 Released</option>
      
      <option value="/news/2014/01/12/frida-1-0-7-released/">Frida 1.0.7 Released</option>
      
      <option value="/news/2014/01/11/frida-1-0-6-released/">Frida 1.0.6 Released</option>
      
      <option value="/news/2014/01/05/frida-1-0-5-released/">Frida 1.0.5 Released</option>
      
    </optgroup>
  </select>
</div>

      <div class="news-nav-desktop unit one-quarter hide-on-mobiles">
  <aside>
    <ul>
      <li class="">
        <a href="../index.html">All News</a>
      </li>
      <li class="current">
        <a href="index.html">Frida Releases</a>
      </li>
    </ul>
    <h4>Recent Releases</h4>
    <ul>
      
      <li class="">
        <a href="../2023/12/24/frida-16-1-10-released/index.html">Version 16.1.10</a>
      </li>
      
      <li class="">
        <a href="../2023/12/20/frida-16-1-9-released/index.html">Version 16.1.9</a>
      </li>
      
      <li class="">
        <a href="../2023/11/28/frida-16-1-8-released/index.html">Version 16.1.8</a>
      </li>
      
      <li class="">
        <a href="../2023/11/16/frida-16-1-7-released/index.html">Version 16.1.7</a>
      </li>
      
      <li class="">
        <a href="../2023/11/13/frida-16-1-6-released/index.html">Version 16.1.6</a>
      </li>
      
      <li>
        <a href="../../docs/history/index.html">History »</a>
      </li>
    </ul>
    <h4>Other News</h4>
    <ul>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        <li class="">
          <a href="../2019/05/15/nowsecure-connect-2019/index.html">NowSecure Connect 2019</a>
        </li>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        <li class="">
          <a href="../2016/01/31/frida-fosdem-presentation/index.html">Frida presentation at FOSDEM 2016</a>
        </li>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </ul>
  </aside>
</div>


      <div class="news-articles unit three-quarters">
        
  <article>
  <h2>
    <a href="../2023/12/24/frida-16-1-10-released/index.html">
      Frida 16.1.10 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      24 Dec 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Some neat little bug-fixes, just in time for Christmas:</p>

<ul>
  <li>server: Add missing entitlements for iOS 16, required to remap binary files in
memory. Thanks <a href="https://x.com/as0ler">@as0ler</a>!</li>
  <li>android: Fix Java hooking of interpreter-run methods on Android 14.</li>
  <li>Fix argv[0] shown in CLI tools such as frida-server and frida-inject. Thanks
<a href="https://github.com/bet4it">@bet4it</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/12/20/frida-16-1-9-released/index.html">
      Frida 16.1.9 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      20 Dec 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Quite a few goodies in this release:</p>

<ul>
  <li>interceptor: Pause cloaked threads too. This prevents random SIGBUS crashes on
our own threads while using Interceptor to hook functions residing on the same
page as any of the ones potentially used internally. Thanks <a href="https://x.com/bezjaje">@mrmacete</a>!</li>
  <li>darwin: Move to our POSIX Exceptor backend. Mach exception handling APIs have
become increasingly restrictive in recent Apple OS versions.</li>
  <li>darwin: Resolve import trampolines on arm64, allowing us to hook targets such
as sigaction().</li>
  <li>linux: Improve spawn() to handle r_brk being hit again.</li>
  <li>linker: Improve spawn() to consider on-disk ELF for RTLD symbols. This means
we might find r_debug on additional Android systems, for example.</li>
  <li>linux: Fix spawn() when DT_INIT_ARRAY contains sentinel values.</li>
  <li>linux: Improve spawn() to use DT_PREINIT_ARRAY if present.</li>
  <li>android: Handle symlinks in RTLD fallback logic.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/11/28/frida-16-1-8-released/index.html">
      Frida 16.1.8 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      28 Nov 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Three exciting changes this time around:</p>

<ul>
  <li>process: Add <em>get_main_module()</em>, exposed to JavaScript as
<em>Process.mainModule</em>. Useful when needing to know which module represents the
main executable of the process. In the past this was typically accomplished
by enumerating the loaded modules and assuming that the first one in the list
is the one. This is no longer the case on the latest Apple OSes, so we now
provide an efficient and portable solution with this new API. Thanks
<a href="https://x.com/bezjaje">@mrmacete</a>!</li>
  <li>compiler: Bump @types/frida-gum to 18.5.0, now with typings for recent API
additions.</li>
  <li>barebone: Fix compatibility with latest Corellium.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/11/16/frida-16-1-7-released/index.html">
      Frida 16.1.7 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      16 Nov 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Some neat refinements this time around:</p>

<ul>
  <li>stalker: Allow transformer to skip calls on x86. Thanks <a href="https://github.com/s1341">@s1341</a>!</li>
  <li>objc: Tolerate mangled Swift class names. Thanks <a href="https://x.com/hsorbo">@hsorbo</a>!</li>
  <li>cpu-features: Improve the AVX2 detection. Thanks for the assist, <a href="https://github.com/smx-smx">@smx-smx</a>!</li>
  <li>windows: Add support for MinGW. Thanks for the assist, <a href="https://github.com/smx-smx">@smx-smx</a>!</li>
  <li>openssl: Upgrade to openssl-3.0.12+quic@b81f0ae.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/11/13/frida-16-1-6-released/index.html">
      Frida 16.1.6 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      13 Nov 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Just a quick bug-fix release to roll back two of the Interceptor/Relocator arm64
changes that went into the previous release. Turns out that these need some more
refinement before they can land, so we will roll them back for now.</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>Revert “relocator: Improve scratch register strategy on arm64”.</li>
  <li>Revert “interceptor: Relocate tiny targets on arm64”.</li>
  <li>stalker: Allow transformer to skip calls on arm64.</li>
</ul>

  </div>
</article>


  <article>
  <h2>
    <a href="../2023/11/04/frida-16-1-5-released/index.html">
      Frida 16.1.5 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      04 Nov 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Since our last release, <a href="https://x.com/hsorbo">@hsorbo</a> and I had a lot of fun pair-programming on a
wide range of exciting tech. Let’s dive right in.</p>

<h2 id="swift">Swift</h2>

<p>We’ve introduced a brand new ApiResolver for Swift, which you can use like this:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ApiResolver</span><span class="p">(</span><span class="dl">'</span><span class="s1">swift</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">r</span><span class="p">.</span><span class="nx">enumerateMatches</span><span class="p">(</span><span class="dl">'</span><span class="s1">functions:*CoreDevice!*RemoteDevice*</span><span class="dl">'</span><span class="p">)</span>
<span class="p">.</span><span class="nx">forEach</span><span class="p">(({</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">address</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Found:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="dl">'</span><span class="s1">at:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">address</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure>

<p>There’s also a new and exciting frida-tools release, 12.3.0, which upgrades
frida-trace with Swift tracing support, using the new ApiResolver:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida-trace Xcode <span class="nt">-y</span> <span class="s1">'*CoreDevice!*RemoteDevice*'</span></code></pre></figure>

<h2 id="module">Module</h2>

<p>Our Module API now also provides <em>enumerateSections()</em> and
<em>enumerateDependencies()</em>. And for when you want to scan loaded modules for
specific section names, our existing <em>module</em> ApiResolver now lets you do
this with ease:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ApiResolver</span><span class="p">(</span><span class="dl">'</span><span class="s1">module</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">r</span><span class="p">.</span><span class="nx">enumerateMatches</span><span class="p">(</span><span class="dl">'</span><span class="s1">sections:*!*text*/i</span><span class="dl">'</span><span class="p">)</span>
<span class="p">.</span><span class="nx">forEach</span><span class="p">(({</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">address</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Found:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="dl">'</span><span class="s1">at:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">address</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure>

<h2 id="eof">EOF</h2>

<p>There’s also a bunch of other exciting changes, so definitely check out the
changelog below.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>swift-api-resolver: Add a brand new Swift API Resolver.</li>
  <li>module-api-resolver: Support resolving sections.</li>
  <li>api-resolver: Add optional <em>size</em> field to matches.</li>
  <li>module: Add enumerate_sections().</li>
  <li>module: Add enumerate_dependencies().</li>
  <li>device: Add unpair(). Only implemented for iOS-devices for now.</li>
  <li>compiler: Bump frida-compile to 16.4.1, and @types/frida-gum to 18.4.5.</li>
  <li>gdb: Handle empty response packets.</li>
  <li>gdb: Handle error reply to feature document request.</li>
  <li>darwin-mapper: Initialize TLV descriptors on load. Thanks <a href="https://github.com/fabianfreyer">@fabianfreyer</a>!</li>
  <li>darwin-module: Add Thread Local Variable APIs. Thanks <a href="https://github.com/fabianfreyer">@fabianfreyer</a>!</li>
  <li>darwin-module: Optimize exports enumeration slightly.</li>
  <li>elf-module: Improve the section ID generation.</li>
  <li>x86-writer: Add reg-reg {fs,gs}-based MOV insns. Thanks <a href="https://github.com/fabianfreyer">@fabianfreyer</a>!</li>
  <li>arm64-writer: Add MRS instruction. Thanks <a href="https://github.com/fabianfreyer">@fabianfreyer</a>!</li>
  <li>arm64-writer: Add UBFM, LSL, and LSR instructions. Thanks <a href="https://github.com/fabianfreyer">@fabianfreyer</a>!</li>
  <li>relocator: Improve scratch register strategy on arm64.</li>
  <li>interceptor: Branch to trampoline using computed scratch register.</li>
  <li>interceptor: Relocate tiny targets on arm64.</li>
  <li>linux: Handle disabled process_vm_{read,write}v(). Thanks <a href="https://github.com/Pyraun">@Pyraun</a>!</li>
  <li>server: Use sysroot for temporary files on rootless iOS. Thanks
<a href="https://github.com/fabianfreyer">@fabianfreyer</a>!</li>
  <li>gumjs: Fix crash in File and Database when Interceptor is absent. Thanks
<a href="https://x.com/bezjaje">@mrmacete</a>!</li>
  <li>gumjs: Fix NativePointer from number for 32-bit BE (#752). Thanks <a href="https://github.com/forky2">@forky2</a>!</li>
  <li>gumjs: Bump frida-swift-bridge to 2.0.7.</li>
  <li>ci: Publish prebuilds for Node.js 20 &amp; 21, and Electron 27.</li>
  <li>ci: Do not publish Swift bindings for now. There’s a long-standing heisenbug
that causes the x86_64 slice to randomly end up corrupted, in turn resulting
in CI release jobs failing. As I’m not too keen on sinking time into this
anytime soon, considering how easy it is to build these bindings locally using
a downloaded core devkit, simply dropping the release asset seems like the
best solution.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/08/29/frida-16-1-4-released/index.html">
      Frida 16.1.4 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      29 Aug 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Some exciting improvements this time around:</p>

<ul>
  <li>ios: Fix spawn() on iOS 17. Thanks <a href="https://x.com/hsorbo">@hsorbo</a>!</li>
  <li>ios: Add support for rootless systems. Thanks for the pair-programming,
<a href="https://x.com/hsorbo">@hsorbo</a>!</li>
  <li>android: Fix dynamic linker compatibility regression. Thanks for the
pair-programming, <a href="https://x.com/hsorbo">@hsorbo</a>! Kudo to <a href="https://x.com/getorix">@getorix</a> for reporting.</li>
  <li>gumjs: Add Worker API, so heavy processing can be moved to a background
thread, allowing hooks to be handled in a timely manner. Only implemented in
the QuickJS runtime for now. Kudos to <a href="https://x.com/bezjaje">@mrmacete</a> for tracking down and
fixing last-minute bugs in the implementation.</li>
  <li>linux: Improve error-handling when trying to attach to processes that are
near death.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/07/14/frida-16-1-3-released/index.html">
      Frida 16.1.3 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      14 Jul 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Time for a new release, just in time for the weekend:</p>

<ul>
  <li>server: Add missing entitlement for iOS &gt;= 17. Kudos to <a href="https://github.com/alexhude">@alexhude</a> for
helping get to the bottom of this one.</li>
  <li>stalker: Improve exclusive store handling on arm and arm64. Instead of
potentially expanding the current block to include instructions beyond where
the block would naturally end, we move to a safer approach: Once we encounter
an exclusive store, we look back at the previously generated blocks to see if
we can find one with an exclusive load. If we do, we mark this range of blocks
as using exclusive access. We also invalidate the blocks, so that problematic
instrumentation can be omitted upon recompilation. To also allow custom
transformers to adapt their generated code, we introduce
StalkerIterator.get_memory_access(). Thanks for the fun and productive
pair-programming, <a href="https://twitter.com/hsorbo">@hsorbo</a>!</li>
  <li>gumjs: Add <em>StalkerIterator.memoryAccess</em>, allowing a custom transformer to
determine what kind of instrumentation is safe to add without disturbing an
exclusive store operation. Set to either ‘open’, when “noisy” instrumentation
such as callouts are safe, or ‘exclusive’, when such instrumentation is risky
and may lead to infinite loops. (Due to an exclusive store failing, and every
subsequent retry also failing.)</li>
  <li>gumjs: Fix CModule bindings for Stalker on arm.</li>
  <li>stalker: Fix crash on invalidation in added slabs.</li>
  <li>arm64-writer: Add put_eor_reg_reg_reg(). Thanks for the fun and productive
pair-programming, <a href="https://twitter.com/hsorbo">@hsorbo</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/07/11/frida-16-1-2-released/index.html">
      Frida 16.1.2 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      11 Jul 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Time for a new release to refine a few things:</p>

<ul>
  <li>darwin: Fix Stalker.follow() regression where ongoing system calls would get
brutally interrupted, typically resulting in the target crashing. Thanks for
the pair-programming, <a href="https://twitter.com/hsorbo">@hsorbo</a>!</li>
  <li>gumjs: Implement the WeakRef API for QuickJS.</li>
  <li>compiler: Bump @types/frida-gum to 18.4.0.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/07/01/frida-16-1-1-released/index.html">
      Frida 16.1.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      01 Jul 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Only a few changes this time around:</p>

<ul>
  <li>compiler: Bump frida-compile to 16.3.0, now with TypeScript 5.1.5 and other
improvements. Among them is a fix by <a href="https://twitter.com/hsorbo">@hsorbo</a> that changes the default
<em>moduleResolution</em> to <em>Node16</em>.</li>
  <li>stalker: Add Iterator.get_capstone(), so transformers can use Capstone APIs
that require the Capstone handle.</li>
  <li>node: Fix RPC message array check. Thanks <a href="https://github.com/ZachQin">@ZachQin</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/06/23/frida-16-1-0-released/index.html">
      Frida 16.1.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      23 Jun 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>For quite some years I’ve been dreaming of taking Frida beyond user-space
software, to also support instrumenting OS kernels as well as barebone systems.
Perhaps even microcontrollers…</p>

<h2 id="microcontrollers">Microcontrollers</h2>

<p>Earlier this year my family’s cat door broke down. After some back and forth
with the retailer, double-checking the installation and such, it would work
for a little while before it eventually started malfunctioning.</p>

<p>This was obviously not much fun for our cats:</p>

<p><img src="../../img/cat-door-fail.jpg" alt="cat-door-fail" title="disappointed cat" /></p>

<p>It’s also no surprise that they’d end up making a lot of noise, in turn making
it hard to get a good night’s sleep when having to get up to let them back in
manually.</p>

<p>I ended up buying a second cat door and, lo and behold, no more issues. The old
one ended up collecting dust for a while. Something I kept thinking of was
whether I could debug it, and perhaps even extend the software to do more useful
things.</p>

<p>Feeling the urge to open it up to poke at the electronics inside of it, I
eventually gave in:</p>

<p><img src="../../img/cat-door-pcb.jpg" alt="cat-door-pcb" title="cat-door PCB" width="100%" /></p>

<p>That looked like an STM32F030C6T6, which is an ARM Cortex M0-based MCU. My first
thought was whether I could dump the flash memory to do some static analysis.</p>

<p>After quickly skimming MCU docs, and a little bit of multimeter probing, I
figured out the JP12 pads:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">PAD 1/2</th>
      <th style="text-align: center"> </th>
      <th style="text-align: center"> </th>
      <th style="text-align: center">PAD 7/8</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">BOOT0</td>
      <td style="text-align: center">USART1 RX</td>
      <td style="text-align: center">SWDIO</td>
      <td style="text-align: center">GND</td>
    </tr>
    <tr>
      <td style="text-align: center">VDD</td>
      <td style="text-align: center">USART1 TX</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">SWCLK</td>
    </tr>
  </tbody>
</table>

<p>This made it easy to pull <em>BOOT0</em> high, so the MCU boots into its internal
bootloader instead of user code.</p>

<p>By hooking up a USB to 3.3V TTL device to the USART1 pads, I could dump the
flash:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>./stm32flash <span class="nt">-r</span> firmware.bin /dev/ttyUSB0
stm32flash 0.7

http://stm32flash.sourceforge.net/

Interface serial_posix: 57600 8E1
Version      : 0x31
Option 1     : 0x00
Option 2     : 0x00
Device ID    : 0x0444 <span class="o">(</span>STM32F03xx4/6<span class="o">)</span>
- RAM        : Up to 4KiB  <span class="o">(</span>2048b reserved by bootloader<span class="o">)</span>
- Flash      : Up to 32KiB <span class="o">(</span>size first sector: 4x1024<span class="o">)</span>
- Option bytes  : 16b
- System memory : 3KiB
Memory <span class="nb">read
</span>Read address 0x08008000 <span class="o">(</span>100.00%<span class="o">)</span> Done.</code></pre></figure>

<p>And perform some static analysis:
<img src="../../img/cat-door-firmware.png" alt="cat-door-firmware" title="cat-door firmware" /></p>

<p>Seeing as two of the other pads are connected to SWDIO and SWCLK, used for
Serial Wire Debug (SWD), the natural next step was to hook up a <a href="https://www.raspberrypi.com/products/debug-probe/">Raspberry Pi
Debug Probe</a> to those. After getting that set up, I fired up <a href="https://openocd.org/">OpenOCD</a>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>openocd <span class="nt">-f</span> interface/cmsis-dap.cfg <span class="nt">-f</span> target/stm32f0x.cfg
Open On-Chip Debugger 0.11.0-g8e3c38f7-dirty <span class="o">(</span>2023-05-05-14:25<span class="o">)</span>
Licensed under GNU GPL v2
For bug reports, <span class="nb">read
	</span>http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport <span class="s2">"swd"</span><span class="nb">.</span> To override use <span class="s1">'transport select &lt;transport&gt;'</span><span class="nb">.</span>
Info : Listening on port 6666 <span class="k">for </span>tcl connections
Info : Listening on port 4444 <span class="k">for </span>telnet connections
Info : Using CMSIS-DAPv2 interface with VID:PID<span class="o">=</span>0x2e8a:0x000c, <span class="nv">serial</span><span class="o">=</span>E6614103E78B482F
Info : CMSIS-DAP: SWD  Supported
Info : CMSIS-DAP: FW Version <span class="o">=</span> 2.0.0
Info : CMSIS-DAP: Interface Initialised <span class="o">(</span>SWD<span class="o">)</span>
Info : SWCLK/TCK <span class="o">=</span> 0 SWDIO/TMS <span class="o">=</span> 0 TDI <span class="o">=</span> 0 TDO <span class="o">=</span> 0 nTRST <span class="o">=</span> 0 nRESET <span class="o">=</span> 0
Info : CMSIS-DAP: Interface ready
Info : clock speed 1000 kHz
Info : SWD DPIDR 0x0bb11477
Info : stm32f0x.cpu: hardware has 4 breakpoints, 2 watchpoints
Info : starting gdb server <span class="k">for </span>stm32f0x.cpu on 3333
Info : Listening on port 3333 <span class="k">for </span>gdb connections</code></pre></figure>

<p>The idea I had been thinking about for a long time was to add a new Frida
backend where the only process you can attach to is PID 0. Any scripts loaded
there would actually be run locally, and implement the familiar
<a href="../../docs/javascript-api/index.html">JavaScript API</a>. Any API that accesses memory, such as when dereferencing an
<em>int *</em> by doing e.g. <em>ptr(‘0x80000’).readInt()</em>, would end up querying the
target, through SWD in the above case.</p>

<p>I initially started sketching this where the backend would talk to the OpenOCD
daemon through its telnet interface. But I quickly realized that it would be
better to talk to its GDB-compatible remote stub. In this way, Frida will be
able to instrument any target with an available remote stub. Whether that’s
OpenOCD, <a href="https://www.corellium.com/">Corellium</a> (iOS kernel instrumentation!), QEMU, etc.</p>

<p>As for Interceptor, my thinking was that basic functionality would be
implemented using breakpoints. But, only if the user supplies JavaScript
callbacks. If function pointers are supplied instead, we could perform inline
hooking so the target can run without any traps/ping-pongs with the host. This
means it could even be used for observing and modifying hot code inside an OS
kernel or MCU firmware.</p>

<p>After some initial sketching, I was able to run the following script:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">breakpointKind</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">hard</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">THUMB_BIT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">initRest</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="dl">'</span><span class="s1">0x0800306a</span><span class="dl">'</span><span class="p">).</span><span class="nx">or</span><span class="p">(</span><span class="nx">THUMB_BIT</span><span class="p">);</span>
<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">initRest</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">&gt;&gt;&gt; init_rest()</span><span class="dl">'</span><span class="p">,</span>
        <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
  <span class="p">},</span>
  <span class="nx">onLeave</span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`&lt;&lt;&lt; init_rest() retval=</span><span class="p">${</span><span class="nx">retval</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p>Using the Frida REPL:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida <span class="nt">-D</span> barebone <span class="nt">-p</span> 0 <span class="nt">-l</span> demo.js
     ____
    / _  |   Frida 16.1.0 - A world-class dynamic instrumentation toolkit
   | <span class="o">(</span>_| |
    <span class="o">&gt;</span> _  |   Commands:
   /_/ |_|       <span class="nb">help</span>      -&gt; Displays the <span class="nb">help </span>system
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       object?   -&gt; Display information about <span class="s1">'object'</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       <span class="nb">exit</span>/quit -&gt; Exit
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   More info at https://frida.re/docs/home/
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   Connected to GDB Remote Stub <span class="o">(</span><span class="nb">id</span><span class="o">=</span>barebone<span class="o">)</span>

<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt; <span class="nv">$gdb</span>.continue<span class="o">()</span>
<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt; <span class="o">&gt;&gt;&gt;</span> init_rest<span class="o">()</span> <span class="o">{</span>
  <span class="s2">"r7"</span>: <span class="s2">"0xffffffff"</span>,
  <span class="s2">"pc"</span>: <span class="s2">"0x800306a"</span>,
  <span class="s2">"r8"</span>: <span class="s2">"0xffffffff"</span>,
  <span class="s2">"xPSR"</span>: <span class="s2">"0x41000000"</span>,
  <span class="s2">"r9"</span>: <span class="s2">"0xffffffff"</span>,
  <span class="s2">"sp"</span>: <span class="s2">"0x20000578"</span>,
  <span class="s2">"r0"</span>: <span class="s2">"0x0"</span>,
  <span class="s2">"r10"</span>: <span class="s2">"0xffffffff"</span>,
  <span class="s2">"lr"</span>: <span class="s2">"0x8003069"</span>,
  <span class="s2">"r1"</span>: <span class="s2">"0x40021008"</span>,
  <span class="s2">"r11"</span>: <span class="s2">"0xffffffff"</span>,
  <span class="s2">"r2"</span>: <span class="s2">"0xffffffff"</span>,
  <span class="s2">"r12"</span>: <span class="s2">"0xffffffff"</span>,
  <span class="s2">"r3"</span>: <span class="s2">"0xffffffff"</span>,
  <span class="s2">"r4"</span>: <span class="s2">"0xffffffff"</span>,
  <span class="s2">"r5"</span>: <span class="s2">"0xffffffff"</span>,
  <span class="s2">"r6"</span>: <span class="s2">"0xffffffff"</span>
<span class="o">}</span>
<span class="o">&lt;&lt;&lt;</span> init_rest<span class="o">()</span> <span class="nv">retval</span><span class="o">=</span>0x1</code></pre></figure>

<p>A few things to note here:</p>

<ul>
  <li>We set <em>Interceptor.breakpointKind</em> to <em>hard</em>, as our target’s code resides
in flash, which means software-breakpoints won’t work. This would not have
been necessary if I was using a <a href="https://www.segger.com/products/debug-probes/j-link/technology/flash-breakpoints/">J-Link</a> or similar SWD interface, which
transparently reflashes as software-breakpoints are added.</li>
  <li>The backend does not yet automatically resume, so we are doing that manually
through <em>$gdb.continue()</em>, part of <a href="https://github.com/frida/frida-core/blob/0c6737becb603871f62c775f06214b27c3e208ad/src/barebone/script.vala#L220-L257">this internal API</a>, which exposes most
of <a href="https://github.com/frida/frida-core/blob/0c6737becb603871f62c775f06214b27c3e208ad/src/gdb.vala#L3">GDB.Client</a> to JavaScript. This is meant to become an internal
implementation detail, but will be needed while this new backend matures –
it should not yet be considered stable API.</li>
  <li>We set the least significant bit to indicate to Interceptor that the target
function uses Thumb instruction encoding. This part may already be familiar to
you if you have previously used Frida’s conventional backends on 32-bit ARM.</li>
  <li>The new Barebone backend connects to the GDB-compatible remote stub at
<em>127.0.0.1:3333</em> by default. This matches what OpenOCD typically defaults to,
but can be overridden by setting the <em>FRIDA_BAREBONE_ADDRESS</em> environment
variable.</li>
</ul>

<h2 id="os-kernels">OS kernels</h2>

<p>While my fun little cat door side-quest is a great test case for the tiny part
of the spectrum, there’s also a lot of potential in supporting larger systems.</p>

<p>One of the cooler use-cases there is definitely Corellium, as it means we can
instrument the iOS kernel. Using a <a href="https://github.com/stacksmashing/tamarin-firmware">Tamarin Cable</a> it should even be possible
to get this working on a checkm8-exploitable physical device.</p>

<p>Before we touch on that though, let’s see if we can get things going with QEMU
and a live Linux kernel.</p>

<h3 id="linux">Linux</h3>

<p>First, we’ll fire up a VM we can play with:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>pip <span class="nb">install </span>arm_now
<span class="nv">$ </span>arm_now start aarch64 <span class="nt">--add-qemu-options</span><span class="o">=</span><span class="s1">'-gdb tcp::9000'</span>
...
Welcome to arm_now
buildroot login:</code></pre></figure>

<p>Next, we’ll use the Frida REPL to look around:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">FRIDA_BAREBONE_ADDRESS</span><span class="o">=</span>127.0.0.1:9000
<span class="nv">$ </span>frida <span class="nt">-D</span> barebone <span class="nt">-p</span> 0
     ____
    / _  |   Frida 16.1.0 - A world-class dynamic instrumentation toolkit
   | <span class="o">(</span>_| |
    <span class="o">&gt;</span> _  |   Commands:
   /_/ |_|       <span class="nb">help</span>      -&gt; Displays the <span class="nb">help </span>system
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       object?   -&gt; Display information about <span class="s1">'object'</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       <span class="nb">exit</span>/quit -&gt; Exit
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   More info at https://frida.re/docs/home/
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   Connected to GDB Remote Stub <span class="o">(</span><span class="nb">id</span><span class="o">=</span>barebone<span class="o">)</span>

<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt; Process.arch
<span class="s2">"arm64"</span>
<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt; Process.enumerateRanges<span class="o">(</span><span class="s1">'r-x'</span><span class="o">)</span>
<span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">"base"</span>: <span class="s2">"0xffffff8008080000"</span>,
        <span class="s2">"protection"</span>: <span class="s2">"r-x"</span>,
        <span class="s2">"size"</span>: 4259840
    <span class="o">}</span>
<span class="o">]</span>
<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt; <span class="nv">$gdb</span>.state
<span class="s2">"stopped"</span>
<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt; <span class="nv">$gdb</span>.exception
<span class="o">{</span>
    <span class="s2">"breakpoint"</span>: null,
    <span class="s2">"signum"</span>: 2,
    <span class="s2">"thread"</span>: <span class="o">{}</span>
<span class="o">}</span>
<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt; <span class="nv">$gdb</span>.exception.thread.readRegisters<span class="o">()</span>
<span class="o">{</span>
    <span class="s2">"cpsr"</span>: 1610613189,
    <span class="s2">"pc"</span>: <span class="s2">"0xffffff8008096648"</span>,
    <span class="s2">"sp"</span>: <span class="s2">"0xffffff80085f3f10"</span>,
    <span class="s2">"x0"</span>: <span class="s2">"0x0"</span>,
    <span class="s2">"x1"</span>: <span class="s2">"0xffffff80085e6b78"</span>,
    <span class="s2">"x10"</span>: <span class="s2">"0x880"</span>,
    <span class="s2">"x11"</span>: <span class="s2">"0xffffffc00e877180"</span>,
    <span class="s2">"x12"</span>: <span class="s2">"0x0"</span>,
    <span class="s2">"x13"</span>: <span class="s2">"0xffffffc00ffe1f30"</span>,
    <span class="s2">"x14"</span>: <span class="s2">"0x0"</span>,
    <span class="s2">"x15"</span>: <span class="s2">"0xfffffff8"</span>,
    <span class="s2">"x16"</span>: <span class="s2">"0xffffffbeff000000"</span>,
    <span class="s2">"x17"</span>: <span class="s2">"0x0"</span>,
    <span class="s2">"x18"</span>: <span class="s2">"0xffffffc00ffe17e0"</span>,
    <span class="s2">"x19"</span>: <span class="s2">"0xffffff80085e0000"</span>,
    <span class="s2">"x2"</span>: <span class="s2">"0x40079f5000"</span>,
    <span class="s2">"x20"</span>: <span class="s2">"0xffffff80085f892c"</span>,
    <span class="s2">"x21"</span>: <span class="s2">"0xffffff80085f88a0"</span>,
    <span class="s2">"x22"</span>: <span class="s2">"0xffffff80085ffe80"</span>,
    <span class="s2">"x23"</span>: <span class="s2">"0xffffff80085ffe80"</span>,
    <span class="s2">"x24"</span>: <span class="s2">"0xffffff80085d5028"</span>,
    <span class="s2">"x25"</span>: <span class="s2">"0x0"</span>,
    <span class="s2">"x26"</span>: <span class="s2">"0x0"</span>,
    <span class="s2">"x27"</span>: <span class="s2">"0x0"</span>,
    <span class="s2">"x28"</span>: <span class="s2">"0x405a0018"</span>,
    <span class="s2">"x29"</span>: <span class="s2">"0xffffff80085f3f10"</span>,
    <span class="s2">"x3"</span>: <span class="s2">"0x30c"</span>,
    <span class="s2">"x30"</span>: <span class="s2">"0xffffff800808492c"</span>,
    <span class="s2">"x4"</span>: <span class="s2">"0x0"</span>,
    <span class="s2">"x5"</span>: <span class="s2">"0x40079f5000"</span>,
    <span class="s2">"x6"</span>: <span class="s2">"0x1"</span>,
    <span class="s2">"x7"</span>: <span class="s2">"0x1c0"</span>,
    <span class="s2">"x8"</span>: <span class="s2">"0x2"</span>,
    <span class="s2">"x9"</span>: <span class="s2">"0xffffff80085f3e80"</span>
<span class="o">}</span>
<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt;</code></pre></figure>

<p>You might wonder how we’ve implemented <em>Process.enumerateRanges()</em>. This part is
for now only implemented on arm64, and it is accomplished by <a href="https://github.com/frida/frida-core/blob/0c6737becb603871f62c775f06214b27c3e208ad/src/barebone/arch-arm64/machine.vala#L38-L91">parsing the page
tables</a>. (And if we’re talking to Corellium’s remote stub we use a
vendor-specific monitor command to save ourselves a lot of network roundtrips.)</p>

<p>So now that we’re peeking into a running kernel, one of the things we might want
to do is find internal functions and data structures. This is where the memory-
scanning API comes handy:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">r</span> <span class="k">of</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">enumerateRanges</span><span class="p">(</span><span class="dl">'</span><span class="s1">r-x</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
  <span class="kd">const</span> <span class="nx">matches</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">scanSync</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">base</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">7b2000f0 fa03082a 992480d2 : 1f00009f ffffffff 1f00e0ff</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Matches:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">matches</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span></code></pre></figure>

<p>Here we’re looking for the Linux kernel’s <a href="https://github.com/torvalds/linux/blob/569dbb88e80deb68974ef6fdd6a13edb9d686261/arch/arm64/kernel/entry.S#L800-L802">arm64 syscall handler</a>, matching on
its first three instructions. We use the masking feature to mask out the
immediates of the ADRP and MOV instructions (first and third instruction).</p>

<p>Let’s take it for a spin:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida <span class="nt">-D</span> barebone <span class="nt">-p</span> 0 <span class="nt">-l</span> scan.js
     ____
    / _  |   Frida 16.1.0 - A world-class dynamic instrumentation toolkit
   | <span class="o">(</span>_| |
    <span class="o">&gt;</span> _  |   Commands:
   /_/ |_|       <span class="nb">help</span>      -&gt; Displays the <span class="nb">help </span>system
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       object?   -&gt; Display information about <span class="s1">'object'</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       <span class="nb">exit</span>/quit -&gt; Exit
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   More info at https://frida.re/docs/home/
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   Connected to GDB Remote Stub <span class="o">(</span><span class="nb">id</span><span class="o">=</span>barebone<span class="o">)</span>
Attaching...
<span class="o">{</span>
  <span class="s2">"base"</span>: <span class="s2">"0xffffff8008080000"</span>,
  <span class="s2">"size"</span>: 4259840,
  <span class="s2">"protection"</span>: <span class="s2">"r-x"</span>
<span class="o">}</span>
Matches: <span class="o">[</span>
  <span class="o">{</span>
    <span class="s2">"address"</span>: <span class="s2">"0xffffff8008082f00"</span>,
    <span class="s2">"size"</span>: 12
  <span class="o">}</span>
<span class="o">]</span>
<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt;</code></pre></figure>

<p>So now we’ve dynamically detected the kernel’s internal syscall handler! 🚀</p>

<p>Re-implementing the memory scanning feature was one of the highlights for me
personally, as <a href="https://twitter.com/hsorbo">@hsorbo</a> and I had a lot of fun pair-programming on it. The
implementation is conceptually very similar to what we’re doing in our Fruity
backend for jailed iOS, and our new Linux injector: instead of transferring data
to the host, and searching that, we can get away with transferring only the
search algorithm, to run that on the target.</p>

<p>The <a href="https://github.com/frida/frida-core/tree/0c6737becb603871f62c775f06214b27c3e208ad/src/barebone/helpers">memory scanner implementation</a> is written in Rust, and helped prepare
the groundwork for a new cool feature I’m going to cover a bit later in this
post.</p>

<p>So, now that we know where the Linux kernel’s syscall handler is, we can use
Interceptor to install an instruction-level hook:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">el0Svc</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="dl">'</span><span class="s1">0xffffff8008082f00</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">el0Svc</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">context</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">scno</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">x8</span><span class="p">.</span><span class="nx">toUInt32</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`syscall! scno=</span><span class="p">${</span><span class="nx">scno</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure>

<p>And try that out on our running VM:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida <span class="nt">-D</span> barebone <span class="nt">-p</span> 0 <span class="nt">-l</span> kernhook.js
     ____
    / _  |   Frida 16.1.0 - A world-class dynamic instrumentation toolkit
   | <span class="o">(</span>_| |
    <span class="o">&gt;</span> _  |   Commands:
   /_/ |_|       <span class="nb">help</span>      -&gt; Displays the <span class="nb">help </span>system
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       object?   -&gt; Display information about <span class="s1">'object'</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       <span class="nb">exit</span>/quit -&gt; Exit
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   More info at https://frida.re/docs/home/
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   Connected to GDB Remote Stub <span class="o">(</span><span class="nb">id</span><span class="o">=</span>barebone<span class="o">)</span>

<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt; <span class="nv">$gdb</span>.continue<span class="o">()</span>
<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt; syscall! <span class="nv">scno</span><span class="o">=</span>63
syscall! <span class="nv">scno</span><span class="o">=</span>64
syscall! <span class="nv">scno</span><span class="o">=</span>73
syscall! <span class="nv">scno</span><span class="o">=</span>63
syscall! <span class="nv">scno</span><span class="o">=</span>64
syscall! <span class="nv">scno</span><span class="o">=</span>73
syscall! <span class="nv">scno</span><span class="o">=</span>63
syscall! <span class="nv">scno</span><span class="o">=</span>64
syscall! <span class="nv">scno</span><span class="o">=</span>56
syscall! <span class="nv">scno</span><span class="o">=</span>62
syscall! <span class="nv">scno</span><span class="o">=</span>64
syscall! <span class="nv">scno</span><span class="o">=</span>57
syscall! <span class="nv">scno</span><span class="o">=</span>29
syscall! <span class="nv">scno</span><span class="o">=</span>134
...</code></pre></figure>

<p>And that’s it – we are monitoring system calls across the entire system! 💥</p>

<h3 id="rust">Rust</h3>

<p>One of the first things you’ll probably notice if you try the previous example
is that we slow down the system quite a bit. This is because Interceptor uses
breakpoints when a JavaScript function is specified as the callback.</p>

<p>Not to worry though. If we write our callback in machine code and pass a
NativePointer instead, Interceptor will pick a different strategy: it will
modify the target’s machine code to redirect execution to a trampoline, which in
turn calls the function at the address that we specify.</p>

<p>So that’s great. We only need to get our machine code into memory. Some of you
may be familiar with our <a href="../../docs/javascript-api/index.html#cmodule">CModule API</a>. We don’t yet implement that one in
this new Barebone backend (and we will, eventually!), but we have something even
better. Enter <em>RustModule</em>:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">kernBase</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="dl">'</span><span class="s1">0xffffff8008080000</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">procPidStatus</span> <span class="o">=</span> <span class="nx">kernBase</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mh">0x15e600</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RustModule</span><span class="p">(</span><span class="s2">`
#[no_mangle]
pub unsafe extern "C" fn hook(ic: &amp;mut gum::InvocationContext) -&gt; () {
    let regs = &amp;mut ic.cpu_context;
    println!("proc_pid_status() was called with x0={:#x} x1={:#x}",
        regs.x[0],
        regs.x[1],
    );
}
`</span><span class="p">);</span>

<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">procPidStatus</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">hook</span><span class="p">);</span></code></pre></figure>

<p>The RustModule implementation uses a local Rust toolchain, assumed to be on your
PATH, to compile the code you provide it into a <em>no_std</em> self-contained ELF. It
relocates this ELF and writes it into the target’s memory. As part of this it
will also parse the MMU’s page tables and insert new entries there so the
uploaded code becomes part of the virtual address space, where the pages are
read/write/execute.</p>

<p>In this example we’re hooking <a href="https://github.com/torvalds/linux/blob/569dbb88e80deb68974ef6fdd6a13edb9d686261/fs/proc/array.c#L372-L391">proc_pid_status()</a> in our live Linux kernel.</p>

<p>Note that <em>File.readAllText()</em> can be used to avoid having to inline Rust code
inside your JavaScript. Here we’re using inline code for the sake of brevity.</p>

<p>Now, with our Rust-powered agent, let’s take it for a spin:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida <span class="nt">-D</span> barebone <span class="nt">-p</span> 0 <span class="nt">-l</span> kernhook2.js
     ____
    / _  |   Frida 16.1.0 - A world-class dynamic instrumentation toolkit
   | <span class="o">(</span>_| |
    <span class="o">&gt;</span> _  |   Commands:
   /_/ |_|       <span class="nb">help</span>      -&gt; Displays the <span class="nb">help </span>system
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       object?   -&gt; Display information about <span class="s1">'object'</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       <span class="nb">exit</span>/quit -&gt; Exit
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   More info at https://frida.re/docs/home/
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   Connected to GDB Remote Stub <span class="o">(</span><span class="nb">id</span><span class="o">=</span>barebone<span class="o">)</span>

Error: to <span class="nb">enable </span>this feature, <span class="nb">set </span>FRIDA_BAREBONE_HEAP_BASE to the physical base address to use, e.g. 0x48000000
    at &lt;<span class="nb">eval</span><span class="o">&gt;</span> <span class="o">(</span>/home/oleavr/src/demo/kernhook2.js:13<span class="o">)</span>
    at evaluate <span class="o">(</span>native<span class="o">)</span>
    at &lt;anonymous&gt; <span class="o">(</span>/frida/repl-2.js:1<span class="o">)</span>

<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt;</code></pre></figure>

<p>Oops! That didn’t quite work. There is still one piece missing in our new
backend: we don’t yet have any “kernel bridges” in place that automatically
fingerprint the internals of known kernels in order to find a suitable internal
memory allocator we can use. This will also be needed to implement APIs such as
<em>Process.enumerateModules()</em>, which will allow listing the loaded kernel
modules/kexts. We could also locate the kernel’s process list and implement
<em>enumerate_processes()</em>, so frida-ps works. And those are only a couple of
examples… How about injecting frida-gadget into a user-space process? That
would be super-useful for an embedded system where we want to avoid modifying
the flash. Anyway, I digress 😊</p>

<p>So, on MCUs and unknown kernels you will have to tell Frida where, in physical
memory, we may clobber if you want to use intrusive features such as RustModule,
Interceptor in its inline hooking mode, Memory.alloc(), etc.</p>

<p>With that in mind, let’s retry our example, but this time we’ll set the
<em>FRIDA_BAREBONE_HEAP_BASE</em> environment variable:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">FRIDA_BAREBONE_HEAP_BASE</span><span class="o">=</span>0x48000000
<span class="nv">$ </span>frida <span class="nt">-D</span> barebone <span class="nt">-p</span> 0 <span class="nt">-l</span> kernhook2.js
     ____
    / _  |   Frida 16.1.0 - A world-class dynamic instrumentation toolkit
   | <span class="o">(</span>_| |
    <span class="o">&gt;</span> _  |   Commands:
   /_/ |_|       <span class="nb">help</span>      -&gt; Displays the <span class="nb">help </span>system
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       object?   -&gt; Display information about <span class="s1">'object'</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       <span class="nb">exit</span>/quit -&gt; Exit
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   More info at https://frida.re/docs/home/
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   Connected to GDB Remote Stub <span class="o">(</span><span class="nb">id</span><span class="o">=</span>barebone<span class="o">)</span>

<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt; m
<span class="o">{</span>
    <span class="s2">"hook"</span>: <span class="s2">"0xffffff80080103e0"</span>
<span class="o">}</span>
<span class="o">[</span>Remote::SystemSession <span class="o">]</span>-&gt; <span class="nv">$gdb</span>.continue<span class="o">()</span></code></pre></figure>

<p>Yay! 🎉 So now, in the terminal where we have QEMU running, let’s try accessing
<em>/proc/$pid/status</em> three times, so the hooked function gets called:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># head -3 /proc/self/status</span>
Name:	<span class="nb">head
</span>Umask:	0022
State:	R <span class="o">(</span>running<span class="o">)</span>
<span class="c"># head -3 /proc/self/status</span>
Name:	<span class="nb">head
</span>Umask:	0022
State:	R <span class="o">(</span>running<span class="o">)</span>
<span class="c"># head -3 /proc/self/status</span>
Name:	<span class="nb">head
</span>Umask:	0022
State:	R <span class="o">(</span>running<span class="o">)</span></code></pre></figure>

<p>Over in our REPL, we should see our <em>hook()</em> getting hit three times:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">proc_pid_status<span class="o">()</span> was called with <span class="nv">x0</span><span class="o">=</span>0xffffffc00d4bca00 <span class="nv">x1</span><span class="o">=</span>0xffffff8008608758
proc_pid_status<span class="o">()</span> was called with <span class="nv">x0</span><span class="o">=</span>0xffffffc00d4bc780 <span class="nv">x1</span><span class="o">=</span>0xffffff8008608758
proc_pid_status<span class="o">()</span> was called with <span class="nv">x0</span><span class="o">=</span>0xffffffc00d4bc780 <span class="nv">x1</span><span class="o">=</span>0xffffff8008608758</code></pre></figure>

<p>It works! 🥳</p>

<p>There’s one important thing to note though: In our example we’re using
<em>println!()</em>, and this actually causes the target to hit a breakpoint, so the
host can read out the message passed to it, and bubble that up just like a
<em>console.log()</em> from JavaScript. This means you should only use this feature for
temporary debugging purposes, and throttle how often it’s called if on a hot
code-path.</p>

<p>The next thing you might want to do is pass external symbols into your
RustModule. For example if you want to call internal kernel functions from your
Rust code. This is accomplished by declaring them like this:</p>

<figure class="highlight"><pre><code class="language-rs" data-lang="rs"><span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">frobnicate</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">*</span><span class="k">const</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">len</span><span class="p">:</span> <span class="nb">usize</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Then when constructing the RustModule, pass it in through the second argument:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RustModule</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">frobnicate</span><span class="p">:</span> <span class="nx">ptr</span><span class="p">(</span><span class="dl">'</span><span class="s1">0xffffff8008084320</span><span class="dl">'</span><span class="p">),</span>
<span class="p">});</span></code></pre></figure>

<p>For those of you familiar with our CModule API, this part is exactly the same.
You can also use NativeCallback to implement portions host-side, in JavaScript,
but this needs to be handled with care to avoid performance bottlenecks. Going
in the opposite direction there is also NativeFunction, which you can use to
call into your Rust code from JavaScript.</p>

<p>Last but not least, you may also want to import existing Rust crates from
<a href="https://crates.io/">crates.io</a>. This is also supported:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RustModule</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span>
  <span class="na">dependencies</span><span class="p">:</span> <span class="p">[</span>
    <span class="dl">'</span><span class="s1">cstr_core = { version = "0.2.6", default-features = false }</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">]</span>
<span class="p">});</span></code></pre></figure>

<h2 id="corellium">Corellium</h2>

<p>What’s so exciting is that all of the Linux bits above all “just work” on
Corellium as well. All you need to do is point <em>FRIDA_BAREBONE_ADDRESS</em> at the
endpoint shown in Corellium’s UI under “Advanced Options” -&gt; “gdb”.</p>

<p>Shout-out to the awesome folks at Corellium for their support while doing this.
They even implemented new protocol features to improve interoperability 🔥</p>

<h2 id="future">Future</h2>

<p>This new backend should be considered alpha quality for now, but I think it’s
already capable of so many useful things that it would be a shame to keep it
sitting on a branch.</p>

<p>You may notice that the JS APIs implemented only cover a subset, and not all
features are available on non-arm64 targets yet. But all of this will improve as
the backend matures. (Pull-requests are super-welcome!)</p>

<p>And as a fun aside, here’s Frida attached to the BeOS kernel:</p>

<p><img src="../../img/barebone-beos.png" alt="beos-kernel" title="BeOS kernel" width="100%" /></p>

<h2 id="eof">EOF</h2>

<p>There’s also a bunch of other exciting changes, so definitely check out the
changelog below.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>Add Barebone backend. (Covered extensively above.)</li>
  <li>objc: Handle modifiers. This makes type parsing more reliable, especially when
dealing with ivars which often times have the “atomic” modifier: exceptions
were thrown because the modifiers ended up being treated as unknown types.
Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>android: Fix support for Android 14. Thanks <a href="https://github.com/gsingh93">@gsingh93</a>! Also thanks
<a href="https://github.com/jayluxferro">@jayluxferro</a> for contributing a follow-up fix for a mistake I made while
merging <a href="https://github.com/gsingh93">@gsingh93</a>’s PR.</li>
  <li>gum-graft: Add support for chained imports. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>gumjs: Add NativePointer#readVolatile(), to provide a safe way to read from
memory that may become unmapped or have its memory protection changed midway
through. Thanks <a href="https://twitter.com/hsorbo">@hsorbo</a>!</li>
  <li>darwin: Improve tvOS support to also cover frida-server. Thanks <a href="https://twitter.com/tmm1">@tmm1</a>!</li>
  <li>darwin: Plug memory leak in fallback kill() logic. Thanks <a href="https://twitter.com/tmm1">@tmm1</a>!</li>
  <li>fruity: Handle failure to fetch dyld symbols.</li>
  <li>compiler: Bump frida-compile to 16.2.2. Dependencies’ source maps are now also
bundled – thanks <a href="https://github.com/vfsfitvnm">@vfsfitvnm</a>!</li>
  <li>compiler: Bump @types/frida-gum to 18.3.2, now with improved typings for
<em>hexdump()</em>.</li>
  <li>gdb: Add GDB.Client, by factoring out the guts of Fruity’s LLDB.Client, with
many protocol enhancements and interoperability fixes added on top.</li>
  <li>elf-module: Improve API and make it cross-platform. Support loading from a
blob, expose relocations, and improve overall robustness.</li>
  <li>capstone: Fix crash on x86 when building with MSVC.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/04/27/frida-16-0-19-released/index.html">
      Frida 16.0.19 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      27 Apr 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Some exciting stability improvements this time around:</p>

<ul>
  <li>darwin: Make spawn() aware of the <a href="https://developer.apple.com/documentation/uikit/app_and_environment/responding_to_the_launch_of_your_app/about_the_app_launch_sequence?language=objc">prewarm</a> feature used on iOS &gt;= 15. What
happens is that the most frequently used apps are being spawned ahead of time
by <em>dasd</em> and kept suspended until the user attempts to launch them, in order
to save some startup time. This was in the way of Frida’s spawn mechanism
because:
    <ul>
      <li>apps launched this way won’t be going through launchd when expected, causing
a “timeout was reached” error, or more complex race conditions</li>
      <li>Frida needs to spawn a fresh process to ensure early instrumentation</li>
    </ul>

    <p>We solve these problems by:</p>
    <ul>
      <li>ignoring prewarm spawns from the launchd agent (though they’re still emitted
as spawn if spawn gating is enabled)</li>
      <li>killing existing prewarmed apps before attempting to spawn them
Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
    </ul>
  </li>
  <li>glib: Ensure {Input,Output}Stream only g_poll() if pollable. This is essential on
Apple OSes and BSDs, where GLib uses kqueue to implement GMainContext, as it
may otherwise end up waiting forever when the file-descriptor represents an
ordinary file. Thanks <a href="https://twitter.com/hsorbo">@hsorbo</a>!</li>
  <li>android: Fix x86 devkits by improving libffi to avoid problematic relocations.</li>
  <li>gadget: Fix deadlock during Windows process termination. Kudos to
<a href="https://github.com/Palacee-hun">@Palacee-hun</a> for reporting!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/04/22/frida-16-0-18-released/index.html">
      Frida 16.0.18 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      22 Apr 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Just a quick bug-fix release reviving support for Android x86/x86_64 systems
with ARM emulation. This is still a blind spot in our CI, and I forgot all about
it while working on the new Linux injector. Kudos to <a href="https://github.com/stopmosk">@stopmosk</a> for promptly
reporting and helping triage this regression.</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/04/19/frida-16-0-17-released/index.html">
      Frida 16.0.17 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      19 Apr 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Time for a bug-fix release with only one change: turns out the ARMv8 BTI interop
<a href="https://github.com/frida/frida-gum/commit/ea1e836e70cd5e7976bf680ff7771a5a4bc0a494">introduced</a> in 16.0.14 is problematic on Apple A12+ SoCs when running in
arm64e mode, i.e. with pointer authentication enabled.</p>

<p>Kudos to <a href="https://github.com/miticollo">@miticollo</a> for reporting and helping triage the cause, and
<a href="https://twitter.com/bezjaje">@mrmacete</a> for digging further into it, brainstorming potential fixes, and
implementing the <a href="https://github.com/frida/frida-gum/commit/698b356fef0ecfc3ac2818f0b387be90e93deeda">fix</a>. You guys rock! ❤️</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/04/19/frida-16-0-16-released/index.html">
      Frida 16.0.16 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      19 Apr 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Seeing as TypeScript 5.0 was released last month, and frida.Compiler was still
at 4.9, we figured it’s time to upgrade it. So with this release we’re now
shipping 5.0.4. The upgrade also revealed a couple of bugs in our V8-based
runtime, and that our embedded frida-gum typings were slightly outdated.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>gumjs: Fix task deadlock during V8 Isolate teardown.</li>
  <li>gumjs: Fix undefined behavior during V8 snapshot creation.</li>
  <li>compiler: Bump frida-compile.</li>
  <li>compiler: Use the proper @types/frida-gum.</li>
</ul>

  </div>
</article>


  <article>
  <h2>
    <a href="../2023/04/19/frida-16-0-15-released/index.html">
      Frida 16.0.15 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      19 Apr 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Here’s a release fixing two stability issues affecting users on Apple platforms:</p>

<ul>
  <li>interceptor: Keep thread ports alive between suspend and resume on Darwin. We
were borrowing the Mach thread port right names released by
enumerate_threads(), assuming that another reference existed to keep each of
them alive. When this wasn’t the case we would at best pass an invalid Mach
port right name to thread_resume(), and worst-case we would use a totally
unrelated port. Regardless, we would leave such threads suspended forever.
Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>agent: Dispose ThreadSuspendMonitor in its own transaction. Since Interceptor
relies on ThreadSuspendMonitor passthrough, disposing of it in its own
transaction and after all the other components which use Interceptor at
destruction time makes sure no Frida thread will attempt executing code on
non-executable pages at teardown time. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/04/18/frida-16-0-14-released/index.html">
      Frida 16.0.14 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      18 Apr 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>More exciting bug-fixes:</p>

<ul>
  <li>linux: Fix ProcMapsEntry major/minor number parsing. Thanks <a href="https://github.com/chouex">@chouex</a>!</li>
  <li>interceptor: Fix ARMv8 BTI interoperability. Thanks <a href="https://github.com/zjw88282740">@zjw88282740</a>!</li>
  <li>arm64-writer: Add put_ret_reg(). Thanks <a href="https://github.com/zjw88282740">@zjw88282740</a>!</li>
  <li>compiler: Fix filesystem access on some Linux systems, e.g. Ubuntu 20.04.
Kudos to <a href="https://twitter.com/trufae">@pancake</a> for reporting and helping track this one down!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/04/15/frida-16-0-13-released/index.html">
      Frida 16.0.13 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      15 Apr 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Only a few bug-fixes this time around:</p>

<ul>
  <li>android: Fix dynamic linker probing on older systems.</li>
  <li>android: Limit graceful injection to arm and arm64.</li>
  <li>linux: Fix syscall wait logic on x86 and x86_64.</li>
</ul>

  </div>
</article>


  <article>
  <h2>
    <a href="../2023/04/14/frida-16-0-12-released/index.html">
      Frida 16.0.12 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      14 Apr 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Lots of goodies this time around. One of them is our brand new Linux injector.
This was a lot of fun, especially as it involved lots of pair-programming with
<a href="https://twitter.com/hsorbo">@hsorbo</a>.</p>

<p>We’re quite excited about this one. Frida now supports injecting into Linux
containers, such as Flatpak apps. Not just that, it can finally inject code into
processes without a dynamic linker present.</p>

<p>Another neat improvement is if you’re running Frida on Linux &gt;= 3.17, you may
notice that it no longer writes out any temporary files. This is accomplished
through memfd and a reworked injector signaling mechanism.</p>

<p>Our new Linux injector has a fully asynchronous design, without any dangerous
blocking operations that can result in deadlocks. It is also the first injector
to support providing a control channel to the injected payload.</p>

<p>Down the road the plan is to implement this in our other backends as well, and
make it part of our cross-platform Injector API. The thinking there is to make
it easier to implement custom payloads.</p>

<p>There are also many other goodies in this release, so definitely check out the
changelog below.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>linux: Re-engineer injector. Thanks for the productive pair-programming,
<a href="https://twitter.com/hsorbo">@hsorbo</a>!</li>
  <li>linux: Fix the libc-based module enumeration.</li>
  <li>linux: Fix query_libc_name() on musl.</li>
  <li>linux: Fix module handle resolver logic on musl.</li>
  <li>linux: Fix Module.ensure_initialized() on musl.</li>
  <li>darwin: Make ThreadSuspendMonitor passthrough if called by Frida, to
avoid deadlock scenarios. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>darwin: During spawn(), always use PTYs for piped stdio, and enable
close-on-exec.</li>
  <li>windows: Use existing DbgHelp instance if present. Thanks <a href="https://github.com/fesily">@fesily</a>!</li>
  <li>windows: Implement Module.enumerate_symbols(). Thanks <a href="https://github.com/fesily">@fesily</a>!</li>
  <li>process: Skip cloaked modules in enumerate_modules().</li>
  <li>cloak: Add has_range_containing().</li>
  <li>elf-module: Replace has_interp() with get_interpreter().</li>
  <li>gumjs: Fix runtime serialization unsigned encoding.</li>
  <li>objc: Add symbol property on method as a means for the method object to fully
describe itself in a human readable way. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>java: Use symbols for unique property names. Thanks <a href="https://github.com/yotamN">@yotamN</a>!</li>
  <li>java: Add toString() method to overloads. Thanks <a href="https://github.com/oriori1703">@oriori1703</a>!</li>
  <li>java: Add toString() method to types and field. Thanks <a href="https://github.com/yotamN">@yotamN</a>!</li>
  <li>java: Fix toString() for overloaded methods. Thanks <a href="https://github.com/yotamN">@yotamN</a>!</li>
  <li>server: Support loading as a shared library. Thanks <a href="https://twitter.com/Yannayli">@Yannayli</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/03/10/frida-16-0-11-released/index.html">
      Frida 16.0.11 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      10 Mar 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Only a few bug-fixes this time around:</p>

<ul>
  <li>darwin: Fix deadlock while pausing threads on non-RWX systems.
Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>darwin: Fix mapping zero-sized segments. Thanks <a href="https://twitter.com/comex">@comex</a>!</li>
  <li>linux: Improve Gum to support programs without a runtime linker.</li>
  <li>linux: Fix error-propagation from Gum.Linux APIs.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/02/17/frida-16-0-10-released/index.html">
      Frida 16.0.10 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      17 Feb 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>This time we’re bringing you additional iOS 15 improvements, an even better
frida.Compiler, brand new support for musl libc, and more. Do check out the
changelog below for more details.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>ios: Fix spawn() on lower versions of iOS 15. Thanks <a href="https://twitter.com/as0ler">@as0ler</a> and
<a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>ios: Ensure launchd prioritizes our daemon. Kudos to <a href="https://twitter.com/getorix">@getorix</a> for
investigating and suggesting this fix.</li>
  <li>compiler: Bump frida-compile, frida-fs, and Gum typings. This means that
frida.Compiler now also works properly on linux-arm64 and linux-x86.</li>
  <li>linux: Add support for musl libc, including CI that publishes release assets
for x86_64 and arm64.</li>
  <li>gumjs: Add console.debug() and console.info(). Thanks <a href="https://github.com/oriori1703">@oriori1703</a>!</li>
  <li>gumjs: Fix build when node_modules/@types exists above us.</li>
  <li>gumjs: Ignore tcclib.h symbols when generating runtime. Thanks <a href="https://github.com/milahu">@milahu</a>!</li>
  <li>build: Improve support for shared builds. Thanks <a href="https://github.com/milahu">@milahu</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2023/02/11/frida-16-0-9-released/index.html">
      Frida 16.0.9 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      11 Feb 2023
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>The main theme of this release is improved support for jailbroken iOS. We now
support iOS 16.3, including app listing and launching. Also included is improved
support for iOS 15, and some regression fixes for older iOS versions.</p>

<p>There are also some other goodies in this release, so definitely check out the
changelog below.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>darwin: Fix app listing and launching on iOS &gt;= 16. Thanks for the productive
pair-programming, <a href="https://twitter.com/hsorbo">@hsorbo</a>!</li>
  <li>darwin: Fix crash during early instrumentation of modern dylds.</li>
  <li>darwin: Fix breakpoint conflict in early instrumentation, a regression
introduced in 16.0.8 as part of improving spawn() performance.
Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>package-server-ios: Force xz compression.</li>
  <li>darwin-grafter: Create multiple segments if needed. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>interceptor: Flip page protection on Darwin grafted import activation.
Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>stalker: Fix handling of ARM LDMIA without writeback.</li>
  <li>darwin: Add query_protection(). Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>darwin: Avoid kernel task port probing in hardened processes. Thanks <a href="https://twitter.com/as0ler">@as0ler</a>!</li>
  <li>darwin: Fix Process.modify_thread() reliability.</li>
  <li>darwin: Fix query_hardened() on iOS w/ tweaks enabled. Thanks <a href="https://twitter.com/as0ler">@as0ler</a>!</li>
  <li>darwin: Make Process.modify_thread() less disruptive.</li>
  <li>darwin: Optimize Process.modify_thread().</li>
  <li>darwin: Add modify_thread().</li>
  <li>arm-writer: Add put_ldmia_reg_mask_wb().</li>
  <li>gumjs: Fix runtime serialization not handling unicode. Thanks <a href="https://github.com/milahu">@milahu</a>!</li>
  <li>python: Add async variant to RPC calls. Thanks <a href="https://github.com/yotamN">@yotamN</a>!</li>
  <li>python: Add specific signals type hinting for core. Thanks <a href="https://github.com/yotamN">@yotamN</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/12/13/frida-16-0-8-released/index.html">
      Frida 16.0.8 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      13 Dec 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>This time we’ve focused on polishing up our macOS and iOS support. For those of
you using <em>spawn()</em> and spawn-gating for early instrumentation, things are now
in much better shape.</p>

<h2 id="imacos-spawn-performance">i/macOS spawn() performance</h2>

<p>The most exciting change in this release is all about performance. Programs that
would previously take a while to start when launched using Frida should now be a
lot quicker to start. This long-standing bottleneck was so bad that an app with
a lot of libraries could fail to launch due to Frida slowing down its startup
too much.</p>

<h2 id="imacos-and-sigpipe">i/macOS and SIGPIPE</h2>

<p>Next up we have a fix for a long-standing reliability issue. Turns out our
file-descriptors used for IPC did not have SO_NOSIGPIPE set, so we could
sometimes end up in a situation where either Frida or the target process
terminated abruptly, and the other side would end up getting zapped by SIGPIPE
while trying to write().</p>

<h2 id="sandboxed-environments-part-two">Sandboxed environments, part two</h2>

<p>The previous release introduced some bold new changes to support injecting into
hardened targets. Since then <a href="https://twitter.com/hsorbo">@hsorbo</a> and me dug back into our recent GLib
kqueue() patch and fixed some rough edges. We also fixed a regression where
attaching to hardened processes through usbmuxd would fail with “connection
closed”.</p>

<h2 id="linux">Linux</h2>

<p>On the Linux and Android side of things, some of you may have noticed that
thread enumeration could fail randomly, especially inside busy processes. That
issue has now finally been dealt with.</p>

<p>Also, thanks to <a href="https://github.com/drosseau">@drosseau</a> we also have an error-handling improvement that
should avoid some confusion when things fail in 32-/64-bit cross-arch builds.</p>

<h2 id="eof">EOF</h2>

<p>That is all this time around. Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/12/02/frida-16-0-7-released/index.html">
      Frida 16.0.7 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      02 Dec 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s been a busy week. Let’s dive in.</p>

<h2 id="sandboxed-environments">Sandboxed environments</h2>

<p>This week <a href="https://twitter.com/hsorbo">@hsorbo</a> and me spent some days trying to get Frida working better
in sandboxed environments. Our goal was to be able to get Frida into Apple’s
SpringBoard process on iOS. But to make things a little interesting, we figured
we’d start with <em>imagent</em>, the daemon that handles the iMessage protocol. It has
been hardened quite a bit in recent OS versions, and Frida was no longer able to
attach to it.</p>

<p>So we first started out with this daemon on macOS, just to make things easier to
debug. After finding the daemon’s sandbox profile at
<code class="language-plaintext highlighter-rouge">/System/Library/Sandbox/Profiles/com.apple.imagent.sb</code>, it was hard to miss the
syscall policy. It disallows all syscalls by default, and carefully enables some
groups of syscalls, plus some specific ones that it also needs.</p>

<p>We then discovered that Frida’s use of the pipe() syscall was the first hurdle.
This code is not actually in Frida itself, but in GLib, the excellent library
that Frida uses for data structures, cross-platform threading primitives, event
loop, etc. It uses pipe() to implement a primitive needed for its event loop.
More precisely, it uses this primitive to wake up the event loop’s thread in
case it is blocking in a poll()-style syscall.</p>

<p>Anyway, we noticed that kqueue() is part of the groups of syscalls explicitly
allowed. Given that Apple’s kqueue() supports polling file-descriptors and Mach
ports at the same time, among other things, it’s likely to be needed in a lot of
places, and thus allowed by a broad range of sandbox profiles. It is also a
great fit for us, since EVFILT_USER means there is a way to wake up the event
loop’s thread. Not just that, but it doesn’t cost us a single file-descriptor.</p>

<p>After lots of coffee and fun pair-programming, we arrived at a <a href="https://github.com/frida/glib/commit/99ec1f987dfbc9b0ab45ac32dd98464cc023cd42">patch</a> that
switches GLib’s event loop over to kqueue() on OSes that support it. This got
us to the next hurdle: Frida is using socket APIs for file-descriptor passing,
part of the child-gating feature used for instrumenting children of the current
process. However, since hardened system services aren’t likely to be allowed to
do things like fork() and execve(), it is fine to simply degrade this part of
our functionality. That was <a href="https://github.com/frida/frida-core/commit/d31a5437c583eee49da9c710d10b8c3aa89710bb">tackled</a> next, and boom… Frida is finally able
to attach to <em>imagent</em>. 🎉 Yay!</p>

<p>Next up we moved over to iOS and took it for a spin there. Much to our surprise,
Frida could attach to SpringBoard right out of the gate. Later we tried
<em>notifyd</em> and <em>profiled</em>, and could attach to those too. Even on latest iOS 16.
But, there’s still work to do, as Frida cannot yet attach to <em>imagent</em> and
<em>WebContent</em> on iOS. This is exciting progress, though.</p>

<h2 id="injection-on-ios--15">Injection on iOS &gt;= 15</h2>

<p>While doing all of this we also tracked down a crash on iOS where frida-server
would get killed due to <em>EXC_GUARD</em> during injection on iOS &gt;= 15. That has now
also been fixed, just in time for the release!</p>

<h2 id="debugsymbol-api">DebugSymbol API</h2>

<p>Another exciting piece of news is that <a href="https://twitter.com/bezjaje">@mrmacete</a> improved our DebugSymbol
API to consistently provide the full path instead of only the filename. This was
a long-standing inconsistency across our different platform backends. While at
it he also exposed the <em>column</em>, so you also get that in addition to the line
number.</p>

<h2 id="interceptorreplace-but-fast">Interceptor.replace(), but fast</h2>

<p>Last but not least it’s worth mentioning an exciting new improvement in
Interceptor. For those of you using it from C, there’s now <em>replace_fast()</em>
to complement <em>replace()</em>. This new fast variant emits an inline hook that
vectors directly to your replacement. You can still call the original if you
want to, but it has to be called through the function pointer that Interceptor
gives you as an optional out-parameter. It also cannot be combined with
<em>attach()</em> for the same target. It is a lot faster though, so definitely good to
be aware of when needing to hook functions in hot code-paths.</p>

<h2 id="eof">EOF</h2>

<p>That’s all this time. Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>darwin: Disable advanced features in hardened processes.</li>
  <li>darwin: Port GLib’s MainContext to use kqueue() instead of poll().</li>
  <li>darwin: Fix EXC_GUARD during injection on iOS &gt;= 15.</li>
  <li>package-server-ios: Port launchd plist to iOS 16.</li>
  <li>gadget: Do not cloak main thread while loading.</li>
  <li>debug-symbol: Ensure path is absolute and add column field. Thanks
<a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>darwin: Add <em>query_hardened()</em>.</li>
  <li>interceptor: Add <em>replace_fast()</em>.</li>
  <li>interceptor: Reduce memory usage per target.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/12/01/frida-16-0-6-released/index.html">
      Frida 16.0.6 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      01 Dec 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Turns out a serious stability regression made it into Frida 16.0.3, where our
out-of-process dynamic linker for Apple OSes could end up crashing the target
process. This is especially disastrous when the target process is launchd, as it
results in a kernel panic. Thanks to the amazing work of <a href="https://twitter.com/bezjaje">@mrmacete</a>, this
embarrassing regression is now fixed. 🎉 Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/11/28/frida-16-0-5-released/index.html">
      Frida 16.0.5 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      28 Nov 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Quick bug-fix release this time around: the Android system_server
instrumentation adjustments should now work reliably on all systems.</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2022/11/26/frida-16-0-4-released/index.html">
      Frida 16.0.4 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      26 Nov 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Here’s a brand new release just in time for the weekend! 🎉 A few critical
stability fixes this time around.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>gumjs: Fix use-after-free in the V8 JobState logic. Kudos to <a href="https://twitter.com/trufae">@pancake</a> for
reporting and helping track this one down!</li>
  <li>android: Fix racy Zygote and system_server instrumentation. Thanks for the fun
and productive pair-programming, <a href="https://twitter.com/hsorbo">@hsorbo</a>!</li>
  <li>submodules: Add frida-go. Thanks <a href="https://github.com/lateralusd">@lateralusd</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/11/23/frida-16-0-3-released/index.html">
      Frida 16.0.3 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      23 Nov 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Some cool new things this time. Let’s dive right in.</p>

<h2 id="tvos-and-watchos">tvOS and watchOS</h2>

<p>One of the exciting contributions this time around came from <a href="https://twitter.com/tmm1">@tmm1</a>, who
opened a whole bunch of pull-requests adding support for tvOS. Yay! As part of
landing these I took the opportunity to add support for watchOS as well.</p>

<p>This also turned out to be a great time to simplify the build system, getting
rid of complexity introduced to support non-Meson build systems such as
autotools. So as part of this clean-up we now have separate binaries for
Simulator targets such as the iOS Simulator, tvOS Simulator, etc. Previously we
only supported the x86_64 iOS Simulator, and now arm64 is covered as well.</p>

<h2 id="macos-13-and-ios-16">macOS 13 and iOS 16</h2>

<p>Earlier this week, <a href="https://twitter.com/hsorbo">@hsorbo</a> and I did some fun and productive
pair-programming where we tackled the dynamic linker changes in Apple’s latest
OSes. Those of you using Frida on i/macOS may have noticed that spawn() stopped
working on macOS 13 and iOS 16.</p>

<p>This was a fun one. It turns out that the dyld binary on the filesystem now
looks in the <a href="https://iphonedev.wiki/index.php/Dyld_shared_cache">dyld_shared_cache</a> for a dyld with the same UUID as itself, and
if found vectors execution there instead. Explaining why this broke Frida’s
spawn() functionality needs a little context though, so bear with me.</p>

<p>Part of what Frida does when you call attach() is to inject its agent, if it
hasn’t already done this. Before performing the injection however, we check if
the process is sufficiently initialized, i.e. whether libSystem has been
initialized.</p>

<p>When this isn’t the case, such as after spawn(), where the target is suspended
at dyld’s entrypoint, Frida basically advances the main thread’s execution until
it reaches a point where libSystem is ready. This is typically accomplished
using a hardware breakpoint.</p>

<p>So because the new dyld now chains to another copy of itself, inside the
dyld_shared_cache, Frida was placing a breakpoint in the version mapped in from
the filesystem, instead of the one in the cache. Obviously that never got hit,
so we would end up timing out while waiting for this to happen.</p>

<p>The <a href="https://github.com/frida/frida-core/commit/73ac5eab9e6912bbd9903270e629e0d0ca773209">fix</a> was reasonably straight-forward though, so we managed to squeeze
this one into the release in the last minute.</p>

<h2 id="compiler-improvements">Compiler improvements</h2>

<p>The frida.Compiler just got a whole lot better, and now supports additional
configuration through tsconfig.json, as well as using local frida-gum typings.</p>

<h2 id="v8-debugger">V8 debugger</h2>

<p>The V8 debugger integration was knocked out by the move to having one V8
Isolate per script, which was a delicate refactoring needed for V8 snapshot
support. This is now back in working order.</p>

<h2 id="dependency-upgrades">Dependency upgrades</h2>

<p>One of the heavier lifts this time around was clearly dependency upgrades, where
most of our dependencies have now been upgraded: from Capstone supporting
ARMv9.2 to latest GLib using PCRE2, etc.</p>

<p>The move to PCRE2 means our Memory.scan() regex support just got upgraded, since
GLib was previously using PCRE1. We don’t yet enable PCRE2’s JIT on any
platforms though, but this would be an easy thing to improve down the road.</p>

<h2 id="cross-post-frida-tools-1202">Cross-post: frida-tools 12.0.2</h2>

<p>We also have a brand new release of frida-tools, which thanks to <a href="https://twitter.com/tmm1">@tmm1</a> has a
new and exciting feature. The <em>frida-ls-devices</em> tool now displays higher
fidelity device names, with OS name and version displayed in a fourth column:</p>

<p><img src="../../img/ls-devices-12-0-2.png" alt="frida-ls-devices" title="frida-ls-devices in 12.0.2" width="100%" /></p>

<p>To upgrade:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>pip3 <span class="nb">install</span> <span class="nt">-U</span> frida frida-tools</code></pre></figure>

<h2 id="eof">EOF</h2>

<p>There are also some other goodies in this release, so definitely check out the
changelog below.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>darwin: Add support for watchOS and tvOS. Thanks <a href="https://twitter.com/tmm1">@tmm1</a>!</li>
  <li>darwin: Fix early instrumentation on macOS 13 and iOS 16. (Thanks for the
pair-programming on this one, <a href="https://twitter.com/hsorbo">@hsorbo</a>!)</li>
  <li>interceptor: Suspend threads while mutating pages on W^X systems such
as iOS. This improves stability when instrumenting busy processes.</li>
  <li>system-session: Re-enable Exceptor for now.</li>
  <li>compiler: Allow configuring <em>target</em>, <em>lib</em>, and <em>strict</em>.</li>
  <li>compiler: Fix support for local frida-gum typings.</li>
  <li>compiler: Use latest <em>@types/frida-gum</em> from git.</li>
  <li>ci: Drop prebuilds for Node.js 10.</li>
  <li>ci: Publish prebuilds for Node.js 19.</li>
  <li>ci: Publish prebuilds for Electron 21 instead of 20.</li>
  <li>unw-backtracer: Improve accuracy on 32-bit ARM.</li>
  <li>thread: Add <em>suspend()</em> and <em>resume()</em> to the Gum C API.</li>
  <li>darwin: Improve handling of chained fixups.</li>
  <li>darwin: Fix Objective-C symbol synthesis on arm64e.</li>
  <li>linux: Detect <em>noxsave</em> on Linux.</li>
  <li>linux: Improve injector to handle faux .so mappings. Thanks <a href="https://github.com/lx866">@lx866</a>!</li>
  <li>module-map: Support lookups with ptrauth bits set.</li>
  <li>gumjs: Add NativeFunction <em>traps: ‘none’</em> option. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>gumjs: Prevent File and SQLite APIs from triggering Interceptor. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>gumjs: Hold Isolate lock while performing V8 jobs.</li>
  <li>gumjs: Fix deadlock on V8 script teardown.</li>
  <li>gumjs: Fix V8 debugger not seeing loaded scripts.</li>
  <li>gumjs: Fix CModule external toolchain support on Darwin/arm64e.</li>
  <li>gumjs: Fall back if V8 MAP_JIT fails on Darwin.</li>
  <li>gumjs: Do not freeze V8 flags after init, to avoid issues with hardened
processes on Darwin.</li>
  <li>socket: Upgrade to libsoup 3.x for HTTP/2 support.</li>
  <li>devkit: Add .gir to the frida-core kit. Thanks <a href="https://github.com/lateralusd">@lateralusd</a>!</li>
  <li>devkit: Update examples to the current Device API.</li>
  <li>python: Support UNIX socket addresses everywhere.</li>
  <li>node: Fix Node.js v19 compatibility.</li>
  <li>deps: Upgrade most of the dependencies to the latest and greatest.</li>
  <li>build: Refactor to get rid of non-Meson cruft.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/10/22/frida-16-0-2-released/index.html">
      Frida 16.0.2 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      22 Oct 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s Friday! Here’s a brand new release with lots of improvements:</p>

<ul>
  <li>macOS: Fix support for attaching to arm64e system apps and services on
macOS &gt;= 12.</li>
  <li>i/macOS: Upgrade support for chained fixups.</li>
  <li>iOS: Fix system session on arm64e devices running iOS &lt; 14.</li>
  <li>system-session: Disable Exceptor and monitors.
    <ul>
      <li>Exceptor interferes with the signal handling of the hosting process, which
is risky and prone to conflict.</li>
      <li>Monitors aren’t really useful for the system session.</li>
    </ul>
  </li>
  <li>interceptor: Fix trampolines used in grafted mode on iOS/arm64. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>compiler: Fix stability issues on multiple platforms.</li>
  <li>compiler: Fix the @frida/path shim.</li>
  <li>compiler: Speed things up by also making use of snapshot on non-x86/64 Linux.</li>
  <li>devkit: Fix regressions in the Windows, macOS, and Linux devkits.</li>
  <li>v8: Fix heap corruptions caused by our libc-shim failing to implement
malloc_usable_size() APIs, which V8 relies on.</li>
  <li>v8: Fix support for scripts using different snapshots, which was broken due to
V8 previously being configured to share read-only space across isolates. That
option conflicts with multiple snapshots.</li>
  <li>v8: Improve teardown.</li>
  <li>v8: Fix v8::External API contract violations.</li>
  <li>v8: Upgrade to 10.9.42.</li>
  <li>zlib: Upgrade to 1.2.13.</li>
  <li>gum: Fix subproject build for ELF-based OSes.</li>
  <li>python: Fix tags of published Linux wheels.
    <ul>
      <li>Add legacy platform tags so older versions of pip recognize them.</li>
      <li>Pretend some of the wheels require glibc &gt;= 2.17, as lower versions
aren’t recognized on certain architectures.</li>
    </ul>
  </li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/10/08/frida-16-0-1-released/index.html">
      Frida 16.0.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      08 Oct 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Two small but significant bugfixes this time around:</p>

<ul>
  <li>python: Fix computed sdist version metadata.</li>
  <li>python: Assume non-universal devkit build on macOS.</li>
</ul>

  </div>
</article>


  <article>
  <h2>
    <a href="../2022/10/08/frida-16-0-0-released/index.html">
      Frida 16.0.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      08 Oct 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Hope some of you are enjoying frida.Compiler! In case you have no idea what that
is, check out the <a href="../2022/07/21/frida-15-2-0-released/index.html">15.2.0 release notes</a>.</p>

<h2 id="performance">Performance</h2>

<p>Back in 15.2.0 there was something that bothered me about frida.Compiler: it
would take a few seconds just to compile a tiny “Hello World”, even on my
i9-12900K Linux workstation:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">time </span>frida-compile explore.ts <span class="nt">-o</span> _agent.js

real	0m1.491s
user	0m3.016s
sys	0m0.115s</code></pre></figure>

<p>After a lot of <a href="https://github.com/frida/frida-core/blob/155328df3420ead34e485f1c4fb7e5b3fe7d71a6/tests/profile-compiler.sh">profiling</a> and insane amounts of yak shaving, I finally
arrived at this:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">time </span>frida-compile explore.ts <span class="nt">-o</span> _agent.js

real	0m0.325s
user	0m0.244s
sys	0m0.109s</code></pre></figure>

<p>That’s quite a difference! This means on-the-fly compilation use-cases such as
<code class="language-plaintext highlighter-rouge">frida -l explore.ts</code> are now a lot smoother. More importantly though, it means
Frida-based tools can load user scripts this way without making their users
suffer through seconds of startup delay.</p>

<h2 id="snapshots">Snapshots</h2>

<p>You might be wondering how we made our compiler so quick to start. If you take
a peek under the hood, you’ll see that it uses the TypeScript compiler. This is
quite a bit of code to parse and run at startup. Also, loading and processing
the .d.ts files that define all of the types involved is actually even more
expensive.</p>

<p>The first optimization that we implemented back in 15.2 was to simply use our
V8 runtime if it’s available. That alone gave us a nice speed boost. However,
after a bit of profiling it was clear that V8 realized that it’s dealing with
a heavy workload once we start processing the .d.ts files, and that resulted in
it spending a big chunk of time just optimizing the TypeScript compiler’s code.</p>

<p>This reminded me of a really cool V8 feature that I’d noticed a long time ago:
<a href="https://v8.dev/blog/custom-startup-snapshots">custom startup snapshots</a>. Basically if we could warm up the TypeScript
compiler ahead of time and also pre-create all of the .d.ts source files when
building Frida, we could snapshot the VM’s state at that point and embed the
resulting startup snapshot. Then at runtime we can boot from the snapshot and
hit the ground running.</p>

<p>As part of implementing this, I extended GumJS so a snapshot can be passed to
create_script(), together with the source code of the agent. There is also
snapshot_script(), used to create the snapshot in the first place.</p>

<p>For example:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">frida</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">snapshot</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">snapshot_script</span><span class="p">(</span><span class="s">"const example = { magic: 42 };"</span><span class="p">,</span>
                                   <span class="n">warmup_script</span><span class="o">=</span><span class="s">"true"</span><span class="p">,</span>
                                   <span class="n">runtime</span><span class="o">=</span><span class="s">"v8"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Snapshot created! Size:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshot</span><span class="p">))</span></code></pre></figure>

<p>This snapshot could then be saved to a file and later loaded like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">script</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">create_script</span><span class="p">(</span><span class="s">"console.log(JSON.stringify(example));"</span><span class="p">,</span>
                               <span class="n">snapshot</span><span class="o">=</span><span class="n">snapshot</span><span class="p">,</span>
                               <span class="n">runtime</span><span class="o">=</span><span class="s">"v8"</span><span class="p">)</span>
<span class="n">script</span><span class="p">.</span><span class="n">load</span><span class="p">()</span></code></pre></figure>

<p>Note that snapshots need to be created on the same OS/architecture/V8 version
as they’re later going to be loaded on.</p>

<h2 id="v8-10x">V8 10.x</h2>

<p>Another exciting bit of news is that we’ve upgraded V8 to 10.x, which means we
get to enjoy the latest VM refinements and JavaScript language features.
Considering that our last upgrade was more than two years ago, it’s definitely a
solid upgrade this time around.</p>

<h2 id="the-curse-of-multiple-build-systems-part-two">The curse of multiple build systems, part two</h2>

<p>As you may recall from the <a href="../2022/02/01/frida-15-1-15-released/index.html">15.1.15 release notes</a>, we were closer than ever
to reaching the milestone where all of Frida can be built with a single build
system. The only component left at that point was V8, which we used to build
using Google’s GN build system. I’m happy to report that we have finally reached
that milestone. We now have a brand new Meson build system for V8. Yay!</p>

<h2 id="eof">EOF</h2>

<p>There’s also a bunch of other exciting changes, so definitely check out the
changelog below.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>compiler: Use snapshot to reduce startup time.</li>
  <li>compiler: Bump frida-compile and other dependencies.</li>
  <li>Add support for JavaScript VM snapshots. This is only implemented by the V8
backend, as QuickJS does not currently support this.</li>
  <li>Move debugger API from Session to Script. This is necessary since V8’s
debugger works on a per-Isolate basis, and we now need one Isolate per Script
in order to support snapshots.</li>
  <li>server+portal: Fix daemon parent ready fail exit. Thanks <a href="https://github.com/pachoo">@pachoo</a>!</li>
  <li>resource-compiler: Add support for compression. We make use of this for
frida.Compiler’s heap snapshot.</li>
  <li>ipc: Bump UNIX socket buffer sizes for improved throughput.</li>
  <li>meson: Promote frida-payload to public API. This allows implementing custom
payloads for use-cases where frida-agent and frida-gadget aren’t suitable.</li>
  <li>windows: Move to Visual Studio 2022.</li>
  <li>windows: Move toolchain/SDK logic to use granular SDKs.</li>
  <li>windows: Do not rely on .py file association.</li>
  <li>darwin: Fix compatibility with macOS 13 and iOS &gt;= 15.6.1.</li>
  <li>darwin: Use Apple’s libffi-trampolines.dylib if present, so we can support
iOS 15 and beyond. Thanks for the fun pair-programming sessions, <a href="https://twitter.com/hsorbo">@hsorbo</a>!</li>
  <li>fruity: Fix handling of USBMUXD_SOCKET_ADDRESS. Thanks <a href="https://github.com/0x3c3e">@0x3c3e</a>!</li>
  <li>fruity: Drop support for USBMUXD_SERVER_* envvars. Thanks <a href="https://twitter.com/as0ler">@as0ler</a>!</li>
  <li>droidy: Improve handling of ADB envvars. Thanks <a href="https://github.com/0x3c3e">@0x3c3e</a>!</li>
  <li>java: (android) Fix ClassLinker offset detection on Android 11 &amp; 12 (#264).
Thanks <a href="https://github.com/sh4dowb">@sh4dowb</a>!</li>
  <li>java: (android) Fix early instrumentation on Android 13.</li>
  <li>java: Handle methods and fields prefixed with <em>$</em>. Thanks <a href="https://github.com/eybisi">@eybisi</a>!</li>
  <li>android: Move to NDK r25.</li>
  <li>arm64: Optimize memory copy implementation.</li>
  <li>stalker: Ensure EventSink gets stopped on teardown.</li>
  <li>stalker: Fix ARM stack clobbering when branch involves a shift.</li>
  <li>stalker: Handle ARM PC load involving shifted register.</li>
  <li>stalker: Notify ARM observer when backpatches are applied.</li>
  <li>stalker: Apply ARM backpatches when notified.</li>
  <li>stalker: Add ARM support for switch block callback.</li>
  <li>arm-reader: Expose disassemble_instruction_at().</li>
  <li>thumb-reader: Expose disassemble_instruction_at().</li>
  <li>memory: Realign API with current V8 semantics.</li>
  <li>gumjs: Move V8 backend to one Isolate per script.</li>
  <li>gumjs: Support passing V8 flags using an env var: FRIDA_V8_EXTRA_FLAGS.</li>
  <li>gumjs: Use V8 write protection on Darwin/arm*.</li>
  <li>gumjs: Add support for dynamically defined scripts.</li>
  <li>prof: Support old system headers on Linux/MIPS.</li>
  <li>devkit: Improve examples’ compilation docs on UNIX.</li>
  <li>ci: Migrate remainder of the legacy CI to GitHub Actions.</li>
  <li>quickjs: Fix use-after-free on error during module evaluation.</li>
  <li>v8: Upgrade to latest V8 10.x.</li>
  <li>v8: Add Meson build system.</li>
  <li>usrsctp: Lower Windows requirement to XP, like the rest of our components.</li>
  <li>xz: Avoid ANSI-era Windows API.</li>
  <li>libc-shim: Support old system headers on Linux/MIPS.</li>
  <li>glib: Add Linux libc fallbacks for MIPS.</li>
  <li>Add config.mk option to be able to disable emulated agents on Android, to
allow building smaller binaries. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>python: Drop Python 2 support, modernize code, add docstrings, typings, add CI
with modern tooling, and many other goodies. Thanks <a href="https://github.com/yotamN">@yotamN</a>!</li>
  <li>python: Build Python wheels instead of eggs. Thanks <a href="https://github.com/oriori1703">@oriori1703</a>!</li>
  <li>python: Fix Device.get_bus(). The previous implementation called
_Device.get_bus(), which doesn’t exist. Thanks <a href="https://github.com/oriori1703">@oriori1703</a>!</li>
  <li>python: Move to the stable Python C API.</li>
  <li>python: Add support for building from source, using a frida-core devkit.</li>
  <li>python: Add support for the new snapshot APIs.</li>
  <li>node: Add support for the new snapshot APIs.</li>
  <li>node: Fix Electron v20 compatibility.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/07/21/frida-15-2-2-released/index.html">
      Frida 15.2.2 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      21 Jul 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Two more improvements, just in time for the weekend:</p>

<ul>
  <li>darwin: Always host system session locally. In this way we avoid needing to
write our frida-helper to a temporary file and spawn it just to use the system
session (PID 0).</li>
  <li>darwin: Rework frida-helper IPC to avoid Mach ports. This means we avoid
crashing on recent versions of macOS. Kudos to co-author <a href="https://twitter.com/hsorbo">@hsorbo</a> for the
productive pair-programming on this one!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/07/21/frida-15-2-1-released/index.html">
      Frida 15.2.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      21 Jul 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Two small but significant bugfixes this time around:</p>

<ul>
  <li>compiler: Ignore irrelevant changes during watch().</li>
  <li>darwin: Improve accuracy of memory range file info. By using
PROC_PIDREGIONPATHINFO2 when available, so the query is constrained to
vnode-backed mappings. Kudos to <a href="https://twitter.com/i0n1c">@i0n1c</a> for discovering and tracking
down this long-standing issue.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/07/21/frida-15-2-0-released/index.html">
      Frida 15.2.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      21 Jul 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Super-excited about this one. What I’ve been wanting to do for years is to
streamline Frida’s JavaScript developer experience. As a developer I may start
out with a really simple agent, but as it grows I start to feel the pain.</p>

<p>Early on I may want to split up the agent into multiple files. I may also want
to use some off-the-shelf packages from npm, such as <a href="https://github.com/nowsecure/frida-remote-stream">frida-remote-stream</a>.
Later I’d want code completion, inline docs, type checking, etc., so I move the
agent to TypeScript and fire up VS Code.</p>

<p>Since we’ve been piggybacking on the amazing frontend web tooling that’s already
out there, we already have all the pieces of the puzzle. We can use a bundler
such as <a href="https://rollupjs.org/guide/en/">Rollup</a> to combine our source files into a single .js, we can use
<a href="https://www.npmjs.com/package/@frida/rollup-plugin-node-polyfills">@frida/rollup-plugin-node-polyfills</a> for interop with packages from npm, and
we can plug in <a href="https://www.npmjs.com/package/@rollup/plugin-typescript">@rollup/plugin-typescript</a> for TypeScript support.</p>

<p>That is quite a bit of plumbing to set up over and over though, so I eventually
created <a href="https://www.npmjs.com/package/frida-compile">frida-compile</a> as a simple tool that does the plumbing for you, with
configuration defaults optimized for what makes sense in a Frida context. Still
though, this does require some boilerplate such as package.json, tsconfig.json,
and so forth.</p>

<p>To solve that, I published <a href="https://github.com/oleavr/frida-agent-example">frida-agent-example</a>, a repo that can be cloned
and used as a starting point. That is still a bit of friction, so later
frida-tools got a new CLI tool called frida-create. Anyway, even with all of
that, we’re still asking the user to install Node.js and deal with npm, and
potentially also feel confused by the .json files just sitting there.</p>

<p>Then it struck me. What if we could use frida-compile to compile frida-compile
into a self-contained .js that we can run on Frida’s system session? The system
session is a somewhat obscure feature where you can load scripts inside of the
process hosting frida-core. For example if you’re using our Python bindings,
that process would be the Python interpreter.</p>

<p>Once we are able to run that frida-compile agent inside of GumJS, we can
communicate with it and turn that into an API. This API can then be exposed
by language bindings, and frida-tools can consume it to give the user a
frida-compile CLI tool that doesn’t require Node.js/npm to be installed. Tools
such as our REPL can seamlessly use this API too if the user asks it to load a
script with a .ts extension.</p>

<p>And all of that is precisely what we have done! 🥳</p>

<h2 id="build">build()</h2>

<p>Here’s how easy it is to use it from Python:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">frida</span>

<span class="n">compiler</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">Compiler</span><span class="p">()</span>
<span class="n">bundle</span> <span class="o">=</span> <span class="n">compiler</span><span class="p">.</span><span class="n">build</span><span class="p">(</span><span class="s">"agent.ts"</span><span class="p">)</span></code></pre></figure>

<p>The <em>bundle</em> variable is a string that can be passed to create_script(), or
written to a file.</p>

<p>Running that example we might see something like:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"/home/oleavr/src/explore.py"</span>, line 4, <span class="k">in</span> &lt;module&gt;
    bundle <span class="o">=</span> compiler.build<span class="o">(</span><span class="s2">"agent.ts"</span><span class="o">)</span>
  File <span class="s2">"/home/oleavr/.local/lib/python3.10/site-packages/frida/core.py"</span>, line 76, <span class="k">in </span>wrapper
    <span class="k">return </span>f<span class="o">(</span><span class="k">*</span>args, <span class="k">**</span>kwargs<span class="o">)</span>
  File <span class="s2">"/home/oleavr/.local/lib/python3.10/site-packages/frida/core.py"</span>, line 1150, <span class="k">in </span>build
    <span class="k">return </span>self._impl.build<span class="o">(</span>entrypoint, <span class="k">**</span>kwargs<span class="o">)</span>
frida.NotSupportedError: compilation failed</code></pre></figure>

<p>That makes us wonder <em>why</em> it failed, so let’s add a handler for the
<em>diagnostics</em> signal:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">frida</span>

<span class="k">def</span> <span class="nf">on_diagnostics</span><span class="p">(</span><span class="n">diag</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"on_diagnostics:"</span><span class="p">,</span> <span class="n">diag</span><span class="p">)</span>

<span class="n">compiler</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">Compiler</span><span class="p">()</span>
<span class="n">compiler</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">"diagnostics"</span><span class="p">,</span> <span class="n">on_diagnostics</span><span class="p">)</span>
<span class="n">bundle</span> <span class="o">=</span> <span class="n">compiler</span><span class="p">.</span><span class="n">build</span><span class="p">(</span><span class="s">"agent.ts"</span><span class="p">)</span></code></pre></figure>

<p>And suddenly it’s all making sense:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">on_diagnostics: <span class="o">[{</span><span class="s1">'category'</span>: <span class="s1">'error'</span>, <span class="s1">'code'</span>: 6053,
    <span class="s1">'text'</span>: <span class="s2">"File '/home/oleavr/src/agent.ts' not "</span>
            <span class="s2">"found.</span><span class="se">\n</span><span class="s2">  The file is in the program "</span>
            <span class="s2">"because:</span><span class="se">\n</span><span class="s2">    Root file specified for"</span>
             <span class="s2">" compilation"</span><span class="o">}]</span>
…</code></pre></figure>

<p>We forgot to actually create the file! Ok, let’s create <em>agent.ts</em>:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello from Frida:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">Frida</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span></code></pre></figure>

<p>And let’s also write that script to a file:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">frida</span>

<span class="k">def</span> <span class="nf">on_diagnostics</span><span class="p">(</span><span class="n">diag</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"on_diagnostics:"</span><span class="p">,</span> <span class="n">diag</span><span class="p">)</span>

<span class="n">compiler</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">Compiler</span><span class="p">()</span>
<span class="n">compiler</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">"diagnostics"</span><span class="p">,</span> <span class="n">on_diagnostics</span><span class="p">)</span>
<span class="n">bundle</span> <span class="o">=</span> <span class="n">compiler</span><span class="p">.</span><span class="n">build</span><span class="p">(</span><span class="s">"agent.ts"</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"_agent.js"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span></code></pre></figure>

<p>If we now run it, we should have an _agent.js ready to go:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cat </span>_agent.js
📦
175 /explore.js.map
39 /explore.js
✄
<span class="o">{</span><span class="s2">"version"</span>:3,<span class="s2">"file"</span>:<span class="s2">"explore.js"</span>,<span class="s2">"sourceRoot"</span>:<span class="s2">"/home/oleavr/src/"</span>,<span class="s2">"sources"</span>:[<span class="s2">"explore.ts"</span><span class="o">]</span>,<span class="s2">"names"</span>:[],<span class="s2">"mappings"</span>:<span class="s2">"AAAA,OAAO,CAAC,GAAG,CAAC,SAAS,KAAK,CAAC,OAAO,GAAG,CAAC,CAAC"</span><span class="o">}</span>
✄
console.log<span class="o">(</span><span class="sb">`</span>Hello <span class="k">${</span><span class="nv">Frida</span><span class="p">.version</span><span class="k">}</span><span class="o">!</span><span class="sb">`</span><span class="o">)</span><span class="p">;</span></code></pre></figure>

<p>This weird-looking format is how GumJS’ allows us to opt into the new ECMAScript
Module (ESM) format where code is confined to the module it belongs to instead
of being evaluated in the global scope. What this also means is we can load
multiple modules that import/export values. The .map files are optional and can
be omitted, but if left in they allow GumJS to map the generated JavaScript line
numbers back to TypeScript in stack traces.</p>

<p>Anyway, let’s take _agent.js for a spin:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida <span class="nt">-p</span> 0 <span class="nt">-l</span> _agent.js
     ____
    / _  |   Frida 15.2.0 - A world-class dynamic instrumentation toolkit
   | <span class="o">(</span>_| |
    <span class="o">&gt;</span> _  |   Commands:
   /_/ |_|       <span class="nb">help</span>      -&gt; Displays the <span class="nb">help </span>system
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       object?   -&gt; Display information about <span class="s1">'object'</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       <span class="nb">exit</span>/quit -&gt; Exit
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   More info at https://frida.re/docs/home/
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   Connected to Local System <span class="o">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">local</span><span class="o">)</span>
Attaching...
Hello 15.2.0!
<span class="o">[</span>Local::SystemSession <span class="o">]</span>-&gt;</code></pre></figure>

<p>It works! Now let’s try refactoring it to split the code into two files:</p>

<h3 id="agentts">agent.ts</h3>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span> <span class="nx">log</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./log.js</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello from Frida:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">Frida</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span></code></pre></figure>

<h3 id="logts">log.ts</h3>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">export</span> <span class="kd">function</span> <span class="nx">log</span><span class="p">(...</span><span class="nx">args</span><span class="p">:</span> <span class="kr">any</span><span class="p">[])</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(...</span><span class="nx">args</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>If we now run our example compiler script again, it should produce a slightly
more interesting-looking _agent.js:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">📦
204 /agent.js.map
72 /agent.js
199 /log.js.map
58 /log.js
✄
<span class="o">{</span><span class="s2">"version"</span>:3,<span class="s2">"file"</span>:<span class="s2">"agent.js"</span>,<span class="s2">"sourceRoot"</span>:<span class="s2">"/home/oleavr/src/"</span>,<span class="s2">"sources"</span>:[<span class="s2">"agent.ts"</span><span class="o">]</span>,<span class="s2">"names"</span>:[],<span class="s2">"mappings"</span>:<span class="s2">"AAAA,OAAO,EAAE,GAAG,EAAE,MAAM,UAAU,CAAC;AAE/B,GAAG,CAAC,mBAAmB,EAAE,KAAK,CAAC,OAAO,CAAC,CAAC"</span><span class="o">}</span>
✄
import <span class="o">{</span> log <span class="o">}</span> from <span class="s2">"./log.js"</span><span class="p">;</span>
log<span class="o">(</span><span class="s2">"Hello from Frida:"</span>, Frida.version<span class="o">)</span><span class="p">;</span>
✄
<span class="o">{</span><span class="s2">"version"</span>:3,<span class="s2">"file"</span>:<span class="s2">"log.js"</span>,<span class="s2">"sourceRoot"</span>:<span class="s2">"/home/oleavr/src/"</span>,<span class="s2">"sources"</span>:[<span class="s2">"log.ts"</span><span class="o">]</span>,<span class="s2">"names"</span>:[],<span class="s2">"mappings"</span>:<span class="s2">"AAAA,MAAM,UAAU,GAAG,CAAC,GAAG,IAAW;IAC9B,OAAO,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,CAAC;AACzB,CAAC"</span><span class="o">}</span>
✄
<span class="nb">export </span><span class="k">function </span>log<span class="o">(</span>...args<span class="o">)</span> <span class="o">{</span>
    console.log<span class="o">(</span>...args<span class="o">)</span><span class="p">;</span>
<span class="o">}</span></code></pre></figure>

<p>Loading that into the REPL should yield the exact same result as before.</p>

<h2 id="watch">watch()</h2>

<p>Let’s turn our toy compiler into a tool that loads the compiled script, and
recompiles whenever a source file changes on disk:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">frida</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">script</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">on_output</span><span class="p">(</span><span class="n">bundle</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">script</span>
    <span class="k">if</span> <span class="n">script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Unloading old bundle..."</span><span class="p">)</span>
        <span class="n">script</span><span class="p">.</span><span class="n">unload</span><span class="p">()</span>
        <span class="n">script</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Loading bundle..."</span><span class="p">)</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">create_script</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
    <span class="n">script</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="n">on_message</span><span class="p">)</span>
    <span class="n">script</span><span class="p">.</span><span class="n">load</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">on_diagnostics</span><span class="p">(</span><span class="n">diag</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"on_diagnostics:"</span><span class="p">,</span> <span class="n">diag</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"on_message:"</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

<span class="n">compiler</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">Compiler</span><span class="p">()</span>
<span class="n">compiler</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">"output"</span><span class="p">,</span> <span class="n">on_output</span><span class="p">)</span>
<span class="n">compiler</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">"diagnostics"</span><span class="p">,</span> <span class="n">on_diagnostics</span><span class="p">)</span>
<span class="n">compiler</span><span class="p">.</span><span class="n">watch</span><span class="p">(</span><span class="s">"agent.ts"</span><span class="p">)</span>

<span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">read</span><span class="p">()</span></code></pre></figure>

<p>And off we go:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python3 explore.py
Loading bundle...
Hello from Frida: 15.2.0</code></pre></figure>

<p>If we leave that running and then edit the source code on disk we should see
some new output:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Unloading old bundle...
Loading bundle...
Hello from Frida version: 15.2.0</code></pre></figure>

<p>Yay!</p>

<h2 id="frida-compile">frida-compile</h2>

<p>We can also use frida-tools’ new frida-compile CLI tool:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida-compile agent.ts <span class="nt">-o</span> _agent.js</code></pre></figure>

<p>It also supports watch mode:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida-compile agent.ts <span class="nt">-o</span> _agent.js <span class="nt">-w</span></code></pre></figure>

<h2 id="repl">REPL</h2>

<p>Our REPL is also powered by the new frida.Compiler:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida <span class="nt">-p</span> 0 <span class="nt">-l</span> agent.ts
     ____
    / _  |   Frida 15.2.0 - A world-class dynamic instrumentation toolkit
   | <span class="o">(</span>_| |
    <span class="o">&gt;</span> _  |   Commands:
   /_/ |_|       <span class="nb">help</span>      -&gt; Displays the <span class="nb">help </span>system
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       object?   -&gt; Display information about <span class="s1">'object'</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>       <span class="nb">exit</span>/quit -&gt; Exit
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   More info at https://frida.re/docs/home/
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>
   <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span>   Connected to Local System <span class="o">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">local</span><span class="o">)</span>
Compiled agent.ts <span class="o">(</span>1428 ms<span class="o">)</span>
Hello from Frida version: 15.2.0
<span class="o">[</span>Local::SystemSession <span class="o">]</span>-&gt;</code></pre></figure>

<h2 id="shoutout">Shoutout</h2>

<p>Shoutout to <a href="https://twitter.com/hsorbo">@hsorbo</a> for the fun and productive pair-programming sessions
where we were working on frida.Compiler together! 🙌</p>

<h2 id="eof">EOF</h2>

<p>There are also quite a few other goodies in this release, so definitely check
out the changelog below.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>core: Add Compiler API. Only exposed by Python bindings for now, but available
from C/Vala.</li>
  <li>interceptor: Improve <em>replace()</em> to support returning original. Thanks
<a href="https://github.com/aviramha">@aviramha</a>!</li>
  <li>gumjs: Fix typing for <em>pc</em> in the writer options.</li>
  <li>gumjs: Fix V8 ESM crash with circular dependencies.</li>
  <li>gumjs: Handle ESM bundles with multiple aliases per module.</li>
  <li>gumjs: Tighten up the <em>Checksum</em> data argument parsing.</li>
  <li>android: Fix null pointer deref in crash delivery. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>fruity: Use env variables to find usbmuxd. Thanks <a href="https://github.com/0x3c3e">@0x3c3e</a>!</li>
  <li>ios: Make Substrate detection logic a bit more resilient. Thanks
<a href="https://github.com/lemon4ex">@lemon4ex</a>!</li>
  <li>meson: Only try to use V8 if available. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>windows: Add support for building without V8.</li>
  <li>devkit: Fix library dependency hints on Windows. Thanks <a href="https://github.com/nblog">@nblog</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/07/06/frida-15-1-28-released/index.html">
      Frida 15.1.28 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      06 Jul 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>A couple of exciting new things in this release.</p>

<h2 id="file-api">File API</h2>

<p>Those of you using our JavaScript File API may have noticed that it supports
writing to the given file, but there was no way to read from it. This is now
supported.</p>

<p>For example, to read each line of a text-file as a string:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">File</span><span class="p">(</span><span class="dl">'</span><span class="s1">/etc/passwd</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">r</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">line</span><span class="p">;</span>
<span class="k">while</span> <span class="p">((</span><span class="nx">line</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">readLine</span><span class="p">())</span> <span class="o">!==</span> <span class="dl">''</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Read line: </span><span class="p">${</span><span class="nx">line</span><span class="p">.</span><span class="nx">trimEnd</span><span class="p">()}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>(Note that this assumes that the text-file is UTF-8-encoded. Other encodings are
not currently supported.)</p>

<p>You can also read a certain number of bytes at some offset:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">File</span><span class="p">(</span><span class="dl">'</span><span class="s1">/var/run/utmp</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">rb</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">f</span><span class="p">.</span><span class="nx">seek</span><span class="p">(</span><span class="mh">0x2c</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">readBytes</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">readText</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span></code></pre></figure>

<p>The argument may also be omitted to read the rest of the file. But if you’re
just looking to read a text file in one go, there’s an easier way:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">File</span><span class="p">.</span><span class="nx">readAllText</span><span class="p">(</span><span class="dl">'</span><span class="s1">/etc/passwd</span><span class="dl">'</span><span class="p">);</span></code></pre></figure>

<p>Reading a binary file is just as easy:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">bytes</span> <span class="o">=</span> <span class="nx">File</span><span class="p">.</span><span class="nx">readAllBytes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/var/run/utmp</span><span class="dl">'</span><span class="p">);</span></code></pre></figure>

<p>(Where <em>bytes</em> is an ArrayBuffer.)</p>

<p>Sometimes you may also want to dump a string into a text file:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">File</span><span class="p">.</span><span class="nx">writeAllText</span><span class="p">(</span><span class="dl">'</span><span class="s1">/tmp/secret.txt</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">so secret</span><span class="dl">'</span><span class="p">);</span></code></pre></figure>

<p>Or perhaps dump an ArrayBuffer:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">readByteArray</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
<span class="nx">File</span><span class="p">.</span><span class="nx">writeAllBytes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/tmp/mystery.bin</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span></code></pre></figure>

<p>Going back to the example earlier, seek() also supports relative offsets:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">f</span><span class="p">.</span><span class="nx">seek</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nx">File</span><span class="p">.</span><span class="nx">SEEK_CUR</span><span class="p">);</span>
<span class="nx">f</span><span class="p">.</span><span class="nx">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="nx">File</span><span class="p">.</span><span class="nx">SEEK_END</span><span class="p">);</span></code></pre></figure>

<p>Retrieving the current file offset is just as easy:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">tell</span><span class="p">();</span></code></pre></figure>

<h2 id="checksum-api">Checksum API</h2>

<p>The other JavaScript API addition this time around is for when you want to
compute checksums. While this could be implemented in JavaScript entirely in
“userland”, we do get it fairly cheap since Frida depends on GLib, and it
already provides a <a href="https://docs.gtk.org/glib/struct.Checksum.html">Checksum API</a> out of the box. All we needed to do was
expose it.</p>

<p>Putting it all together, this means we can read a file and compute its SHA-256:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">utmp</span> <span class="o">=</span> <span class="nx">File</span><span class="p">.</span><span class="nx">readAllBytes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/var/run/utmp</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">Checksum</span><span class="p">.</span><span class="nx">compute</span><span class="p">(</span><span class="dl">'</span><span class="s1">sha256</span><span class="dl">'</span><span class="p">,</span> <span class="nx">utmp</span><span class="p">);</span></code></pre></figure>

<p>Or, for more control:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">checksum</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Checksum</span><span class="p">(</span><span class="dl">'</span><span class="s1">sha256</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">checksum</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">File</span><span class="p">.</span><span class="nx">readAllText</span><span class="p">(</span><span class="dl">'</span><span class="s1">/etc/hosts</span><span class="dl">'</span><span class="p">));</span>
<span class="nx">checksum</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">File</span><span class="p">.</span><span class="nx">readAllBytes</span><span class="p">(</span><span class="dl">'</span><span class="s1">/var/run/utmp</span><span class="dl">'</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Result:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">checksum</span><span class="p">.</span><span class="nx">getString</span><span class="p">());</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hexdump</span><span class="p">(</span><span class="nx">checksum</span><span class="p">.</span><span class="nx">getDigest</span><span class="p">(),</span> <span class="p">{</span> <span class="na">ansi</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span></code></pre></figure>

<p>(You can learn more about this API from our <a href="https://github.com/DefinitelyTyped/DefinitelyTyped/blob/edfba0b718c853dea18c23e2f4b5dd9b4c17dd6d/types/frida-gum/index.d.ts#L2500-L2559">TypeScript bindings</a>.)</p>

<h2 id="eof">EOF</h2>

<p>There are also a few other goodies in this release, so definitely check out the
changelog below.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>gumjs: Extend the <em>File</em> API.</li>
  <li>gumjs: Add <em>Checksum</em> API.</li>
  <li>gumjs: Fix handling of relative ESM imports from root.</li>
  <li>glib: (win32) Add Input/OutputStream support for plain files.</li>
  <li>build: Make XP SDK optional on Windows.</li>
  <li>node: Target Electron 19.0.0 instead of 19.0.0-alpha.1.</li>
  <li>node: Define <em>openssl_fips</em> to work around node-gyp issue.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/06/20/frida-15-1-27-released/index.html">
      Frida 15.1.27 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      20 Jun 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It appears I should have had some more coffee this morning, so here’s another
release to actually fix <a href="https://github.com/frida/frida-java-bridge/commit/e9a24559e967dac39edf6f74db37b1287063010c">this</a> broken fix back in 15.1.25:</p>

<blockquote>
  <ul>
    <li>java: (android) Prevent ART from compiling replaced methods</li>
  </ul>
</blockquote>

<p>Turns out the <em>kAccCompileDontBother</em> constant changed in Android 8.1. It also
didn’t exist before 7.0. Oops! This release <a href="https://github.com/frida/frida-java-bridge/commit/cdc3d3638c735d008283bfe177cffdd59b0e62c3">fixes</a> it, for real this time 😊</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/06/20/frida-15-1-26-released/index.html">
      Frida 15.1.26 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      20 Jun 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Only one change this time around, related to <a href="https://github.com/frida/frida-java-bridge/commit/e9a24559e967dac39edf6f74db37b1287063010c">this</a> fix in the previous
release:</p>

<blockquote>
  <ul>
    <li>java: (android) Prevent ART from compiling replaced methods</li>
  </ul>
</blockquote>

<p>Well, turns out the <em>kAccCompileDontBother</em> constant was incorrect. This release
<a href="https://github.com/frida/frida-java-bridge/commit/13451378145e10de880dbc2dfb4fc241e6629959">fixes</a> it. (Spoiler from the future: it didn’t.)</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/06/18/frida-15-1-25-released/index.html">
      Frida 15.1.25 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      18 Jun 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Quite a few exciting bits in this release. Let’s dive right in.</p>

<h2 id="fpuvector-register-access">FPU/vector register access</h2>

<p>Some great news for those of you using Frida on 32- and 64-bit ARM. Up until
now, we have only exposed the CPU’s integer registers, but as of this release,
FPU/vector registers are also available! 🎉</p>

<p>For 32-bit ARM this means <em>q0</em> through <em>q15</em>, <em>d0</em> through <em>d31</em>, and <em>s0</em>
through <em>s31</em>. As for 64-bit ARM they’re <em>q0</em> through <em>q31</em>, <em>d0</em> through <em>d31</em>,
and <em>s0</em> through <em>s31</em>. If you’re accessing these from JavaScript, the vector
properties are represented using <em>ArrayBuffer</em>, whereas for the others we’re
using the <em>number</em> type.</p>

<h2 id="javabacktrace">Java.backtrace()</h2>

<p>Our existing Java.backtrace() API now provides a couple of new properties in the
returned <em>frames</em>, which now also expose <em>methodFlags</em> and <em>origin</em>.</p>

<h2 id="quality">Quality</h2>

<p>I finally <a href="https://github.com/frida/vala/commit/d07b689485b3c79116a569696d36ad7c0e299c02">plugged</a> a memory leak in our RPC server-side code. This was
introduced by me in 15.1.10 when implementing an <a href="https://github.com/frida/vala/commit/74a66f908957f9c141e4b50c915a2968721e267a">optimization</a> in the Vala
compiler’s code generation for DBus reply handling. Shoutout to <a href="https://github.com/rev1si0n">@rev1si0n</a>
for reporting and helping track down this regression!</p>

<h2 id="eof">EOF</h2>

<p>There are also some other goodies in this release, so definitely check out the
changelog below.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>vala: Plug leak in server-side GDBus reply handling. This affected all
server-side implementations in Frida.</li>
  <li>glib: Disable support for “charset.alias”. This means we no longer try to
open this file, which could cause sandbox violations on some systems, such
as iOS.</li>
  <li>java: (android) Add <em>methodFlags</em> to Java.backtrace() frames.</li>
  <li>java: (android) Add <em>origin</em> to Java.backtrace() frames.</li>
  <li>java: (android) Prevent ART from compiling replaced methods. Kudos to
<a href="https://github.com/s1341">@s1341</a> for figuring this one out!</li>
  <li>cpu-context: Add ARM FPU/vector registers and NZCV.</li>
  <li>cpu-features: Add VFPD32 flag and detection logic.</li>
  <li>stalker: Fix VFP D32 detection in the arm backend.</li>
  <li>gumjs: Add vector regs to arm_reg bindings.</li>
  <li>x86-writer: Add put_fx{save,rstor}_reg_ptr().</li>
  <li>arm-writer: Add load/store variants without offset.</li>
  <li>arm-writer: Add put_v{push,pop}_range().</li>
  <li>arm-writer: Remove noop check from put_ands_reg_reg_imm().</li>
  <li>arm-writer: Rename *_registers() to *_regs().</li>
  <li>arm-writer: Support vector push/pop with Q regs.</li>
  <li>thumb-writer: Add put_v{push,pop}_range().</li>
  <li>thumb-writer: Support vector push/pop with Q regs.</li>
  <li>arm64-writer: Add load/store variants without offset.</li>
  <li>arm64-writer: Add put_mov_{reg_nzcv,nzcv_reg}().</li>
  <li>libc-shim: Support old system headers on Linux/ARM.</li>
  <li>node: Bump dependencies.</li>
  <li>node: Publish prebuilds for Electron 19 instead of 18.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/06/03/frida-15-1-24-released/index.html">
      Frida 15.1.24 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      03 Jun 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Only one change this time, but it’s an important one for those of you using
Frida on Android: Our Java method hooking implementation was crashing in some
cases, where we would pick a scratch register that conflicted with the generated
code. This is now <a href="https://github.com/frida/frida-java-bridge/commit/d4d2a42ef2f370487a88d108e966de30f2a48322">fixed</a>.</p>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/05/30/frida-15-1-23-released/index.html">
      Frida 15.1.23 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      30 May 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>The main theme of this release is OS support, where we’ve fixed some rough edges
on Android 12, and introduced preliminary support for Android 13. While working
on frida-java-bridge I also found myself needing some of the JVMTI code in the
JVM-specific backend. Those bits are now shared, and the JVM-specific code is
in better shape, with brand new support for JDK 17.</p>

<p>We have also improved stability in several places, and made it easier to use the
CodeWriter APIs safely. Portability has also been improved, where our
QuickJS-based JavaScript runtime finally works when cross-compiled for
big-endian from a little-endian build machine, and vice versa.</p>

<p>To learn more, be sure to check out the changelog below.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>linux: Handle spurious signals during ptrace().</li>
  <li>android: Add missing SELinux rule for system_server on Android 12+.</li>
  <li>android: Fix Android 13 detection on real devices.</li>
  <li>android: Handle new linker internals in Android 13.</li>
  <li>java: Improve the Java.enumerateMethods() error message. Thanks <a href="https://github.com/jpstotz">@jpstotz</a>!</li>
  <li>java: (android) Handle inlined GetOatQuickMethodHeader().</li>
  <li>java: (android) Improve support for non-Google Android 12+ ROMs.</li>
  <li>java: (android) Fix Java.choose() on Android &gt;= 12.</li>
  <li>java: (android) Add support for Android 13.</li>
  <li>java: (android) Fix <em>threadReg</em> clobber in the x64 recompilation logic.</li>
  <li>java: (android) Explain why Java.deoptimizeBootImage() is unavailable.</li>
  <li>java: (android) Expose JVMTI through <em>api.jvmti</em>.</li>
  <li>java: (android) Improve error messages about OS features.</li>
  <li>java: (jvm) Add basic support for JDK 17.</li>
  <li>java: (jvm) Add fallback for thread_from_jni_environment().</li>
  <li>java: (jvm) Fix UAF in withJvmThread() prologue/epilogue logic.</li>
  <li>java: (jvm) Improve <em>InstanceKlass</em> offset detection.</li>
  <li>code-writer: Add <em>flush_on_destroy</em> option.</li>
  <li>gumjs: Disable the CodeWriter <em>flush_on_destroy</em> option. In this way, the
writers are safer to use as they won’t be writing to memory once they’re
garbage-collected. At that point the target memory may no longer be writable,
or might be owned by other code.</li>
  <li>gumjs: Embed byteswapped QuickJS bytecode when needed. This means GumJS can be
cross-compiled across endians.</li>
  <li>gumjs: Fix double free in the Instruction copy logic.</li>
  <li>gumjs: Fix Relocator instruction accessors.</li>
  <li>gumjs: Flush CodeWriter on reset() and dispose().</li>
  <li>gumjs: Improve NativePointer#strip() to support ARM TBI.</li>
  <li>gumjs: Make Instruction wrapper safer in zero-copy mode.</li>
  <li>gumjs: Plug Relocator leak in the QuickJS runtime.</li>
  <li>quickjs: Fix support for byteswapped output. Also upgrade QuickJS to latest
upstream version with Unicode 14 updates.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/05/09/frida-15-1-22-released/index.html">
      Frida 15.1.22 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      09 May 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Turns out the major surgery that Gum went through in 15.1.15 introduced some
error-handling regressions. Errors thrown vs. actually expected by the Vala code
in frida-core did not match, which resulted in the process crashing instead of a
friendly error bubbling up to e.g. the Python bindings. That is now finally
taken care of. I wish we had noticed it sooner, though — we’re clearly lacking
test coverage in this area.</p>

<p>Beside the error-handling fixes, we’re also including a build system <a href="https://github.com/frida/frida/commit/6a717d636a87c501327c77a70080b495556c8d25">fix</a> for
incremental build issues. Kudos to <a href="https://github.com/londek">Londek</a> for this nice contribution.</p>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/05/06/frida-15-1-21-released/index.html">
      Frida 15.1.21 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      06 May 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Only change this time is an important bugfix for i/macOS, where imports could
not always be resolved. Kudos to <a href="https://twitter.com/bezjaje">@mrmacete</a> for this <a href="https://github.com/frida/frida-gum/commit/5582d1f922368ccf0f8c7576be1717e14d64ced0">fix</a>.</p>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/05/06/frida-15-1-20-released/index.html">
      Frida 15.1.20 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      06 May 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It was discovered that 15.1.10 broke inline hooking in frida-java-bridge on
Android/x86_64. This release <a href="https://github.com/frida/frida-java-bridge/commit/32f2faa7064eee629bc03fafcac90cfbeb4e5018">fixes</a> it.</p>

<p>This time we’re also moving to shipping Node.js prebuilds for v18 instead of
v17. (Sigh, should port frida-node to <a href="https://nodejs.org/api/n-api.html">Node-API</a> so we can stop this madness!)</p>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/05/04/frida-15-1-19-released/index.html">
      Frida 15.1.19 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      04 May 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Turns out 15.1.18 had a release automation bug that resulted in stale Python
binding artifacts getting uploaded.</p>

<p>To make this release a little happier, I also threw in a Stalker improvement
for x86/64, where the <em>clone3</em> syscall is now <a href="https://github.com/frida/frida-gum/commit/eb7621136af07d3db38a68effafa37087d23b8d4">handled</a> as well. This was
caught by Stalker’s test-suite on some systems.</p>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/05/04/frida-15-1-18-released/index.html">
      Frida 15.1.18 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      04 May 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Lots of improvements all over the place this time. Many stability improvements.</p>

<p>I have continued improving our CI and build system infrastructure. QNX and MIPS
support are back from the dead, after long-standing regressions. These went
unnoticed due to lack of CI coverage. We now have CI in place to ensure that
won’t happen again.</p>

<p>Do check out the changelog below for a full overview of what’s new.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>gadget: Fix deadlock when Gadget is blocking the dynamic linker with its
internal lock(s) held while waiting for resume(). In that case we are
processing the JS MainContext while blocking, with network I/O handled by the
Gadget thread. Because Stalker may interact with the dynamic linker during its
class_init(), we must ensure that it happens from the JS thread and not the
network I/O thread.</li>
  <li>exit-monitor: Fix deadlock when a fork() goes unnoticed.</li>
  <li>darwin: Skip pseudo-signing when running on Corellium.</li>
  <li>darwin: Fix compatibility with older iOS SDKs.</li>
  <li>darwin-backtracer: Fix loop variable wrap-around.</li>
  <li>darwin-mapper: Fix footprint budgeting w/ chained fixups.</li>
  <li>linux: Fix the Process.modify_thread() wait logic.</li>
  <li>linux: Fully resolve libc on modern glibc systems.</li>
  <li>linux: Remove the Linjector cleanup delay.</li>
  <li>ios: Add config.mk option for building without jailbreak support code, for
compatibility with e.g. TestFlight.</li>
  <li>ios: Eliminate dependency on external Mach VM header.</li>
  <li>android: Fix unw_getcontext() on Android/x86, which resulted in stack
corruption during e.g. Thread.backtrace().</li>
  <li>freebsd: Add BSDmakefile for convenience.</li>
  <li>freebsd: Fix gum_clear_cache() reliability.</li>
  <li>freebsd: Improve the program path query API.</li>
  <li>freebsd: Try a bit harder when MAP_32BIT fails.</li>
  <li>mips: Fix long-standing regressions that went unnoticed due to lack of CI.</li>
  <li>qnx: Fix long-standing regressions that went unnoticed due to lack of CI. Also
improve the QNX backend while at it.</li>
  <li>posix: Use posix_madvise() if madvise() is unavailable.</li>
  <li>stalker: Detect thread exit implementation on glibc, Android, and FreeBSD.</li>
  <li>stalker: Fix Linux clone() support in the x86 backend.</li>
  <li>stalker: Fix backpatching of JECXZ/JRCXZ x86 instructions.</li>
  <li>stalker: Fix two <em>pc</em> vs <em>code</em> mixups in the x86 backend.</li>
  <li>stalker: Optimize Linux syscall logic in the x86 backend.</li>
  <li>stalker: Move unwind support behind an API.</li>
  <li>stalker: Simplify and fix the x86 unwind Interceptor logic.</li>
  <li>stalker: Implement unwind hooking in the arm64 backend. Thanks <a href="https://github.com/s1341">@s1341</a>!</li>
  <li>stalker: Add backpatch query support.</li>
  <li>stalker: Add support for recompiling blocks.</li>
  <li>process: Add resolve_module_pointer().</li>
  <li>elf-module: Improve the DT_SYMTAB entry count detection.</li>
  <li>elf-module: Skip symbols with a dangling name reference.</li>
  <li>symbolutil-libdwarf: Add support for DWARF v5.</li>
  <li>libdwarf: Backport upstream fix for handling of DW_FORM_line_strp.</li>
  <li>dbghelp-backtracer: Improve reliability on 32-bit x86.</li>
  <li>arm-relocator: Simplify PC-relative <em>LDR</em> handling.</li>
  <li>arm-writer: Add call_reg_with_arguments*().</li>
  <li>arm-writer: Handle put_call*() w/ more than four args.</li>
  <li>thumb-writer: Handle put_call*() stack alignment.</li>
  <li>arm64-writer: Optimize <em>LDR reg, #0</em>.</li>
  <li>x86-relocator: Add <em>input_pc</em> to support offline use.</li>
  <li>x86-relocator: Fix PC vs output mixup in RIP-relative fast-path.</li>
  <li>x86-relocator: Improve the RIP offset fixup logic.</li>
  <li>bounds-checker: Fall back to the matching heap API.</li>
  <li>gumjs: Fix CModule memory allocation logic.</li>
  <li>gumjs: Fix CModule runtime with internal TinyCC.</li>
  <li>gumjs: Lower build-time Python requirement to 3.7.</li>
  <li>heap-api: Improve libc detection on non-Windows OSes.</li>
  <li>heap-api: Include static MSVC CRT APIs in the list.</li>
  <li>gum: Improve Meson build system to support MSVC.</li>
  <li>gum: Improve Gum vapis to expose more APIs.</li>
  <li>core: Fix build failure with some locales by switching off localization when
invoking tools from modulate.py.</li>
  <li>python: Fix stability issue caused by incorrect refcounting in
get_max_argument_count().</li>
  <li>python: Fix get_index_url_from_pip(). Thanks <a href="https://github.com/X5tar">@X5tar</a>!</li>
  <li>python: Fix index URL retrieval on Python &lt; 3.6. Thanks <a href="https://github.com/serfend">@serfend</a>!</li>
  <li>node: Publish prebuilds for Electron 18 instead of 16.</li>
  <li>ci: Add Linux/MIPS, FreeBSD/x86_64, FreeBSD/arm64, and QNX/armeabi. For Gum,
also add Windows/x86_64, macOS/x86_64, Linux/x86, Linux/x86_64, iOS/arm64,
Android/x86, Android/arm, and Android/arm64.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/02/10/frida-15-1-17-released/index.html">
      Frida 15.1.17 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      10 Feb 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>One notable improvement in this release is that <code class="language-plaintext highlighter-rouge">Java.backtrace()</code> got a major
overhaul. It is now lazy and &gt;10x faster. I have also refined its <a href="https://github.com/DefinitelyTyped/DefinitelyTyped/commit/37db50ef28bb33d3dbbd3250107d15213861bbf5">API</a>,
which is now considered stable.</p>

<p>While working on <a href="https://github.com/frida/frida-java-bridge">frida-java-bridge</a>, I optimized how Env objects are handled,
so we can recycle an existing instance if we already have one for the current
thread.</p>

<p>The remaining goodies are covered by the changelog below, so definitely check
it out.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>Fix devkits for i/macOS, Android, and QNX, where parts of libiconv were
missing.</li>
  <li>Improve devkit packaging on LLVM toolchains.</li>
  <li>Improve diet mode support in GLib.</li>
  <li>cmodule: Expose g_strndup().</li>
  <li>cmodule: Expose Gum’s Thread Local Storage API.</li>
  <li>java: Rework Java.backtrace() to be lazy and &gt;10x faster.
    <ul>
      <li>Move thread transition and stack walking logic to CModule.</li>
      <li>Return a Backtrace object instead of an array with the frames.</li>
      <li>Provide a cheap <em>id</em> property that can be used for deduplication.</li>
      <li>Lazily compute the frames when accessing the <em>frames</em> property.</li>
    </ul>
  </li>
  <li>java: Avoid expensive Env creation when possible.</li>
  <li>python: Improve index URL handling. Thanks <a href="https://github.com/GalaxySnail">@GalaxySnail</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/02/03/frida-15-1-16-released/index.html">
      Frida 15.1.16 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      03 Feb 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>This time we’re bringing you two bugfixes and one new feature, just in time for
the weekend.</p>

<p>Gum used to depend on GIO, but that dependency was removed in the previous
release. The unfortunate result of that change was that agent and gadget no
longer tore down GIO, as they were relying on Gum’s teardown code doing that.
What this meant was that we were leaving threads behind, and that is never a
good thing. So that’s the first bugfix.</p>

<p>Also in the previous release, over in our Python bindings, setup.py went through
some heavy changes. We improved the .egg download logic, but managed to break
the local .egg logic. That’s the second bugfix.</p>

<p>Onto the new feature. For those of you using Gum’s JavaScript bindings, GumJS,
we now support <code class="language-plaintext highlighter-rouge">console.count()</code> and <code class="language-plaintext highlighter-rouge">console.countReset()</code>. These are
implemented by browsers and Node.js, and make it easy to count the number of
times a given label has been seen. Kudos to <a href="https://github.com/yotamN">@yotamN</a> for this nice
contribution.</p>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2022/02/01/frida-15-1-15-released/index.html">
      Frida 15.1.15 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      01 Feb 2022
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Quite a few exciting bits in this release. Let’s dive right in.</p>

<h2 id="freebsd">FreeBSD</h2>

<p>Our ambition is to support all platforms that our users care about. In this
release I wanted to plant the first seed in expanding that to BSDs. So now I’m
thrilled to announce that Frida finally also supports FreeBSD! 🎉</p>

<p>For now we only support x86_64 and arm64, but expanding to the remaining
architectures is straight-forward in case anybody is interested in helping out.</p>

<p>The porting effort resulted in several architectural refinements and improved
robustness for ELF-based OSes in general. It also gave me some ideas on how to
improve our Linux injector to support injecting into containers, which is
something I’d like to do down the road.</p>

<h2 id="stalker-performance">Stalker Performance</h2>

<p>Back in 15.1.10, Stalker got a massive performance boost on x86/64. In this
release those same ideas have been applied to our arm64 backend. This includes
improved locality, better inline caches, etc. I’m told we were able to beat or
match QEMU in FuzzBench back then, and now we should be in good shape on arm64
as well. We also managed to improve stability while at it. Exciting!</p>

<h2 id="gobject-introspection">GObject Introspection</h2>

<p>Back in 14.1, <a href="https://github.com/meme">@meme</a> wired up build system support for
<a href="https://gi.readthedocs.io/en/latest/">GObject Introspection</a>. This means we have a machine-readable description of
all of our APIs, which lets us piggyback on existing language <a href="https://gi.readthedocs.io/en/latest/users.html">binding</a>
infrastructure, and even get <a href="https://gitlab.gnome.org/GNOME/gi-docgen/">auto-generated reference docs</a> for free.</p>

<p>This release adds a lot of annotations and doc-strings to Gum, and we are now
closer than ever to having auto-generated reference docs. Still some work left
to do before it makes sense to publish the generated documentation, but it’s not
far off. If anyone is interested in pitching in, check out Gum’s <a href="https://github.com/frida/frida-gum/actions">CI</a> and have
a look at the warnings output by GObject Introspection.</p>

<h2 id="meson-subproject-support">Meson subproject support</h2>

<p>One thing I really like about the Meson build system is its support for
<a href="https://mesonbuild.com/Subprojects.html">subprojects</a>. Gum now supports being used as a subproject. Some of you may
already be consuming Gum through its <a href="https://github.com/frida/frida/releases">devkit binaries</a>, and now you have a
brand new option that is even easier.</p>

<p>The main advantage over using a devkit is that everything is built from source,
so it’s easy to experiment with the code.</p>

<p>Let’s say we have a file <code class="language-plaintext highlighter-rouge">hello.c</code> that contains:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define _GNU_SOURCE
#include &lt;dlfcn.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;gum.h&gt;
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span> <span class="n">open_impl</span><span class="p">)</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oflag</span><span class="p">,</span> <span class="p">...);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">replacement_open</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oflag</span><span class="p">,</span> <span class="p">...);</span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span>
      <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">gum_init</span> <span class="p">();</span>

  <span class="n">GumInterceptor</span> <span class="o">*</span> <span class="n">interceptor</span> <span class="o">=</span> <span class="n">gum_interceptor_obtain</span> <span class="p">();</span>

  <span class="n">gum_interceptor_begin_transaction</span> <span class="p">(</span><span class="n">interceptor</span><span class="p">);</span>

  <span class="n">open_impl</span> <span class="o">=</span> <span class="n">dlsym</span> <span class="p">(</span><span class="n">RTLD_DEFAULT</span><span class="p">,</span> <span class="s">"open"</span><span class="p">);</span>
  <span class="n">gum_interceptor_replace</span> <span class="p">(</span><span class="n">interceptor</span><span class="p">,</span> <span class="n">open_impl</span><span class="p">,</span> <span class="n">replacement_open</span><span class="p">,</span>
      <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">gum_interceptor_end_transaction</span> <span class="p">(</span><span class="n">interceptor</span><span class="p">);</span>

  <span class="n">close</span> <span class="p">(</span><span class="n">open_impl</span> <span class="p">(</span><span class="s">"/etc/hosts"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">));</span>
  <span class="n">close</span> <span class="p">(</span><span class="n">open_impl</span> <span class="p">(</span><span class="s">"/etc/fstab"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">));</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">replacement_open</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">path</span><span class="p">,</span>
                  <span class="kt">int</span> <span class="n">oflag</span><span class="p">,</span>
                  <span class="p">...)</span>
<span class="p">{</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">"!!! open(</span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">, 0x%x)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">oflag</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">open_impl</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">oflag</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>To build it we can create a <code class="language-plaintext highlighter-rouge">meson.build</code> next to it with the following:</p>

<figure class="highlight"><pre><code class="language-meson" data-lang="meson">project('hello', 'c')
gum = dependency('frida-gum-1.0')
executable('hello', 'hello.c', dependencies: [gum])</code></pre></figure>

<p>And create <code class="language-plaintext highlighter-rouge">subprojects/frida-gum.wrap</code> containing:</p>

<figure class="highlight"><pre><code class="language-ini" data-lang="ini"><span class="nn">[wrap-git]</span>
<span class="py">url</span> <span class="p">=</span> <span class="s">https://github.com/frida/frida-gum.git</span>
<span class="py">revision</span> <span class="p">=</span> <span class="s">main</span>
<span class="py">depth</span> <span class="p">=</span> <span class="s">1</span>

<span class="nn">[provide]</span>
<span class="py">dependency_names</span> <span class="p">=</span> <span class="s">frida-gum-1.0, frida-gum-heap-1.0, frida-gum-prof-1.0, frida-gumjs-1.0</span></code></pre></figure>

<p>In case you don’t have Meson and Ninja already installed, run
<code class="language-plaintext highlighter-rouge">pip install meson ninja</code>.</p>

<p>Then, to build and run:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>meson setup build
<span class="nv">$ </span>meson compile <span class="nt">-C</span> build
<span class="nv">$ </span>./build/hello
<span class="o">!!!</span> open<span class="o">(</span><span class="s2">"/etc/hosts"</span>, 0x0<span class="o">)</span>
<span class="o">!!!</span> open<span class="o">(</span><span class="s2">"/etc/fstab"</span>, 0x0<span class="o">)</span></code></pre></figure>

<h2 id="footprint">Footprint</h2>

<p>We put a lot of effort into making sure that Frida can scale from desktops all
the way down to embedded systems. In this release I spent some time profiling
our binary footprint, and based on this I ended up making a slew of tweaks and
build options to reduce our footprint.</p>

<p>I was curious how small I could make a <a href="https://github.com/oleavr/hello-gum">Gum Hello World</a> program that only
uses Interceptor. The end result was measured on 32-bit ARM w/ Thumb
instructions, where Gum and its dependencies are statically linked, and the only
external dependency is the system’s libc.</p>

<p>The result was as small as 55K (!), and that made me really excited. What I did
was to introduce new build options in Gum, GLib, and Capstone. For Gum we now
support a “diet” mode where we don’t make use of GObject and only offer a plain
C API. This means it won’t support GObject Introspection and fancy language
bindings. It also means we don’t offer the full Gum API, but that is something
that can be expanded on in the future.</p>

<p>Similarly for GLib there is also a new “diet” mode, and boils down to disabling
its slice allocator, debugging features, and a few other minor tweaks like that.</p>

<p>As for Capstone, I ended up introducing a new “profile” option that can be set
to “tiny”. The result of doing so is that Capstone only understands enough of
the instruction set to determine each instruction’s length, and provide some
details on position-dependent instructions. The idea is to only support what
our Relocator implementations need, as those do most of the heavy lifting
behind Interceptor and Stalker.</p>

<p>While I wouldn’t recommend using these build options unless you really need a
footprint that small, it’s good to be aware of what’s possible. We also offer
other, less extreme options. Read more in our <a href="../../docs/footprint/index.html">footprint docs</a>.</p>

<h2 id="the-curse-of-multiple-build-systems">The curse of multiple build systems</h2>

<p>Something that has been bothering me for as long as Frida has existed, is that
building Frida involves dealing with multiple build systems. While we do of
course try to hide that complexity behind scripts/makefiles, we are inevitably
going to have unhappy users who find themselves trying to figure out why Frida
is not building for them.</p>

<p>Some are also interested in cross-compiling Frida for a slightly different libc,
toolchain, or what have you. They may even be looking to add support for an OS
we don’t yet support. Chances are that we’re going to demotivate them the moment
they realize they need to deal with four different build-systems: Meson,
autotools, custom Perl scripts (OpenSSL), and GN (V8).</p>

<p>As we are happy users of Meson, my goal is to “Mesonify all the things!”. With
this release, we have now finally reached the point where virtually all of our
required dependencies are built using Meson. The only exception is V8, but we
will hopefully also build that with Meson someday. (Spoiler from the future:
Frida 16 will get us there!)</p>

<h2 id="eof">EOF</h2>

<p>There’s also a bunch of other exciting changes, so definitely check out the
changelog below.</p>

<p>Enjoy!</p>

<h3 id="changelog">Changelog</h3>

<ul>
  <li>Add support for FreeBSD.</li>
  <li>Add support for ARMv4, for instrumenting old embedded systems.</li>
  <li>Add build options for binary footprint reductions (see config.mk).</li>
  <li>Tweak Capstone and GLib to enable much smaller binary footprints.</li>
  <li>droidy: Add AXML decoder. Thanks <a href="https://github.com/meme">@meme</a>!</li>
  <li>windows: Fix dbghelp backtracer support for libffi-frames.</li>
  <li>linux: Fix compatibility with new glibc versions.</li>
  <li>linux: Only use one frida-helper when assets are installed.</li>
  <li>qnx: Remove tempfiles when injector is closed.</li>
  <li>core: Plug leak when agent teardown is cancelled.</li>
  <li>gumjs: Fix handling of RPC invocations returning <em>null</em>.</li>
  <li>interceptor: Use a “jumbo”-JMP on x86 when needed, when impossible to allocate
memory reachable from a “JMP <imm32>".</imm32></li>
  <li>interceptor: Generate variable size x86 NOP padding.</li>
  <li>stalker: Improve performance of the arm64 backend, by applying ideas recently
used to optimize the x86/64 backend – e.g. improved locality, better inline
caches, etc.</li>
  <li>stalker: Fix handling of zero-sized freeze/thaw().</li>
  <li>stalker: Rework x86 PLT exclusion code to avoid reentrancy-issues during
stalking.</li>
  <li>stalker: Don’t require a C++ runtime to be present.</li>
  <li>arm-writer: Add put_bl_reg(), put_call_reg().</li>
  <li>arm-writer: Fix register clobbering in put_call_address*().</li>
  <li>arm64-reader: Expose disassemble_instruction_at().</li>
  <li>arm64-writer: Fix handling of mixed-width literals.</li>
  <li>arm64-writer: Fix TBZ/TBNZ encoding.</li>
  <li>arm64-writer: Fix put_and_reg_reg_imm() on 32-bit systems.</li>
  <li>arm64-writer: Add put_{ldr,str}_reg_reg_offset_mode().</li>
  <li>elf-module: Expose more details, add support for offline mode, add Vala
bindings.</li>
  <li>exceptor: Add reset() for exception handler recovery.</li>
  <li>gum: Add lots of GObject Introspection annotations and API docs.</li>
  <li>gum: Add support for using as a Meson subproject.</li>
  <li>gum: Port Meson build system to Windows.</li>
  <li>gum: Eliminate the GIO dependency.</li>
  <li>gum: Add diet mode, allowing a “Hello World” C program that uses Interceptor
to be as small as 55K on 32-bit ARM w/ Thumb instructions.</li>
  <li>gum: Add CI. Thanks <a href="https://github.com/meme">@meme</a>!</li>
  <li>Improve build system with many portability improvements.</li>
  <li>Build elfutils, libiconv, libdwarf, libunwind, openssl, xz with Meson.</li>
  <li>Upgrade dependencies: capstone, elfutils, libdwarf, libunwind.</li>
  <li>Release packages for Fedora 35 instead of 34.</li>
  <li>python: Use PEP 503 instead of PyPI xmlrpc. Thanks <a href="https://github.com/GalaxySnail">@GalaxySnail</a>!</li>
  <li>python: Fix support for Python &gt;= 3.10 on Windows.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2021/09/03/frida-15-1-released/index.html">
      Frida 15.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      03 Sep 2021
    </span>
    <a href="https://github.com/hot3eed" class="post-author">
      <img src="https://github.com/hot3eed.png" class="avatar" alt="hot3eed"/>
      hot3eed
    </a>
  </div>
  <div class="post-content">
    <p>Introducing the <em>brand new</em> Swift bridge! Now that Swift has been
ABI-stable since version 5, this long-awaited bridge allows Frida to play nicely
with binaries written in Swift. Whether you <a href="https://youtu.be/0rHG_Pa86oA?t=36">consider</a> Swift a static or a
dynamic language, one thing is for sure, it just got a lot more dynamic with
this Frida release.</p>

<h2 id="metadata">Metadata</h2>

<p>Probably the first thing a reverser does when they start reversing a binary is
getting to know the different data structures that the binary defines. So it
made most sense to start by building the Swift equivalent of the <code class="language-plaintext highlighter-rouge">ObjC.classes</code>
and <code class="language-plaintext highlighter-rouge">ObjC.protocols</code> APIs. But since Swift has other first-class types,
i.e. structs and enums, and since the Swift runtime doesn’t offer reflection
primitives, at least not in the sense that Objective-C does, it meant we had to
dig a little deeper.</p>

<p>Luckily for us, the Swift compiler emits metadata for each type
defined by the binary. This metadata is bundled in a
<code class="language-plaintext highlighter-rouge">TargetTypeContextDescriptor</code> C++ struct, defined in
<a href="https://github.com/apple/swift/blob/52e852a7a9758e6edcb872761ab997b552eec565/include/swift/ABI/Metadata.h">include/swift/ABI/Metadata.h</a> at the time of writing. This data structure
includes the type name, its fields, its methods (if applicable,) and other useful
data depending on the type at hand. These data structures are pointed to by
relative pointers (defined in <a href="https://github.com/apple/swift/blob/52e852a7a9758e6edcb872761ab997b552eec565/include/swift/Basic/RelativePointer.h">include/swift/Basic/RelativePointer.h</a>.) In
Mach-O binaries, these are stored in the <code class="language-plaintext highlighter-rouge">__swift5_types</code> section.</p>

<p>So to dump types, Frida basically iterates over these data structures and
parses them along the way, very similar to what <a href="https://github.com/DerekSelander/dsdump">dsdump</a> does, except that you
don’t have to build the Swift compiler in order to tinker with it.</p>

<p>Frida also has the advantage of being able to probe into
internal Apple dylibs written in Swift, and that’s because we don’t need to
parse the <code class="language-plaintext highlighter-rouge">dyld_shared_cache</code> thanks to the private <code class="language-plaintext highlighter-rouge">getsectiondata</code> API, which
gives us section offsets hassle-free.</p>

<p>Once we have the metadata, we’re able to easily create JavaScript wrappers for
object instances and values of different types.</p>

<h2 id="conventions">Conventions</h2>

<p>To be on par with the Objective-C bridge, the Swift bridge has to support
calling Swift functions, which also proved to be not as straight forward.</p>

<p>Swift defines its own calling convention, <code class="language-plaintext highlighter-rouge">swiftcall</code>, which, to put it
succinctly, tries to be as efficient as possible. That means, not wasting load
and store instructions on structs that are smaller than 4 registers-worth of
size. That is, to pass those kinds of structs directly in registers. And since
that could quickly over-book our precious 8 argument registers
(on AARCH64 <code class="language-plaintext highlighter-rouge">x0</code>-<code class="language-plaintext highlighter-rouge">x7</code>), it doesn’t use the first register for the <code class="language-plaintext highlighter-rouge">self</code>
argument. It also defines an <code class="language-plaintext highlighter-rouge">error</code> register where callees can store errors
which they throw.</p>

<p>What we just described above is termed “physical lowering” in the Swift compiler
docs, and it’s implemented by the back-end, LLVM.</p>

<p>The process that precedes physical lowering is termed “semantic lowering,” which
is the compiler front-end figuring out who “owns” a value and whether
it’s direct or indirect. Some structs, even though they might be smaller than
4 registers, have to be passed indirectly, because, for example, they are
generic and thus their exact memory layout is not known at compile time, or
because they include a weak reference that has to be in-memory at all times.</p>

<p>We had to implement both semantic and physical lowering in order to be able
to call Swift functions. Physical lowering is implemented using JIT-compiled
adapter functions (thanks to the <code class="language-plaintext highlighter-rouge">Arm64Writer</code> API) that does the necessary
<code class="language-plaintext highlighter-rouge">SystemV</code>-<code class="language-plaintext highlighter-rouge">swiftcall</code> translation. Semantic lowering is implemented by utilizing
the type’s metadata to figure out whether we should pass a value directly or
not.</p>

<p>The compiler <a href="https://github.com/apple/swift/blob/52e852a7a9758e6edcb872761ab997b552eec565/docs/ABI/CallingConvention.rst">docs</a> are a great resource to learn more about the calling
convention.</p>

<h2 id="interception">Interception</h2>

<p>Because Swift passes structs directly in registers, there isn’t a 1-to-1 mapping
between registers and actual arguments.</p>

<p>And now that we have JavaScript wrappers for types, and are able to call Swift
functions from the JS runtime, a good next step would be extending <code class="language-plaintext highlighter-rouge">Interceptor</code>
to support Swift functions.</p>

<p>For functions that are not stripped, we use a simple regex to parse argument
types and names, same for return values. After parsing them we retrieve the
type metadata, figure out the type’s layout, then simply construct JS wrappers
for each argument, which we pass the Swift argument value, however many
registers it occupies.</p>

<h2 id="eof">EOF</h2>

<p>Note that the bridge is still very early in development, and so:</p>
<ul>
  <li>Currently supports Darwin arm64(e) only.</li>
  <li>Performance is not yet in tip-top shape, some edge case might not be handled
properly and some bugs are to be expected.</li>
  <li>There’s a chance the API might change in breaking ways in the
short-to-medium term.</li>
  <li>PRs and issues are very welcome!</li>
</ul>

<p>Refer to the <a href="https://github.com/frida/frida-swift-bridge/blob/master/docs/api.md">documentation</a> for an up-to-date resource on the current API.</p>

<p>Enjoy!</p>

<h3 id="changes-in-1510">Changes in 15.1.0</h3>

<ul>
  <li>Implement the Swift bridge, which allows Frida to:
    <ul>
      <li>Explore Swift modules along with types implemented in them, i.e. classes,
structs, enums and protocols.</li>
      <li>Create JavaScript wrappers for object instances and values.</li>
      <li>Invoke functions that use the <code class="language-plaintext highlighter-rouge">swiftcall</code> calling convention from the
JavaScript runtime.</li>
      <li>Intercept Swift functions and automatically parse their arguments and return
values.</li>
    </ul>
  </li>
  <li>Fix i/macOS regression where changes related to iOS 15 support ended up
breaking support for attaching to Apple system daemons.</li>
  <li>gadget: Add interaction.parameters in connect mode. These parameters are then
“reflected” into app’s info under <code class="language-plaintext highlighter-rouge">parameters.config</code>. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
</ul>

<h3 id="changes-in-1511">Changes in 15.1.1</h3>

<ul>
  <li>gumjs: Fix Swift lifetime logic in the V8 runtime.</li>
</ul>

<h3 id="changes-in-1512">Changes in 15.1.2</h3>

<ul>
  <li>control-service: Fix signal wiring, so signals such as Device.output get
emitted correctly by a remote frida-server. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>gadget: Fix the “runtime” option, which was forgotten during the refactorings
leading up to Frida 15.</li>
  <li>relocator: Optimize handling of x86 RIP relative code, by simply adjusting the
offset where possible.</li>
  <li>gumjs: Add ESM support, so tools like frida-compile can output better code.</li>
  <li>gumjs: Throw away source code after parsing it.</li>
  <li>gumjs: Plug leak when compiling to QuickJS bytecode.</li>
  <li>java: Expose JNIEnv-&gt;GetDirectBufferAddress. Thanks <a href="https://github.com/pandasauce">@pandasauce</a>!</li>
</ul>

<h3 id="changes-in-1513">Changes in 15.1.3</h3>

<ul>
  <li>objc: Fix the Proxy respondsToSelector implementation. Thanks <a href="https://github.com/hot3eed">@hot3eed</a>!</li>
  <li>gumjs: Fix V8 runtime crash when module is missing.</li>
  <li>gumjs: Emit V8 exceptions thrown by ESM entrypoints.</li>
</ul>

<h3 id="changes-in-1514">Changes in 15.1.4</h3>

<ul>
  <li>gumjs: Fix double-free related to weak ref callbacks in the QuickJS runtime.
Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>gumjs: Ignore Interceptor context in unrelated NativeCallback invokes. In this
way invalid Interceptor contexts from higher up the call stack will be safely
ignored in favor of the minimal but correct callback context. Thanks
<a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>gumjs: Fix ESM module name normalization logic.</li>
  <li>gumjs: Add Process getters for cwd, home, and tmp dirs.</li>
  <li>swift: Improve metadata caching performance by ~3x. Thanks <a href="https://github.com/hot3eed">@hot3eed</a>!</li>
  <li>node: Publish Electron prebuilds for v15 instead of v13.</li>
</ul>

<h3 id="changes-in-1515">Changes in 15.1.5</h3>

<ul>
  <li>gumjs: Fix crash when QuickJS stringifies large numbers. Thanks
<a href="https://github.com/vfsfitvnm">@vfsfitvnm</a>!</li>
  <li>gumjs: Expose GError and GIConv to CModule. Thanks <a href="https://github.com/0xDC00">@0xDC00</a>!</li>
  <li>droidy: Support ADB server host/port environment variables. Thanks
<a href="https://github.com/amirpeles90">@amirpeles90</a>!</li>
  <li>swift: Improve load behavior on non-Darwin.</li>
</ul>

<h3 id="changes-in-1516">Changes in 15.1.6</h3>

<ul>
  <li>swift: Fix crash during load on non-Darwin. Thanks <a href="https://github.com/hot3eed">@hot3eed</a>!</li>
</ul>

<h3 id="changes-in-1517">Changes in 15.1.7</h3>

<ul>
  <li>swift: Fix CoreSymbolication integration on older OS versions. Thanks
<a href="https://github.com/hot3eed">@hot3eed</a>!</li>
  <li>python: Add setup.py download logic for Android/ARM. Our CI doesn’t yet build
and upload such a binary, though.</li>
</ul>

<h3 id="changes-in-1518">Changes in 15.1.8</h3>

<ul>
  <li>darwin: Add support for working in the SRD environment. Thanks <a href="https://github.com/Nessphoro">@Nessphoro</a>!</li>
  <li>darwin: Add support for building with newer iOS SDKs.</li>
</ul>

<h3 id="changes-in-1519">Changes in 15.1.9</h3>

<ul>
  <li>x86-relocator: Fix patching of RIP relative instructions. This was a
regression introduced in 15.1.2, resulting in Stalker becoming unreliable.</li>
  <li>portal-service: Always remove ClusterNode sessions whenever a session ID is
unset from PortalService. This avoids both NULL dereferences and leaks.
Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>frida-portal: Fix typo in –help output.</li>
</ul>

<h3 id="changes-in-15110">Changes in 15.1.10</h3>

<ul>
  <li>p2p: Gracefully handle unsupported ICE candidates.</li>
  <li>p2p: Disable ICE-TCP for now.</li>
  <li>p2p: Rework PeerSocket to fix synchronization issues.</li>
  <li>socket: Fix WebService teardown.</li>
  <li>vala: Optimize server-side GDBus reply handling. This means our RPC and
network protocols become less chatty/more performant.</li>
  <li>x86-writer: Add UD2 instructions after/in indirect branches.</li>
  <li>x86-writer: Emit larger NOPs when possible.</li>
  <li>stalker: Improve performance of the x86/64 backend.</li>
  <li>objc-api-resolver: Guard against disposed ObjC classes. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>gumjs: Fix V8 Interceptor.{replace,revert}() regression. Thanks <a href="https://github.com/3vilWind">@3vilWind</a>!</li>
  <li>gumjs: Expand Instruction API w/ regsAccessed and operand.access. Thanks
<a href="https://github.com/3vilWind">@3vilWind</a>!</li>
</ul>

<h3 id="changes-in-15111">Changes in 15.1.11</h3>

<ul>
  <li>x86-writer: Add put_sahf() and put_lahf().</li>
  <li>x86-relocator: Fix handling of out-of-range Jcc branch targets. Thanks
<a href="https://github.com/0xDC00">@0xDC00</a>!</li>
  <li>stalker: Optimize target address retrieval.</li>
  <li>stalker: Avoid expensive XCHG instructions.</li>
  <li>stalker: Optimize IC prolog to use SAHF/LAHF.</li>
  <li>memory: Improve scan() to support regex patterns. Thanks <a href="https://github.com/hot3eed">@hot3eed</a>!</li>
  <li>kernel: Get base from all_image_info where supported. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>windows: Improve dbghelp backtracer reliability. Thanks <a href="https://github.com/HonicRoku">@HonicRoku</a>!</li>
</ul>

<h3 id="changes-in-15112">Changes in 15.1.12</h3>

<ul>
  <li>agent: Fix hang on unload w/ NO_REPLY_EXPECTED calls, where we would wait for
a reply to be sent. Due to the server-side DBus code being generated by the
Vala compiler, and it previously (in Frida &lt;= 15.1.9) ignoring
NO_REPLY_EXPECTED, this bug went unnoticed.</li>
  <li>android: Move to NDK r24 Beta 1.</li>
</ul>

<h3 id="changes-in-15113">Changes in 15.1.13</h3>

<ul>
  <li>linux: Improve module resolution on glibc systems.</li>
  <li>fruity: Fix spawn on dyld v4 case (jailed iOS 15.x). Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>objc-api-resolver: Protect against objc_disposeClassPair() via mutex. Thanks
<a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>gumjs: Update Kernel.scan*() to match Memory.scan*(). Thanks <a href="https://github.com/hot3eed">@hot3eed</a>!</li>
  <li>stalker: Fix emitted branch op-code on x86.</li>
  <li>stalker: Fix handling of Thumb IT AL.</li>
  <li>stalker: Handle excluded Linux calls through PLT on x86.</li>
  <li>stalker: Fix Linux exception handling on x86.</li>
  <li>java: Add Java.backtrace(), without any API stability guarantees for now.</li>
</ul>

<h3 id="changes-in-15114">Changes in 15.1.14</h3>

<ul>
  <li>backtracer: Improve fuzzy backtracers to also include the immediate caller,
and avoid walking past stack end when known.</li>
  <li>windows: Implement Thread.try_get_ranges().</li>
  <li>linux: Implement Thread.try_get_ranges().</li>
  <li>ios: Check in with launchd on SRD systems.</li>
  <li>stalker: Fix accidental clobbery in call depth code on x86.</li>
  <li>node: Publish Node.js prebuilds for v17, too.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2021/07/18/frida-15-0-released/index.html">
      Frida 15.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      18 Jul 2021
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>So much has changed. Let’s kick things off with the big new feature that guided
most of the other changes in this release:</p>

<h2 id="portals">Portals</h2>

<h3 id="part-i-conception">Part I: Conception</h3>

<p>Earlier this year <a href="https://twitter.com/insitusec">@insitusec</a> and I were brainstorming ways we could simplify
distributed instrumentation use-cases. Essentially ship a Frida Gadget that’s
“hollow”, where application-specific instrumentation is provided by a backend.</p>

<p>One way one could implement this is by using the Socket.connect() JavaScript
API, and then define an application-specific signaling protocol over which the
code is loaded, before handing it off to the JavaScript runtime.</p>

<p>But this way of doing things does quickly end up with quite a bit of boring glue
code, and existing tools such as frida-trace won’t actually be usable in such a
setup.</p>

<p>That’s when @insitusec suggested that perhaps Frida’s Gadget could offer an
inverse counterpart to its <a href="../../docs/gadget/index.html#listen">Listen</a> interaction. So instead of it being a
server that exposes a frida-server compatible interface, it could be configured
to act as a client that connects to a Portal.</p>

<p>Such a Portal then aggregates all of the connected gadgets, and also exposes a
frida-server compatible interface where all of them appear as processes. To the
outside it appears as if they’re processes on the same machine as where the
Portal is running: they all have unique process IDs if you use
enumerate_processes() or frida-ps, and one can attach() to them seamlessly.</p>

<p>In this way, existing Frida tools work exactly the same way – and by enabling
spawn-gating on the Portal, any Gadget connecting could be instructed to wait
for somebody to resume() it after applying the desired instrumentation. This
is the same way spawn-gating works in other situations.</p>

<h3 id="part-ii-implementation">Part II: Implementation</h3>

<p>Implementing this was a lot of fun, and it wasn’t long until the first PoC was
up and running. It took some time before all the details were clear, though, but
this eventually <a href="https://github.com/frida/frida-core/blob/0120cf59bc6f623bb842c93bc8870ce2a704453c/src/portal-service.vala">crystallized</a> into the following:</p>

<p>The Portal should expose two different interfaces:</p>

<ol>
  <li>The <strong><em>cluster</em></strong> interface that Gadgets can connect to, allowing them to join
the cluster.</li>
  <li>Optionally also a <strong><em>control</em></strong> interface that controllers can talk to. E.g.
<code class="language-plaintext highlighter-rouge">frida-trace -H my.portal.com -n Twitter -i open</code></li>
</ol>

<p>To a user this would be pretty simple: just grab the frida-portal binary from
our <a href="https://github.com/frida/frida/releases">releases</a>, and run it on some machine that the Gadget is able to
<a href="../../docs/gadget/index.html#connect">reach</a>. Then point tools at that – as if it was a regular frida-server.</p>

<p>That is however only one part of the story – how it would be used for simple
use-cases. The frida-portal CLI program is actually nothing more than a thin CLI
wrapper around the underlying <em>PortalService</em>. This CLI program is just a bit
north of <a href="https://github.com/frida/frida-core/blob/0120cf59bc6f623bb842c93bc8870ce2a704453c/portal/portal.vala">200 lines of code</a>, of which very little is actual logic.</p>

<p>One can also use our frida-core language bindings, for e.g. Python or Node.js,
to instantiate the PortalService. This allows configuring it to not provide
any control interface, and instead access its <strong><em>device</em></strong> property. This is a
standard Frida Device object, on which one can enumerate_processes(), attach(),
etc. Or one can do both at the same time.</p>

<p>Using the API also offers other features, but we will get back to those.</p>

<h3 id="part-iii-tls">Part III: TLS</h3>

<p>Given how useful it might be to run a frida-portal on the public Internet, it
was also clear that we should support TLS. As we already had <a href="https://gitlab.gnome.org/GNOME/glib-networking">glib-networking</a>
among our dependencies for other features, this made it really cheap to add,
footprint-wise.</p>

<p>And implementation-wise it’s a tiny bit of logic on the <a href="https://github.com/frida/frida-core/blob/0120cf59bc6f623bb842c93bc8870ce2a704453c/src/socket/socket-host-session.vala#L117-L133">client</a> side, and
similarly straight-forward for the server side of the story.</p>

<p>For the CLI tools it’s only a matter of passing <code class="language-plaintext highlighter-rouge">--certificate=/path/to/pem</code>.
If it’s a server it expects a PEM-encoded file with a public + private key,
where it will accept any certificate from incoming clients. For a client it’s
also expecting a PEM-encoded file, but only with the public key of a trusted CA,
which the server’s certificate must match or be derived from.</p>

<p>At the API level it boils down to this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">frida</span>

<span class="n">manager</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">get_device_manager</span><span class="p">()</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="n">add_remote_device</span><span class="p">(</span><span class="s">"my.portal.com"</span><span class="p">,</span>
                                   <span class="n">certificate</span><span class="o">=</span><span class="s">"/path/to/pem/or/inline/pem-data"</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="s">"Twitter"</span><span class="p">)</span>
<span class="err">…</span></code></pre></figure>

<h3 id="part-iv-authentication">Part IV: Authentication</h3>

<p>The next fairly obvious feature that goes hand in hand with running a
frida-portal on the public Internet, is authentication. In this case our server
CLI programs now support <code class="language-plaintext highlighter-rouge">--token=secret</code>, and so do our CLI tools.</p>

<p>At the API level it’s also pretty simple:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">frida</span>

<span class="n">manager</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">get_device_manager</span><span class="p">()</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="n">add_remote_device</span><span class="p">(</span><span class="s">"my.portal.com"</span><span class="p">,</span>
                                   <span class="n">token</span><span class="o">=</span><span class="s">"secret"</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="s">"Twitter"</span><span class="p">)</span>
<span class="err">…</span></code></pre></figure>

<p>But this gets a lot more interesting if you instantiate the PortalService
through the API, as it makes it easy to plug in your own custom authentication
backend:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">frida</span>

<span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="c1"># Where `token` might be an OAuth access token
</span>    <span class="c1"># that is used to grab user details from e.g.
</span>    <span class="c1"># GitHub, Twitter, etc.
</span>    <span class="n">user</span> <span class="o">=</span> <span class="err">…</span>

    <span class="c1"># Attach some application-specific state to the connection.
</span>    <span class="k">return</span> <span class="p">{</span>
        <span class="s">'name'</span><span class="p">:</span> <span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">}</span>

<span class="n">cluster_params</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">EndpointParameters</span><span class="p">(</span><span class="n">authentication</span><span class="o">=</span><span class="p">(</span><span class="s">'token'</span><span class="p">,</span> <span class="s">"wow-such-secret"</span><span class="p">))</span>
<span class="n">control_params</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">EndpointParameters</span><span class="p">(</span><span class="n">authentication</span><span class="o">=</span><span class="p">(</span><span class="s">'callback'</span><span class="p">,</span> <span class="n">authenticate</span><span class="p">))</span>
<span class="n">service</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">PortalService</span><span class="p">(</span><span class="n">cluster_params</span><span class="p">,</span> <span class="n">control_params</span><span class="p">)</span></code></pre></figure>

<p>The EndpointParameters constructor also supports other options such as
<code class="language-plaintext highlighter-rouge">address</code>, <code class="language-plaintext highlighter-rouge">port</code>, <code class="language-plaintext highlighter-rouge">certificate</code>, etc.</p>

<h3 id="part-v-offline-mode">Part V: Offline Mode</h3>

<p>That leads us to our next challenge, which is how to deal with transient
connectivity issues. I did make sure to implement automatic reconnect logic in
<a href="https://github.com/frida/frida-core/blob/0120cf59bc6f623bb842c93bc8870ce2a704453c/lib/payload/portal-client.vala">PortalClient</a>, which is what Gadget uses to connect to the PortalService.</p>

<p>But even if the Gadget reconnects to the Portal, what should happen to loaded
scripts in the meantime? And what if the controller gets disconnected from the
Portal?</p>

<p>We now have a solution that handles both situations. But it’s opt-in, so the old
behavior is still the default.</p>

<p>Here’s how it’s done:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">session</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="s">"Twitter"</span><span class="p">,</span>
                        <span class="n">persist_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span></code></pre></figure>

<p>Now, once some connectivity glitch occurs, scripts will stay loaded on the
remote end, but any messages emitted will get queued. In the example above, the
client has 30 seconds to reconnect before scripts get unloaded and data is lost.</p>

<p>The controller would then subscribe to the <code class="language-plaintext highlighter-rouge">Session.detached</code> signal to be able
to handle this situation:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">on_detached</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">crash</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">reason</span> <span class="o">==</span> <span class="s">'connection-terminated'</span><span class="p">:</span>
        <span class="c1"># Oops. Better call session.resume()
</span>
<span class="n">session</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">'detached'</span><span class="p">,</span> <span class="n">on_detached</span><span class="p">)</span></code></pre></figure>

<p>Once <code class="language-plaintext highlighter-rouge">session.resume()</code> succeeds, any buffered messages will be delivered and
life is good again.</p>

<p>The above example does gloss over a few details such as our current Python
bindings’ finicky threading constraints, but have a look at the full example
<a href="https://github.com/frida/frida-python/blob/bbdcdfaca821276361399775bd81599710ec0625/examples/session_persist_timeout.py">here</a>. (This will become a lot simpler once we port our Python bindings off
our synchronous APIs and onto async/await.)</p>

<h3 id="part-vi-latency-and-bottlenecks">Part VI: Latency and Bottlenecks</h3>

<p>Alright, so next up we’ve got a Portal running in a data center in the US, but
the Gadget is at my friend’s place in Spain, and I’m trying to control it from
Norway using frida-trace. It would be a shame if the script messages coming from
Spain would have to cross the Atlantic twice, not just because of the latency,
but also the AWS bill I’ll have to pay next month. Because I’m dumping memory
right now, and that’s quite a bit of traffic right there.</p>

<p>This one’s a bit harder, but thanks to <a href="https://libnice.freedesktop.org/">libnice</a>, a lightweight and mature ICE
implementation built on <a href="https://gitlab.gnome.org/GNOME/glib">GLib</a>, we can go ahead and use that. Given that GLib
is already part of our stack – as it’s our standard library for C programming
(and our Vala code compiles to C code that depends on GLib) – it’s a perfect
fit. And this is very good news footprint-wise.</p>

<p>As a user it’s only a matter of passing <code class="language-plaintext highlighter-rouge">--p2p</code> along with a STUN server:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>frida-trace <span class="se">\</span>
    <span class="nt">-H</span> my.portal.com <span class="se">\</span>
    <span class="nt">--p2p</span> <span class="se">\</span>
    <span class="nt">--stun-server</span><span class="o">=</span>my.stunserver.com <span class="se">\</span>
    <span class="nt">-n</span> Twitter <span class="se">\</span>
    <span class="nt">-i</span> open</code></pre></figure>

<p>(TURN relays are also supported.)</p>

<p>The API side of the story looks like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">session</span><span class="p">.</span><span class="n">setup_peer_connection</span><span class="p">(</span><span class="n">stun_server</span><span class="o">=</span><span class="s">"my.stunserver.com"</span><span class="p">)</span></code></pre></figure>

<p>That’s all there is to it!</p>

<h3 id="part-vii-are-only-gadgets-invited-to-the-party">Part VII: Are Only Gadgets Invited To The Party?</h3>

<p>You may have noticed that our Gadget has been a recurring theme so far. I’m not
very excited about adding features that only apply to one <a href="../../docs/modes/index.html">mode</a>, such as
only Injected mode but not Embedded mode. So this was something that came to
mind quite early on, that Portals had to be a universally available feature.</p>

<p>So say my buddy is reversing a target on his iPhone from his living room in
Italy, and I’d like to join in on the fun, he can go ahead and run:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>frida-join <span class="nt">-U</span> ReversingTarget my.portal.com cert.pem secret</code></pre></figure>

<p>Now I can jump in with the Frida REPL:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>frida <span class="se">\</span>
    <span class="nt">-H</span> my.portal.com <span class="se">\</span>
    <span class="nt">--certificate</span><span class="o">=</span>cert.pem <span class="se">\</span>
    <span class="nt">--token</span><span class="o">=</span>secret <span class="se">\</span>
    <span class="nt">--p2p</span> <span class="se">\</span>
    <span class="nt">--stun-server</span><span class="o">=</span>my.stunserver.com <span class="se">\</span>
    <span class="nt">-n</span> ReversingTarget</code></pre></figure>

<p>And if my buddy would like to use the API to join the Portal, he can:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">session</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">get_usb_device</span><span class="p">().</span><span class="n">attach</span><span class="p">(</span><span class="s">"ReversingTarget"</span><span class="p">)</span>
<span class="n">membership</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">join_portal</span><span class="p">(</span><span class="s">"my.portal.com"</span><span class="p">,</span>
                                 <span class="n">certificate</span><span class="o">=</span><span class="s">"/path/to/cert.pem"</span><span class="p">,</span>
                                 <span class="n">token</span><span class="o">=</span><span class="s">"secret"</span><span class="p">)</span></code></pre></figure>

<h3 id="part-viii-the-web">Part VIII: The Web</h3>

<p>Something I’ve been wanting to build since before Frida was born, is an online
collaborative reversing app. Back in the very beginning of Frida, I built a
desktop GUI that had integrated chat, console, etc. My not-so-ample spare-time
was a challenge, however, so I eventually got rid of the GUI code and decided to
focus on the API instead.</p>

<p>Now we’re in 2021, and single-page apps (SPAs) can be a really appealing option
in many cases. I’ve also noticed that there’s been quite a few SPAs built on top
of Frida, and that’s super-exciting! But what I’ve noticed when toying with SPAs
on my own, is that it’s quite tedious to have to write the middleware.</p>

<p>Well, with Frida 15 I had to make some protocol changes to accomodate the
features that I’ve covered so far, so it also seemed like the right time to
really break the protocol and go ahead with a major-bump. This is something
I’ve been trying to avoid for a long time, as I know how painful they are to
everyone, myself included.</p>

<p>So now browsers can finally join in on the fun, without any middleware needed:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="k">async</span> <span class="kd">function</span> <span class="nx">start</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="nx">wrapEventStream</span><span class="p">(</span><span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s2">`ws://</span><span class="p">${</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span><span class="p">}</span><span class="s2">/ws`</span><span class="p">));</span>
  <span class="kd">const</span> <span class="nx">bus</span> <span class="o">=</span> <span class="nx">dbus</span><span class="p">.</span><span class="nx">peerBus</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">authMethods</span><span class="p">:</span> <span class="p">[],</span>
  <span class="p">});</span>

  <span class="kd">const</span> <span class="nx">hostSessionObj</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bus</span><span class="p">.</span><span class="nx">getProxyObject</span><span class="p">(</span><span class="dl">'</span><span class="s1">re.frida.HostSession15</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">/re/frida/HostSession</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">hostSession</span> <span class="o">=</span> <span class="nx">hostSessionObj</span><span class="p">.</span><span class="nx">getInterface</span><span class="p">(</span><span class="dl">'</span><span class="s1">re.frida.HostSession15</span><span class="dl">'</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">processes</span><span class="p">:</span> <span class="nx">HostProcessInfo</span><span class="p">[]</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">hostSession</span><span class="p">.</span><span class="nx">enumerateProcesses</span><span class="p">({});</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Got processes:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">processes</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">processes</span><span class="p">.</span><span class="nx">find</span><span class="p">(([,</span> <span class="nx">name</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="nx">name</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">hello2</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Target process not found</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">pid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Got PID:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">pid</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">sessionId</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">hostSession</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">pid</span><span class="p">,</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">persist-timeout</span><span class="dl">'</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Variant</span><span class="p">(</span><span class="dl">'</span><span class="s1">u</span><span class="dl">'</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
  <span class="p">});</span>
  <span class="err">…</span>
<span class="p">}</span></code></pre></figure>

<p>(Full example can be found in <a href="https://github.com/frida/frida-python/blob/bbdcdfaca821276361399775bd81599710ec0625/examples/web_client/src/store/plugins/frida.ts">examples/web_client</a>.)</p>

<p>This means that Frida’s network protocol is now WebSocket-based, so browsers can
finally talk directly to a running Portal/frida-server, without any middleware
or gateways in between.</p>

<p>I didn’t want this to be a half-baked story though, so I made sure that the
<a href="https://github.com/frida/frida-core/blob/0120cf59bc6f623bb842c93bc8870ce2a704453c/lib/base/p2p.vala">peer-to-peer implementation</a> is built on WebRTC data channels – this way
even browsers can communicate with minimal latency and help keep the AWS bill
low.</p>

<h3 id="part-ix-assets">Part IX: Assets</h3>

<p>Once we’ve built a web app to go with our Portal, which is speaking WebSocket
natively, and thus also HTTP, we can also make it super-easy to serve that SPA
from the same server:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>./frida-portal <span class="nt">--asset-root</span><span class="o">=</span>/path/to/web/app</code></pre></figure>

<p>This is also easy at the API level:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">control_params</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">EndpointParameters</span><span class="p">(</span><span class="n">asset_root</span><span class="o">=</span><span class="s">"/path/to/web/app"</span><span class="p">)</span>
<span class="n">service</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">PortalService</span><span class="p">(</span><span class="n">cluster_params</span><span class="p">,</span> <span class="n">control_params</span><span class="p">)</span></code></pre></figure>

<h3 id="part-x-collaboration">Part X: Collaboration</h3>

<p>A natural next step once we have a controller, say a web app, is that we might
want collaboration features where multiple running instances of that SPA are
able to communicate with each other.</p>

<p>Given that we already have a TCP connection between the controller and the
PortalService, it’s practically free to also let the developer use that channel.
For many use-cases, needing an additional signaling channel brings a lot of
complexity that could be avoided.</p>

<p>This is where the new <code class="language-plaintext highlighter-rouge">Bus</code> API comes into play:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">frida</span>

<span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># TODO: Handle incoming message.
</span>    <span class="k">pass</span>

<span class="n">manager</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">get_device_manager</span><span class="p">()</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="n">add_remote_device</span><span class="p">(</span><span class="s">"my.portal.com"</span><span class="p">)</span>
<span class="n">bus</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">bus</span>

<span class="n">bus</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">'message'</span><span class="p">,</span> <span class="n">on_message</span><span class="p">)</span>
<span class="n">bus</span><span class="p">.</span><span class="n">attach</span><span class="p">()</span>

<span class="n">bus</span><span class="p">.</span><span class="n">post</span><span class="p">({</span>
    <span class="s">'type'</span><span class="p">:</span> <span class="s">'rename'</span><span class="p">,</span>
    <span class="s">'address'</span><span class="p">:</span> <span class="s">"0x1234"</span><span class="p">,</span>
    <span class="s">'name'</span><span class="p">:</span> <span class="s">"EncryptPacket"</span>
<span class="p">})</span>
<span class="n">bus</span><span class="p">.</span><span class="n">post</span><span class="p">({</span>
    <span class="s">'type'</span><span class="p">:</span> <span class="s">'chat'</span><span class="p">,</span>
    <span class="s">'text'</span><span class="p">:</span> <span class="s">"Hey, check out EncryptPacket everybody"</span>
<span class="p">})</span></code></pre></figure>

<p>Here we’re first attaching a message handler so we can receive messages from the
Portal.</p>

<p>Then we’re calling <code class="language-plaintext highlighter-rouge">attach()</code> so that the Portal knows we’re interested
in communicating with it. (We wouldn’t want it sending messages to controllers
that don’t make use of the Bus, such as frida-trace.)</p>

<p>Finally, we <code class="language-plaintext highlighter-rouge">post()</code> two different message types. It is up to the PortalService
to decide what to do with them.</p>

<p>So this means that the remote PortalService needs to be instantiated through the
API, as incoming messages need to be handled – the Portal won’t forward them to
other controllers on its own.</p>

<p>Worry not, though, this is easy:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">frida</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="n">connection_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># TODO: Handle incoming message.
</span>    <span class="k">pass</span>

<span class="n">cluster_params</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">EndpointParameters</span><span class="p">()</span>
<span class="n">control_params</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">EndpointParameters</span><span class="p">()</span>
<span class="n">service</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">PortalService</span><span class="p">(</span><span class="n">cluster_params</span><span class="p">,</span> <span class="n">control_params</span><span class="p">)</span>
<span class="n">service</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">'message'</span><span class="p">,</span> <span class="n">on_message</span><span class="p">)</span>
<span class="n">service</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">read</span><span class="p">()</span></code></pre></figure>

<p>In <code class="language-plaintext highlighter-rouge">on_message()</code> it should look at the <code class="language-plaintext highlighter-rouge">message</code> and decide what to do.</p>

<p>It might choose to reply to the controller that sent it the message:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">service</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">connection_id</span><span class="p">,</span> <span class="p">{</span>
    <span class="s">'type'</span><span class="p">:</span> <span class="s">'rename-rejected'</span><span class="p">,</span>
    <span class="s">'reason'</span><span class="p">:</span> <span class="s">"Not authorized"</span>
<span class="p">})</span></code></pre></figure>

<p>Another useful thing to do is sending a welcome message whenever somebody
calls attach() on their Bus object:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">on_subscribe</span><span class="p">(</span><span class="n">connection_id</span><span class="p">):</span>
    <span class="n">service</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">connection_id</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">'type'</span><span class="p">:</span> <span class="s">'welcome'</span><span class="p">,</span>
        <span class="s">'users'</span><span class="p">:</span> <span class="p">[</span><span class="n">user</span><span class="p">.</span><span class="n">nick</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">connected_users</span><span class="p">]</span>
    <span class="p">})</span>

<span class="n">service</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">'subscribe'</span><span class="p">,</span> <span class="n">on_subscribe</span><span class="p">)</span></code></pre></figure>

<p>Depending on your application, you might also need a way to broadcast a message
to all controllers who are attached to their Bus:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">service</span><span class="p">.</span><span class="n">broadcast</span><span class="p">({</span>
    <span class="s">'type'</span><span class="p">:</span> <span class="s">'announce'</span><span class="p">,</span>
    <span class="s">'text'</span><span class="p">:</span> <span class="s">"Important Service Announcement"</span>
<span class="p">})</span></code></pre></figure>

<p>You can also <code class="language-plaintext highlighter-rouge">narrowcast()</code> a message to a subset of controllers:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">service</span><span class="p">.</span><span class="n">narrowcast</span><span class="p">(</span><span class="s">"#reversing"</span><span class="p">,</span> <span class="p">{</span>
    <span class="s">'type'</span><span class="p">:</span> <span class="s">'chat'</span><span class="p">,</span>
    <span class="s">'sender'</span><span class="p">:</span> <span class="n">user</span><span class="p">.</span><span class="n">nick</span><span class="p">,</span>
    <span class="s">'text'</span><span class="p">:</span> <span class="s">"Hello everyone"</span>
<span class="p">})</span></code></pre></figure>

<p>This means any controller connection tagged with <code class="language-plaintext highlighter-rouge">#reversing</code> will receive that
message. Tagging is done like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">service</span><span class="p">.</span><span class="n">tag</span><span class="p">(</span><span class="n">connection_id</span><span class="p">,</span> <span class="s">"#reversing"</span><span class="p">)</span></code></pre></figure>

<p>Such tags could then be added based on actions, like a controller sending a
“join” message to join a channel. They could also be applied based on
authentication, so that only connections belonging to a certain GitHub
organization receive that message – just as an example.</p>

<p>Lastly, on the cluster side, it is also possible to specify an Access Control
List (ACL) when joining the Portal. The ACL is an array of strings that specify
tags which will grant controllers access to discover and interact with the given
process. This means that <code class="language-plaintext highlighter-rouge">service.tag()</code> needs to be used for each controller
that should be granted access to a certain node/group of nodes.</p>

<p>That is pretty much all there is to it. For a more comprehensive example, check
out <a href="https://github.com/frida/frida-python/blob/bbdcdfaca821276361399775bd81599710ec0625/examples/portal_server.py">examples/portal_server.py</a> and <a href="https://github.com/frida/frida-python/blob/bbdcdfaca821276361399775bd81599710ec0625/examples/portal_client.py">examples/portal_client.py</a>, which
implement an IRC-esque chat service.</p>

<h2 id="system-parameters">System Parameters</h2>

<p>Back in May I had a chat with <a href="https://twitter.com/Hexploitable">@Hexploitable</a>, who was working on a tool
where he needed to pick a Device object based on whether it’s running iOS vs
Android. This is a feature that’s been requested in the past, and it felt like
it might be time to finally address it.</p>

<p>While one could do device.attach(0) and load a script in the system session, in
order to run code inside Frida itself (e.g. in a remote frida-server), it is
somewhat tedious. It also doesn’t work if the Device represents a
jailed/non-rooted device, where code execution is a lot more constrained.</p>

<p>So after brainstorming this a bit, @Hexploitable started working on implementing
it, and quickly got to the point where he had the first draft working. This was
later refined by me, and got merged shortly after the Portals feature had
finally landed.</p>

<p>The API is simple, and easy to extend in the future:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>python3 <span class="nt">-c</span> <span class="s1">'import frida; import json; \
    print(json.dumps(frida.query_system_parameters()))'</span> <span class="se">\</span>
    | jq</code></pre></figure>

<p><img src="../../img/query-system-parameters-macos.png" alt="macOS Device" title="Output for a macOS Device" /></p>

<p>And if I attach a jailed iOS device, I can also query it:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>python3 <span class="nt">-c</span> <span class="s1">'import frida; import json; \
    device = frida.get_usb_device(); \
    print(json.dumps(device.query_system_parameters()))'</span> <span class="se">\</span>
    | jq</code></pre></figure>

<p><img src="../../img/query-system-parameters-ios.png" alt="iOS Device" title="Output for an iOS Device" /></p>

<p>An important detail to note here is <code class="language-plaintext highlighter-rouge">access: 'jailed'</code>. This is how you can
determine whether you’re accessing the device through our support for jailed
iOS/Android systems, i.e. limited to debuggable apps, or actually talking to
a remote frida-server – which is what <code class="language-plaintext highlighter-rouge">access: 'full'</code> means.</p>

<p>Things are not quite as juicy for Android yet (PRs welcome, btw!), but there are
still plenty of useful details:</p>

<p><img src="../../img/query-system-parameters-android.png" alt="Android Device" title="Output for an Android Device" /></p>

<p>We’re also able to identify the specific Linux distro if it’s LSB-compliant:</p>

<p><img src="../../img/query-system-parameters-ubuntu.png" alt="Ubuntu Device" title="Output for an Ubuntu Device" /></p>

<p>And last but not least, Windows:</p>

<p><img src="../../img/query-system-parameters-windows.png" alt="Windows Device" title="Output for a Windows Device" /></p>

<h2 id="application-and-process-parameters">Application and Process Parameters</h2>

<p>Another cool idea that started taking shape after some impromptu chats, was when
<a href="https://twitter.com/trufae">@pancake</a> told me it would be useful to know the particular version of an
installed iOS app.</p>

<p>As I had just broken the protocol in so many ways working on the Portals
feature, it also seemed like a great time to break it some more, and avoid
another painful major bump down the road.</p>

<p>Fast forward a bit, and here’s how it turned out: Our <code class="language-plaintext highlighter-rouge">Application</code> and
<code class="language-plaintext highlighter-rouge">Process</code> objects no longer have any <code class="language-plaintext highlighter-rouge">small_icon</code> or <code class="language-plaintext highlighter-rouge">large_icon</code> properties,
but they now have a <code class="language-plaintext highlighter-rouge">parameters</code> dict.</p>

<p>By default, with <code class="language-plaintext highlighter-rouge">enumerate_applications()</code>, things look familiar:</p>

<p><img src="../../img/enumerate-applications-ios-minimal.png" alt="enumerate_applications()" title="enumerate_applications()" /></p>

<p>But by changing that to <code class="language-plaintext highlighter-rouge">enumerate_applications(scope='metadata')</code>, things get a
lot more interesting:</p>

<p><img src="../../img/enumerate-applications-ios-metadata.png" alt="enumerate_applications(scope='metadata')" title="enumerate_applications(scope='metadata')" /></p>

<p>Here we can see the iOS Twitter app’s version and build number, where its app
bundle is on the filesystem, the containers that it owns, that it is currently
the frontmost app, how long ago it was started, etc.</p>

<p>We can also crank that up to <code class="language-plaintext highlighter-rouge">enumerate_applications(scope='full')</code> and get
icons as well:</p>

<p><img src="../../img/enumerate-applications-ios-full.png" alt="enumerate_applications(scope='full')" title="enumerate_applications(scope='full')" /></p>

<p>The <code class="language-plaintext highlighter-rouge">debuggable: true</code> parameter is very useful if query_system_parameters()
reported <code class="language-plaintext highlighter-rouge">access: 'jailed'</code>, as that means your application may want to filter
the list of apps to only show the ones it is able to spawn() and/or attach() to,
or perhaps show debuggable apps more prominently to provide a better UX.</p>

<p>It’s probably also worth mentioning that <code class="language-plaintext highlighter-rouge">get_frontmost_application()</code> now
supports passing a <code class="language-plaintext highlighter-rouge">scope</code> as well.</p>

<p>Those of you familiar with the old API may have noticed that icons may now be
delivered in compressed form, as PNGs. Previously this was always uncompressed
RGBA data, and the iOS side would do the PNG decoding and downscaling to two
fixed resolutions (16x16 and 32x32).</p>

<p>All of this meant that we would waste a lot of CPU time, memory and bandwidth to
include icons, even if all of that data would end up in a CLI tool that doesn’t
make use of it. So now with Frida 15 you might notice that application and
process listing is a lot faster. And even if you do request icons, it should
also be faster than before as we don’t do any decompression and downscaling.</p>

<p>That was application listing. All of the above is also true for process listing,
and this is what <code class="language-plaintext highlighter-rouge">enumerate_applications(scope='full')</code> might look like now:</p>

<p><img src="../../img/enumerate-processes-ios-full.png" alt="enumerate_processes(scope='full')" title="enumerate_processes(scope='full')" /></p>

<p>Here it is also clear that the Twitter app is currently frontmost, that its
parent PID is launchd (PID 1), the user it is running as, when it was started,
etc.</p>

<p>You might be wondering why <code class="language-plaintext highlighter-rouge">applications</code> is an array though, and the answer is
probably best illustrated by an example from Android:</p>

<p><img src="../../img/enumerate-processes-android-full.png" alt="enumerate_processes(scope='full')" title="enumerate_processes(scope='full')" /></p>

<p>The “com.android.phone” process actually hosts six different “applications”!</p>

<p>And once again, last but not least, I didn’t forget about Windows:</p>

<p><img src="../../img/enumerate-processes-windows-full.png" alt="enumerate_processes(scope='full')" title="enumerate_processes(scope='full')" /></p>

<p>So that’s the “scope” option. There’s also another one, meant for UIs. The idea
is that a UI might want to grab the list of applications/processes quickly, and
may not actually need metadata/icons until the user interacts with a particular
entry, or scrolls a subset of entries into view. So we now provide an option to
support such use-cases.</p>

<p>Say we only want to grab the metadata for two specific apps, we can now do:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">ids</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"com.atebits.Tweetie2"</span><span class="p">,</span>
    <span class="s">"no.sparebank1.mobilbank"</span>
<span class="p">]</span>
<span class="n">apps</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">enumerate_applications</span><span class="p">(</span><span class="n">identifiers</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
                                     <span class="n">scope</span><span class="o">=</span><span class="s">'full'</span><span class="p">)</span></code></pre></figure>

<p><img src="../../img/enumerate-selected-applications.png" alt="enumerate_applications(identifiers=x)" title="enumerate_applications(identifiers=x)" /></p>

<p>We also support the same feature for process listing, where it looks like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">processes</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">enumerate_processes</span><span class="p">(</span><span class="n">pids</span><span class="o">=</span><span class="p">[</span><span class="mi">1337</span><span class="p">,</span> <span class="mi">1338</span><span class="p">],</span>
                                       <span class="n">scope</span><span class="o">=</span><span class="s">'full'</span><span class="p">)</span></code></pre></figure>

<h2 id="portals-and-applicationprocess-parameters">Portals and Application/Process Parameters</h2>

<p>Now that we have covered application parameters <strong>and</strong> portals, there’s an
important detail that’s worth mentioning: Given that it doesn’t make much sense
to implement query_system_parameters() in the case of a PortalService, as it’s
surfacing processes from any number of (potentially remote) systems, we can use
application/process parameters to fill this void.</p>

<p>This means that any Application and Process coming from a PortalService will,
if <code class="language-plaintext highlighter-rouge">scope</code> is set to <code class="language-plaintext highlighter-rouge">metadata</code> or <code class="language-plaintext highlighter-rouge">full</code>, provide one parameter named <code class="language-plaintext highlighter-rouge">system</code>,
which contains the system parameters for that particular application/process.
This way an application can still know ahead of time if it’s interested in a
particular process.</p>

<h2 id="jailed-ios-and-android-improvements">Jailed iOS and Android Improvements</h2>

<p>I had a lot of fun implementing the Application and Process parameters feature,
and tried to see how narrow I could make the gap between jailed (non-rooted) and
jailbroken (rooted). For example on Android, we didn’t even fetch app labels in
the non-rooted code-path. This was because we were relying on running shell
commands over ADB, and I couldn’t find a way to grab labels in that case.</p>

<p>The shell command route is very fragile, as most tools output details in a
format that’s meant to be consumed by a human, not a machine. And obviously
such output is likely to change as Android evolves.</p>

<p>Because of this we now have a tiny prebuilt .dex that we copy over and run, and
grabbing metadata is only a matter of making RPC calls to that helper process.
This means we are able to provide all the same details for non-rooted as we
provide in the rooted case, where we have a frida-server running on the Android
side.</p>

<p>Another thing worth mentioning is that we no longer consider Android’s launcher
a frontmost app, which means this is now consistent with our behavior on iOS,
where SpringBoard is never considered the frontmost app.</p>

<p>As part of these major changes I also added code to fetch icons on Android as
well, both non-rooted and rooted, so that this feature is no longer just limited
to iOS, macOS, and Windows.</p>

<p>We didn’t provide icons for jailed iOS though, but that feature gap is now also
closed. There is however still one difference between jailed and jailbroken iOS:
the <code class="language-plaintext highlighter-rouge">ppid</code> and <code class="language-plaintext highlighter-rouge">user</code> parameters are not available in the jailed case, as this
is not exposed by any lockdown/DTX API that I’m currently aware of. But other
than that, things are in pretty good shape.</p>

<h2 id="massively-improved-backtraces-on-imacos">Massively improved backtraces on i/macOS</h2>

<p>Thanks to a very exciting pull-request by <a href="https://github.com/hot3eed">@hot3eed</a>, we now have an i/macOS
symbolication fallback that uses the Objective-C runtime. In this way, instead
of showing <code class="language-plaintext highlighter-rouge">module!0x1234</code>, we may be able to resolve that to an Objective-C
method. Yay!</p>

<p>We also got another awesome contribution by <a href="https://twitter.com/bezjaje">@mrmacete</a>, where NativeCallback
now always exposes a context, so you can do <code class="language-plaintext highlighter-rouge">Thread.backtrace(this.context)</code> and
expect it to work in all cases.</p>

<p>This was previously only possible when NativeCallback was used as an Interceptor
replacement. So if you were using ObjC.implement() to swizzle an Objective-C
API, you couldn’t actually capture a backtrace from that NativeCallback. So this
is a super-exciting improvement!</p>

<h2 id="unextracted-native-libraries-on-android">Unextracted Native Libraries on Android</h2>

<p>For those of you using Frida on Android, you may have encountered apps where
native libraries don’t reside on the filesystem, but are loaded directly from
the app’s .apk. Thanks to a great contribution by <a href="https://github.com/P-Sc">@P-Sc</a>, we now support this
transparently – no changes needed in your existing instrumentation code.</p>

<h2 id="upgraded-os-support">Upgraded OS Support</h2>

<p>We now also support the latest betas of macOS Monterey, iOS 15, and Android 12.
Special thanks to <a href="https://github.com/alexhude">@alexhude</a> at <a href="https://corellium.com/">Corellium</a> for helping debug and test
things on iOS 15, and <a href="https://github.com/pengzhangdev">@pengzhangdev</a> who contributed a fix for
frida-java-bridge to support Android 12.</p>

<h2 id="networked-ios-devices">Networked iOS Devices</h2>

<p>Another feature that’s been requested a few times is support for networked iOS
devices. This is great if you don’t want to destroy your iPhone/iPad’s battery
by leaving it plugged in all day. What’s great about this feature is that it
“just works” – you should see them if you run <code class="language-plaintext highlighter-rouge">frida-ls-devices</code>.</p>

<p>Only two pitfalls worth mentioning: You may now have two different Device
objects with the same ID, in case a networked iOS device is reachable through
the network while also being plugged in.</p>

<p>E.g.:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>frida-ls-devices
Id                         Type    Name
<span class="nt">-------------------------</span>  <span class="nt">------</span>  <span class="nt">-------------------------------------</span>
<span class="nb">local                      local   </span>Local System
00008027-xxxxxxxxxxxxxxxx  usb     iPad
socket                     remote  Local Socket
00008027-xxxxxxxxxxxxxxxx  remote  iOS Device <span class="o">[</span>fe80::146f:75af:d79:630c]</code></pre></figure>

<p>So if you’re using <code class="language-plaintext highlighter-rouge">-U</code> or <code class="language-plaintext highlighter-rouge">frida.get_usb_device()</code> things will work just like
before, where you’ll be using your device through USB. But if you want to use
the networked device, then resolving it by ID means the USB entry will take
precedence, as it’s typically ahead of the networked device in the list of
devices.</p>

<p>This means you would also need to check its <code class="language-plaintext highlighter-rouge">type</code>. Our CLI tools don’t
yet provide a switch to do this, but this would be a welcome pull-request if
anyone’s interested!</p>

<p>The second pitfall is that frida-server only listens on the loopback interface
by default, meaning we won’t be able to connect to it over the network. So if
you’re using our iOS .deb either manually or through Cydia, you will have to
edit <code class="language-plaintext highlighter-rouge">/Library/LaunchDaemons/re.frida.server.plist</code> to add the <code class="language-plaintext highlighter-rouge">--listen</code>
switch, and then use <code class="language-plaintext highlighter-rouge">launchctl</code> to restart it.</p>

<p>This may also be a situation where you want to make use of the new TLS and
authentication features mentioned earlier, depending on how much you trust your
network environment.</p>

<h2 id="eof">EOF</h2>

<p>There’s also a bunch of other exciting changes, so definitely check out the
changelog below.</p>

<p>Enjoy!</p>

<h3 id="changes-in-1500">Changes in 15.0.0</h3>

<ul>
  <li>Introduce PortalService API and daemon, a network service that
orchestrates a cluster of remote processes instrumented by Frida.
Implements both a frida-server compatible control interface, as well
as a cluster interface that agents and gadgets in target processes can
talk to. Connected controllers can enumerate processes as if they were
local to the system where the portal is running, and are able to
attach() and also enable spawn-gating to apply early instrumentation.</li>
  <li>Add Session.join_portal(), making it easy to share control of a
process with a remote PortalService, joining its cluster together with
other nodes.</li>
  <li>Add “connect” interaction to frida-gadget, so it can join a
PortalService cluster as well.</li>
  <li>Add PortalClient, used to implement Session.join_portal() and
frida-gadget’s “connect” interaction. Connects to the PortalService
and joins its cluster. Implements automatic reconnect in case of
transient failures. Also supports specifying an ACL, which is a list
of tags that the PortalService must require connected controllers to
possess at least one of. It’s up to the application to implement
tagging of controllers based on e.g. authentication.</li>
  <li>Add Device.bus API to allow clients connected to a PortalService to
exchange application-specific messages with it. Requires instantiating
the service using the API in order to wire up message handlers and
protocol logic.</li>
  <li>Add Session persistence support, enabled by specifying a non-zero
“persist_timeout” option when attach()ing to a process. When the
server subsequently detects that the client owning the session got
disconnected, it will allow scripts to stay loaded until the timeout
(in seconds) is reached. Any script and debugger messages emitted in
the meantime are queued, and may later be delivered if the client
returns before the timeout is reached.</li>
  <li>Add TLS support, enabled by specifying a certificate. On the server
end this is a PEM with a public and private key, where the server
will accept any certificate from the client’s side. However for the
client this is a PEM with the public key of a trusted CA, which the
server’s certificate must match or be derived from.</li>
  <li>Add authentication support, enabled by specifying a token. The daemons
allow specifying a static token through a CLI option, and the APIs
allow plugging in a custom authentication backend – which means the
token can be interpreted as desired.</li>
  <li>Move network protocols to WebSocket.</li>
  <li>Add protocol-level keepalives.</li>
  <li>Implement WebRTC Data Channel compatible peer-to-peer support, enabled
by calling setup_peer_connection() on Session. This allows a direct
connection to be established between the client and the remote
process, which is useful when talking to it through e.g. a Portal.</li>
  <li>Optimize protocol by skipping the DBus authentication handshake and
telling GDBus not to fetch properties, saving an additional roundtrip.</li>
  <li>Drop deprecated protocol bits, such as Session.enable_jit().</li>
  <li>Add Device.query_system_parameters(). Thanks <a href="https://twitter.com/Hexploitable">@Hexploitable</a>!</li>
  <li>Improve the application and process query APIs. (Covered extensively above.)</li>
  <li>Switch Crash parameter names to kebab-case.</li>
  <li>Add Session.is_detached(), useful in multi-threaded scenarios where the
“detached” signal may already have been emitted by the time we manage to
connect to it.</li>
  <li>Fix Stalker handling of SYSCALL instructions on Linux/x86.</li>
  <li>Fix the iPad device name on macOS.</li>
  <li>Massively improve backtraces/symbolication on i/macOS in cases where symbols
are missing, but the address to be symbolicated belongs to an Objective-C
method. Thanks <a href="https://github.com/hot3eed">@hot3eed</a>!</li>
  <li>Improve backtracer accuracy and flexibility, now exposing a minimal context to
NativeCallback in cases where it’s not used as an Interceptor replacement. One
such example is ObjC.implement(), used for swizzling APIs. Thanks
<a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Improve Interceptor reliability on macOS/arm64, by switching to the mapping
strategy that we use on iOS.</li>
  <li>Add support for network-connected iOS devices.</li>
  <li>Avoid leaving behind a file when sandbox check fails on iOS.</li>
  <li>Fix Stalker on newer iOS hardware jailbroken with checkra1n. This was solved
by disabling RWX support on iOS for now: Even if the jailbreak appears to make
it available, whether it actually works boils down to which mitigations the
hardware supports. Shout-out to <a href="https://twitter.com/ghidraninja">@stacksmashing</a> for reporting and helping
get to the bottom of this one!</li>
  <li>Remove bashisms from iOS maintainer scripts, for improved jailbreak
compatibility. Thanks <a href="https://github.com/nyuszika7h">@nyuszika7h</a>!</li>
  <li>Improve Interceptor frame layout on arm64, so backtracing code is able to walk
the stack past our generated code. This also makes it easier to use a debugger
together with Interceptor.</li>
  <li>Fix ObjC ApiResolver deadlock, which occurred when free() was resolved lazily
from a dyld image callback, at which point it is a bad idea to call dlsym().</li>
  <li>Add support for unextracted native libraries on Android. Thanks <a href="https://github.com/P-Sc">@P-Sc</a>!</li>
  <li>Fix Android get_frontmost_application() name truncation.</li>
  <li>Don’t consider the Android launcher a frontmost app.</li>
  <li>Use the Android app’s label as the process name if the process represents is
its main UI process. This is finally consistent with what we do on iOS.</li>
  <li>Improve jailed Android injector: Now using a long-lived shell session to speed
things up. Also ensure filenames dropped into /data/local/tmp are unique, and
clean up temporary files.</li>
  <li>Drop Firefox OS support.</li>
  <li>Rename the weak ref API to avoid clashing with ES2021. So instead of
WeakRef.bind() and WeakRef.unbind(), these are now Script.bindWeak() and
Script.unbindWeak().</li>
  <li>Massively improve memory allocation performance on Windows, by lowering the
dlmalloc spin-lock sleep duration to zero – which means it will only yield
the remainder of its time slice. The default of 50 ms is prone to introduce
significant delay as soon as threads start competing for the lock.</li>
  <li>Lazily create the ScriptScheduler thread pool. This means anyone using GumJS
can avoid background threads until they’re really needed. Very useful if
you’re writing a tool or agent that needs to handle fork(), without having to
implement logic to stop and later restart threads. (Something frida-agent
does, but which isn’t necessarily needed for simple use-cases.)</li>
  <li>Java: Add support for Android 12 beta. Thanks <a href="https://github.com/pengzhangdev">@pengzhangdev</a>!</li>
  <li>Java: Fix Java.array() for unloaded array types: If the type of the array was
not used in the application it means that it wasn’t loaded into memory, and
Java.array() previously failed because of this. Thanks <a href="https://github.com/yotamN">@yotamN</a>!</li>
  <li>Java: Add toString() to primitive arrays, so that instead of the generic
“[Object Object]” string it will generate a string where the array values are
separated by commas. Thanks <a href="https://github.com/yotamN">@yotamN</a>!</li>
  <li>CModule: Add missing TinyCC builtins for 32-bit x86.</li>
  <li>python: Add Script.is_destroyed property.</li>
  <li>python: Add Session.is_detached property.</li>
  <li>python: Add Device.is_lost property.</li>
  <li>python: Throw when attempting an RPC call on a destroyed script.</li>
  <li>node: Fix compatibility with newer versions of Node.js, where any given
Buffer’s backing store needs to be unique. We solve this by simply making a
copy in cases where we cannot guarantee that the same buffer can only be
observed once.</li>
  <li>node: Fix use-after-free in signal transform callbacks.</li>
  <li>node: Fix use-after-free in signal connection callbacks.</li>
  <li>node: Move to C++17, for compatibility with newer Node.js headers.</li>
  <li>node: Add Script.isDestroyed property.</li>
  <li>node: Add Device.isLost property.</li>
</ul>

<h3 id="changes-in-1501">Changes in 15.0.1</h3>

<ul>
  <li>Ensure DarwinGrafter’s merging of binds doesn’t make gaps in __LINKEDIT.
Not doing so triggers a bug in <code class="language-plaintext highlighter-rouge">codesign</code> for which the resulting signed
binary turns out corrupted. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>node: Fix compilation error when building with MSVC.</li>
</ul>

<h3 id="changes-in-1502">Changes in 15.0.2</h3>

<ul>
  <li>Fix handling of large messages, for both client-server and p2p. Also bump the
WebSocket payload size limit to 256 KiB - same as is typically negotiated for
data channels in p2p mode.</li>
  <li>Move WebSocket I/O to the DBus thread, to avoid unnecessary thread hopping.</li>
  <li>Plug leaks when using p2p.</li>
</ul>

<h3 id="changes-in-1503">Changes in 15.0.3</h3>

<ul>
  <li>Implement a new frida-pipe strategy for i/macOS. Turns out that our previous
strategy of directly setting up a Mach port in the target process becomes
problematic with guarded Mach ports. So instead we register a Mach service
that’s globally visible, and have the target process contact it to fetch its
end of the socketpair. We also check with the sandbox up front, and issue an
extension token if needed. However, if we’re unable to register the Mach
service with launchd, we fall back to our previous strategy.</li>
  <li>Skip iOS platformized detection on iOS &gt;= 15. It interacts badly with guarded
Mach ports.</li>
  <li>Port early instrumentation to macOS 12 and iOS 15.</li>
  <li>Gracefully handle agent failing to start. Instead of crashing the target
process, simply log the error and unload.</li>
  <li>Linux: Use an abstract name for frida-pipe when supported.</li>
  <li>Unlink UNIX socket when frida-pipe is done with it.</li>
  <li>Fix iOS policyd Mach message lifetime logic.</li>
</ul>

<h3 id="changes-in-1504">Changes in 15.0.4</h3>

<ul>
  <li>Fix the i/macOS injector’s data size logic. It’s been hard-coded since the
beginning, and the recent entrypoint data size adjustment broke it on systems
with 4K pages.</li>
  <li>Fix i/macOS early instrumentation regression on dyld &lt; 4.</li>
</ul>

<h3 id="changes-in-1505">Changes in 15.0.5</h3>

<ul>
  <li>Fix the __CFInitialize() code-path on dyld &gt;= 4.</li>
  <li>Fix i/macOS sandbox extension logic during spawn().</li>
  <li>Port jailed iOS injector to iOS 15.</li>
  <li>Implement Android USAP interop.</li>
  <li>Improve DarwinGrafter lazy binds merge logic. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
</ul>

<h3 id="changes-in-1506">Changes in 15.0.6</h3>

<ul>
  <li>Fix Windows build regression.</li>
</ul>

<h3 id="changes-in-1507">Changes in 15.0.7</h3>

<ul>
  <li>Fix early instrumentation on Android 12.</li>
  <li>node: Fix the ApplicationParameters typings. Thanks for reporting,
<a href="https://twitter.com/trufae">@pancake</a>!</li>
</ul>

<h3 id="changes-in-1508">Changes in 15.0.8</h3>

<ul>
  <li>iOS: Add support for unc0ver v6.1.2.</li>
  <li>iOS: Update Substrate interop logic to support 0.9.7113.</li>
</ul>

<h3 id="changes-in-1509">Changes in 15.0.9</h3>

<ul>
  <li>iOS: Revive support for older OS versions. (Verified on iOS 10.3.)</li>
  <li>iOS: Fix support for older Apple usbmuxd versions.</li>
  <li>Android: Handle devices where jailed is unsupported.</li>
  <li>Fix DarwinGrafter alignment issue, aligning to 16 bytes also when lazy
binds follow regular binds. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
</ul>

<h3 id="changes-in-15010">Changes in 15.0.10</h3>

<ul>
  <li>Fix regression where Device.open_channel(“lockdown:”) ended up closing the
stream right away.</li>
  <li>Fix crash when talking to older versions of ADB.</li>
</ul>

<h3 id="changes-in-15011">Changes in 15.0.11</h3>

<ul>
  <li>Rewrite macOS spawn gating to use DTrace. This means we’ve now dropped support
for our kernel extension, and we don’t need to worry about future OSes no
longer supporting extensions. It also means we finally support spawn gating on
Apple Silicon as well.</li>
  <li>Work around i/macOS arm64 single-step delay during early instrumentation.</li>
</ul>

<h3 id="changes-in-15012">Changes in 15.0.12</h3>

<ul>
  <li>Fix macOS spawn gating task port lifetime issue. Should not try to be clever
and keep task ports around – bad things happen if a task port is used after an
exec transition.</li>
  <li>Remove the i/macOS task port caching logic. It is dangerous in exec
transitions, adds some complexity, and doesn’t help all that much
performance-wise, anyway.</li>
  <li>Make the macOS spawn gating DTrace predicate environment variable optional.</li>
  <li>Improve the macOS spawn gating error message.</li>
</ul>

<h3 id="changes-in-15013">Changes in 15.0.13</h3>

<ul>
  <li>Improve clients to specify Host header and use TLS SNI.</li>
  <li>Revert i/macOS single-step delay workarounds.</li>
  <li>iOS: Fix usbmux port number encoding in the connect request.</li>
  <li>Python, Node.js: Fix ownership in Device.spawn() aux options logic.</li>
</ul>

<h3 id="changes-in-15014">Changes in 15.0.14</h3>

<ul>
  <li>Port iOS crash reporter integration to iOS 14.7.1.</li>
  <li>Configure internal agents to be less intrusive on i/macOS.</li>
  <li>Improve i/macOS error-handling during process preparation.</li>
  <li>Revive i/macOS single-step delay workarounds, which turned out to be needed
after all.</li>
  <li>Handle reentrancy when about to yield JS lock, which may happen if a replaced
function gets called by Interceptor during end_transaction().</li>
  <li>Fix conditional Interceptor unignore logic in GumJS. This was preventing
Interceptor from ignoring internal calls, and resulted in noise and reduced
performance.</li>
  <li>Enhance the i/macOS DebugSymbol fallback name to also include the unslid
address. This makes it easy to plop it into a static analysis tool.</li>
  <li>Fix Stalker code slab refill logic.</li>
  <li>Add Stalker stats interface.</li>
</ul>

<h3 id="changes-in-15015">Changes in 15.0.15</h3>

<ul>
  <li>Rework i/macOS Exceptor to support latest iOS 14. This would previously result
in a deadlock whenever a native exception occurred.</li>
</ul>

<h3 id="changes-in-15016">Changes in 15.0.16</h3>

<ul>
  <li>Fix i/macOS single-step handling on ARM during early instrumentation, which
would result in attach() failing randomly for a freshly spawn()ed process.
Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Add Stalker backpatch prefetching support.</li>
  <li>Make Stalker inline cache size configurable on x86.</li>
  <li>Optimize Stalker x86 return handling.</li>
  <li>ObjC: Allow proxies to implement methods. Thanks <a href="https://github.com/hot3eed">@hot3eed</a>!</li>
</ul>

<h3 id="changes-in-15017">Changes in 15.0.17</h3>

<ul>
  <li>gadget: Support packaging as framework on i/macOS. Load config from
“Resources/config.json”, and resolve relative paths relative to the same
directory. As an added bonus, we now also support specifying relative paths
for “certificate” and “asset_root”.</li>
  <li>web-service: Implement basic directory listing with NGINX-style output. This
is useful with e.g. “frida-server –asset-root=/”.</li>
  <li>stalker: Fix backpatch args for 32-bit x86.</li>
</ul>

<h3 id="changes-in-15018">Changes in 15.0.18</h3>

<ul>
  <li>Plug long-standing memory leaks, both in our internal heap’s realloc behavior
being misconfigured and causing leaks, and in how we register JavaScript
classes with QuickJS. Kudos to <a href="https://twitter.com/bezjaje">@mrmacete</a> for discovering and helping track
down these long-standing bugs!</li>
</ul>

<h3 id="changes-in-15019">Changes in 15.0.19</h3>

<ul>
  <li>gadget: Fix framework resource lookup logic on iOS.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2021/02/10/frida-14-2-released/index.html">
      Frida 14.2 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      10 Feb 2021
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>So much to talk about. Let’s kick things off with a big new feature:</p>

<h2 id="realms">Realms</h2>

<p>Frida has supported Android for quite a while, but one particular feature has
kept getting requested (mostly) by users who thought they were looking at a bug.
The conversation usually started something like: “I’m using Frida inside the
hardware-accelerated Android emulator X, and when I attach to this process Y,
Process.enumerateModules() is missing JNI library Z. But I can see it in
Process.enumerateRanges() and /proc/$pid/maps. How come?”</p>

<p>As you may have guessed, we’re talking about Android’s NativeBridge, typically
used on Intel-powered Android devices to enable them to run apps that only
support ARM – i.e. apps with one or more JNI components only built for ARM.</p>

<p>In a Frida context, however, we’re usually talking about a VirtualBox-based
emulator that runs an Android system built for x86. This system then ships with
NativeBridge support powered by libhoudini, a proprietary ARM translator.</p>

<p>There’s quite a few of these emulators, e.g. BlueStacks, LDPlayer, NoxPlayer,
etc. While the ones mentioned are optimized for running games, there’s now also
Google’s official Android 11 AVDs which ship with NativeBridge support out of
the gate.</p>

<p>Through the years I’ve been thinking about how we could support such scenarios
in Frida, but thinking about it always made my head hurt a little. It did feel
like something we should support at some point, though, I just had a hard time
figuring out what the API would look like.</p>

<p>Then along came 2020 and Apple announced their transition to ARM, and suddenly
Rosetta became relevant once again. “Alright”, I thought, “now we have two
platforms where it would be useful to support processes containing an emulated
realm that’s running legacy code.”</p>

<p>And yeah there’s also Windows, but we don’t yet support Windows on ARM. We
totally should though, so if somebody’s interested in taking a stab at this
then please <em>do</em> get in touch.</p>

<p>Anyway, I’m exited to announce that our Android binaries for x86 and x86_64
now support such processes out of the box. You may already be familiar with
the following frida-core API, where the Python flavor looks like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">session</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">target</span><span class="p">)</span></code></pre></figure>

<p>(Or <em>frida.attach()</em> if your code only deals with the local system.)</p>

<p>If <em>target</em> has an emulated realm, you can now do:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">session</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">realm</span><span class="o">=</span><span class="s">'emulated'</span><span class="p">)</span></code></pre></figure>

<p>The default is <code class="language-plaintext highlighter-rouge">realm='native'</code>, and you can actually use both realms at the
same time. And when using our CLI tools, pass <code class="language-plaintext highlighter-rouge">--realm=emulated</code> to act on the
emulated realm.</p>

<p>One important caveat when using this on Android is that you will need to apply
your Java-level instrumentation in the <em>native</em> realm.</p>

<p>Lastly it’s worth noting that this new feature is only supported on Android for
now, but it shouldn’t be hard to support Rosetta on macOS down the road.
Definitely get in touch if you want to help out with this.</p>

<h2 id="taking-android-java-hooking-inline">Taking Android Java Hooking Inline</h2>

<p>The way Frida’s <a href="https://github.com/frida/frida-java-bridge">Java bridge</a> replaces Java methods on Android has up until
now been accomplished by mutating the in-memory method metadata so that the
target method becomes native – if it wasn’t already. This allows us to install
a NativeCallback that matches the given method’s JNI signature.</p>

<p>This has presented some challenges, as the ART runtime does have other internal
state that depends on the given method’s personality. We have devised a few
hacks to dance around some of these issues, but some particularly gnarly
edge-cases remained unsolved. One such example is JIT profiling data maintained
by the ART VM.</p>

<p>An idea I had been thinking about for a while was to stop mutating the method
metadata, and instead perform inline hooking of the AOT-generated machine code –
for non-native methods that is. That still leaves methods run on the VM’s
interpreter, but the assumption was that we could deal with those by hooking
VM internals.</p>

<p>I took a stab at an early prototype to explore this approach further. It seemed
like it could work, but there were still many challenges to work through. After
some brainstorming with <a href="https://github.com/muhzii">@muhzii</a>, he kept working on evolving this rough PoC
further in his spare time. Then one day I almost fell off my chair out of pure
excitement when I saw the amazing pull-request he had just opened.</p>

<p>Thanks to Muhammed’s amazing work, you can now all enjoy a much improved Java
instrumentation experience on Android. This means improved stability and also
that direct calls won’t bypass your replacement method. Yay!</p>

<h2 id="deoptimization">Deoptimization</h2>

<p>For those of you using Java.deoptimizeEverything() on Android to ensure that
your hooks aren’t skipped due to optimizations, there’s now a more granular
alternative. Thanks to <a href="https://twitter.com/alkalinesec">@alkalinesec</a>’s neat contribution to our Java bridge,
you can now use Java.deoptimizeBootImage(). It ensures only code in the boot
image OAT files gets deoptimized. This is a serious performance gain in some
situations where the app code itself is slow when deoptimized, and it is not
necessary to deoptimize it in order for hooks to be hit reliably.</p>

<h2 id="cmodule">CModule</h2>

<p>Another really exciting update here. The next hero in our story is <a href="https://github.com/mephi42">@mephi42</a>,
who started porting Frida to S390x. Our CModule implementation relies on TinyCC
behind the scenes, and it doesn’t yet support this architecture. The system
might have a C compiler though, so @mephi42 proposed that we add support for
using GCC on systems where TinyCC cannot help us out.</p>

<p>I really liked this idea. Not only from the perspective of architecture support,
but also because of the potential for much faster code – TinyCC optimizes for
small compiler footprint and fast compilation, not fast code.</p>

<p>So needless to say I got more and more excited with each pull-request towards
GCC support. Once the last one landed it inspired me to add support for using
Apple’s clang on i/macOS.</p>

<p>In the end we arrived at this:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">cm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CModule</span><span class="p">(</span><span class="s2">`…`</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span> <span class="na">toolchain</span><span class="p">:</span> <span class="dl">'</span><span class="s1">external</span><span class="dl">'</span> <span class="p">});</span></code></pre></figure>

<p>Where <code class="language-plaintext highlighter-rouge">toolchain</code> is either <code class="language-plaintext highlighter-rouge">any</code>, <code class="language-plaintext highlighter-rouge">internal</code>, or <code class="language-plaintext highlighter-rouge">external</code>. The default is
<code class="language-plaintext highlighter-rouge">any</code>, which means we will use TinyCC if it supports your <code class="language-plaintext highlighter-rouge">Process.arch</code>, and
fall back to <code class="language-plaintext highlighter-rouge">external</code> otherwise.</p>

<p>The story doesn’t end here, though. While implementing support for i/macOS,
it wasn’t really clear to me how we could fuse in symbols provided by the
JavaScript side. (The second argument to CModule’s constructor.)</p>

<p>The GCC implementation uses a linker script, which is a really elegant solution
that Apple’s linker doesn’t support. But then it hit me: we already have our own
dynamic linker that we use for our injector.</p>

<p>Once I had wired that up, it seemed really obvious that we could also trivially
support skipping Clang entirely, and allow the user to pass in a precompiled
shared library.</p>

<p>The thinking there was that it would enable cross-compilation, but also make it
possible to implement a CModule in languages such as Swift and Rust: basically
anything that can interop with C.</p>

<p>So this means we now also support the following:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">cm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CModule</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span></code></pre></figure>

<p>Where <code class="language-plaintext highlighter-rouge">blob</code> is an ArrayBuffer containing the shared library to construct it
from. For now this part is only implemented on i/macOS, but the goal is to
support this on all platforms. (Contributions welcome!)</p>

<p>Also, as of frida-tools 9.2, the REPL’s <code class="language-plaintext highlighter-rouge">-C</code> switch also supports this, making
it easy to use an external toolchain without missing out on live-reload – which
makes for a much shorter feedback loop during development.</p>

<p>Taking that one step further, the CModule API now also provides a the property
<code class="language-plaintext highlighter-rouge">CModule.builtins</code>, which scaffolding tools can use to obtain the built-in
headers and preprocessor defines.</p>

<p>And on that note we now have such a tool in frida-tools:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">mkdir </span>pewpew
<span class="nv">$ </span><span class="nb">cd </span>pewpew
<span class="nv">$ </span>frida-create cmodule
Created ./meson.build
Created ./pewpew.c
Created ./.gitignore
Created ./include/glib.h
Created ./include/gum/gumstalker.h
Created ./include/gum/gumprocess.h
Created ./include/gum/gummetalarray.h
Created ./include/gum/guminterceptor.h
Created ./include/gum/gumspinlock.h
Created ./include/gum/gummetalhash.h
Created ./include/gum/gummemory.h
Created ./include/gum/gumdefs.h
Created ./include/gum/gummodulemap.h
Created ./include/json-glib/json-glib.h
Created ./include/gum/arch-x86/gumx86writer.h
Created ./include/capstone.h
Created ./include/x86.h
Created ./include/platform.h

Run <span class="sb">`</span>meson build <span class="o">&amp;&amp;</span> ninja <span class="nt">-C</span> build<span class="sb">`</span> to build, <span class="k">then</span>:
- Inject CModule using the REPL: frida Calculator <span class="nt">-C</span> ./build/pewpew.dylib
- Edit <span class="k">*</span>.c, and build incrementally through <span class="sb">`</span>ninja <span class="nt">-C</span> build<span class="sb">`</span>
- REPL will live-reload whenever ./build/pewpew.dylib changes on disk

<span class="nv">$ </span>meson build <span class="o">&amp;&amp;</span> ninja <span class="nt">-C</span> build
…
<span class="o">[</span>2/2] Linking target pewpew.dylib
<span class="nv">$ </span>frida Calculator <span class="nt">-C</span> ./build/pewpew.dylib
…
init<span class="o">()</span>
<span class="o">[</span>Local::Calculator]-&gt;</code></pre></figure>

<p>And yes, it live-reloads! Taken to the extreme you could use a file-watcher tool
and make it run <code class="language-plaintext highlighter-rouge">ninja -C build</code> whenever <code class="language-plaintext highlighter-rouge">pewpew.c</code> changes – then just save
and instantly see the instrumentation go live in the target process.</p>

<p>It’s worth noting that you can also use the above when using the internal
CModule toolchain, as having the headers available on disk is handy for editor
features such as code completion.</p>

<h2 id="eof">EOF</h2>

<p>There’s also a bunch of other exciting changes, so definitely check out the
changelog below.</p>

<p>Enjoy!</p>

<h3 id="changes-in-1420">Changes in 14.2.0</h3>

<ul>
  <li>Brand new realms API for instrumenting emulated realms inside native
processes. Only implemented on Android for now.</li>
  <li>Add Java.deoptimizeBootImage(). Thanks <a href="https://twitter.com/alkalinesec">@alkalinesec</a>!</li>
  <li>Add –disable-preload/-P to frida-server. Useful in case of OS compatibility
issues where Frida crashes certain OS processes when attaching to them.</li>
  <li>Fix libc detection on older versions of Android.</li>
  <li>Fix crash when resolving export of the vDSO on Android. Thanks <a href="https://github.com/ant9000">@ant9000</a>!</li>
  <li>Restore support for libhoudini on Android.</li>
  <li>Fix ARM cache flushing on Android 11’s translator.</li>
  <li>Fix linker offsets for Android 5.x. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>Start refactoring CModule’s internals to prepare for multiple backends. Thanks
<a href="https://github.com/mephi42">@mephi42</a>!</li>
  <li>Fix CModule aggregate initializations on ARM.</li>
  <li>Fix ModuleApiResolver fast-path emitting bad matches.</li>
</ul>

<h3 id="changes-in-1421">Changes in 14.2.1</h3>

<ul>
  <li>Fix CModule constructor error-path in the V8 runtime.</li>
  <li>Use V8 runtime for the “system_server” agent on Android.</li>
</ul>

<h3 id="changes-in-1422">Changes in 14.2.2</h3>

<ul>
  <li>Fix Darwin.Mapper arm64e handling of pages without fixups. This went unnoticed
out of pure “luck”, until our binaries eventually mutated sufficiently to
expose this bug.</li>
</ul>

<h3 id="changes-in-1423">Changes in 14.2.3</h3>

<ul>
  <li>Upgrade to using inline hooking for the ART runtime. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>Fix direct transport regression on i/macOS, introduced by GLib upgrade where
GLib.Socket gained GLib.Credentials support on Apple OSes. A typical symptom
of this regression is that frida-server gets killed by Jetsam.</li>
  <li>Fix libffi support for stdcall, thiscall, and fastcall on 32-bit Windows.</li>
  <li>Extend Memory.alloc() to support allocating near a given address. Thanks
<a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>Fix relocation of RIP-relative indirect branches on x86_64. Thanks
<a href="https://github.com/dkw72n">@dkw72n</a>!</li>
  <li>Improve the JVM C++ allocator API probing logic by consulting debug symbols
before giving up. Thanks <a href="https://github.com/Happyholic1203">@Happyholic1203</a>!</li>
  <li>Upgrade SELinux libraries to support bleeding edge Android systems.</li>
  <li>Add gum-linux-x86_64-gir target for GIR generation. Thanks <a href="https://github.com/meme">@meme</a>!</li>
</ul>

<h3 id="changes-in-1424">Changes in 14.2.4</h3>

<ul>
  <li>Fix Android performance regression when ART’s interpreter is used, such as
when using deoptimizeEverything() or deoptimizeBootImage(), which results in
our JS callbacks becoming extremely hot. Move the hot callbacks to CModule to
speed things up.</li>
  <li>Fix V8 debugger support in Node.js bindings on Linux.</li>
  <li>Fix crash on ELF init error in the libdwarf backend.</li>
</ul>

<h3 id="changes-in-1425">Changes in 14.2.5</h3>

<ul>
  <li>Fix regression on older Android systems, introduced in 14.2.4.</li>
</ul>

<h3 id="changes-in-1426">Changes in 14.2.6</h3>

<ul>
  <li>Fix compatibility with legacy NativeBridge v3 and newer, where a namespace
needs to be specified.</li>
</ul>

<h3 id="changes-in-1427">Changes in 14.2.7</h3>

<ul>
  <li>Fix frida-java-bridge crash on systems where printf() renders %p without
“0x” prefix.</li>
  <li>Fix jni_ids_indirection_ offset parsing on ARM64. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
</ul>

<h3 id="changes-in-1428">Changes in 14.2.8</h3>

<ul>
  <li>Fix GLib SO_NOSIGPIPE regression on i/macOS. This would typically result in
frida-server dying due to SIGPIPE. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Refactor CModule internals and lay foundations for GCC backend. Thanks
<a href="https://github.com/mephi42">@mephi42</a>!</li>
  <li>Add EventSink.make_from_callback() for Stalker C API consumers that only care
about events, and don’t need lifecycle hooks or code transformations.</li>
  <li>Emit Stalker BLOCK event at the start of the block, as this is what’s the most
intuitive, as one would expect at least as many BLOCK events as COMPILE
events. This behavior is also the most suitable for measuring coverage.</li>
  <li>Add Stalker prefetch support, useful for optimizing “AFL fork server”-like
use-cases.</li>
</ul>

<h3 id="changes-in-1429">Changes in 14.2.9</h3>

<ul>
  <li>Handle permanent entries in Darwin CodeSegment backend. Starting from iOS 14.3
on A12+ devices, mach_vm_remap() can return KERN_NO_SPACE when the target VM
map entries are marked as “permanent”. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Wire up GCC support in CModule. Thanks <a href="https://github.com/mephi42">@mephi42</a>!</li>
  <li>Add CModule backend for Clang on Apple OSes.</li>
  <li>Add support for linking in a prebuilt CModule. (Only on i/macOS for now.)</li>
  <li>Finalize the CModule toolchain selection API.</li>
  <li>Add CModule.builtins property for tooling support.</li>
  <li>Generate frida-core GIR by default. Thanks <a href="https://github.com/meme">@meme</a>!</li>
  <li>Fix regressions on Linux/MIPS.</li>
</ul>

<h3 id="changes-in-14210">Changes in 14.2.10</h3>

<ul>
  <li>Improve frida-inject to support bidirectional stdio.</li>
  <li>Add support for Termux in frida-python: <code class="language-plaintext highlighter-rouge">pip install frida-tools</code> now works.</li>
</ul>

<h3 id="changes-in-14211">Changes in 14.2.11</h3>

<ul>
  <li>Improve frida-inject to support raw terminal mode.</li>
  <li>Add internal policy daemon for Darwin.</li>
  <li>Improve Gum.Darwin.Mapper to support strict kernels.</li>
</ul>

<h3 id="changes-in-14212">Changes in 14.2.12</h3>

<ul>
  <li>Fix ART method hooking reliability after GC. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
</ul>

<h3 id="changes-in-14213">Changes in 14.2.13</h3>

<ul>
  <li>Fix Instruction operands parsing on x86, ensuring the immediate value is
always represented by an Int64 and never a number. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>Fix frida-inject when process is not attached to a terminal. Thanks
<a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>Expose Base64 and Checksum GLib primitives to CModule. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
</ul>

<h3 id="changes-in-14214">Changes in 14.2.14</h3>

<ul>
  <li>Fix Gadget crash on i/macOS when loaded early.</li>
  <li>Make frida-inject stdin communication optional. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>Support iOS app spawn on unc0ver 6.x. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Work around single-step delay when spawning iOS apps, to avoid failing
randomly. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Fix read() signature mismatch in the libc shim, which would result in a
compilation error on newer Apple toolchains. Thanks <a href="https://github.com/Manouchehri">@Manouchehri</a>!</li>
  <li>Fix Android enumerate_applications() name truncation on newer versions of
Android. Kudos to <a href="https://twitter.com/trufae">@pancake</a> for reporting and helping figure this one out!</li>
  <li>Fix hang when target is unable to load frida-agent.</li>
  <li>Fix support for attaching to Windows services.</li>
  <li>Clean up stale Windows services before registering new ones.</li>
  <li>Add build option to support using installed assets instead of embedding them.</li>
  <li>Update iOS packaging to use installed assets.</li>
  <li>Add basic support for jailed Android. Thanks <a href="https://twitter.com/enovella_">@enovella_</a> for all the fun
and productive pair-programming on this one!</li>
  <li>Extend Arm64Writer API to support more immediates.</li>
  <li>Improve Stalker to support temporarily misaligned stack on arm64.</li>
  <li>Fix crash in Stalker follow() without a sink.</li>
  <li>Implement Stalker invalidation support. This allows updating the
instrumentation without throwing away all of the translated code. Thanks
for the assist on this one, <a href="https://twitter.com/p1onk">@p1onk</a>!</li>
  <li>Add Gum.DarwinModule.enumerate_function_starts().</li>
  <li>Add Gum.DarwinGrafter for AOT grafting to be able to prepare binaries so they
can be instrumented when runtime code modification isn’t possible. Thanks for
the assist, <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Add Memory.allocate_near().</li>
  <li>Improve Stalker performance and robustness on all supported architectures:
    <ul>
      <li>Improve call probes to probe at the target instead of at the call
site, and take advantage of the new invalidation infrastructure.</li>
      <li>Handle adding/removing call probes from within call probes.</li>
      <li>Refactor callout-handling so user data can be destroyed on invalidate.
This also eliminates the callout lock.</li>
      <li>In case of self-modifying code, recompile instead of allocating a new
block.</li>
      <li>Use separate slabs for code and data, to avoid cases where we only
use part of the slab because we run out of metadata storage.</li>
      <li>Inline the first code/data slab in ExecCtx, so we use a lot less
memory when following threads that either don’t touch much code, or
none at all in case they don’t wake up.</li>
      <li>Don’t bother storing original code when trust_threshold is 0.</li>
      <li>Simplify Stalker block metadata to reduce the per-block memory
consumption.</li>
    </ul>
  </li>
  <li>Fix result of Java.enumerateMethods() on ART. This was a bug where static
initializer methods were being included in the enumerated set as ‘$init’ when
they should be skipped altogether. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>Fix the Android/ART near memory allocation code path used during Java method
hooking. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>Fix handling of generic Java array types. This allows array objects obtained
from the runtime to be reused later when marshalling array types, which is
necessary to preserve type information particularly in cases where the type
is dynamic. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>Port Android/ART StackVisitor to x86, x64, and ARM32. Thanks <a href="https://github.com/P-Sc">@P-Sc</a>!</li>
  <li>Fix ARM cache flushing on Android. Turns out cacheflush() expects a range on
Linux/ARM. This 32-bit Android/ARM regression was introduced in 14.2.0.</li>
  <li>Add a few missing TinyCC builtins for 32-bit ARM.  Kudos to <a href="https://twitter.com/giantpune">@giantpune</a> for
reporting and helping figure this one out!</li>
  <li>Fix wrap-around in Stalker block recycling logic.</li>
  <li>Fix V8 NativePointer construction from large numbers.</li>
  <li>Fix Stalker local thread actions on Windows.</li>
  <li>Fix the CModule temporary directory cleanup logic.</li>
  <li>Remove forgotten InspectorServer debug code.</li>
  <li>Fix the V8 debugger integration. Kudos to <a href="https://twitter.com/taviso">@taviso</a> for reporting!</li>
</ul>

<h3 id="changes-in-14215">Changes in 14.2.15</h3>

<ul>
  <li>Fix compatibility with latest unc0ver iOS jailbreak. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Add support for Anbox. Thanks <a href="https://twitter.com/asabil">@asabil</a>!</li>
  <li>Add Java.deoptimizeMethod(). Thanks <a href="https://github.com/liuyufei">@liuyufei</a>!</li>
  <li>Handle replacing ART methods that may be devirtualized. Thanks <a href="https://github.com/liuyufei">@liuyufei</a>!</li>
</ul>

<h3 id="changes-in-14216">Changes in 14.2.16</h3>

<ul>
  <li>Add many missing TinyCC builtins for 32-bit ARM. Kudos to <a href="https://twitter.com/giantpune">@giantpune</a> for
reporting and helping figure this one out!</li>
  <li>Fix Android ART trampoline alignment when using ADRP on arm64, previously
resulting in <code class="language-plaintext highlighter-rouge">Error: invalid argument</code> exception being thrown when attempting
to replace some methods. Kudos to <a href="https://github.com/pandasauce">@pandasauce</a> for reporting and helping
figure this one out!</li>
</ul>

<h3 id="changes-in-14217">Changes in 14.2.17</h3>

<ul>
  <li>Enumerate Darwin imports from chained fixups, to support the latest arm64e
binaries. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Fix chained fixups handling in the jailed iOS injector. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>qml: Compile with <em>no_keywords</em> for GLib compatibility. Thanks <a href="https://github.com/suy">@suy</a>!</li>
</ul>

<h3 id="changes-in-14218">Changes in 14.2.18</h3>

<ul>
  <li>Fix i/macOS injector on recent XNU versions, where mach_port_extract_right()
fails with KERN_INVALID_CAPABILITY when trying to steal the target process’
POSIX thread port send right. This resulted in the injector assuming that we’d
uninjected, subsequently deallocating memory still in use.</li>
  <li>Fix ___error symbol name in the jailed iOS injector. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Fix enumeration of modules with spaces on path in the Linux backend. Thanks
<a href="https://github.com/suy">@suy</a>!</li>
  <li>Fix Stalker handling of direct branch addresses on x64.</li>
  <li>python: Add RPC exports listing functionality. Thanks <a href="https://github.com/NewbieGoose">@NewbieGoose</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2020/12/01/frida-14-1-released/index.html">
      Frida 14.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      01 Dec 2020
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Lots of goodies this time! 🎉 Let’s dive in.</p>

<h2 id="dependencies">Dependencies</h2>

<p>We’ve just upgraded all of our dependencies to the latest and greatest. Part of
this work included refurbishing the build system bits used for building them.</p>

<p>With these improvements we will finally support building past versions of Frida
fully from source, which has been a long-standing issue that’s caused a lot of
frustration.</p>

<p>It is now also a whole lot easier to tweak our dependencies, e.g. while
debugging an issue. Say you’re troubleshooting why <em>Thread.backtrace()</em> isn’t
working well on Android, you might want to play around with libunwind’s
internals. It is now really easy to build one specific dependency:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>make <span class="nt">-f</span> Makefile.sdk.mk <span class="nv">FRIDA_HOST</span><span class="o">=</span>android-arm64 libunwind</code></pre></figure>

<p>Or if you’re building it for the local system:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>make <span class="nt">-f</span> Makefile.sdk.mk libunwind</code></pre></figure>

<p>But you might already have built Frida, and want to switch out libunwind in the
prebuilt SDK that it is using. To do that you can now do:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>make <span class="nt">-f</span> Makefile.sdk.mk symlinks-libunwind</code></pre></figure>

<p>You can then keep making changes to “deps/libunwind”, and perform an incremental
compilation by re-running:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>make <span class="nt">-f</span> Makefile.sdk.mk libunwind</code></pre></figure>

<h2 id="ios">iOS</h2>

<p>We now support iOS 14.2. It was kinda already working, but our crash reporter
integration would deadlock Apple’s crash reporter, and this isn’t great for
system stability overall.</p>

<h2 id="gumjs-support-for-size_t-and-ssize_t">GumJS support for size_t and ssize_t</h2>

<p>Thanks to <a href="https://twitter.com/mame82">@mame82</a> we finally support “size_t” and “ssize_t” in APIs
such as <em>NativeFunction</em>. This means that your cross-platform agents no longer
need to maintain mappings to the native types that these correspond to. Yay!</p>

<h2 id="system-glib-support">System GLib support</h2>

<p><a href="https://github.com/frida/frida-gum">Gum</a> can finally be built with the upstream version of GLib, and we now
support generating <a href="https://gi.readthedocs.io/en/latest/">GObject introspection</a> definitions. This paves the way for
future language bindings that are fully auto-generated.</p>

<p>Kudos to <a href="https://github.com/meme">@meme</a> for these awesome improvements!</p>

<h2 id="windows-inprocess-injection">Windows inprocess injection</h2>

<p>Our Windows backend finally supports inprocess injection. By this I mean that in
the most common cases where the target process’ architecture is the same – and
no elevation is needed – we can now avoid writing out “frida-helper-{32,64}.exe”
to a temporary directory and launching it before we’re able to <em>attach()</em> to a
given target. As an added bonus this also reduces our startup time.</p>

<p>The motivation behind this improvement was to fix a long-standing issue where
some endpoint security products would prevent our injector from working, as our
logic was prone to trigger false positives in such software. We will still
obviously run into such issues when we <em>do</em> need to spawn our helpers, but
there’s now a good chance that the most common use-cases will actually work.</p>

<h2 id="stalker-arm-improvements">Stalker ARM improvements</h2>

<p>For those of you using Stalker on 32-bit ARM, it should now be working a whole
lot better than ever before. A whole slew of fixes landed in this release.</p>

<h2 id="bytecode-and-frida-tools">Bytecode and frida-tools</h2>

<p>One of the realizations since 14.0 was released is that QuickJS’ bytecode format
is a lot more volatile than expected. Because of this I would caution against
using “frida-compile -b” unless your application is designed to only be used
with one exact version of Frida.</p>

<p>As I wasn’t aware of this pitfall when cutting the previous release of
frida-tools, I opted to precompile the frida-trace agent to bytecode. Upon
realizing my mistake while working on releasing 14.1, I reverted this mistake
and released a new version of frida-tools.</p>

<p>So make sure you also grab its latest release while upgrading:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>pip3 <span class="nb">install</span> <span class="nt">-U</span> frida-tools</code></pre></figure>

<h2 id="eof">EOF</h2>

<p>There’s also a bunch of other exciting changes, so definitely check out the
changelog below.</p>

<p>Enjoy!</p>

<h3 id="changes-in-1410">Changes in 14.1.0</h3>

<ul>
  <li>All dependencies upgraded to the latest and greatest.</li>
  <li>Heavily refurbished build system for dependencies. Going forward we will
finally support building past versions of Frida fully from source.</li>
  <li>Port iOS crash reporter integration to iOS 14.2.</li>
  <li>Fix error propagation when talking to iOS devices.</li>
  <li>Add support for “size_t” and “ssize_t” in GumJS. Thanks <a href="https://twitter.com/mame82">@mame82</a>!</li>
  <li>Support linking against system GLib and libffi. Thanks <a href="https://github.com/meme">@meme</a>!</li>
  <li>Support GObject Introspection. Thanks <a href="https://github.com/meme">@meme</a>!</li>
  <li>Improve Windows backend to support inprocess injection. This means we can
dodge common AV heuristics and speed things up in the most common cases where
the target process’ architecture is the same, and no elevation is needed.</li>
  <li>Fix Stalker ARM handling of “ldr pc, [sp], #4”.</li>
  <li>Fix Stalker ARM clobbering of flags in IT blocks.</li>
  <li>Fix Stalker ARM handling of CMN/CMP/TST in IT blocks.</li>
  <li>Fix suppression flags for ThumbWriter instruction.</li>
  <li>Fix Stalker ARM exclusion logic reliability.</li>
  <li>Fix ARM Stalker follow() of thread in Thumb mode.</li>
  <li>Fix ARM Stalker SVC handling in Thumb mode.</li>
  <li>Fix ThumbRelocator handling of unaligned ADR.</li>
  <li>Move Stalker ARM to runtime VFP feature detection.</li>
  <li>Refuse to Interceptor.attach() without any callbacks.</li>
  <li>Improve GumJS error message formatting.</li>
  <li>Fix starvation in the V8 debugger integration.</li>
  <li>Keep NativeCallback alive during calls on V8 also.</li>
</ul>

<h3 id="changes-in-1411">Changes in 14.1.1</h3>

<ul>
  <li>Fix CModule regression where Capstone went missing.</li>
  <li>Add missing CModule builtins for 32-bit ARM.</li>
  <li>Fix Thread.backtrace() on Android/ARM64.</li>
</ul>

<h3 id="changes-in-1412">Changes in 14.1.2</h3>

<ul>
  <li>Fix Thread.backtrace() on Android/ARM.</li>
</ul>

<h3 id="changes-in-1413">Changes in 14.1.3</h3>

<ul>
  <li>Fix ObjC.choose(). The TinyCC upgrade in 14.1.0 exposed an existing bug.</li>
  <li>Re-enable V8 by default. Turns out we have use-cases where it is a much better
fit than QuickJS, and its debugger features were also being sorely missed.</li>
  <li>Add –ignore-crashes/-C to frida-server for disabling the native crash
reporter integration. For use-cases where the integration is undesired, or
when running on bleeding edge OS versions that we don’t yet fully support.
(Crash reporter integration is only available on iOS and Android for now.)</li>
  <li>Enhance devkits to ensure Capstone APIs are exposed on all platforms.</li>
  <li>Improve devkit examples.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2020/10/28/frida-14-0-released/index.html">
      Frida 14.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      28 Oct 2020
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Here’s a major new release that took weeks of intense coding, with way too many
cups of coffee. But before we dive into it, we need to have a quick look down
memory lane.</p>

<p>For years now our V8-based runtime has served us well. But eventually we needed
to support constrained systems where V8 isn’t a great fit, so we introduced a
second runtime.</p>

<p>This has worked out nicely, but there were some trade-offs we were left with:</p>

<ul>
  <li>Language feature support being wildly different between the two runtimes.
We tried to alleviate some of this by making the minimalistic runtime be the
default, as it’s available everywhere and is the lowest common denominator in
terms of features.</li>
  <li>Needing to sacrifice performance when using a tool such as <a href="https://github.com/frida/frida-compile">frida-compile</a>
to compile modern JavaScript to old JavaScript that runs on both runtimes.</li>
  <li>Non-trivial agents with lots of code and data floating around make it clear
not just how fast V8 is – no surprise there – but that it’s really good at
packing objects to avoid wasting precious RAM. And to widen the gap between
the two runtimes even more, V8 can run the modern JavaScript as-is and doesn’t
need to run a bloated version that contains compatibility shims to fill in the
missing runtime bits such as <em>Map</em> and <em>Set</em>.</li>
  <li>Example code and documentation tends to look arcane to avoid confusing users
who might try to run modern code on the default runtime.</li>
  <li>Garbage collector implementation differences may hide the user’s bugs in one
runtime that instantly blow up in the other where resources are released way
more eagerly. One such example is failing to keep a NativeCallback alive while
external code is still using it.</li>
  <li>Terrible UX: All of the above is a very frustrating and confusing story to
tell our users.</li>
  <li>New features and refinements need to be implemented twice. This is a real pain
for me as a maintainer for obvious reasons.</li>
</ul>

<p>Fast-forward to 2019 and <a href="https://bellard.org/quickjs/">QuickJS</a> caught my eye. I was really busy with other
things at the time, though, so by the time I looked closer at it I noticed it
supports ES2020, and also <a href="https://bellard.org/quickjs/bench.html">performs</a> impressively well for an interpreter.</p>

<p>But as I started thinking about bringing up a new runtime from scratch, and
seeing as the other two are roughly ~25 KLOC each, it just felt overwhelming.</p>

<p>I kept coming back to the QuickJS website though, devouring the technical
details, and even started reading deeper into the public API at some point.</p>

<p>Then I noticed that it didn’t support cooperative multi-threaded use, where
multiple threads execute JavaScript in lockstep. This made the mountain of work
ahead feel even more daunting, but then I remembered that I’d already
contributed support for this in Duktape, and it wasn’t that hard.</p>

<p>Eventually I mustered up the courage. Picked a super-simple test from GumJS’
extensive <a href="https://github.com/frida/frida-gum/blob/6873f1504e40ad1a8bbc51d469c95519a2076fb0/tests/gumjs/script.c">test-suite</a> as my first challenge, and went ahead and copy-pasted
the <a href="https://github.com/frida/frida-gum/blob/6873f1504e40ad1a8bbc51d469c95519a2076fb0/bindings/gumjs/gumscriptbackend.h">ScriptBackend</a> and <a href="https://github.com/frida/frida-gum/blob/6873f1504e40ad1a8bbc51d469c95519a2076fb0/bindings/gumjs/gumscript.h">Script</a> implementations from the youngest of the
existing two runtimes. First renaming things, then stubbing out all of the
modules (Interceptor, Stalker, etc.), just wanting to get a near-empty “shell”
to compile and run.</p>

<p>At this point I was hooked and couldn’t stop. Lots of coffee was consumed, and
before I knew it I’d gotten the core bits and the first module implemented. Then
another, and then one more.</p>

<p>After working quite a bit with the QuickJS API, and jumping around its internals
to make sure I understood the reference counting rules etc., it suddenly seemed
really clear what was needed to implement the cooperative multi-threading API
that would be needed to make this a real runtime and not just a toy.</p>

<p>What we need to be able to do is suspend JS execution while calling out to a
NativeFunction. This is because the called function may block waiting for a lock
which another thread might already be holding, but that other thread may have
just called a hooked function and is waiting to enter the JS runtime. So if we
didn’t let go of the JS lock before calling the NativeFunction, we’d now be in
a deadlock.</p>

<p>Another use-case is calling <em>Thread.sleep()</em> or some other blocking API where
we’d cause starvation if we did that while holding the JS lock.</p>

<p>Anyway, the <a href="https://github.com/frida/quickjs/commit/7ec1392b19bcf6ae2b109cda3e2133c5d6918a6c">QuickJS multi-threading API</a> turned out to be straight-forward,
so from there I kept on going, until it was all finally <a href="https://github.com/frida/frida-gum/commit/c47c0711c72a87e729e3e59110b7f611ff392fe2">done</a>! 🎉</p>

<p>At this point I was really curious about the performance of this brand new
runtime, starting with the question of what it costs to enter and leave it.</p>

<p>Went ahead and took it for a spin on an iPhone 6, running the GumJS <a href="https://github.com/frida/frida-gum/blob/6873f1504e40ad1a8bbc51d469c95519a2076fb0/tests/gumjs/script.c#L5089-L5137">test</a>
that uses Interceptor to hook a nearly empty C function, supplying an empty JS
callback, and then measures the wall-clock time spent on each call as it keeps
calling the C function over and over.</p>

<p>The idea is to simulate what would happen if the user hooks a function that’s
called frequently, to get an idea of the base overhead.</p>

<p>Here’s what I got:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># QuickJS</span>
&lt;min: 1.0 us, max: 7.0 us, median: 2.0 us&gt; ok 1 /GumJS/Script/Interceptor/Performance/interceptor_on_enter_performance#QJS
&lt;min: 2.0 us, max: 54.0 us, median: 2.0 us&gt; ok 2 /GumJS/Script/Interceptor/Performance/interceptor_on_leave_performance#QJS
&lt;min: 3.0 us, max: 18.0 us, median: 3.0 us&gt; ok 3 /GumJS/Script/Interceptor/Performance/interceptor_on_enter_and_leave_performance#QJS
<span class="c"># Duktape</span>
&lt;min: 2.0 us, max: 8.0 us, median: 3.0 us&gt; ok 4 /GumJS/Script/Interceptor/Performance/interceptor_on_enter_performance#DUK
&lt;min: 2.0 us, max: 6.0 us, median: 3.0 us&gt; ok 5 /GumJS/Script/Interceptor/Performance/interceptor_on_leave_performance#DUK
&lt;min: 4.0 us, max: 89.0 us, median: 4.0 us&gt; ok 6 /GumJS/Script/Interceptor/Performance/interceptor_on_enter_and_leave_performance#DUK
<span class="c"># V8</span>
&lt;min: 13.0 us, max: 119.0 us, median: 14.0 us&gt; ok 7 /GumJS/Script/Interceptor/Performance/interceptor_on_enter_performance#V8
&lt;min: 15.0 us, max: 127.0 us, median: 16.0 us&gt; ok 8 /GumJS/Script/Interceptor/Performance/interceptor_on_leave_performance#V8
&lt;min: 26.0 us, max: 198.0 us, median: 28.0 us&gt; ok 9 /GumJS/Script/Interceptor/Performance/interceptor_on_enter_and_leave_performance#V8</code></pre></figure>

<p>Wow, so that was looking promising!  How about <a href="https://github.com/frida/frida-gum/blob/6873f1504e40ad1a8bbc51d469c95519a2076fb0/tests/gumjs/script.c#L7356-L7399">baseline memory usage</a>, i.e.
how much memory is consumed by one instance of the runtime itself?</p>

<p><img src="../../img/qjs-memory-baseline.png" alt="QJS Memory Baseline" title="QJS Memory Baseline" /></p>

<p>That’s quite an improvement – only one fifth of the previous runtime!</p>

<p>The next thing I was curious about was the approximate initial size of Frida’s
internal heap when using our REPL. That includes all of the memory used by
frida-agent, the JS runtime, and the REPL agent that was loaded:</p>

<p><img src="../../img/qjs-memory-repl.png" alt="QJS Memory REPL" title="QJS Memory REPL" /></p>

<p>Yay, 1 MB freed up for other purposes!</p>

<p>So with that, I hope you’re as excited as I am about this new release. We’ve
replaced our previous default runtime with this brand new one built on QuickJS.</p>

<p>And as an experiment I have also decided to build our official binaries without
our V8 runtime. This means that the binaries are way smaller than they’ve ever
been before.</p>

<p>I do realize that some of you may have use-cases where the V8 runtime is
essential, so my hope is that you will take the new QuickJS runtime for a spin
and let me know how it works for you. If it’s an absolute disaster for your
particular use-case then don’t worry, just let me know and we will figure
something out.</p>

<p>If you’d like to build Frida yourself with the V8 runtime enabled, it’s only a
matter of tweaking <a href="https://github.com/frida/frida/blob/b5aa3aa623c2d919e7fe7c34eee9ded31da8212e/config.mk#L22">this line</a>. But please do let me know if you can’t live
without it, so we can decide on whether we need to keep supporting this runtime
down the road.</p>

<p>The only other change in this major release applies to i/macOS, where we’re
finally following Apple’s move to drop support for 32-bit programs. We’ll keep
the codepaths around for now though, but our official binaries have a lot less
fat, and the top-level build system is also a bit slimmer. E.g.
<code class="language-plaintext highlighter-rouge">make core-macos-thin</code> is now just <code class="language-plaintext highlighter-rouge">make core-macos</code>.</p>

<p>That’s all in Frida itself, but there’s more.  We’ve also released frida-tools
9.0, freshly upgraded to make use of modern JavaScript features everywhere. That
includes frida-trace, where the generated boilerplate hooks have become a lot
more readable after some syntax upgrades.  Last but not least we have also
released frida-compile 10.0, where the Babel dependencies are gone and so are
the corresponding command-line switches; it’s faster and so much simpler.</p>

<p>So with that, I hope you’ll enjoy this new release!</p>

<h3 id="changes-in-1400">Changes in 14.0.0</h3>

<ul>
  <li>Replace the default runtime with a brand new GumJS runtime based on QuickJS.</li>
  <li>Disable V8 by default.</li>
  <li>Retain callback object in Interceptor.attach() on V8.</li>
  <li>Drop “enumerate” trap from the global access API.</li>
</ul>

<h3 id="changes-in-1401">Changes in 14.0.1</h3>

<ul>
  <li>QJS: Fix nested global access requests.</li>
  <li>qml: Update to the new frida-core API.</li>
</ul>

<h3 id="changes-in-1402">Changes in 14.0.2</h3>

<ul>
  <li>QJS: Keep NativeCallback alive during calls.</li>
  <li>QJS: Speed up the NativeCallback construction logic.</li>
  <li>QJS: Disable stack limitation for now.</li>
  <li>iOS: Port the iOS crash reporter integration to iOS 14.</li>
  <li>iOS: Remove packaging logic for 32-bit.</li>
  <li>Android: Use the default runtime for the “system_server” agent.</li>
  <li>Modernize internal JavaScript agents.</li>
</ul>

<h3 id="changes-in-1403">Changes in 14.0.3</h3>

<ul>
  <li>Disable V8 on Windows also.</li>
  <li>iOS: Improve the packaging script.</li>
</ul>

<h3 id="changes-in-1404">Changes in 14.0.4</h3>

<ul>
  <li>iOS: Fix arm64e regression caused by toolchain upgrade.</li>
</ul>

<h3 id="changes-in-1405">Changes in 14.0.5</h3>

<ul>
  <li>QJS: Fix Interceptor error-handling.</li>
</ul>

<h3 id="changes-in-1406">Changes in 14.0.6</h3>

<ul>
  <li>ObjC: Fix lifetime of replaced methods so they’re not tied to the class
wrapper, and also kept alive in chaining use-cases. Kudos to <a href="https://twitter.com/Hexploitable">@Hexploitable</a>
and <a href="https://twitter.com/bezjaje">@mrmacete</a> for the assist!</li>
  <li>Fix Exceptor sigaction() registration failure when act == oact. Thanks
<a href="https://github.com/hluwa">@hluwa</a>!</li>
  <li>Improve Linux libc detection.</li>
  <li>Fix intermittent hang when enumerating and modifying threads on Linux.</li>
  <li>Fix inconsistent PC vs CPSR Thumb bit handling.</li>
  <li>Fix build regressions on Linux/armhf and Linux/arm64.</li>
  <li>Publish binaries for Raspberry Pi 32- and 64-bit.</li>
</ul>

<h3 id="changes-in-1407">Changes in 14.0.7</h3>

<ul>
  <li>Avoid deadlocking in scenarios where we crash while executing JS code, e.g.
when calling out to a NativeFunction w/ <code class="language-plaintext highlighter-rouge">exceptions: 'propagate'</code>, or in case
of a bug in GumJS. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Fix CModule on macOS/arm64.</li>
  <li>Publish Python and Node.js binaries for Raspberry Pi 32-bit.</li>
  <li>Publish binaries for Fedora 33 instead of Fedora 32.</li>
  <li>Publish binaries for Ubuntu 20.10.</li>
</ul>

<h3 id="changes-in-1408">Changes in 14.0.8</h3>

<ul>
  <li>Improve jailed iOS upload reliability by adding some bi-directional
communication into the upload connection. This is to prevent DoS protections
from kicking in during gadget upload in complex remote configurations. Thanks
<a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2020/07/24/frida-12-11-released/index.html">
      Frida 12.11 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      24 Jul 2020
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>In anticipation of Apple releasing macOS 11, it’s time for Frida 12.11! This
release brings full compatibility with macOS 11 Beta 3. Not only that, we now
also support macOS on Apple silicon. Yay!</p>

<p>It’s worth noting that we didn’t stop at arm64, we also support arm64e. This ABI
is still a moving target, so if you have a Developer Transition Kit (DTK) and
want to take this for a spin you will have to disable SIP, and then add a boot
argument:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>nvram boot-args<span class="o">=</span><span class="s2">"-arm64e_preview_abi"</span></code></pre></figure>

<p>Considering this awesome convergence of platforms, there’s actually a chance
that we may already support jailbroken iOS 14. We will know once a public
jailbreak becomes available. At least it shouldn’t require much work to support.</p>

<p>So for those of you exploring your DTK, you can grab our CLI tools and Python
bindings the usual way:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>pip3 <span class="nb">install </span>frida-tools</code></pre></figure>

<p>As a sidenote we just released <a href="https://github.com/frida/cryptoshark/releases/tag/0.2.0">CryptoShark 0.2.0</a> and would highly recommend
checking it out. Only caveat is that we only provide binaries for macOS/x86_64
for now, so if you want to try this on macOS/arm64 you will be able to run it
thanks to Rosetta, but attaching to processes on the “Local System” device
won’t work.</p>

<p>The workaround is simple though – just grab a frida-server binary from our
<a href="https://github.com/frida/frida/releases">releases</a> and fire it up, then point CryptoShark at the “Local Socket”
device. You can also use local SSH port forwarding if you’d like to run
CryptoShark on one system and attach to processes on another:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ssh <span class="nt">-L</span> 27042:127.0.0.1:27042 dtk</code></pre></figure>

<p>There’s also a lot of other exciting changes in this release, so definitely
check out the changelog below.</p>

<p>Enjoy!</p>

<h3 id="changes-in-12110">Changes in 12.11.0</h3>

<ul>
  <li>Add support for macOS 11 and Apple silicon.</li>
  <li>Daemonize helper process on Darwin. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Daemonize helper process on Linux.</li>
  <li>Fix unreliable iOS device handling when using usbmuxd. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Fix infinite wait when i/macOS frida-helper dies early.</li>
  <li>Add Android spawn() “uid” option to specify user ID. Thanks <a href="https://github.com/sowdust">@sowdust</a>!</li>
  <li>Add support for the latest checkra1n jailbreak. Thanks for the assist,
<a href="https://twitter.com/Hexploitable">@Hexploitable</a>!</li>
  <li>Improve Stalker ARM stability.</li>
  <li>Plug leak in Interceptor arm64 backend error path.</li>
  <li>Fix interception near memcpy() on systems w/o RWX pages.</li>
  <li>Fix encoding of CpuContext pointers on Darwin/arm64e.</li>
  <li>Always strip backtrace items on Darwin/arm64.</li>
  <li>Fix Linux architecture detection on big-endian systems.</li>
  <li>Fix Capstone endianness configuration on ARM BE8.</li>
</ul>

<h3 id="changes-in-12111">Changes in 12.11.1</h3>

<ul>
  <li>Handle i/macOS targets using different ptrauth keys.</li>
  <li>Fix Linux CPU type detection on big-endian systems.</li>
  <li>Fix early instrumentation on Linux/ARM-BE8.</li>
  <li>Fix injection into Linux processes blocked on SIGTTIN or SIGTTOU.</li>
</ul>

<h3 id="changes-in-12112">Changes in 12.11.2</h3>

<ul>
  <li>Fix Stalker thread_exit probing on macOS 11/x86_64.</li>
  <li>Fix slow exports resolution on macOS 11/x86_64.</li>
  <li>Fix CModule support for Capstone headers on ARM.</li>
  <li>Add ArmWriter to the CModule runtime for ARM.</li>
  <li>qml: Add support for specifying the script runtime to use.</li>
</ul>

<h3 id="changes-in-12113">Changes in 12.11.3</h3>

<ul>
  <li>Fix prototype of ModuleMap.values() in the V8 runtime.</li>
  <li>qml: Sync DetachReason enum with the current Frida API.</li>
  <li>qml: Fix Device lifetime logic.</li>
</ul>

<h3 id="changes-in-12114">Changes in 12.11.4</h3>

<ul>
  <li>Fix injector on macOS 11 beta 3. Drop support for older betas.</li>
  <li>Drop helper hack made redundant by macOS 11 beta 3.</li>
  <li>Fix handling of i/macOS introspection modules.</li>
</ul>

<h3 id="changes-in-12115">Changes in 12.11.5</h3>

<ul>
  <li>Fix i/macOS early instrumentation of processes using dyld’s modern code path
on macOS 11 and iOS 14.</li>
  <li>Make JVM method interception safer by installing new methods using
VMThread::execute(), which blocks all Java threads and makes it safer to do
interception of hot methods. Thanks <a href="https://twitter.com/0xraaz">@0xraaz</a>!</li>
  <li>Add support for SUB instruction to ARM Relocator. This means improved
reliability when using Interceptor and Stalker on 32-bit ARM.</li>
  <li>qml: Fix build with GCC by adding missing include.</li>
</ul>

<h3 id="changes-in-12116">Changes in 12.11.6</h3>

<ul>
  <li>Port iOS jailed injector to the new arm64e ABI. This means iOS 14 beta 3 is
now fully supported in jailed mode, even on A12+ devices.</li>
</ul>

<h3 id="changes-in-12117">Changes in 12.11.7</h3>

<ul>
  <li>Improve libc detection on Linux and QNX. Thanks <a href="https://github.com/demantz">@demantz</a>!</li>
  <li>Fix checking of symbol sizes in libdwarf backend. This means more reliable
debug symbol resolution on Linux.</li>
  <li>Fix brittle Android activity start logic. Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>Improve Android Java hooking reliability by clearing the
<em>kAccFastInterpreterToInterpreterInvoke</em> flag. Thanks <a href="https://github.com/deroko">@deroko</a>!</li>
  <li>Guard against using Java wrappers after <em>$dispose()</em>, to make such dangerous
bugs easier to detect.</li>
  <li>Improve the frida-qml build system and add support for standalone use.</li>
</ul>

<h3 id="changes-in-12118">Changes in 12.11.8</h3>

<ul>
  <li>Add support for macOS 11 beta 4 on Apple silicon.</li>
</ul>

<h3 id="changes-in-12119">Changes in 12.11.9</h3>

<ul>
  <li>Add support for jailed iOS w/ Xcode 12 developer disk images.</li>
</ul>

<h3 id="changes-in-121110">Changes in 12.11.10</h3>

<ul>
  <li>node: Plug leak in IOStream’s WriteOperation. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>qml: Add support for listing applications.</li>
  <li>qml: Expose a “count” property on each model.</li>
  <li>Fix ARM relocation of “add sb, pc, r4”.</li>
  <li>Fix ARM relocation of “add ip, pc, #4, #12”.</li>
  <li>Fix ARM writer support for LDMIA when Rn is in reglist.</li>
</ul>

<h3 id="changes-in-121111">Changes in 12.11.11</h3>

<ul>
  <li>Add support for opaque JNI IDs on Android R, to support debuggable apps.
Thanks <a href="https://github.com/muhzii">@muhzii</a>!</li>
  <li>qml: Add support for spawning processes.</li>
  <li>qml: Add missing libraries when linking with devkit on Linux.</li>
  <li>qml: Fix static linking on Linux.</li>
  <li>qml: Optimize startup to not wait for enumerate_devices().</li>
</ul>

<h3 id="changes-in-121112">Changes in 12.11.12</h3>

<ul>
  <li>Initialize CoreFoundation during early instrumentation on i/macOS. Thanks
<a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Support a NULL EventSink in Stalker. Thanks <a href="https://github.com/meme">@meme</a>!</li>
  <li>node: Provide Electron prebuilds for v10 and v11. Next release will drop
prebuilds for v9.</li>
  <li>qml: Add post(QJsonArray).</li>
</ul>

<h3 id="changes-in-121113">Changes in 12.11.13</h3>

<ul>
  <li>Fix ART internals probing on Android 11/arm64. Thanks <a href="https://twitter.com/enovella_">@enovella_</a>!</li>
  <li>Build GumJS runtime for V8 without compression for now, as we need to improve
frida-compile to use the latest version of <a href="https://github.com/terser/terser">terser</a>.</li>
</ul>

<h3 id="changes-in-121114">Changes in 12.11.14</h3>

<ul>
  <li>Build GumJS runtime for V8 with compression now that frida-compile has been
upgraded to the latest version of <a href="https://github.com/terser/terser">terser</a>.</li>
</ul>

<h3 id="changes-in-121115">Changes in 12.11.15</h3>

<ul>
  <li>Add support for iOS 14.x secure DTX. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Fix Java.deoptimizeEverything() on Android 11. Thanks <a href="https://github.com/Gh0u1L5">@Gh0u1L5</a>!</li>
</ul>

<h3 id="changes-in-121116">Changes in 12.11.16</h3>

<ul>
  <li>Fix arm64e support in Arm64Relocator.can_relocate(). Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Add “onEvent” option to Stalker.follow(). This allows synchronous
processing of events in native code – typically implemented using CModule.
Useful when wanting to implement custom filtering and/or queuing logic to
improve performance, or sacrifice performance in exchange for reliable event
delivery.</li>
  <li>Expose Stalker’s live CpuContext to EventSink. This can be accessed through
the “onEvent” callback, and through the Gum C API.</li>
  <li>Add Spinlock to the CModule runtime.</li>
</ul>

<h3 id="changes-in-121117">Changes in 12.11.17</h3>

<ul>
  <li>Kill via LLDB on jailed iOS, to avoid killing via ProcessControl when
possible. Turns out our previous behavior left debugserver in a bad state
for which killed apps sometimes would appear as already running, failing early
instrumentation on subsequent spawn() attempts. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Fix Java bridge initialization on older Android API levels by letting the
instrumentation field detection fail gracefully. We don’t need it on older API
levels anyway.</li>
  <li>Reduce Duktape memory usage a little per script. There is no need to intern
the script source code string.</li>
</ul>

<h3 id="changes-in-121118">Changes in 12.11.18</h3>

<ul>
  <li>Skip app extensions when detecting frontmost app on jailed iOS. Sometimes an
app extension was returned as the first matched process, subsequently throwing
“Unable to resolve bundle path to bundle ID”. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Improve Android ART instrumentation offset detection for x86/x86_64. Thanks
<a href="https://github.com/Gh0u1L5">@Gh0u1L5</a>!</li>
  <li>Fix JDWP initialization failure on Android 7.1-8.1. Thanks <a href="https://github.com/Gh0u1L5">@Gh0u1L5</a>!</li>
  <li>Fix nearest symbol logic in the libdwarf backend.</li>
  <li>Plug a leak in the Duktape-based runtime’s argument parsing logic, where any
collected memory range arrays would leak in case an error occurs parsing one
of the following arguments.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2020/06/29/frida-12-10-released/index.html">
      Frida 12.10 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      29 Jun 2020
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>This time we have some exciting news for Java developers and reversers:
<a href="https://github.com/frida/frida-java-bridge">frida-java-bridge</a> now supports the HotSpot JVM. This means our Java
runtime bridge is no longer exclusively an Android feature. Huge thanks to
<a href="https://twitter.com/0xraaz">Razvan Sima</a> for this amazing addition.</p>

<p>The timing couldn’t have been any better either, as we recently also added
<em>Java.enumerateMethods(query)</em>, a brand new API for efficiently locating methods
matching a given query. We made sure to also implement this for the HotSpot JVM.</p>

<p>The query is specified as <code class="language-plaintext highlighter-rouge">"class!method"</code>, with globs permitted. It may also be
suffixed with <code class="language-plaintext highlighter-rouge">/</code> and one or more modifiers:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">i</code>: Case-insensitive matching.</li>
  <li><code class="language-plaintext highlighter-rouge">s</code>: Include method signatures, so e.g. <code class="language-plaintext highlighter-rouge">"putInt"</code> becomes
<code class="language-plaintext highlighter-rouge">"putInt(java.lang.String, int): void"</code>. Handy to match on argument and
return types, such as <code class="language-plaintext highlighter-rouge">"*!*: boolean/s"</code> to match all methods that return a
boolean.</li>
  <li><code class="language-plaintext highlighter-rouge">u</code>: User-defined classes only, ignoring system classes.</li>
</ul>

<p>For instance:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">groups</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">enumerateMethods</span><span class="p">(</span><span class="dl">'</span><span class="s1">*youtube*!on*</span><span class="dl">'</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">groups</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">});</span></code></pre></figure>

<p>Which might output something like:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"loader"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;instance: java.lang.ClassLoader, $className: dalvik.system.PathClassLoader&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"classes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"com.google.android.apps.youtube.app.watch.nextgenwatch.ui.NextGenWatchLayout"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"methods"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"onAttachedToWindow"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"onDetachedFromWindow"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"onFinishInflate"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"onInterceptTouchEvent"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"onLayout"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"onMeasure"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"onSizeChanged"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"onTouchEvent"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"onViewRemoved"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"com.google.android.apps.youtube.app.search.suggest.YouTubeSuggestionProvider"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"methods"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"onCreate"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"com.google.android.libraries.youtube.common.ui.YouTubeButton"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"methods"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"onInitializeAccessibilityNodeInfo"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="err">…</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span></code></pre></figure>

<p>We’ve also enhanced frida-trace to support Java method tracing:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida-trace <span class="se">\</span>
    <span class="nt">-U</span> <span class="se">\</span>
    <span class="nt">-f</span> com.google.android.youtube <span class="se">\</span>
    <span class="nt">--runtime</span><span class="o">=</span>v8 <span class="se">\</span>
    <span class="nt">-j</span> <span class="s1">'*!*certificate*/isu'</span>
Instrumenting...
X509Util.addTestRootCertificate: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/org.chromium.net.X509Util/addTestRootCertificate.js"</span>
X509Util.clearTestRootCertificates: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/org.chromium.net.X509Util/clearTestRootCertificates.js"</span>
X509Util.createCertificateFromBytes: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/org.chromium.net.X509Util/createCertificateFromBytes.js"</span>
X509Util.isKnownRoot: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/org.chromium.net.X509Util/isKnownRoot.js"</span>
X509Util.verifyKeyUsage: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/org.chromium.net.X509Util/verifyKeyUsage.js"</span>
X509Util.verifyServerCertificates: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/org.chromium.net.X509Util/verifyServerCertificates.js"</span>
ResourceLoader<span class="nv">$CppProxy</span>.native_enableDevCertificate: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/com.google.android.libraries.elements.interfaces.ResourceLoader_CppProxy/native_enableDevCertificate.js"</span>
ResourceLoader<span class="nv">$CppProxy</span>.enableDevCertificate: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/com.google.android.libraries.elements.interfaces.ResourceLoader_CppProxy/enableDevCertificate.js"</span>
AndroidCertVerifyResult.getCertificateChainEncoded: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/org.chromium.net.AndroidCertVerifyResult/getCertificateChainEncoded.js"</span>
bjbm.a: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/bjbm/a.js"</span>
bjbn.a: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/bjbn/a.js"</span>
AndroidNetworkLibrary.addTestRootCertificate: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/org.chromium.net.AndroidNetworkLibrary/addTestRootCertificate.js"</span>
AndroidNetworkLibrary.clearTestRootCertificates: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/org.chromium.net.AndroidNetworkLibrary/clearTestRootCertificates.js"</span>
AndroidNetworkLibrary.verifyServerCertificates: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/org.chromium.net.AndroidNetworkLibrary/verifyServerCertificates.js"</span>
vxr.checkClientTrusted: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/vxr/checkClientTrusted.js"</span>
vxr.checkServerTrusted: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/vxr/checkServerTrusted.js"</span>
vxr.getAcceptedIssuers: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/vxr/getAcceptedIssuers.js"</span>
ResourceLoader.enableDevCertificate: Auto-generated handler at <span class="s2">"/Users/oleavr/__handlers__/com.google.android.libraries.elements.interfaces.ResourceLoader/enableDevCertificate.js"</span>
Started tracing 18 functions. Press Ctrl+C to stop.
           /<span class="k">*</span> TID 0x339d <span class="k">*</span>/
   955 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,9,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"suggestqueries.google.com"</span><span class="o">)</span>
   972 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span>
  1043 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,4,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"www.googleadservices.com"</span><span class="o">)</span>
  1059 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span>
           /<span class="k">*</span> TID 0x33a0 <span class="k">*</span>/
  1643 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,5,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"googleads.g.doubleclick.net"</span><span class="o">)</span>
           /<span class="k">*</span> TID 0x339d <span class="k">*</span>/
  1651 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,9,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"www.youtube.com"</span><span class="o">)</span>
           /<span class="k">*</span> TID 0x33a1 <span class="k">*</span>/
  1665 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,15,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"lh3.googleusercontent.com"</span><span class="o">)</span>
           /<span class="k">*</span> TID 0x33a0 <span class="k">*</span>/
  1674 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span>
           /<span class="k">*</span> TID 0x339d <span class="k">*</span>/
  1674 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span>
           /<span class="k">*</span> TID 0x3417 <span class="k">*</span>/
  1674 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,15,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"yt3.ggpht.com"</span><span class="o">)</span>
           /<span class="k">*</span> TID 0x33a1 <span class="k">*</span>/
  1684 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span>
           /<span class="k">*</span> TID 0x3417 <span class="k">*</span>/
  1688 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span>
  2513 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,9,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"redirector.googlevideo.com"</span><span class="o">)</span>
  2527 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span>
  2722 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,9,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"r1---sn-bxuovgf5t-vnaz.googlevideo.com"</span><span class="o">)</span>
           /<span class="k">*</span> TID 0x33a1 <span class="k">*</span>/
  2741 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,9,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"r2---sn-bxuovgf5t-vnas.googlevideo.com"</span><span class="o">)</span>
           /<span class="k">*</span> TID 0x339d <span class="k">*</span>/
  2758 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,9,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"r2---sn-bxuovgf5t-vnaz.googlevideo.com"</span><span class="o">)</span>
           /<span class="k">*</span> TID 0x33a1 <span class="k">*</span>/
  2771 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span>
           /<span class="k">*</span> TID 0x3417 <span class="k">*</span>/
  2772 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span>
           /<span class="k">*</span> TID 0x339d <span class="k">*</span>/
  2777 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span>
  2892 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,6,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"r2---sn-bxuovgf5t-vnas.googlevideo.com"</span><span class="o">)</span>
           /<span class="k">*</span> TID 0x3417 <span class="k">*</span>/
  2908 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,6,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"r2---sn-bxuovgf5t-vnaz.googlevideo.com"</span><span class="o">)</span>
           /<span class="k">*</span> TID 0x33a1 <span class="k">*</span>/
  2926 ms  AndroidNetworkLibrary.verifyServerCertificates<span class="o">([[</span>48,-126,6,…],[48,-126,4,…]], <span class="s2">"RSA"</span>, <span class="s2">"r1---sn-bxuovgf5t-vnaz.googlevideo.com"</span><span class="o">)</span>
           /<span class="k">*</span> TID 0x3417 <span class="k">*</span>/
  2935 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span>
           /<span class="k">*</span> TID 0x339d <span class="k">*</span>/
  2937 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span>
           /<span class="k">*</span> TID 0x33a1 <span class="k">*</span>/
  2942 ms  AndroidCertVerifyResult.getCertificateChainEncoded<span class="o">()</span></code></pre></figure>

<p>This was just released as part of <a href="https://github.com/frida/frida-tools">frida-tools</a> 8.0 – which you may grab
through e.g.: <code class="language-plaintext highlighter-rouge">pip3 install -U frida-tools</code></p>

<p>We’ve also been working hard on quality improvements across the board. One good
example is Stalker for 32-bit ARM, which now works a lot better on Android. It
is also a lot faster, in part because of a bug resulting in Thumb blocks being
recompiled over and over. We have also implemented one of the adaptive
optimizations that the other Stalker backends make use of, and this alone
typically amounts to a ~5x performance improvement.</p>

<p>So that should cover the highlights – but if you’re curious about the details
I’d highly recommend reading the changelog below.</p>

<p>Enjoy!</p>

<h3 id="changes-in-12100">Changes in 12.10.0</h3>

<ul>
  <li>Java: Add support for HotSpot JVM. Uses JVMTI to enumerate classes and choose
objects. Method interception works if the JVM library has symbols (default
with JDK on macOS). Tested on macOS with java 8, 11, 13, 14. Thanks
<a href="https://twitter.com/0xraaz">@0xraaz</a>!</li>
  <li>Java: Fix non-return from <em>_getUsedClass()</em>, where calling <em>Java.use()</em> twice
without using <em>Java.perform()</em> would result in <em>_getUsedClass()</em> getting stuck
in an infinite sleep loop. Thanks <a href="https://twitter.com/0xraaz">@0xraaz</a>!</li>
  <li>Java: Fix <em>$alloc()</em>, which got broken by the refactoring a while back.</li>
  <li>ObjC: Add <em>Block.declare()</em> to be able to work with blocks without signature
metadata.</li>
  <li>ObjC: Fix ObjC <em>pointer</em> handling regression introduced in 12.9.8.</li>
</ul>

<h3 id="changes-in-12101">Changes in 12.10.1</h3>

<ul>
  <li>Java: Allow ClassFactory.get(null), for convenience when using
enumerateMethods().</li>
  <li>Java: Restore the JVM method adjustment logic, which got accidentally dropped
from the pull-request. Thanks <a href="https://twitter.com/0xraaz">@0xraaz</a>!</li>
</ul>

<h3 id="changes-in-12102">Changes in 12.10.2</h3>

<ul>
  <li>Fix handling of long symbol names on i/macOS. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Java: Fix JVM interception issues for static/final methods. Thanks
<a href="https://twitter.com/0xraaz">@0xraaz</a>!</li>
  <li>Fix Stalker ARM handling of Thumb-2 “mov pc, &lt;reg&gt;”.</li>
  <li>Fix Stalker ARM handling of volatile VFP registers.</li>
</ul>

<h3 id="changes-in-12103">Changes in 12.10.3</h3>

<ul>
  <li>Fix device removal wiring in the Fruity backend. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>Avoid clobbering R9 in <em>ArmWriter.put_branch_address()</em>.</li>
  <li>Add <em>ThumbWriter.can_branch_directly_between()</em>.</li>
  <li>Add <em>ThumbWriter.put_branch_address()</em>.</li>
  <li>Improve ThumbRelocator to handle ADR.</li>
  <li>Fix Stalker ARM block corruption.</li>
  <li>Fix Stalker ARM block recycling logic for Thumb blocks.</li>
  <li>Add missing Stalker ARM continuation logic, to support long basic blocks.</li>
  <li>Implement Stalker ARM backpatching logic to improve performance, typically 5x.</li>
</ul>

<h3 id="changes-in-12104">Changes in 12.10.4</h3>

<ul>
  <li>Fix encoding of <em>Module.name</em> in the V8 runtime. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2020/05/19/frida-12-9-released/index.html">
      Frida 12.9 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      19 May 2020
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Our previous big release was all about <a href="../../docs/stalker/index.html">Stalker</a>. For those of you not yet
familiar with it, it’s basically a code tracing engine – allowing threads to be
followed, capturing every function, every block, even every instruction which is
executed. Beyond just tracing code, it also allows you to add and remove
instructions anywhere. It even uses advanced JIT tricks to make all of this
really fast.</p>

<p>That may still sound a little abstract, so let’s have a look at a couple of
examples. One way to use it is when you want to determine “<a href="https://codeshare.frida.re/@oleavr/who-does-it-call/">what other functions
does this function call</a>”. Or, perhaps you’d like to use Apple’s speech
synthesizer to announce the RAX register’s value at every RET instruction in
code belonging to the app? <a href="https://github.com/frida/frida-presentations/blob/master/R2Con2017/02-transforms/06-return-values.js">Here</a> is how that can be done. This was one of the
demos at my <a href="https://youtu.be/sBcLPLtqGYU">r2con presentation</a> back in 2017.</p>

<p>Up until now Stalker has only been available on Intel architectures and ARM64.
So I’m really excited to announce that Stalker is now also available on ARM32!
Yay! 🎉 I’m hopeful that this sorely missed Stalker backend will motivate a lot
of you to start building really cool things on top of Stalker. I feel like it
has a ton of potential beyond “just” code tracing. And combined with <a href="../../docs/javascript-api/index.html#cmodule">CModule</a>
it’s become really easy to balance rapid prototyping and dynamic behavior with
performance.</p>

<p>There’s so much to talk about in this release. One of the other major changes is
that we have upgraded all of our dependencies. Most interesting among them is
probably V8, which we have upgraded to 8.4. This means you can use all of the
latest JavaScript language features such as <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Optional_chaining">optional chaining</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Nullish_coalescing_operator">nullish
coalescing operator</a> without having to <a href="https://github.com/oleavr/frida-agent-example">frida-compile</a> your agent. That, and
performance improvements, another area where V8 just keeps on getting better and
better.</p>

<p>We’ve also just added support for Android 11 Developer Preview 4, and iOS/arm64e
apps are now fully supported even on jailed iOS. Things have improved so much
across all of our supported platforms. One thing in particular that I’d like to
highlight is that we have finally eliminated a long-standing resource <a href="https://github.com/svaarala/duktape/pull/2282">leak</a>
affecting our Duktape-based JS runtime – a bug that’s been around for as long as
we’ve been using Duktape as our default JS runtime.</p>

<p>Anyway, there’s really no easy way to dig into all of the areas where things
have improved, so definitely check out the changelog below.</p>

<p>Enjoy!</p>

<h3 id="changes-in-1290">Changes in 12.9.0</h3>

<ul>
  <li>Stalker now also available on ARM32. 🎉</li>
  <li>Stalker JS integrations no longer clobber <em>errno</em> / <em>LastError</em>.</li>
  <li><em>Stalker.follow()</em> now reliable on x86 and ARM64, including when the target
thread is in a syscall on Windows.</li>
  <li>Stalker is finally reliable on WoW64. Thanks <a href="https://github.com/zuypt">@zuypt</a>!</li>
  <li>All dependencies have been updated to the latest and greatest. Most exciting
is V8 8.4, supporting the latest JavaScript language features.</li>
  <li>Long-standing Duktape memory leak finally discovered and fixed. Thanks to
<a href="https://github.com/disazoz">@disazoz</a> for the bug-report that lead to this breakthrough.</li>
  <li><em>Socket.connect()</em> no longer leaks the file-descriptor (and associated memory)
on error. (Fixed by the GLib dependency upgrade.) Thanks for reporting,
<a href="https://github.com/1215clf">@1215clf</a>!</li>
  <li><em>Kernel.read*()</em> no longer leaks in the V8 runtime.</li>
  <li>UNIX build system moved to Meson 0.54.</li>
  <li>Windows build system moved to VS2019.</li>
  <li>Node.js prebuilds provided for v14, in addition to v10 and v12.</li>
  <li>Electron prebuilds provided for v8 and v9.</li>
  <li>Fedora packages for F32.</li>
  <li>Ubuntu packages for Ubuntu 20.04.</li>
  <li>Python bindings no longer using any deprecated APIs.</li>
  <li>Support for leanback-only Android apps. Thanks <a href="https://github.com/5murfette">@5murfette</a>!</li>
  <li>iOS jailed spawn() w/o closure supported on arm64e. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>iOS usbmux pairing record plist parsing now also handles binary plists,
fixing a long-standing issue where Frida would reject a tethered iOS USB
device. Thanks <a href="https://github.com/pachoo">@pachoo</a>!</li>
  <li><em>ObjC.choose()</em> also supported on arm64e. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li><em>ObjC.protocols</em> enumeration finally working properly, and not just the first
time. Thanks for reporting, <a href="https://twitter.com/CodeColorist">@CodeColorist</a>!</li>
  <li>Initial support for Android 11 Developer Preview. Thanks <a href="https://github.com/abdawoud">@abdawoud</a>!</li>
  <li>MUSL libc compatibility.</li>
  <li>Support for older versions of glibc, so our binaries can run on a wide variety
of desktop Linux systems.</li>
  <li>Libc shim also covers <em>memalign()</em> and supports newer GNU toolchains.</li>
  <li>Exceptor’s POSIX backend is now detecting Thumb correctly on ARM32, which
would previously result in random crashes.</li>
  <li>Exceptor no longer clobbers “rflags” (x86_64) and “cpsr” (ARM64) on i/macOS,
and provides write access to the native context.</li>
  <li>Four essential i/macOS 64-bit syscalls added to the libc shim: <em>read()</em>,
<em>write()</em>, <em>mmap()</em>, <em>munmap()</em>. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>iOS binaries now signed with the “skip-library-validation” entitlement for
convenience. Thanks <a href="https://twitter.com/elvanderb">@elvanderb</a>!</li>
  <li>The frida-core Vala API bindings are no longer missing the <em>frida.Error</em> type.</li>
  <li>Our scripts now allow messages to be <em>post()</em>ed to them while they are in the
<em>LOADING</em> state. This is useful when a script needs to make a synchronous
request during <em>load()</em>. Thanks <a href="https://github.com/Gbps">@Gbps</a>!</li>
  <li>Gadget finally supports early instrumentation with the V8 runtime on 64-bit
ELF targets, where constructor functions would previously be run in the wrong
order. Thanks <a href="https://github.com/tacesrever">@tacesrever</a>!</li>
  <li>Support for ADB channels beyond just TCP in <em>Device.open_channel()</em>.
Thanks <a href="https://github.com/aemmitt-ns">@aemmitt-ns</a>!</li>
  <li>Many new instructions supported in the <em>ArmWriter</em> and <em>ThumbWriter</em> APIs.</li>
  <li>Massive improvements to our ARM32 relocator implementations.</li>
  <li>Linux module enumeration working when invoked through loader.</li>
  <li>Linux symbol resolution improvements.</li>
  <li>Better argument list handling in the V8 runtime, treating <em>undefined</em> the same
as in the Duktape runtime. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>CModule Stalker API is back in working order.</li>
  <li>CModule runtime now exposes <em>Thread.{get,set}_system_error()</em>.</li>
  <li>CModule is now a stub on Linux/MIPS, instead of failing to compile due to
TinyCC not yet supporting MIPS.</li>
  <li>Capstone configured to support ARMv8 A32 encodings.</li>
</ul>

<h3 id="changes-in-1291">Changes in 12.9.1</h3>

<ul>
  <li>The Python bindings’ setup.py does the right thing for Python 3.x on macOS.</li>
</ul>

<h3 id="changes-in-1292">Changes in 12.9.2</h3>

<ul>
  <li>Fruity (iOS USB) backend no longer emits a warning on stdio.</li>
</ul>

<h3 id="changes-in-1293">Changes in 12.9.3</h3>

<ul>
  <li>Android 11 Developer Preview 4 is now supported. Thanks for the assist,
<a href="https://twitter.com/enovella_">@enovella_</a>!</li>
  <li>Linux file monitoring is back in great shape.</li>
  <li>ArmRelocator properly relocates ADD instructions involving the PC register.</li>
  <li>ThumbRelocator properly handles IT blocks containing an unconditional branch.
This means Interceptor is able to hook even more tricky cases. Thanks
<a href="https://github.com/bet4it">@bet4it</a>!</li>
  <li>Stalker ARM32 also supports clone syscalls in Thumb mode.</li>
  <li>Stalker ARM32 now suppresses events around exclusive ops like the ARM64
backend.</li>
  <li>Stalker ARM32 trust threshold support.</li>
  <li>Improved error-handling in ObjC and Java bridges, to avoid crashing the
process on unsupported OSes.</li>
</ul>

<h3 id="changes-in-1294">Changes in 12.9.4</h3>

<ul>
  <li><em>ObjC.available</em> no longer pretends that the Objective-C runtime is available
when it indeed is not. The error-handling refactoring in 12.9.3 broke this,
and the regression went unnoticed due to this being a blind spot in our test
coverage.</li>
  <li>Electron v9 is out, so we now only provide prebuilds for v9.</li>
</ul>

<h3 id="changes-in-1295">Changes in 12.9.5</h3>

<ul>
  <li>iOS early instrumentation – i.e. spawn() – supported on latest unc0ver.</li>
  <li>iOS crash reporter integration ported to iOS 13.5.</li>
  <li><em>SystemFunction</em> now implements <em>call()</em> and <em>apply()</em> in the Duktape runtime,
and not only in the V8 runtime.</li>
  <li>Java bridge finally handles strings with embedded nuls, fixing a long-standing
issue that’s been around for as long as the Java bridge has existed. Thanks
<a href="https://github.com/tacesrever">@tacesrever</a>!</li>
</ul>

<h3 id="changes-in-1296">Changes in 12.9.6</h3>

<ul>
  <li>No changes except for proper Windows binaries this time. The Windows CI worker
did not actually build anything last time around, and released stale binaries.</li>
</ul>

<h3 id="changes-in-1297">Changes in 12.9.7</h3>

<ul>
  <li>iOS early instrumentation more reliable on the unc0ver jailbreak: we now load
<em>substrate-inserter.dylib</em> as part of our early instrumentation. This means
it gets a chance to bootstrap the process, and lets you hook system APIs
hooked by the bootstrapper without worrying about the bootstrapper getting
confused when it encounters your hooks. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
</ul>

<h3 id="changes-in-1298">Changes in 12.9.8</h3>

<ul>
  <li>ApiResolver implementations now support case-insensitive matching by appending
“/i” to the query string. Thanks <a href="https://twitter.com/Hexploitable">@Hexploitable</a>!</li>
  <li>The <em>module</em> ApiResolver no longer leaks the <em>MatchInfo</em> instance.</li>
  <li>CModule runtime gained <em>GLib.PatternSpec</em> and GLib UTF-8 case helpers.</li>
  <li><em>DebugSymbol.load()</em> introduced to be able to explicitly load debug symbols.
For now this is only implemented on Windows, where we now also support
“module!symbol” notation for improved performance and precision. Thanks
<a href="https://twitter.com/ohjeongwook">@ohjeongwook</a>!</li>
  <li>Java bridge got a brand new API: <em>Java.enumerateMethods(query)</em> This enables
efficiently locating methods matching a given query.</li>
  <li><em>ObjC.choose()</em> no longer crashes due to a lifetime issue only reproducible in
our V8 runtime.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2019/12/18/frida-12-8-released/index.html">
      Frida 12.8 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      18 Dec 2019
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Get ready for an exciting new release. This time around we’re giving some long
overdue love to our <a href="../../docs/javascript-api/index.html#stalker">Stalker</a> engine. It’s been around for roughly ten years,
but it wasn’t until Frida 10.5 in late 2017 that we <a href="../2017/08/25/frida-10-5-released/index.html">started</a> unleashing its
massive potential.</p>

<p>Up until now we were able to Stalker.follow() existing threads and not only
observe them, but also mutate their instruction streams any way we’d like. It
could also be combined with Interceptor to instrument the current thread
between strategic points. This allowed us to build tools such as <a href="https://github.com/nowsecure/airspy">AirSpy</a>.</p>

<p>But, what if we want to Stalker.follow() a NativeFunction call? This may seem
really simple, but reentrancy makes this really hard. It’s easy to end up
following execution inside e.g. our private heap, and end up needing to allocate
memory for the instrumentation itself… all kinds of fun scenarios that are
mind-boggling to reason about.</p>

<p>The way we dealt with this was to teach Stalker to exclude certain memory
ranges, so that if it sees a call going to such a location it will simply emit
a call instruction there instead of following execution. So what we did was to
automatically exclude frida-agent’s own memory range, and that way we didn’t
have to deal with any of the reentrancy madness.</p>

<p>We also took care to special-case attempts to Stalker.follow() the current
thread, so that we queued that work until we’re about to leave our runtime
and transition back into user code (or our main loop, in the case of the JS
thread).</p>

<p>That still left the big unanswered question of how to use Stalker in conjunction
with NativeFunction. We can now finally put that behind us:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">open</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NativeFunction</span><span class="p">(</span>
    <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">open</span><span class="dl">'</span><span class="p">),</span>
    <span class="dl">'</span><span class="s1">int</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">pointer</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">int</span><span class="dl">'</span><span class="p">],</span>
    <span class="p">{</span> <span class="na">traps</span><span class="p">:</span> <span class="dl">'</span><span class="s1">all</span><span class="dl">'</span> <span class="p">}</span>
<span class="p">);</span>

<span class="nx">Stalker</span><span class="p">.</span><span class="nx">follow</span><span class="p">({</span>
  <span class="na">events</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">call</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="nx">onReceive</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">Stalker</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">e</span><span class="p">)));</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">fd</span> <span class="o">=</span> <span class="nx">open</span><span class="p">(</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">allocUtf8String</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo/bar</span><span class="dl">'</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">open() =&gt;</span><span class="dl">'</span><span class="p">,</span> <span class="nx">fd</span><span class="p">);</span></code></pre></figure>

<p>By setting the <code class="language-plaintext highlighter-rouge">traps: 'all'</code> option on the NativeFunction, it will re-activate
Stalker when called from a thread where Stalker is temporarily paused because
it’s calling out to an excluded range – which is the case here because all of
frida-agent’s code is marked as excluded.</p>

<p>We can also achieve the same goal for Objective-C methods:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">Stalker</span><span class="p">.</span><span class="nx">follow</span><span class="p">({</span>
  <span class="na">events</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">call</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="nx">onReceive</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">Stalker</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">e</span><span class="p">)));</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">NSAutoreleasePool</span> <span class="o">=</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">NSAutoreleasePool</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">NSFileManager</span> <span class="o">=</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">NSFileManager</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">fileExistsAtPath</span> <span class="o">=</span> <span class="nx">NSFileManager</span><span class="p">[</span><span class="dl">'</span><span class="s1">- fileExistsAtPath:</span><span class="dl">'</span><span class="p">]</span>
    <span class="p">.</span><span class="nx">clone</span><span class="p">({</span> <span class="na">traps</span><span class="p">:</span> <span class="dl">'</span><span class="s1">all</span><span class="dl">'</span> <span class="p">});</span>

<span class="kd">const</span> <span class="nx">pool</span> <span class="o">=</span> <span class="nx">NSAutoreleasePool</span><span class="p">.</span><span class="nx">alloc</span><span class="p">().</span><span class="nx">init</span><span class="p">();</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">manager</span> <span class="o">=</span> <span class="nx">NSFileManager</span><span class="p">.</span><span class="nx">defaultManager</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">fileExistsAtPath</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">manager</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/foo/bar</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">fileExistsAtPath() =&gt;</span><span class="dl">'</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
<span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
  <span class="nx">pool</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>And also for Java methods on Android:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">Stalker</span><span class="p">.</span><span class="nx">follow</span><span class="p">({</span>
  <span class="na">events</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">call</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="nx">onReceive</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">Stalker</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">e</span><span class="p">)));</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">JFile</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">java.io.File</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">exists</span> <span class="o">=</span> <span class="nx">JFile</span><span class="p">.</span><span class="nx">exists</span><span class="p">.</span><span class="nx">clone</span><span class="p">({</span> <span class="na">traps</span><span class="p">:</span> <span class="dl">'</span><span class="s1">all</span><span class="dl">'</span> <span class="p">});</span>

  <span class="kd">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">JFile</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo/bar</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">exists</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">exists() =&gt;</span><span class="dl">'</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure>

<p>Yay. That said, these examples are barely scratching the surface of what’s
possible using Stalker. One of the really cool use-cases is in-process fuzzing,
which <a href="https://twitter.com/andreafioraldi/status/1205194910372110337">frida-fuzz</a> is a great example of. There’s also a bunch of other
use-cases, such as reversing, measuring code coverage, fault injection for
testing purposes, hooking inline syscalls, etc.</p>

<p>So that’s the main story of this release. Would like to thank
<a href="https://twitter.com/andreafioraldi">@andreafioraldi</a> for the great bug-reports and help testing these tricky
changes.</p>

<h3 id="wrapping-up">Wrapping up</h3>

<p>One cool new feature worth mentioning is the new <code class="language-plaintext highlighter-rouge">ArrayBuffer.wrap()</code> API, which
allows you to conveniently and efficiently access memory regions as if they were
JavaScript arrays:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">header</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">alloc</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nb">ArrayBuffer</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">header</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
<span class="nx">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
<span class="nx">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hexdump</span><span class="p">(</span><span class="nx">header</span><span class="p">,</span> <span class="p">{</span> <span class="na">length</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="na">ansi</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">First byte is:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span></code></pre></figure>

<p>This means you can hand over direct memory access to JavaScript APIs without
needing to copy memory in/out of the runtime. The only drawback is that bad
pointers won’t result in a JS exception, and will crash the process.</p>

<p>We now also allow you to access the backing store of any ArrayBuffer, through
the new <code class="language-plaintext highlighter-rouge">unwrap()</code> method on ArrayBuffer. An example use-case for this is when
using an existing module such as <a href="https://github.com/nowsecure/frida-fs">frida-fs</a> where you get an ArrayBuffer that
you then want to pass to native code.</p>

<p>Kudos to <a href="https://twitter.com/DaveManouchehri">@DaveManouchehri</a> for contributing the first draft of the
ArrayBuffer.wrap() API, and also big thanks to <a href="https://twitter.com/CodeColorist">@CodeColorist</a> for suggesting
and helping shape the unwrap() feature.</p>

<h3 id="changes-in-1280">Changes in 12.8.0</h3>

<ul>
  <li>Stalker reactivation working properly.</li>
  <li>Stalker thread lifetime properly handled. Will also no longer crash when
following a thread to its death on i/macOS.</li>
  <li>Safer garbage collection logic in Stalker.</li>
  <li>Making mistakes in the Stalker transform callback which ends up throwing a JS
exception now results in Stalker.unfollow(), so the error doesn’t get
swallowed by the process crashing.</li>
  <li>Robust support for Stalker transform calling unfollow().</li>
  <li>Stalker support for older x86 CPUs without AVX2 support.</li>
  <li>Support for disabling automatic Stalker queue drain.</li>
  <li>NativeFunction is better at handling exceptions through the brand new
Interceptor unwinding API.</li>
  <li>Java and ObjC APIs to specify NativeFunction options for methods through
clone(options), and blocks through the second argument to ObjC.Block().</li>
  <li>ObjC class and protocol caching logic finally works. Thanks <a href="https://github.com/gebing">@gebing</a>!</li>
  <li>The prebuilt Python 3 extension for Windows finally supports all Python 3
versions &gt;= 3.4 on Windows, just like on the other platforms.</li>
  <li>ArrayBuffer wrap() and unwrap().</li>
  <li>DebugSymbol API has better error-handling on Linux/Android.</li>
  <li>Java integration no longer crashes in recompileExceptionClearForArm64() in
system processes on Android 10.</li>
  <li>GumJS devkit on i/macOS supports V8 once again.</li>
</ul>

<h3 id="changes-in-1281">Changes in 12.8.1</h3>

<ul>
  <li>The CModule Stalker integration is back in business.</li>
</ul>

<h3 id="changes-in-1282">Changes in 12.8.2</h3>

<ul>
  <li>Thumb IT blocks are finally relocated correctly. This means we are able to
hook a lot more functions on 32-bit ARM targets, e.g. Android. Thanks
<a href="https://github.com/bigboysun">@bigboysun</a>!</li>
</ul>

<h3 id="changes-in-1283">Changes in 12.8.3</h3>

<ul>
  <li>Java.ClassFactory.get() introduced to be able to work with multiple class
loaders without worrying about colliding class names. This means that
assigning to the <em>loader</em> property is now considered deprecated. We still
keep it around for backwards compatibility, but using it alongside the new
API is not supported.</li>
  <li>Java.enumerateLoadedClasses() also provides class handles and not just names.</li>
  <li>The JNI GetByteArrayRegion() function is now part of the Env wrapper. Thanks
<a href="https://github.com/iddoeldor">@iddoeldor</a>!</li>
</ul>

<h3 id="changes-in-1284">Changes in 12.8.4</h3>

<ul>
  <li>Internal hooks no longer result in crashes on Linux/ELF targets when PLT/GOT
entries haven’t been warmed up.</li>
</ul>

<h3 id="changes-in-1285">Changes in 12.8.5</h3>

<ul>
  <li>Python bindings finally provide properly encoded error messages on Python 2.x.</li>
</ul>

<h3 id="changes-in-1286">Changes in 12.8.6</h3>

<ul>
  <li>Android linker detection is finally working again in sandboxed processes.
This was a regression introduced in 12.7.8. Kudos to <a href="https://twitter.com/DaveManouchehri">@DaveManouchehri</a>
for reporting and helping track this one down!</li>
</ul>

<h3 id="changes-in-1287">Changes in 12.8.7</h3>

<ul>
  <li>Our Node.js <em>IOStream</em> bindings received two critical stability improvements.
Turns out the cancellation logic had a race-condition that resulted in the
cancellable not always being used. There was also a bug in the teardown logic
that could result in a stream being closed before all I/O operations had
completed. Kudos to <a href="https://twitter.com/bezjaje">@mrmacete</a> for these awesome fixes!</li>
</ul>

<h3 id="changes-in-1288">Changes in 12.8.8</h3>

<ul>
  <li>Gadget no longer deadlocks on Android/Linux during early instrumentation
use-cases where Gadget’s entrypoint gets called with dynamic linker lock(s)
held. Due to Exceptor now using <em>dlsym()</em> to avoid running into PLT/GOT issues
during early instrumentation, we need to ensure that Exceptor gets initialized
from the entrypoint thread, and not the Gadget thread.</li>
</ul>

<h3 id="changes-in-1289">Changes in 12.8.9</h3>

<ul>
  <li>Stalker’s JavaScript integration is no longer performing a use-after-free in
<em>EventSink::stop()</em>, i.e. after <em>Stalker.unfollow()</em>.</li>
</ul>

<h3 id="changes-in-12810">Changes in 12.8.10</h3>

<ul>
  <li>Gadget is once again able to run on iOS without a debugger present. This was a
regression introduced in 12.8.8. Kudos to <a href="https://github.com/ddzobov">@ddzobov</a> for reporting!</li>
</ul>

<h3 id="changes-in-12811">Changes in 12.8.11</h3>

<ul>
  <li>The i/macOS Exceptor’s API hooks no longer perform an OOB write when a
user of the Mach exception handling APIs only requests a subset of the
handlers. Such a user would typically be a crash reporter or analytics
framework.</li>
  <li>Electron prebuilds are now provided for v8 (stable) and v9 (beta). We no
longer provide prebuilds for v7.</li>
</ul>

<h3 id="changes-in-12812">Changes in 12.8.12</h3>

<ul>
  <li>Massively overhauled Android Java integration, now using Proxy objects and
CModule to lazily resolve things. And no more <em>eval</em>-usage to dynamically
generate method and field wrappers – i.e. less memory required per wrapper
generated. All of these changes reduce memory usage and allow <em>Java.use()</em>
to complete much faster.</li>
  <li>Android Java integration provides uncensored access to methods and fields on
Android versions that attempt to hide private APIs, i.e. Android &gt;= 9.</li>
  <li>Way faster Android device enumeration. No longer running any <em>adb shell</em>
commands to determine the device name when the locally running ADB daemon is
new enough (i.e. ADB &gt;= sometime during 2017).</li>
  <li>We’ve finally eliminated a long-standing memory leak on Linux-based OSes,
affecting restricted processes such as <em>zygote</em> and <em>system_server</em> on newer
versions of Android. This was a bug in our logic that garbage-collects
thread-local data shortly after a given thread has exited. The mechanism that
determines that the thread has indeed finished exiting would fail and never
consider the thread gone. This would result in more and more garbage
accumulating, with a longer and longer collection of garbage to iterate over.
So not only would we be spending increasingly more time on futile GC attempts,
we would also be eating CPU retrying a GC every 50 ms.</li>
  <li>The Python bindings allow obtaining a file-descriptor from a Cancellable in
order to integrate it into event loops and other <em>poll()</em>-style use-cases.
Worth noting that frida-tools 7.0.1 is out with a major improvement built on
this: The CLI tools no longer delay for up to 500 ms before exiting. So
short-lived programs like <em>frida-ls-devices</em> and <em>frida-ps</em> now feel very
snappy.</li>
  <li>Duktape source-map handling now also works with scripts loaded by the REPL –
where the inline source-map isn’t the last line of the script due to the REPL
appending its own code. This means stack-traces always contain meaningful
filenames and line numbers.</li>
  <li>Duktape: the baked in JavaScript runtime – i.e. GumJS’ glue code, ObjC, and
Java – is now Babelified with the <em>loose</em> option enabled, to reduce bloat and
improve performance. No modern JavaScript data structures leak out through the
APIs, so there’s no need to have Babel be spec-compliant.</li>
  <li>V8: the baked in JavaScript runtime is compressed, for a smaller footprint and
faster code. This was previously only done to the Duktape one.</li>
  <li>Better Linux process name heuristics in <em>enumerate_processes()</em>.</li>
</ul>

<h3 id="changes-in-12813">Changes in 12.8.13</h3>

<ul>
  <li><em>Java.performNow()</em> is back in working order.</li>
  <li>Python bindings’ setup.py now looks for a local <em>.egg</em> before attempting to
download one, and expects the download to complete within two minutes.
Kudos to <a href="https://github.com/XieEDeHeiShou">@XieEDeHeiShou</a> for these nice improvements!</li>
</ul>

<h3 id="changes-in-12814">Changes in 12.8.14</h3>

<ul>
  <li>The iOS Simulator is now properly supported, both in Gadget form and attaching
to a running Simulator process from macOS. Kudos to <a href="https://twitter.com/insitusec">@insitusec</a> for helping
fix these issues!</li>
  <li>Gadget now also looks for its .config in the directory above on iOS, but only
if its parent directory is named “Frameworks”. Kudos to <a href="https://twitter.com/insitusec">@insitusec</a> for
the suggestion!</li>
</ul>

<h3 id="changes-in-12815">Changes in 12.8.15</h3>

<ul>
  <li>Brand new feature-complete support for iOS/arm64e, including new
<em>NativePointer</em> methods: <em>sign()</em>, <em>strip()</em>, <em>blend()</em>.</li>
  <li>Latest iOS Unc0ver jailbreak is now supported. Kudos to <a href="https://twitter.com/bezjaje">@mrmacete</a> for
the pull-request, and <a href="https://twitter.com/Pwn20wnd">@Pwn20wnd</a> for the assistance! ❤️</li>
  <li>Improved support for the Chimera jailbreak, making sure its
<em>pspawn_payload-stg2.dylib</em> is initialized. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>The i/macOS injector no longer fails when an agent entrypoint returns
instantly.</li>
  <li>Better error message about needing Gadget for jailed iOS.</li>
  <li>Improved error-handling in the Windows injector to avoid crashing the target
process when our DLL injection fails. Kudos <a href="https://github.com/dasraf9">@dasraf9</a>!</li>
  <li>Support for injection into live newborn targets on i/macOS, and also no longer
treating suspended processes as needing to be prepared for injection,
regardless of whether they actually need it.</li>
  <li>Improved iOS fault tolerance, handling frontmost iOS app name query failing.</li>
  <li>Improved Android fault tolerance, handling <em>zygote</em> and <em>system_server</em>
processes dying without having to restart <em>frida-server</em>.</li>
  <li>Now able to launch <em>frida-server</em> during boot on Android 10, as
<em>LD_LIBRARY_PATH</em> no longer interferes with the spawning of <em>frida-helper-32</em>.
Kudos to <a href="https://twitter.com/enovella_">@enovella</a> for helping track this one down!</li>
  <li>No more infinite loop when failing to handle <em>SIGABRT</em> on UNIXy platforms.</li>
  <li>We now support nested signals in Exceptor’s POSIX backend. Kudos <a href="https://twitter.com/bannsec">@bannsec</a>!</li>
  <li>Proper handling of invalid Windows ANSI strings. Thanks, <a href="https://github.com/clouds56">@clouds56</a>!</li>
  <li><em>Java.perform()</em> working properly again on Android &lt; 5.</li>
  <li>Improved varargs-handling in <em>NativeFunction</em>, now promoting varargs smaller
than int. Thanks for reporting, <a href="https://github.com/0x410c">@0x410c</a>!</li>
</ul>

<h3 id="changes-in-12816">Changes in 12.8.16</h3>

<ul>
  <li>Large CModule instances now working on iOS systems with 16K pages. Kudos to
<a href="https://twitter.com/bezjaje">@mrmacete</a> for discovering and fixing this long-standing issue!</li>
  <li>Stalker also works in arm64 processes on iOS/arm64e. Kudos to <a href="https://twitter.com/AeonLucid">@AeonLucid</a>
for reporting and helping track this one down!</li>
</ul>

<h3 id="changes-in-12817">Changes in 12.8.17</h3>

<ul>
  <li>Support for injection into live newborn targets on i/macOS turned out to cause
regressions, so we’ve reverted it for now. Specifically, <em>notifyd</em> on iOS 12.4
is a case where <em>libSystemInitialized</em> is not getting set. Need to dig deeper
to figure out why, so decided to walk back this logic for now.</li>
</ul>

<h3 id="changes-in-12818">Changes in 12.8.18</h3>

<ul>
  <li>New and improved <em>Java.scheduleOnMainThread()</em> to allow calling APIs such as
<em>getApplicationContext()</em>. Kudos to <a href="https://twitter.com/giantpune">@giantpune</a> for reporting!</li>
  <li>Ability to hook CriticalNative methods on newer versions of Android. Kudos to
<a href="https://github.com/abdawoud">@abdawoud</a> for reporting!</li>
</ul>

<h3 id="changes-in-12819">Changes in 12.8.19</h3>

<ul>
  <li>Scripts are now properly cleaned up if destroyed without first being loaded.
This ensures that ultimately when the script core is disposed, it in turn
disposes its reference to the Exceptor. Failing to do so causes indefinite
hang when attaching after detaching in presence of unloaded scripts, due to
the Exceptor thread remaining in the target process. Kudos to <a href="https://twitter.com/bezjaje">@mrmacete</a>
for discovering and fixing this long-standing issue!</li>
</ul>

<h3 id="changes-in-12820">Changes in 12.8.20</h3>

<ul>
  <li>The <em>remove_remote_device()</em> API is back in working order. This was an
unfortunate regression introduced in 12.7.17. Thanks for reporting,
<a href="https://twitter.com/CodeColorist">@CodeColorist</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2019/09/18/frida-12-7-released/index.html">
      Frida 12.7 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      18 Sep 2019
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>There’s only one new feature this time, but it’s a big one. We’re going to
address the elephant in the room: performance.</p>

<p>While Frida’s instrumentation core, Gum, is written in C and can be used from C,
most use-cases are better off using its JavaScript bindings.</p>

<p>There are however situations where performance becomes an issue. Even when using
our V8-based runtime, which means your JavaScript will be profiled while it’s
running and optimized based on where the hotspots are… (Which by the way is
amazing – V8 is truly an impressive feat of engineering!)</p>

<p>…there is a small price to pay for entering and leaving the JavaScript VM.
On an iPhone 5S this might amount to something like six microseconds if you
use <em>Interceptor.attach()</em> and only specify <em>onEnter</em>, and leave it empty.</p>

<p>This may not sound like a lot, but if a function is called a million times,
it’s going to amount to 6 seconds of added overhead. And perhaps the hook only
needs to do something really simple, so most of the time is actually spent on
entering and leaving the VM.</p>

<p>There’s also the same kind of issue when needing to pass a callback to an API,
where the API walks through potentially millions of items and needs to call the
callback for each of them. The callback might just look at one byte and collect
the few of the items that match a certain criteria.</p>

<p>Naively one could go ahead and use a NativeCallback to implement that callback,
but it quickly becomes apparent that this just doesn’t scale.</p>

<p>Or, you might be writing a fuzzer and needing to call a NativeFunction in a
tight loop, and the cost of entering/leaving the VM plus libffi just adds up.</p>

<p>Short of writing the whole agent in C, one could go ahead and build a native
library, and load it using <em>Module.load()</em>. This works but means it has to be
compiled for every single architecture, deployed to the target, etc.</p>

<p>Another solution is to use the X86Writer/Arm64Writer/etc. APIs to generate
code at runtime. This is also painful as there’s quite a bit of work required
for each architecture to be supported. But up until now this was the only
portable option for use in modules such as <a href="https://github.com/frida/frida-java-bridge">frida-java-bridge</a>.</p>

<p>But now we finally have something much better. Enter <strong>CModule</strong>:</p>

<p><img src="../../img/cmodule-hello-world.png" alt="CModule Hello World" title="CModule Hello World" /></p>

<p>It takes the string of C source code and compiles it to machine code, straight
to memory. This is implemented using <a href="https://bellard.org/tcc/">TinyCC</a>, which means that this feature
only adds ~100 kB of footprint to Frida.</p>

<p>As you can see, any global functions are automatically exported as NativePointer
properties named exactly like in the C source code.</p>

<p>And, it’s fast:</p>

<p><img src="../../img/cmodule-speed.png" alt="CModule Speed" title="CModule Speed" /></p>

<p>(Measured on an Intel i7 @ 3.1 GHz.)</p>

<p>We can also use this new feature in conjunction with APIs like Interceptor:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CModule</span><span class="p">(</span><span class="s2">`
#include &lt;gum/guminterceptor.h&gt;

#define EPERM 1

int
open (const char * path,
      int oflag,
      ...)
{
  GumInvocationContext * ic;

  ic = gum_interceptor_get_current_invocation ();
  ic-&gt;system_error = EPERM;

  return -1;
}
`</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">openImpl</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">open</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">openImpl</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">open</span><span class="p">);</span></code></pre></figure>

<p>(Note that this and the following examples use modern JavaScript features like
template literals, so they either need to be run on our V8 runtime, or compiled
using <a href="https://github.com/oleavr/frida-agent-example">frida-compile</a>.)</p>

<p>We can also combine it with <em>Interceptor.attach()</em>:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">openImpl</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">open</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">openImpl</span><span class="p">,</span> <span class="k">new</span> <span class="nx">CModule</span><span class="p">(</span><span class="s2">`
  #include &lt;gum/guminterceptor.h&gt;
  #include &lt;stdio.h&gt;

  void
  onEnter (GumInvocationContext * ic)
  {
    const char * path;

    path = gum_invocation_context_get_nth_argument (ic, 0);

    printf ("open() path=\\"%s\\"\\n", path);
  }

  void
  onLeave (GumInvocationContext * ic)
  {
    int fd;

    fd = (int) gum_invocation_context_get_return_value (ic);

    printf ("=&gt; fd=%d\\n", fd);
  }
`</span><span class="p">));</span></code></pre></figure>

<p>Yay. Though this last particular example actually writes to <em>stdout</em> of the
target process, which is fine for debugging but probably not all that useful.</p>

<p>We can however fix that by calling back into JavaScript. Let’s see what that
might look like:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">openImpl</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">open</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">openImpl</span><span class="p">,</span> <span class="k">new</span> <span class="nx">CModule</span><span class="p">(</span><span class="s2">`
  #include &lt;gum/guminterceptor.h&gt;

  extern void onMessage (const gchar * message);

  static void log (const gchar * format, ...);

  void
  onEnter (GumInvocationContext * ic)
  {
    const char * path;

    path = gum_invocation_context_get_nth_argument (ic, 0);

    log ("open() path=\\"%s\\"", path);
  }

  void
  onLeave (GumInvocationContext * ic)
  {
    int fd;

    fd = (int) gum_invocation_context_get_return_value (ic);

    log ("=&gt; fd=%d", fd);
  }

  static void
  log (const gchar * format,
       ...)
  {
    gchar * message;
    va_list args;

    va_start (args, format);
    message = g_strdup_vprintf (format, args);
    va_end (args);

    onMessage (message);

    g_free (message);
  }
`</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">onMessage</span><span class="p">:</span> <span class="k">new</span> <span class="nx">NativeCallback</span><span class="p">(</span><span class="nx">messagePtr</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">messagePtr</span><span class="p">.</span><span class="nx">readUtf8String</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">onMessage:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
  <span class="p">},</span> <span class="dl">'</span><span class="s1">void</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">pointer</span><span class="dl">'</span><span class="p">])</span>
<span class="p">}));</span></code></pre></figure>

<p>That is however just a toy example: doing it this way will actually defeat the
purpose of writing the hooks in C to improve performance. A real implementation
might instead append to a <a href="https://developer.gnome.org/glib/stable/glib-Arrays.html">GLib.Array</a> after acquiring a <a href="https://developer.gnome.org/glib/stable/glib-Threads.html#GMutex">GLib.Mutex</a>, and
periodically flush the buffered data by calling back into JS.</p>

<p>And just like JavaScript functions can be called from C, we can also share data
between the two realms:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">calls</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">alloc</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">openImpl</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">open</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">openImpl</span><span class="p">,</span> <span class="k">new</span> <span class="nx">CModule</span><span class="p">(</span><span class="s2">`
  #include &lt;gum/guminterceptor.h&gt;

  extern volatile gint calls;

  void
  onEnter (GumInvocationContext * ic)
  {
    g_atomic_int_add (&amp;calls, 1);
  }
`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">calls</span> <span class="p">}));</span>

<span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Calls so far:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">readInt</span><span class="p">());</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">);</span></code></pre></figure>

<p>For now we don’t have any docs on the built-in C APIs, but you can browse the
headers in <a href="https://github.com/frida/frida-gum/tree/master/bindings/gumjs/runtime/cmodule">frida-gum/bindings/gumjs/runtime/cmodule</a> to get an overview.
Drop function names into an Internet search engine to look up docs for the
non-Frida APIs such as GLib’s.</p>

<p>The intention is to only expose a minimal subset of the standard C library,
GLib, JSON-GLib, and Gum APIs; in order to minimize bloat and maximize
performance. Things we include should either be impossible to achieve by calling
into JS, or prohibitively expensive to achieve that way.</p>

<p>Think of the JS side as the operating system where the functions you plug into
it are system calls; and only use CModule for hooking hot functions or
implementing high-performance glue code like callbacks passed to
performance-sensitive APIs.</p>

<p>Also bear in mind that the machine code generated by TinyCC is not as efficient
as that of Clang or GCC, so computationally expensive algorithms might actually
be faster to implement in JavaScript. (When using our V8-based runtime.) But for
hooks and glue code this difference isn’t significant, and you can always
generate machine code using e.g. Arm64Writer and plug into your CModule if you
need to optimize an inner loop.</p>

<p>One important caveat is that all data is read-only, so writable globals should
be declared <em>extern</em>, allocated using e.g. <em>Memory.alloc()</em>, and passed in as
symbols through the constructor’s second argument. (Like we did with <code class="language-plaintext highlighter-rouge">calls</code> in
the last example.)</p>

<p>You might also need to initialize things and clean them up when the CModule gets
destroyed – e.g. because the script got unloaded – and we provide a couple of
lifetime hooks for such purposes:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">cm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CModule</span><span class="p">(</span><span class="s2">`
#include &lt;stdio.h&gt;

void
init (void)
{
  printf ("init\\n");
}

void
finalize (void)
{
  printf ("finalize\\n");
}
`</span><span class="p">);</span>

<span class="nx">cm</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span> <span class="c1">// or wait until it gets GCed or script unloaded</span></code></pre></figure>

<p>Anyway, this post is getting long, but before we wrap up let’s look at how to
use CModule with the Stalker APIs:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">cm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CModule</span><span class="p">(</span><span class="s2">`
#include &lt;gum/gumstalker.h&gt;

static void on_ret (GumCpuContext * cpu_context,
    gpointer user_data);

void
transform (GumStalkerIterator * iterator,
           GumStalkerOutput * output,
           gpointer user_data)
{
  cs_insn * insn;

  while (gum_stalker_iterator_next (iterator, &amp;insn))
  {
    if (insn-&gt;id == X86_INS_RET)
    {
      gum_x86_writer_put_nop (output-&gt;writer.x86);
      gum_stalker_iterator_put_callout (iterator,
          on_ret, NULL, NULL);
    }

    gum_stalker_iterator_keep (iterator);
  }
}

static void
on_ret (GumCpuContext * cpu_context,
        gpointer user_data)
{
  printf ("on_ret!\n");
}
`</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">mainThread</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">enumerateThreads</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>

<span class="nx">Stalker</span><span class="p">.</span><span class="nx">follow</span><span class="p">(</span><span class="nx">mainThread</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">transform</span><span class="p">:</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">transform</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="nx">ptr</span><span class="p">(</span><span class="mi">1337</span><span class="p">)</span>
<span class="p">});</span></code></pre></figure>

<p>This shows how you can implement both the transform callback and the callouts
in C, but you may also use a hybrid approach where you write the transform
callback in JS and only some of the callouts in C.</p>

<p>It is also worth noting that I rewrote <em>ObjC.choose()</em> to use CModule, and it is
now roughly 100x faster. When testing it on the login screen of the Twitter app
on an iPhone 6S, this went from taking ~5 seconds to now only ~50 ms.</p>

<p>So with that, I hope you’ll enjoy this release. Excited to see what kind of
things you will build with the new CModule API. One thing I’m really looking
forward to is improving our REPL to support loading a <em>.c</em> file next to the
<em>.js</em>, for rapid prototyping purposes.</p>

<p>Enjoy!</p>

<h3 id="changes-in-1270">Changes in 12.7.0</h3>

<ul>
  <li>Brand new CModule API powered by TinyCC. (You just read about it.)</li>
  <li>TinyCC was improved to support Apple’s ABI on macOS/x86.</li>
  <li><em>Stalker.exclude()</em> is now exposed to JS to be able to mark specific memory
ranges as excluded. This is useful to improve performance and reduce noise.</li>
  <li>Concurrent calls to <em>Java.use()</em> are now supported, thanks to a neat
contribution by <a href="https://github.com/gebing">@gebing</a>.</li>
  <li>The <em>hexdump()</em> implementation was improved to clamp the <em>length</em> option to
the length of the ArrayBuffer, thanks to another neat contribution by
<a href="https://github.com/gebing">@gebing</a>.</li>
</ul>

<h3 id="changes-in-1271">Changes in 12.7.1</h3>

<ul>
  <li>More CModule goodies, including <a href="https://developer.gnome.org/glib/stable/glib-Strings.html">GLib.String</a>, <a href="https://developer.gnome.org/glib/stable/glib-Timers.html">GLib.Timer</a>, and
<a href="https://developer.gnome.org/json-glib/stable/JsonBuilder.html">Json.Builder</a>.</li>
  <li>TinyCC was improved to support Apple’s ABI on iOS/arm64.</li>
  <li><em>ObjC.choose()</em> was rewritten using CModule, and is now ~100x faster.</li>
</ul>

<h3 id="changes-in-1272">Changes in 12.7.2</h3>

<ul>
  <li>CModule got some missing ref-counting APIs.</li>
</ul>

<h3 id="changes-in-1273">Changes in 12.7.3</h3>

<ul>
  <li>CModule memory ranges are now properly cloaked.</li>
  <li>The V8 garbage collector is now informed about externally allocated CModule
memory so it can make better decisions about when to GC.</li>
  <li>Symbols attached to a CModule are now properly kept alive in the V8 runtime
also; and the CModule itself is not kept alive indefinitely (or until script
unload).</li>
  <li><em>CModule.dispose()</em> was added for eagerly cleaning up memory.</li>
</ul>

<h3 id="changes-in-1274">Changes in 12.7.4</h3>

<ul>
  <li>The <em>frida-inject</em> tool now supports <em>spawn()</em>. Kudos to <a href="https://github.com/hunterli">@hunterli</a> for
contributing this neat feature.</li>
  <li>Our V8 runtime no longer deadlocks on i/macOS when <em>thread_suspend()</em> is
called with the JS lock still held, like <em>Stalker.follow()</em> indirectly does
when asked to follow another thread.</li>
</ul>

<h3 id="changes-in-1275">Changes in 12.7.5</h3>

<ul>
  <li>Brand new channels API for establishing TCP connections to a tethered iOS
or Android device, as well as talking to lockdown services on a tethered
iOS device.</li>
  <li>The timeout logic behind <em>DeviceManager.find_device()</em> and its sibling methods
is now working properly.</li>
  <li>Java marshaling of <em>java.lang.Class</em> is now working properly, and instance
fields can also be introspected without needing an instance. Kudos to
<a href="https://github.com/gebing">@gebing</a> for contributing these neat fixes!</li>
</ul>

<h3 id="changes-in-1276">Changes in 12.7.6</h3>

<ul>
  <li>The Android linker is now properly detected on Android 10.</li>
  <li>Our Android SELinux policy patcher now also handles devices like Samsung S10,
thanks to a neat contribution by <a href="https://github.com/cbayet">@cbayet</a>.</li>
  <li>The <em>frida-inject</em> tool now supports <em>-D/–device</em> for working with non-local
devices.</li>
  <li>We now have better error-handling to avoid crashing when i/macOS processes
terminate unexpectedly during early instrumentation.</li>
  <li>iOS crash reporter integration is way more robust, thanks to some awesome
fixes contributed by <a href="https://twitter.com/bezjaje">@mrmacete</a>. One of his fixes also ensures parallel
calls to <em>recv().wait()</em> for the same message type don’t end up in an infinite
wait.</li>
  <li>Stalking of thread creation is now supported on Linux/arm64. Kudos to
<a href="https://twitter.com/alvaro_fe">@alvaro_fe</a> for this awesome contribution!</li>
  <li>V8 runtime’s WebAssembly support is working again on non-iOS also.</li>
  <li>The <em>Gum.DarwinModule</em> API is now part of the cross-platform Gum API. Useful
for parsing Mach-O files on non-Apple systems.</li>
</ul>

<h3 id="changes-in-1277">Changes in 12.7.7</h3>

<ul>
  <li>Eternalized agents are now kept around when the last session gets closed,
which means they can be reused for as long as the <em>HostSession</em> side, e.g.
frida-server, sticks around. This means that additional copies of frida-agent
can be avoided in a lot of cases. Kudos to <a href="https://twitter.com/bezjaje">@mrmacete</a> for this awesome
improvement.</li>
  <li>Java bridge no longer triggers a use-after-free when a method returns <em>this</em>.</li>
  <li>Our Android SELinux policy patcher no longer prints a warning on older
versions of Android. This harmless but confusing regression was introduced
by the previous release’ fix for Samsung S10 ROMs.</li>
  <li>Better SELinux-related error messages.</li>
  <li>Rudimentary support for iOS/arm64e.</li>
</ul>

<h3 id="changes-in-1278">Changes in 12.7.8</h3>

<ul>
  <li>Android 10 support just landed in our Java bridge thanks to a brilliant
contribution by <a href="https://github.com/Alien-AV">@Alien-AV</a>.</li>
  <li>Better spawn()-handling for Android apps, where the <em>activity</em> parameter can
be used in cases where the app doesn’t have a launcher activity. This neat
improvement was contributed by <a href="https://github.com/muhzii">@muhzii</a>.</li>
  <li>Android linker seeking logic was made future-proof thanks to an elegant
contribution by <a href="https://twitter.com/timstrazz">@timstrazz</a>.</li>
  <li>Massively improved fault-tolerance on iOS: our launchd agent now kills pending
processes when unloaded. This means that frida-server dying won’t leave
processes stuck in a suspended state. Kudos to <a href="https://twitter.com/bezjaje">@mrmacete</a> for this awesome
improvement.</li>
</ul>

<h3 id="changes-in-1279">Changes in 12.7.9</h3>

<ul>
  <li>We are back in business on macOS after a last-minute build regression snuck
into the previous release.</li>
</ul>

<h3 id="changes-in-12710">Changes in 12.7.10</h3>

<ul>
  <li><em>MemoryAccessMonitor</em> is now available on all platforms, and even the Duktape
runtime. Kudos to <a href="https://twitter.com/alvaro_fe">@alvaro_fe</a> for these awesome improvements.</li>
  <li>Android linker detection working properly again. (Regression introduced in
12.7.8.)</li>
  <li>Gadget was improved to support passing a config through its constructor
function on i/macOS.</li>
  <li>Gadget’s system loop integration – only implemented on i/macOS – was removed
to avoid undefined behavior in some scenarios.</li>
</ul>

<h3 id="changes-in-12711">Changes in 12.7.11</h3>

<ul>
  <li>Frida no longer crashes in Android processes without a vDSO. (Regression
introduced in 12.7.8.)</li>
  <li>Better error-handling when parsing Mach-O images.</li>
  <li>ARM vs Thumb properly handled when restoring exception on i/macOS. Thanks
<a href="https://twitter.com/alvaro_fe">@alvaro_fe</a>!</li>
  <li>CModule’s header for JSON-GLib is now self-contained, as it should be.</li>
</ul>

<h3 id="changes-in-12712">Changes in 12.7.12</h3>

<ul>
  <li>Full-featured iOS lockdown integration and unified devices, so Frida-based
tools don’t need to worry as much about jailed vs jailbroken. When interacting
with a jailed iOS device, Gadget is now injected automatically and there is no
need to repackage the app, it only has to be debuggable.</li>
  <li>Frida is finally able to detect recent iOS devices on Windows.</li>
  <li>Bug in V8 was tracked down and fix backported from upstream. Kudos to
<a href="https://twitter.com/bezjaje">@mrmacete</a> for tracking this one down!</li>
</ul>

<h3 id="changes-in-12713">Changes in 12.7.13</h3>

<ul>
  <li>Better handling of structs and unions in <em>frida-objc-bridge</em>. Thanks
<a href="https://github.com/gebing">@gebing</a>!</li>
  <li>Our Node.js bindings now also expose type definitions for <em>Crash</em> and
<em>CrashParameters</em>.</li>
  <li>Attempts to attach to the system session on jailed iOS throw early and
with a clearer error message.</li>
  <li>The iOS Developer Disk Image-related error messages were tweaked for
consistency.</li>
</ul>

<h3 id="changes-in-12714">Changes in 12.7.14</h3>

<ul>
  <li>Frida now ensures code is readable before accessing it on Android &gt;= 10.
This was the last missing piece for full-featured Android 10 support. Being
able to instrument system processes means that early instrumentation – i.e.
spawn() – works, and starting frida-server doesn’t crash <em>system_server</em> due
to the attempt it makes at preloading so the first <em>spawn()</em> will be fast.
Kudos to <a href="https://github.com/Alien-AV">@Alien-AV</a> and <a href="https://twitter.com/esanfelix">@esanfelix</a> for the painful research that made
the solution possible to implement in one late Saturday evening. :-)</li>
</ul>

<h3 id="changes-in-12715">Changes in 12.7.15</h3>

<ul>
  <li>Node.js bindings also expose the “summary” field of the <em>Crash</em> typing.</li>
</ul>

<h3 id="changes-in-12716">Changes in 12.7.16</h3>

<ul>
  <li>The <em>frida-gadget-ios</em> meta-package comes with type definitions so it can be
consumed from TypeScript.</li>
  <li>Node.js bindings provide proper typings for <em>Stdio</em> and <em>ChildOrigin</em>.</li>
</ul>

<h3 id="changes-in-12717">Changes in 12.7.17</h3>

<ul>
  <li>More robust support for jailed iOS: calling kill() before resume() but after
attach() is now working properly.</li>
  <li>Frida now communicates directly with the remote iOS/Android agent when
possible. We achieve this by establishing a fresh TCP connection to the
frida-server and having its file-descriptor passed to the agent. This means
frida-server can remove itself from the data path, improving performance and
reliability.</li>
  <li>Clients connecting to frida-server to spawn() a process, but getting
disconnected before they get a chance to resume() or kill() said process,
will no longer leave such orphans in limbo. We now keep track of spawned
processes and kill() them if the client suddenly gets disconnected.</li>
  <li>We no longer crash Zygote on Android 10. Turns out an SELinux rule was
missing.</li>
  <li>Our TCP sockets now have <em>TCP_NODELAY</em> set, and we also support communicating
with a remote frida-server or frida-gadget using UNIX sockets in addition to
TCP.</li>
  <li>NativeFunction now supports variadic functions, to avoid needing to
create one instance per unique argument list signature. Thanks <a href="https://github.com/gebing">@gebing</a>!</li>
</ul>

<h3 id="changes-in-12718">Changes in 12.7.18</h3>

<ul>
  <li>Node.js bindings finally link in needed OpenSSL symbols on UNIX, instead of
relying on luck where we’d usually end up in processes with another OpenSSL
already loaded that’s globally visible <em>and</em> ABI-compatible (!).</li>
</ul>

<h3 id="changes-in-12719">Changes in 12.7.19</h3>

<ul>
  <li>We now properly handle apply() on NativeFunction w/o args in the V8 runtime
also. Kudos to <a href="https://twitter.com/taviso">@taviso</a> for reporting this long-standing bug.</li>
  <li>NativeFunction’s handling of optional args in call() and apply() now behaves
like the builtin counterparts.</li>
</ul>

<h3 id="changes-in-12720">Changes in 12.7.20</h3>

<ul>
  <li>Frida now supports both cleartext and encrypted iOS lockdown channels,
retaining support for “cleartext after TLS handshake”-style channels by
appending “?tls=handshake-only” to the channel address. Kudos, <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>The paired lockdown channel itself can be accessed by using “lockdown:” as the
channel address. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
</ul>

<h3 id="changes-in-12721">Changes in 12.7.21</h3>

<ul>
  <li>We now support iOS 13 on the checkra1n jailbreak. (Jailed iOS 13 was already
supported.)</li>
</ul>

<h3 id="changes-in-12722">Changes in 12.7.22</h3>

<ul>
  <li>Our iOS package scripts launch daemon logic is now compatible with checkra1n,
so frida-server won’t have to be started/stopped manually.</li>
</ul>

<h3 id="changes-in-12723">Changes in 12.7.23</h3>

<ul>
  <li>Enhanced support for the checkra1n jailbreak: Stalker is now way faster as it
makes use of RWX pages.</li>
  <li>Stability improvements when using Stalker on iOS on jailbreaks without RWX
support. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>CModule is now compatible with additional iOS jailbreak flavors. Kudos,
<a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>CModule runtime support for working with ModuleMap objects.</li>
  <li>Support for ARMBE8 thanks to awesome contributions by <a href="https://github.com/jonwilson030981">Jon Wilson</a>.</li>
  <li>Frida now makes parent file-descriptors available to child processes when
spawn()ing on i/macOS. This is consistent with the current behavior on Linux.
Thanks <a href="https://twitter.com/wizche">@wizche</a>!</li>
</ul>

<h3 id="changes-in-12724">Changes in 12.7.24</h3>

<ul>
  <li>Node.js prebuilds also provided for Node.js v13.</li>
</ul>

<h3 id="changes-in-12725">Changes in 12.7.25</h3>

<ul>
  <li>Log handler APIs got an overhaul in the Python and Node.js bindings, as part
of a critical fix: the Node.js setter’s type wasn’t the same as the getter,
as it also allowed <em>null</em>. This inconsistency resulted in recent TypeScript
compiler versions choking on it. Thanks <a href="https://twitter.com/bezjaje">@mrmacete</a>!</li>
  <li>No more timestamp truncations in the V8 platform integration. Thanks for
reporting, <a href="https://twitter.com/DaveManouchehri">@DaveManouchehri</a>!</li>
  <li>Our <em>Module.enumerateSymbols()</em> API provides a “size” property when available,
i.e. only on Linux/Android for now. Thanks <a href="https://twitter.com/DaveManouchehri">@DaveManouchehri</a>!</li>
  <li><em>Java.use(name, { cache: ‘skip’ })</em> can now be used to bypass caching. Useful
when dealing with multiple class-loaders and colliding class names. Thanks
<a href="https://github.com/ChaosData">@ChaosData</a> and <a href="https://github.com/H4oK3">@H4oK3</a>!</li>
</ul>

<h3 id="changes-in-12726">Changes in 12.7.26</h3>

<ul>
  <li>Stalker now supports temporary reactivation, to allow stalking code from
inside an excluded memory range.</li>
  <li>NativeFunction got a brand new option <code class="language-plaintext highlighter-rouge">traps: 'all'</code> to allow calls to be
stalked even when Frida’s own memory range is marked as excluded.</li>
  <li>Thread enumeration on Linux is finally working when using Yama. Thanks
<a href="https://github.com/jonwilson030981">Jon Wilson</a>!</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2019/05/28/frida-12-6-released/index.html">
      Frida 12.6 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      28 May 2019
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>After a flurry of fixes across all platforms over the last few weeks,
I figured it was time to do another minor bump to call attention to
this release.</p>

<p>One particular fix is worth mentioning specifically. There was a long-
standing bug in our Android Java integration, where exception delivery
would intermittently result in the process crashing with
<em>GetOatQuickMethodHeader()</em> typically in the stack-trace. Shout-out to
<a href="https://twitter.com/giantpune">Jake Van Dyke</a> and <a href="https://twitter.com/iGio90">Giovanni Rocca</a> for helping track this one
down. This bug has been around for as long as ART has been supported,
so this fix is worth celebrating. 🎉</p>

<p>Our V8 runtime is also a lot more stable, child-gating works better
than ever before, Android device compatibility is much improved, etc.</p>

<p>So bottom line is that this is the most stable version of Frida ever
released – and now is the time to make sure you’re running Frida 12.6.</p>

<p>Enjoy!</p>

<h3 id="changes-in-1261">Changes in 12.6.1</h3>

<ul>
  <li>The exception delivery fix in the Android Java integration introduced
a performance bottleneck when running the VM in interpreter mode, e.g.
through <em>Java.deoptimizeEverything()</em>. For example when running the
Dropbox app from start to login screen, this would take ~94 seconds
on a Pixel 3 running Android 9, and now takes ~6 seconds.</li>
</ul>

<h3 id="changes-in-1262">Changes in 12.6.2</h3>

<ul>
  <li>Android Java integration now supports more arm64 systems thanks to a
fix contributed by <a href="https://twitter.com/iGio90">Giovanni Rocca</a>.</li>
  <li>Android Java integration once again supports being used by more than
one script at a time.</li>
</ul>

<h3 id="changes-in-1263">Changes in 12.6.3</h3>

<ul>
  <li><em>Java.choose()</em> is now working again on Android &gt;= 8.1, thanks to a
fix contributed by <a href="https://twitter.com/eugenekolo">Eugene Kolo</a>.</li>
  <li>Android Java integration unhooking is now working again. This also
means hooks are properly reverted on script unload.</li>
  <li>Frida can now talk to old versions of Frida, from before the addition
of per-script runtime selection.</li>
</ul>

<h3 id="changes-in-1264">Changes in 12.6.4</h3>

<ul>
  <li>Build system is back in business on all platforms.</li>
</ul>

<h3 id="changes-in-1265">Changes in 12.6.5</h3>

<ul>
  <li>Linux thread enumeration is now working properly on x86-64.</li>
  <li>Stalker finally handles restartable Linux syscalls.</li>
</ul>

<h3 id="changes-in-1266">Changes in 12.6.6</h3>

<ul>
  <li>Android Java integration is back in fully working condition on 32-bit ARM.</li>
</ul>

<h3 id="changes-in-1267">Changes in 12.6.7</h3>

<ul>
  <li>Latest Chimera iOS jailbreaks are now supported; confirmed working on <em>1.0.8</em>.</li>
  <li>Linux injector handles target processes where the libc’s name is ambiguous,
which is often an issue on Android.</li>
</ul>

<h3 id="changes-in-1268">Changes in 12.6.8</h3>

<ul>
  <li><em>ObjC.Object</em> now provides <em>$moduleName</em>, useful for determining which module
owns a given class. Kudos to <a href="https://twitter.com/insitusec">David Weinstein</a> for contributing this neat
feature!</li>
</ul>

<h3 id="changes-in-1269">Changes in 12.6.9</h3>

<ul>
  <li>Latest unc0ver jailbreak is now fully supported.</li>
  <li>Early instrumentation logic has been improved to fully support iOS 12. Kudos
to <a href="https://twitter.com/bezjaje">Francesco Tamagni</a> for helping get these tricky changes across the
finish-line.</li>
  <li>Enumeration of memory ranges is now more reliable on iOS 12, as memory ranges
belonging to threads are now correctly cloaked.</li>
  <li>Cloaked memory ranges are now compacted, making lookups faster.</li>
  <li>Child gating is able to hold children for longer than 25 seconds. Previously
these would get resumed automatically after that accidental timeout. This also
affects early instrumentation on Android, as it is built on top of child
gating.</li>
  <li>Swift bindings support RPC and have been moved to Swift 5.0, thanks to
<a href="https://twitter.com/JohnCoatesDev">John Coates</a>’ awesome contribution.</li>
</ul>

<h3 id="changes-in-12610">Changes in 12.6.10</h3>

<ul>
  <li>Enumeration of memory ranges is now reliable on all platforms. There was a
long-standing bug when a removal ends up splitting an existing range.</li>
</ul>

<h3 id="changes-in-12611">Changes in 12.6.11</h3>

<ul>
  <li>Enumeration of applications includes icons on iOS &gt;= 12, thanks to a nice fix
by <a href="https://twitter.com/CodeColorist">CodeColorist</a>.</li>
  <li>Gadget was taught how to detect the executable and package name of Android
apps, thanks to a neat contribution by <a href="https://github.com/gebing">gebing</a>.</li>
  <li>Cloaking of memory ranges got a critical fix affecting Windows users.</li>
</ul>

<h3 id="changes-in-12612">Changes in 12.6.12</h3>

<ul>
  <li>The <em>frida-inject</em> tool now supports passing parameters to the script through
<em>-P/–parameters</em>. Kudos to <a href="https://twitter.com/eugenekolo">Eugene Kolo</a> for contributing this neat
feature.</li>
  <li>Child-gating no longer deadlocks when script unload blocks. Kudos to
<a href="https://github.com/igasparis">Ioannis Gasparis</a> for helping track this one down.</li>
  <li>Child-gating is more reliable as Frida now allocates file-descriptors in a
higher range to avoid them getting closed by applications calling <em>dup2()</em>
during a <em>fork()+exec()</em>. This would typically happen on Android when an app
called <em>Runtime.exec()</em>. Kudos to <a href="https://github.com/igasparis">Ioannis Gasparis</a> for helping track this
one down.</li>
  <li>The painful Android NDK upgrade to r20 landed, thanks to a slew of awesome
contributions by <a href="https://github.com/muhzii">Muhammed Ziad</a>.</li>
  <li>Error-handling was improved to avoid crashing in scenarios where we fail to
initialize due to lack of permissions. Kudos to <a href="https://twitter.com/trufae">pancake</a> for reporting.</li>
  <li>The native lockdown integration for iOS that had been sitting in a branch for
a very long time was finally merged. It is unfinished and considered unstable
API, but had to be merged due to a major refactoring that’s in progress.</li>
  <li><em>Stalker</em> now allows <em>unfollow()</em> from the <em>transform</em> callback, instead of
crashing the process like it used to. Kudos to <a href="https://twitter.com/iGio90">Giovanni Rocca</a> for helping
fix this.</li>
  <li>Gadget’s Android package name detection logic was improved to handle one
edge-case not previously accounted for. Kudos to <a href="https://github.com/xiaobaiyey">xiaobaiyey</a> for reporting
and suggesting a fix.</li>
  <li>The <em>Java.registerClass()</em> API was improved to support specifying the super
class, along with a slew of fixes for both that API and handling of arrays
with generics. Big thanks to <a href="https://github.com/gebing">gebing</a> for these awesome improvements.</li>
</ul>

<h3 id="changes-in-12613">Changes in 12.6.13</h3>

<ul>
  <li>Constructor/destructor functions in Agent and Gadget are now finally correctly
ordered, and our libc shim’s memory allocator hacks could be dropped. Those
fragile hacks broke in a new and colorful way with 32-bit ARM processes on
Android due to a subtle change in the toolchain’s <em>libgcc</em>.</li>
  <li>Our libc shim now also handles <em>__cxa_atexit()</em> and <em>atexit()</em>, where the
former is crucial to avoid leaks.</li>
</ul>

<h3 id="changes-in-12614">Changes in 12.6.14</h3>

<ul>
  <li>The <em>Java.registerClass()</em> API was improved to support user-defined
constructors and fields, thanks to the awesome improvements contributed
by <a href="https://github.com/gebing">gebing</a>.</li>
  <li>Temporary files are now cleaned up on all platforms.</li>
  <li>Ctrl+C is handled by frida-server on Windows to support graceful shutdown
without leaving temporary files behind.</li>
</ul>

<h3 id="changes-in-12615">Changes in 12.6.15</h3>

<ul>
  <li><em>NativePointerValue</em>, i.e. support for passing an object with a <em>handle</em>
property in addition to <em>NativePointer</em>, is once again working everywhere.</li>
</ul>

<h3 id="changes-in-12616">Changes in 12.6.16</h3>

<ul>
  <li>The <em>frida-gadget-ios</em> meta-package is now dependency-free.</li>
</ul>

<h3 id="changes-in-12617">Changes in 12.6.17</h3>

<ul>
  <li>Crash reporter integration is now compatible with iOS 12.4.</li>
  <li>Java integration was improved to eagerly release global handles when a
replaced method is called, to avoid running out of handles. Kudos to
<a href="https://github.com/gebing">gebing</a> for this nice improvement.</li>
  <li><em>Java.retain()</em> was added to allow storing <em>this</em> for later use outside a
replaced Java method.</li>
  <li>Support for older versions of Android should now be slightly better.</li>
  <li>Frida no longer crashes on i/macOS if the target process dies while injecting
a library into it.</li>
  <li>Support for MIPS64 thanks to awesome contributions by <a href="https://github.com/jonwilson030981">Jon Wilson</a>.</li>
  <li><em>Memory.patchCode()</em> no longer crashes on <em>android-arm64</em>, thanks to a fix by
<a href="https://github.com/gebing">gebing</a>.</li>
  <li>Interception of already intercepted Thumb function is now working properly.</li>
  <li>Frida no longer crashes when logging early in the process lifetime on iOS.</li>
  <li>Simple <em>ModuleApiResolver</em> queries are now blazing fast.</li>
  <li><em>Duktape</em> runtime no longer includes the problematic <em>Reflect</em> builtin.</li>
  <li><em>Interceptor</em> C API was refactored to improve naming.</li>
</ul>

<h3 id="changes-in-12618">Changes in 12.6.18</h3>

<ul>
  <li>Gadget binaries are once again stripped on all platforms.</li>
</ul>

<h3 id="changes-in-12619">Changes in 12.6.19</h3>

<ul>
  <li>All APIs are now cancellable. Python and Node.js language bindings support
passing a <em>Cancellable</em> object. Remaining language bindings work like before,
and contributions are most welcome.</li>
</ul>

<h3 id="changes-in-12620">Changes in 12.6.20</h3>

<ul>
  <li><em>DeviceManager.find_device()</em> no longer crashes on startup.</li>
</ul>

<h3 id="changes-in-12621">Changes in 12.6.21</h3>

<ul>
  <li><em>Future.wait_async()</em> no longer crashes when cancelled last-minute.</li>
</ul>

<h3 id="changes-in-12622">Changes in 12.6.22</h3>

<ul>
  <li>State management was improved to allow <em>eternalize()</em> and <em>post()</em> in disposed
state as well.</li>
  <li>The <em>dispose()</em> RPC export is now passed a parameter specifying the reason,
to be able to differentiate between <em>unload</em>, <em>exit</em>, and <em>exec</em>.</li>
  <li>Scripts may now be <em>dispose()</em>d again if an exec transition fails.</li>
  <li>The <em>frida-inject</em> CLI tool was improved to exit on detach.</li>
  <li><em>RpcClient</em> no longer crashes when <em>post_rpc_message()</em> fails.</li>
  <li><em>Fruity</em> and <em>Droidy</em> backends are now disabled on iOS and Android, to reduce
footprint size on platforms where these backends are not applicable.</li>
</ul>

<h3 id="changes-in-12623">Changes in 12.6.23</h3>

<ul>
  <li>Frida no longer crashes when <em>HostSession</em> gets lost mid-request.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2019/05/15/frida-12-5-released/index.html">
      Frida 12.5 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      15 May 2019
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>This is one packed release. So many things to talk about.</p>

<h3 id="v8">V8</h3>

<p>The main story this time is <a href="https://v8.dev/">V8</a>. But first, a little background.</p>

<p>Frida uses the <a href="https://duktape.org/">Duktape</a> JavaScript runtime by default to provide
scriptable access to its instrumentation core, <a href="https://github.com/frida/frida-gum">Gum</a>. We were
originally only using V8, but as V8 used to depend on operating support
for <em>RWX</em> pages – i.e. executable pages of memory that are also
writable – we ended up adding a secondary JS runtime based on Duktape.
Due to this OS constraint with V8, and the fact that Duktape lacks
support for the latest JS syntax and features, I decided to make Duktape
our default runtime so that scripts written for one platform wouldn’t
need any syntactic changes to work on another. Duktape was basically the
lowest common denominator.</p>

<p>Fast forward to today, and V8 no longer depends on OS support for <em>RWX</em>
pages. It’s actually moving towards flipping between <em>RW-</em> and <em>R-X</em> by
default. By doing so it means it can be used on modern iOS jailbreaks,
and also on jailed iOS if the process is marked as being debugged,
so it is able to run unsigned code. But there’s more; V8 can now even run
<a href="https://v8.dev/blog/jitless">JIT-less</a>, which means Frida can use V8 on every single platform, and
users no longer have to <a href="https://github.com/oleavr/frida-agent-example">frida-compile</a> their agents to use the latest
JavaScript syntax and features. This last point only applies to trivial
agents, though, as being able to split a non-trivial agent into multiple
source files is still desirable. Plus, frida-compile makes it easy to
use <a href="https://www.typescriptlang.org/">TypeScript</a>, which is highly recommended for any non-trivial
Frida agent.</p>

<p>So with all of that in mind, it was clearly time to upgrade our V8 to
the latest and greatest. As of this release we are running <a href="https://chromium.googlesource.com/v8/v8/+/refs/tags/7.6.48">7.6.48</a>,
and we also have a much deeper integration with V8 than ever before.
Both C++ memory allocations and page-level allocations are now managed
by Frida, so we are able to hide these memory ranges from APIs like
<em>Process.enumerateRanges()</em>, and also avoid poisoning the application’s
own heap with allocations belonging to Frida. These details may not
sound all that significant, but are actually crucial for implementing
memory-dumping tools on top of Frida. Not only that, however, we also
interfere less with the process that is being observed. That means
there’s a smaller risk of it exhibiting a different behavior than when
it runs without instrumentation.</p>

<h3 id="runtime-selection">Runtime Selection</h3>

<p>You may remember the <em>session.enable_jit()</em> API. It has finally been
deprecated, as you can now specify the desired runtime during script
creation. E.g. using our Python bindings:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">script</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">create_script</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="s">'duk'</span><span class="p">)</span></code></pre></figure>

<p>And using our Node.js bindings:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">script</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">session</span><span class="p">.</span><span class="nx">createScript</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">runtime</span><span class="p">:</span> <span class="dl">'</span><span class="s1">v8</span><span class="dl">'</span>
<span class="p">});</span></code></pre></figure>

<h3 id="stalker">Stalker</h3>

<p>Another significant change in this release is that <a href="../../docs/javascript-api/index.html#stalker">Stalker</a> no longer
depends on <em>RWX</em> pages on arm64, thanks to <a href="https://twitter.com/JohnCoatesDev">John Coates</a>’ awesome
contribution. This means Stalker is finally much more accessible on iOS.</p>

<p>For those of you using Stalker on 64-bit Windows and stalking 32-bit
processes, it finally handles the WOW64 transitions on newer versions of
Windows. This brain-twisting improvement was contributed by <a href="https://twitter.com/thestr4ng3r">Florian Märkl</a>.</p>

<h3 id="moduleload">Module.load()</h3>

<p>There are times when you might want to load your own shared library,
perhaps containing hooks written in C/C++. On most platforms you could
achieve this by using <a href="../../docs/javascript-api/index.html#nativefunction">NativeFunction</a> to call <em>dlopen()</em> (POSIX) or
<em>LoadLibrary()</em> (Windows). It’s a very different story on newer versions
of Android, however, as their <em>dlopen()</em>-implementation looks at the
caller and makes decisions based on it. One such decision is whether
the app is trying to access a private system API, which would make it
hard for them to later remove or break that API. So as of Android 8
the implementation will return <em>NULL</em> when this is the case. This was
a challenge that Frida solved for its own injector’s needs, but users
wanting to load their own library were basically on their own.</p>

<p>As of Frida 12.5, there’s a brand new JavaScript API that takes care of
all the platform-specific quirks for you:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">hooks</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="dl">'</span><span class="s1">/path/to/my-native-hooks.so</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="dl">'</span><span class="s1">libc.so</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">read</span><span class="dl">'</span><span class="p">),</span>
    <span class="nx">hooks</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="dl">'</span><span class="s1">replacement_read</span><span class="dl">'</span><span class="p">));</span></code></pre></figure>

<h3 id="android">Android</h3>

<p>We fixed so many Android-specific bugs in this release. For example,
<em>Module.getExportByName()</em> on an app-bundled library no longer results
in the library being loaded a second time at a different base address.
This bug alone is reason enough to make sure you’ve got all your devices
upgraded and running the latest release.</p>

<h3 id="ios">iOS</h3>

<p>The iOS Chimera jailbreak is also supported thanks to
<a href="https://twitter.com/bezjaje">Francesco Tamagni</a>’s awesome contributions.</p>

<h3 id="all-the-rest">All the rest</h3>

<p>There’s also lots of other improvements across platforms.</p>

<p>In chronological order:</p>

<ul>
  <li>Child gating also works on older versions of Windows.
Thanks <a href="https://github.com/ineedblood">Fernando Urbano</a>!</li>
  <li>Executables are smaller on UNIX OSes as they no longer export any
dynamic symbols.</li>
  <li>Frida’s agent and gadget no longer crash on 32-bit Linux when loaded
at a high address, i.e. where MSB is set.</li>
  <li>Only one of the two <em>frida-helper-{32,64}</em> binaries for Linux/Android
is needed, and none of them for builds without cross-arch support.
This means smaller footprint and improved performance.</li>
  <li>Linux/ARM64 is finally supported, with binaries uploaded as part of
the release process.</li>
  <li>We now provide a hint about Magisk Hide when our early instrumentation
fails to instrument Zygote on Android.</li>
</ul>

<h3 id="changes-in-1251">Changes in 12.5.1</h3>

<ul>
  <li>Script runtime can be specified per script, deprecating <em>enable_jit()</em>.</li>
</ul>

<h3 id="changes-in-1252">Changes in 12.5.2</h3>

<ul>
  <li>Gadget no longer crashes at script load time when using V8 on Linux
and Android. Huge thanks to <a href="https://twitter.com/leonjza">Leon Jacobs</a> for reporting and helping
track this one down.</li>
</ul>

<h3 id="changes-in-1253">Changes in 12.5.3</h3>

<ul>
  <li>Android linker integration supports a lot more devices.</li>
  <li>Android Java integration no longer crashes with “Invalid instruction”
on some arm64 devices. Kudos to <a href="https://twitter.com/giantpune">Jake Van Dyke</a> for reporting and
helping track this one down.</li>
  <li>LineageOS 15.1 is supported after adding a missing SELinux rule.</li>
</ul>

<h3 id="changes-in-1254">Changes in 12.5.4</h3>

<ul>
  <li>Hooks are no longer able to interfere with our V8 page allocator
integration.</li>
  <li>Android stability improved greatly after plugging a hole in our libc
shim. Big thanks to <a href="https://twitter.com/iGio90">Giovanni Rocca</a> for reporting and helping track
this one down!</li>
</ul>

<h3 id="changes-in-1255">Changes in 12.5.5</h3>

<ul>
  <li>Apple USB devices are properly detected on Windows. Thanks <a href="https://github.com/xiofee">@xiofee</a>!</li>
</ul>

<h3 id="changes-in-1256">Changes in 12.5.6</h3>

<ul>
  <li>Android Java integration now has a workaround for a bug in ART’s
exception delivery logic, where one particular code-path assumes that
there is at least one Java stack frame present on the current thread.
That is however not the case on a pure native thread, like Frida’s JS
thread. Simplest reproducer is <em>Java.deoptimizeEverything()</em> followed
by <em>Java.use()</em> of a non-existent class name. Kudos to
<a href="https://twitter.com/giantpune">Jake Van Dyke</a> for reporting and helping track this one down.</li>
  <li>Android Java integration no longer crashes the process when calling
<em>Java.deoptimizeEverything()</em> in a process unable to TCP listen().</li>
  <li>Android Java integration supports JNI checked mode like it used to.</li>
  <li>Node.js 12 supported in addition to 8 and 10, with prebuilds for all
supported platforms.</li>
  <li>Node.js bindings’ <em>enableDebugger()</em> method no longer requires
specifying which port to listen on.</li>
</ul>

<h3 id="changes-in-1257">Changes in 12.5.7</h3>

<ul>
  <li>Android teardown no longer crashes on systems where we are unable to
spawn <em>logcat</em> for crash reporting purposes.</li>
  <li>Better <em>SuperSU</em> integration teardown logic on Android.</li>
  <li>Android Java integration now properly supports JNI checked mode, which
massively improves Android ROM compatibility. Kudos to <a href="https://github.com/muhzii">@muhzii</a> for
reporting and assisting with testing the changes.</li>
  <li>V8 backend teardown no longer suffers from a use-after-free, and also
no longer crashes when a WeakRef is bound late.</li>
</ul>

<h3 id="changes-in-1258">Changes in 12.5.8</h3>

<ul>
  <li>Linux child-gating now handles children changing architecture, e.g. a
32-bit app doing fork+exec to run a 64-bit executable. Big thanks to
<a href="https://github.com/gebing">@gebing</a> for the fix.</li>
  <li>Child gating no longer deadlocks in case of a fork+exec where a child
process is not followed. Kudos to <a href="https://github.com/gebing">@gebing</a> for the fix.</li>
  <li>Module export lookups no longer fail on Android apps’ own modules.</li>
</ul>

<h3 id="changes-in-1259">Changes in 12.5.9</h3>

<ul>
  <li>Our libc shim now includes <em>memcpy()</em>, making it safe to hook. Thanks to
<a href="https://twitter.com/iGio90">Giovanni Rocca</a> for debugging and contributing the fix.</li>
  <li><em>Interceptor.flush()</em> now also works even when a thread has temporarily
released the JS lock, e.g. while calling a <em>NativeFunction</em>.</li>
  <li>Android Java integration no longer crashes intermittently during ART
exception delivery, e.g. when hooking <em>ClassLoader.loadClass()</em>. Kudos
to <a href="https://twitter.com/giantpune">Jake Van Dyke</a> and <a href="https://twitter.com/iGio90">Giovanni Rocca</a> for helping track this one
down. This bug has been around for as long as ART has been supported,
so this fix is worth celebrating. 🎉</li>
  <li>Android Java integration no longer crashes processes where the <em>JDWP</em>
transport cannot be started.</li>
</ul>


  </div>
</article>


  <article>
  <h2>
    <a href="../2018/09/11/frida-12-2-released/index.html">
      Frida 12.2 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      11 Sep 2018
    </span>
    <a href="https://github.com/mrmacete" class="post-author">
      <img src="https://github.com/mrmacete.png" class="avatar" alt="mrmacete"/>
      mrmacete
    </a>
  </div>
  <div class="post-content">
    <p>Let’s talk about iOS kernel introspection. It’s been a while since Frida got
basic support for introspection of the iOS kernel, but in the last months we
kept improving on that. Today’s release includes significant additions to our
Kernel API to work with recent 64-bit kernels.</p>

<h2 id="kernel-base">Kernel base</h2>

<p>You can get the kernel’s base address by reading the <code class="language-plaintext highlighter-rouge">Kernel.base</code> property.
Having the base allows for example to calculate the slid virtual address of
any symbol you already know from static analysis of the kernel cache.</p>

<h2 id="kernel-memory-search">Kernel memory search</h2>

<p>The memory search API has been ported to the Kernel, so you can use
<code class="language-plaintext highlighter-rouge">Kernel.scan()</code> (or <code class="language-plaintext highlighter-rouge">Kernel.scanSync()</code>) in the same way you use <code class="language-plaintext highlighter-rouge">Memory.scan()</code>
(or <code class="language-plaintext highlighter-rouge">Memory.scanSync()</code>) in userland. This is a powerful primitive which,
combined with the recent bit mask feature, allows you to create your own symbol
finding code by searching for arm64 patterns.</p>

<h2 id="kexts-and-memory-ranges">KEXTs and memory ranges</h2>

<p>With <code class="language-plaintext highlighter-rouge">Kernel.enumerateModules()</code> (or <code class="language-plaintext highlighter-rouge">Kernel.enumerateModulesSync()</code>) it’s now
possible to get the names and the offsets of all the KEXTs.</p>

<p><code class="language-plaintext highlighter-rouge">Kernel.enumerateModuleRanges()</code> (or <code class="language-plaintext highlighter-rouge">Kernel.enumerateModuleRangesSync()</code>) is
the way to enumerate all the memory ranges defined by the Mach-O sections
belonging to a module (by name) filtering by protection. The result is similar
to what you can get in userland when calling <code class="language-plaintext highlighter-rouge">Module.enumerateRanges()</code> but it
also includes the section names.</p>

<h2 id="final-notes">Final notes</h2>

<p>All Kernel APIs don’t rely on <code class="language-plaintext highlighter-rouge">NativePointer</code> because its size depends on the
user-space which doesn’t necessarily match the kernel space one. Instead all
addresses are represented as <code class="language-plaintext highlighter-rouge">UInt64</code> objects.</p>

<p>All of this, plus the existing JavaScript interfaces for reading, writing, and
allocating kernel memory can provide a powerful starting point to build your own
kernel analysis or vulnerability research tools.</p>

<p>Note that this is to be considered experimental and messing with the kernel in
random ways can wildly damage your devices, so be careful, and happy hacking!</p>

<h2 id="troubleshooting">Troubleshooting</h2>

<h3 id="problem-kernelavailable-is-false">Problem: Kernel.available is false</h3>

<p>The Kernel API is available if both of these conditions are met:</p>

<ul>
  <li>Your device is jailbroken</li>
  <li>Frida is able to get a send right to the kernel task, either by traditional
<code class="language-plaintext highlighter-rouge">task_for_pid (0)</code> or by accessing the host special port 4 (which is what
modern jailbreaks are doing)</li>
</ul>

<p>The recommended way to accomplish the latter is to attach to the system session,
i.e. PID 0, and load your scripts there.</p>

<h3 id="problem-cant-do-much-with-my-32-bit-kernel">Problem: can’t do much with my 32-bit kernel</h3>

<p>Yes, that could improve in the future but 32-bit iOS is quite far down on the
list of priorities nowadays, but you’re very welcome to contribute and send PRs.</p>

<h3 id="problem-i-was-trying-to-do-x-and-the-kernel-panicked">Problem: I was trying to do X and the kernel panicked</h3>

<p>Don’t worry that’s normal. You can go to the
<code class="language-plaintext highlighter-rouge">/private/var/mobile/Library/Logs/CrashReporter</code> directory on your device, or
navigate to Settings -&gt; Privacy -&gt; Analytics -&gt; Analytics Data, find your panic
log and figure out what you (or Frida) did wrong. Remember: the Kernel is always
right!</p>

<h3 id="problem-i-unrecoverably-damaged-my-device-using-frida-kernel-apis">Problem: I unrecoverably damaged my device using Frida Kernel APIs</h3>

<p>Sorry to hear, if the damage is at the hardware level and you can dedicate
enough time and money you can probably repair it yourself by following tutorials
at <a href="https://ifixit.com">https://ifixit.com</a>.</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2018/08/25/frida-12-1-released/index.html">
      Frida 12.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      25 Aug 2018
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Massive changes under the hood this time. All of our dependencies have been
upgraded to the latest and greatest. Let’s have a look at the highlights.</p>

<h3 id="v8-70">V8 7.0</h3>

<p>Frida’s V8 dependency was previously at 6.2.2, and has now been upgraded to
7.0.242. The move to such a new version means that the V8 debugger API is gone
and has been replaced with the new Inspector API, which the latest Node.js is
also using. One thing that’s pretty awesome about it is that it’s natively
supported by Google Chrome’s Inspector.</p>

<p>To start using it, just tell Frida to use V8, by calling <em>session.enable_jit()</em>,
and then <em>session.enable_debugger()</em>.</p>

<p>Or when using the CLI tools:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>frida-trace <span class="nt">--enable-jit</span> <span class="nt">--debug</span> <span class="nt">-f</span> /bin/cat <span class="nt">-i</span> <span class="nb">read</span></code></pre></figure>

<p>Then in Google Chrome, right-click and choose “Inspect”, and click on the green
Node.js icon in the upper left corner of the Inspector. That’s it, you are now
debugging your Frida scripts. That means a nifty console with auto-completion,
pause/continue, stepping, breakpoints, profiling, and heap snapshots. What makes
it really convenient is that the server listens on your host machine, so you can
call <em>enable_debugger()</em> on a session representing a process on your
USB-tethered Android device, and it all works the same.</p>

<p>Here’s what it looks like:</p>

<p><img src="../../img/inspector-console.png" alt="Console" title="Console" />
<img src="../../img/inspector-profiler.png" alt="Profiler" title="Profiler" />
<img src="../../img/inspector-snapshot.png" alt="Heap Snapshot" title="Heap Snapshot" /></p>

<p>Note however that V8 is currently not included in our prebuilt iOS binaries,
but it should be possible to get it running again on iOS now that it’s able to
run without RWX pages. We do however plan on bridging Duktape’s binary debugger
protocol behind the scenes so debugging “just works” with Duktape also, though
probably with a slightly reduced feature-set.</p>

<h3 id="processid">Process.id</h3>

<p>It is often quite useful to know the PID of the process that your agent is
executing inside, especially in <a href="../../docs/modes/index.html#preloaded">preloaded mode</a>. So instead of requiring you
to use <em>NativeFunction</em> to call e.g. <em>getpid()</em>, this is now a lot simpler as
you can use the brand new <code class="language-plaintext highlighter-rouge">Process.id</code> property.</p>

<h3 id="anything-else">Anything else?</h3>

<p>No other features, but some really nice bug-fixes. Thanks to <a href="https://github.com/mrmacete">mrmacete</a> we are
now able to attach to <em>com.apple.WebKit.*</em> processes on iOS 11.x. And thanks to
<a href="https://github.com/viniciusmarangoni">viniciusmarangoni</a> this release also packs a couple of goodies for frida-java,
fixing one Android 8.0 regression and adding the ability to properly instrument
<em>system_server</em>.</p>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2018/07/12/frida-12-0-released/index.html">
      Frida 12.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      12 Jul 2018
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>As some of you may have picked up on, there may be a <a href="https://twitter.com/fridadotre/status/950085837445836800">book</a> on Frida in the
works. In my day to day at <a href="https://www.nowsecure.com/">NowSecure</a> I spend a good chunk of time as a user
of Frida’s APIs, and consequently I’m often reminded of past design decisions
that I’ve since come to regret. Even though I did address most of them over the
years, some were so painful to address that I kept them on the backburner. Fast
forward to today, and the thought of publishing a book with all these in mind
got me thinking that it was time to bite the bullet.</p>

<p>This is why I’m stoked to announce Frida 12. We have finally reached a point
in Frida’s evolution where our foundations can be considered sufficiently stable
for a book to be written.</p>

<p>Let’s have a look at the changes.</p>

<h3 id="cli-tools">CLI tools</h3>

<p>One thing that caused a bit of confusion in the past was the fact that our
Python bindings also came with some CLI tools. Frida is a toolkit for building
tools, and even though we provide a few sample tools it should be up to you if
you want to have them installed.</p>

<p>Up until now this meant anyone building a tool using our Python bindings would
end up depending on <em>colorama</em>, <em>prompt-toolkit</em>, and <em>pygments</em>, because our
CLI tools happen to depend on those.</p>

<p>Well, that changes now. If you do:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>pip <span class="nb">install </span>frida</code></pre></figure>

<p>You will now only get our Python bindings. Nothing more. And this package has
zero dependencies.</p>

<p>The CLI tools might still be useful to you, though, so to install those do:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>pip <span class="nb">install </span>frida-tools</code></pre></figure>

<h3 id="convenience-apis-in-bindings">Convenience APIs in bindings</h3>

<p>Something that seemed like a great idea at the time was having our language
bindings provide some convenience APIs on the <a href="https://gist.github.com/oleavr/e6af8791adbef8fbde06#file-frida-core-1-0-vapi-L201-L226">Session</a> object. The thinking
was that simple use-cases that only need to enumerate loaded modules and perhaps
a few memory ranges, to then read or write memory, wouldn’t have to load their
own agent. So both our Python and our Node.js bindings did this behind the
scenes for you.</p>

<p>Back then it was somewhat tedious to communicate with an agent as the <a href="../../docs/javascript-api/index.html#rpc">rpc</a>
API didn’t exist, but even so, it was a bad design decision. The <a href="../../docs/javascript-api/index.html">JS APIs</a>
are numerous and not all can be exposed without introducing new layers of
complexity. Another aspect is that every language binding would have to
duplicate such convenience APIs, or we would have to add core APIs that
bindings could expose. Both are terrible options, and cause confusion by
blurring the lines, ultimately confusing people new to Frida. Granted, it did
make things easier for some very simple use-cases, like memory dumping tools,
but for everybody else it just added bloat and confusion.</p>

<p>These APIs are now finally gone from our Python and Node.js bindings. The other
bindings are unaffected as they didn’t implement any such convenience APIs.</p>

<h3 id="nodejs-bindings">Node.js bindings</h3>

<p>It’s been a few years since our Node.js bindings were written, and since then
Node.js has evolved a lot. It now supports ES6 classes, <em>async</em> / <em>await</em>, arrow
functions, <em>Proxy</em> objects, etc.</p>

<p>Just the <em>Proxy</em> support alone means we can simplify <a href="../../docs/javascript-api/index.html#rpc">rpc</a> use-cases like:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">script</span><span class="p">.</span><span class="nx">getExports</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span></code></pre></figure>

<p>to just:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">script</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span></code></pre></figure>

<p>Some of you may also prefer writing your application in <a href="https://www.typescriptlang.org/">TypeScript</a>, which
is an awesome productivity boost compared to old-fashioned JavaScript. Not only
do you get type checking, but if you’re using an editor like <a href="https://code.visualstudio.com/">VS Code</a> you
also get type-aware refactoring and amazing code completion.</p>

<p>However, for type checking and editor features to really shine, it is crucial to
have type definitions for your project’s dependencies. This is rarely ever an
issue these days, except for those of you using Frida’s Node.js bindings.
Up until now we didn’t provide any type definitions. This has finally been
resolved. Rather than augmenting our bindings with type definitions, I decided
to rewrite them in TypeScript instead. This means we also take advantage of
modern language features like ES6 classes and <em>async</em> / <em>await</em>.</p>

<p>We could have stopped there, but those of you using our Node.js bindings from
TypeScript would still find this a bit frustrating:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">script</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="p">});</span></code></pre></figure>

<p>Here, the compiler knows nothing about which events exist on the <em>Script</em>
object, and what the callback’s signature is supposed to be for this particular
event. We’ve finally fixed this. The API now looks like this:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">script</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">connect</span><span class="p">((</span><span class="nx">message</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="p">});</span></code></pre></figure>

<p>Voilà. Your editor can even tell you which events are supported and give you
proper type checking for the code in your callback. Sweet!</p>

<h3 id="interceptor">Interceptor</h3>

<p>Something that’s caused some confusion in the past is the observation that
accessing <em>this.context.pc</em> from <em>onEnter</em> or <em>onLeave</em> would give you the
return address, and not the address of the instruction that you put the hook
on. This has finally been fixed. Also, <em>this.context.sp</em> now points at the
return address on x86, instead of the first argument. The same goes for
<em>Stalker</em> when using call probes.</p>

<p>As part of this refactoring breaking our backtracer implementations, I also
improved our default backtracer on Windows.</p>

<h3 id="tether">Tether?</h3>

<p>You might have wondered why <code class="language-plaintext highlighter-rouge">frida.get_usb_device()</code> would give you a <em>Device</em>
whose <em>type</em> was <em>‘tether’</em>. It is now finally <em>‘usb’</em> as you’d expect. So our
language bindings are finally consistent with our <a href="https://gist.github.com/oleavr/e6af8791adbef8fbde06">core API</a>.</p>

<h3 id="changes-in-1201">Changes in 12.0.1</h3>

<ul>
  <li>core: fix argument access on 32-bit x86</li>
  <li>core: update <em>Stalker</em> to the new <em>CpuContext</em> semantics</li>
  <li>python: publish the correct README to PyPI</li>
  <li>python: fix the Windows build system</li>
</ul>

<h3 id="changes-in-1202">Changes in 12.0.2</h3>

<ul>
  <li>core: upgrade to Capstone’s <em>next</em> branch</li>
  <li>core: fix the DbgHelp backtracer on Windows and update to latest DbgHelp</li>
  <li>python: fix long description</li>
  <li>java: fix hooking of <em>java.lang.Class.getMethod()</em> – thanks <a href="https://github.com/0x3430D">0x3430D</a>!</li>
</ul>

<h3 id="changes-in-1203">Changes in 12.0.3</h3>

<ul>
  <li>core: fix the iOS build system broken by Capstone upgrade</li>
</ul>

<h3 id="changes-in-1204">Changes in 12.0.4</h3>

<ul>
  <li>core: fix i/macOS libc++ initialization on early instrumentation
      – thanks <a href="https://github.com/mrmacete">mrmacete</a>!</li>
  <li>core: add support for memory search with mask – thanks <a href="https://github.com/mrmacete">mrmacete</a>!</li>
  <li>core: fix <em>InvocationContext.get_return_address()</em></li>
  <li>node: fix crash on RPC object return from an async function</li>
</ul>

<h3 id="changes-in-1205">Changes in 12.0.5</h3>

<ul>
  <li>core: fix arm64 crashes caused by Capstone upgrade, where test-and-branch
      decoding logic failed to decode negative offsets – kudos to
      <a href="https://github.com/mrmacete">mrmacete</a> for discovering and fixing this one!</li>
  <li>core: fix MIPS regressions and one crasher – thanks <a href="https://github.com/r0ck3tAKATrashPanda">r0ck3tAKATrashPanda</a>!</li>
</ul>

<h3 id="changes-in-1206">Changes in 12.0.6</h3>

<ul>
  <li>python: improve <em>spawn()</em> to support unicode aux options on Python 2.x</li>
  <li>java: fix <em>Java.registerClass()</em> when cache dir is missing</li>
  <li>java: make the temporary file naming configurable</li>
</ul>

<h3 id="changes-in-1207">Changes in 12.0.7</h3>

<ul>
  <li>core: fix early instrumentation on iOS 11.3.1 through 11.4.1 – thanks
      <a href="https://github.com/mrmacete">mrmacete</a>!</li>
</ul>

<h3 id="changes-in-1208">Changes in 12.0.8</h3>

<ul>
  <li>core: fix launching of Android apps with custom process name – thanks
      <a href="https://github.com/giantpune">giantpune</a>!</li>
  <li>java: fix <em>ClassLinker</em> field offset detection on Android 8.0</li>
</ul>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2018/05/05/frida-11-0-released/index.html">
      Frida 11.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      05 May 2018
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s time to overhaul the <em>spawn()</em> API and fix some rough edges in the spawn-
and child-gating APIs.</p>

<h3 id="spawn">spawn()</h3>

<p>Say you’re using Frida’s Python bindings, you’d currently do:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">pid</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">spawn</span><span class="p">([</span><span class="s">"/bin/cat"</span><span class="p">,</span> <span class="s">"/etc/passwd"</span><span class="p">])</span></code></pre></figure>

<p>Or to spawn an iOS app:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">pid</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">spawn</span><span class="p">([</span><span class="s">"com.apple.mobilesafari"</span><span class="p">])</span></code></pre></figure>

<p>Well, that’s pretty much all you could do with that API really… except one
thing that wasn’t exposed by the Python and Node.js bindings. We’ll get to
that in a bit. Before we go there, let’s take a look at the underlying <a href="https://gist.github.com/oleavr/e6af8791adbef8fbde06">API</a>
in frida-core, which these bindings expose to different languages:</p>

<figure class="highlight"><pre><code class="language-vala" data-lang="vala"><span class="k">namespace</span> <span class="nn">Frida</span> <span class="p">{</span>
	<span class="err">…</span>
	<span class="k">public</span> <span class="k">class</span> <span class="nc">Device</span> <span class="p">:</span> <span class="n">GLib</span><span class="p">.</span><span class="n">Object</span> <span class="p">{</span>
		<span class="err">…</span>
		<span class="k">public</span> <span class="k">async</span> <span class="kt">uint</span> <span class="nf">spawn</span> <span class="p">(</span><span class="kt">string</span> <span class="n">path</span><span class="p">,</span>
			<span class="kt">string</span><span class="p">[]</span> <span class="n">argv</span><span class="p">,</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">envp</span><span class="p">)</span>
			<span class="k">throws</span> <span class="n">Frida</span><span class="p">.</span><span class="n">Error</span><span class="p">;</span>
		<span class="k">public</span> <span class="kt">uint</span> <span class="nf">spawn_sync</span> <span class="p">(</span><span class="kt">string</span> <span class="n">path</span><span class="p">,</span>
			<span class="kt">string</span><span class="p">[]</span> <span class="n">argv</span><span class="p">,</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">envp</span><span class="p">)</span>
			<span class="k">throws</span> <span class="n">Frida</span><span class="p">.</span><span class="n">Error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="err">…</span>
<span class="p">}</span></code></pre></figure>

<p>That’s <a href="https://wiki.gnome.org/Projects/Vala">Vala</a> code by the way, which is the language that frida-core is
written in. It’s a C#-like language that compiles to C, and it’s pretty awesome.
But I digress. The first method, <em>spawn()</em> is asynchronous, allowing the calling
thread to do other things while the call is in progress, whereas <em>spawn_sync()</em>
blocks until the operation completes.</p>

<p>Those two methods compile down to the following three C functions:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">frida_device_spawn</span> <span class="p">(</span><span class="n">FridaDevice</span> <span class="o">*</span> <span class="n">self</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span> <span class="n">path</span><span class="p">,</span>
    <span class="n">gchar</span> <span class="o">**</span> <span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argv_length</span><span class="p">,</span>
    <span class="n">gchar</span> <span class="o">**</span> <span class="n">envp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">envp_length</span><span class="p">,</span>
    <span class="n">GAsyncReadyCallback</span> <span class="n">callback</span><span class="p">,</span> <span class="n">gpointer</span> <span class="n">user_data</span><span class="p">);</span>
<span class="n">guint</span> <span class="nf">frida_device_spawn_finish</span> <span class="p">(</span><span class="n">FridaDevice</span> <span class="o">*</span> <span class="n">self</span><span class="p">,</span>
    <span class="n">GAsyncResult</span> <span class="o">*</span> <span class="n">result</span><span class="p">,</span> <span class="n">GError</span> <span class="o">**</span> <span class="n">error</span><span class="p">);</span>
<span class="n">guint</span> <span class="nf">frida_device_spawn_sync</span> <span class="p">(</span><span class="n">FridaDevice</span> <span class="o">*</span> <span class="n">self</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span> <span class="n">path</span><span class="p">,</span>
    <span class="n">gchar</span> <span class="o">**</span> <span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argv_length</span><span class="p">,</span>
    <span class="n">gchar</span> <span class="o">**</span> <span class="n">envp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">envp_length</span><span class="p">,</span>
    <span class="n">GError</span> <span class="o">**</span> <span class="n">error</span><span class="p">);</span></code></pre></figure>

<p>The first two constitute <em>spawn()</em>, where you’d call the first giving it a
callback, and once that callback gets called you’d call the second one,
<em>spawn_finish()</em>, giving it the <em>GAsyncResult</em> your callback was given.
The return value is the PID, or, in case it failed, the <em>error</em> out-argument
explains what went wrong. This is the <a href="https://developer.gnome.org/gio/stable/ch02.html">GIO</a> async pattern in case you’re
curious.</p>

<p>As for the third, <em>spawn_sync()</em>, this is what Frida’s Python bindings use.
Our Node.js bindings actually use the first two, as those bindings are fully
asynchronous. Someday it would be nice to also migrate our Python bindings to
be fully async, by integrating with the <em>async/await</em> support introduced in
Python 3.5.</p>

<p>Anyway, returning to the examples above, I mentioned there was something not
exposed. If you look closely at the frida-core API you’ll notice that there’s
the <em>envp</em> string-array. Peeking under the hood of the bindings, you’d realize
we did indeed not expose this, and we actually did this:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">  <span class="n">envp</span> <span class="o">=</span> <span class="n">g_get_environ</span> <span class="p">();</span>
  <span class="n">envp_length</span> <span class="o">=</span> <span class="n">g_strv_length</span> <span class="p">(</span><span class="n">envp</span><span class="p">);</span></code></pre></figure>

<p>So that means we passed along whatever the Python process’ environment happened
to be. That’s definitely not good if the actual spawning happened on another
system entirely, like on a connected iOS or Android device. What made this
slightly less problematic was the fact that <em>envp</em> was ignored when spawning
iOS and Android apps, and only used when spawning regular programs.</p>

<p>Another issue with this old API is that the declaration, <em>string[] envp</em>, means
it isn’t nullable, which it would have been if the declaration had been:
<em>string[]? envp</em>. That means there is no way to distinguish between wanting to
spawn without any environment, which intuitively would mean “use defaults”, and
an empty environment.</p>

<p>As I was about to fix this aspect of the API, I realized that it was time to
also fix a few other long-standing issues with it, like being able to:</p>

<ul>
  <li>provide just a few extra environment variables on top of the defaults</li>
  <li>set the working directory</li>
  <li>customize stdio redirection</li>
  <li>pass along platform-specific options</li>
</ul>

<p>Up until this point we have always redirected stdio to our own pipes, and
streamed any output through the <em>output</em> signal on <em>Device</em>. There was also
<em>Device.input()</em> for writing to <em>stdin</em>. Those APIs are still the same, the
only difference is that we no longer do such redirection by default. Most of
you were probably not too bothered with this, though, as we didn’t implement
such redirection for iOS and Android apps. Starting with this release we do
however finally implement it for iOS apps.</p>

<p>By now you’re probably wondering what the new API looks like. Let’s have a look:</p>

<figure class="highlight"><pre><code class="language-vala" data-lang="vala"><span class="k">namespace</span> <span class="nn">Frida</span> <span class="p">{</span>
	<span class="err">…</span>
	<span class="k">public</span> <span class="k">class</span> <span class="nc">Device</span> <span class="p">:</span> <span class="n">GLib</span><span class="p">.</span><span class="n">Object</span> <span class="p">{</span>
		<span class="err">…</span>
		<span class="k">public</span> <span class="k">async</span> <span class="kt">uint</span> <span class="nf">spawn</span> <span class="p">(</span><span class="kt">string</span> <span class="n">program</span><span class="p">,</span>
			<span class="n">Frida</span><span class="p">.</span><span class="n">SpawnOptions</span><span class="p">?</span> <span class="n">options</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
			<span class="k">throws</span> <span class="n">Frida</span><span class="p">.</span><span class="n">Error</span><span class="p">;</span>
		<span class="k">public</span> <span class="kt">uint</span> <span class="nf">spawn_sync</span> <span class="p">(</span><span class="kt">string</span> <span class="n">program</span><span class="p">,</span>
			<span class="n">Frida</span><span class="p">.</span><span class="n">SpawnOptions</span><span class="p">?</span> <span class="n">options</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
			<span class="k">throws</span> <span class="n">Frida</span><span class="p">.</span><span class="n">Error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="err">…</span>
	<span class="k">public</span> <span class="k">class</span> <span class="nc">SpawnOptions</span> <span class="p">:</span> <span class="n">GLib</span><span class="p">.</span><span class="n">Object</span> <span class="p">{</span>
		<span class="k">public</span> <span class="kt">string</span><span class="p">[]?</span> <span class="n">argv</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
		<span class="k">public</span> <span class="kt">string</span><span class="p">[]?</span> <span class="n">envp</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
		<span class="k">public</span> <span class="kt">string</span><span class="p">[]?</span> <span class="n">env</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
		<span class="k">public</span> <span class="kt">string</span><span class="p">?</span> <span class="n">cwd</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
		<span class="k">public</span> <span class="n">Frida</span><span class="p">.</span><span class="n">Stdio</span> <span class="n">stdio</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
		<span class="k">public</span> <span class="n">GLib</span><span class="p">.</span><span class="n">VariantDict</span> <span class="n">aux</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

		<span class="k">public</span> <span class="nf">SpawnOptions</span> <span class="p">();</span>
	<span class="p">}</span>
	<span class="err">…</span>
<span class="p">}</span></code></pre></figure>

<p>So going back to the Python examples at the beginning, those still work without
any changes. But, instead of:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">device</span><span class="p">.</span><span class="n">spawn</span><span class="p">([</span><span class="s">"com.apple.mobilesafari"</span><span class="p">])</span></code></pre></figure>

<p>You can now also do:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">device</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">"com.apple.mobilesafari"</span><span class="p">)</span></code></pre></figure>

<p>As the first argument is the <em>program</em> to spawn. You can still pass an <em>argv</em>
here and that will be used to set the <em>argv</em> option, meaning that <em>argv[0]</em> will
be used for the <em>program</em> argument. You can also do this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">device</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">"/bin/busybox"</span><span class="p">,</span> <span class="n">argv</span><span class="o">=</span><span class="p">[</span><span class="s">"/bin/cat"</span><span class="p">,</span> <span class="s">"/etc/passwd"</span><span class="p">])</span></code></pre></figure>

<p>And if you’d like to replace the entire environment instead of using defaults:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">device</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">"/bin/ls"</span><span class="p">,</span> <span class="n">envp</span><span class="o">=</span><span class="p">{</span> <span class="s">"CLICOLOR"</span><span class="p">:</span> <span class="s">"1"</span> <span class="p">})</span></code></pre></figure>

<p>Though in most cases you probably only want to add/override a few environment
variables, which is now also possible:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">device</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">"/bin/ls"</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span> <span class="s">"CLICOLOR"</span><span class="p">:</span> <span class="s">"1"</span> <span class="p">})</span></code></pre></figure>

<p>You might also want to use a different working directory:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">device</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">"/bin/ls"</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="s">"/etc"</span><span class="p">)</span></code></pre></figure>

<p>Or perhaps you’d like to redirect stdio:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">device</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">"/bin/ls"</span><span class="p">,</span> <span class="n">stdio</span><span class="o">=</span><span class="s">"pipe"</span><span class="p">)</span></code></pre></figure>

<p>The <em>stdio</em> default value is <em>inherit</em>, as mentioned earlier.</p>

<p>We have now covered all of the <em>SpawnOptions</em>, except the last of them: <em>aux</em>.
This is a dictionary for platform-specific options. Setting such options is
pretty simple with the Python bindings: any keyword-argument not recognized
will end up in that dictionary.</p>

<p>For example, to launch Safari and tell it to open a specific URL:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">device</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">"com.apple.mobilesafari"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s">"https://frida.re"</span><span class="p">)</span></code></pre></figure>

<p>Or perhaps you’d like to spawn an i/macOS program with ASLR disabled:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">device</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">"/bin/ls"</span><span class="p">,</span> <span class="n">aslr</span><span class="o">=</span><span class="s">"disable"</span><span class="p">)</span></code></pre></figure>

<p>Another example is spawning an Android app with a specific activity:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">spawn</span><span class="p">(</span><span class="s">"com.android.settings"</span><span class="p">,</span> <span class="n">activity</span><span class="o">=</span><span class="s">".SecuritySettings"</span><span class="p">)</span></code></pre></figure>

<p>And that’s actually all of the aux options we currently support – and what’s
great is that we can add new ones without needing to update our bindings.</p>

<p>But before we move on, let’s take a quick look at what this new API would look
like using our Node.js bindings:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">pid</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">device</span><span class="p">.</span><span class="nx">spawn</span><span class="p">(</span><span class="dl">'</span><span class="s1">/bin/sh</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">argv</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">/bin/sh</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">-c</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ls /</span><span class="dl">'</span><span class="p">],</span>
  <span class="na">env</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">BADGER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">badger-badger-badger</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">SNAKE</span><span class="dl">'</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">MUSHROOM</span><span class="dl">'</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="na">cwd</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/usr</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">stdio</span><span class="p">:</span> <span class="dl">'</span><span class="s1">pipe</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">aslr</span><span class="p">:</span> <span class="dl">'</span><span class="s1">auto</span><span class="dl">'</span>
<span class="p">});</span></code></pre></figure>

<p>So as you can see, the second argument is an object with options, and those not
recognized end up in the aux dictionary.</p>

<h3 id="remaining-changes-in-1100">Remaining changes in 11.0.0</h3>

<p>Let’s just summarize the remaining changes, starting with the <em>Device</em> class:</p>

<ul>
  <li><em>enumerate_pending_spawns()</em> is now <em>enumerate_pending_spawn()</em> to be
grammatically correct.</li>
  <li>The <em>spawned</em> signal has been renamed to <em>spawn-added</em>, and there is now also
<em>spawn-removed</em>.</li>
  <li>The <em>delivered</em> signal has been renamed to <em>child-added</em>, and there is now
also <em>child-removed</em>.</li>
</ul>

<p>The final change is that the <em>Child</em> class’ <em>path</em>, <em>argv</em>, and <em>envp</em>
properties are now all nullable. This is to be able to discern e.g. “no <em>envp</em>
provided” from “empty <em>envp</em> provided”.</p>

<h3 id="changes-in-1101">Changes in 11.0.1</h3>

<ul>
  <li>core: fix stack alignment of agent thread for 32-bit ARM processes</li>
  <li>core: fix fragile SELinux rule patching</li>
</ul>

<h3 id="changes-in-1102">Changes in 11.0.2</h3>

<ul>
  <li>core: plug Mach ports leaks in spawn()-logic on i/macOS (long-standing issue)</li>
</ul>

<h3 id="changes-in-1103">Changes in 11.0.3</h3>

<ul>
  <li>core: fix crash on iPhone 8 and X caused by bad tls_base calculation on arm64</li>
</ul>

<h3 id="changes-in-1104">Changes in 11.0.4</h3>

<ul>
  <li>python: update metadata and bump requirements</li>
</ul>

<h3 id="changes-in-1105">Changes in 11.0.5</h3>

<ul>
  <li>core: fix compatibility issue with Electra’s Tweak Injector</li>
  <li>core: fix process name truncation in <em>enumerate_processes()</em> on iOS</li>
  <li>java: Java.registerClass() now supports overloads</li>
  <li>packaging: every new release now comes with packages for Fedora and Ubuntu</li>
</ul>

<h3 id="changes-in-1106">Changes in 11.0.6</h3>

<ul>
  <li>python: fix dependency spec so REPL works again when installed from PyPI</li>
</ul>

<h3 id="changes-in-1107">Changes in 11.0.7</h3>

<ul>
  <li>core: better child gating API coverage on Windows</li>
  <li>python: 2.7 binaries for Linux are no longer broken when installed from PyPI</li>
</ul>

<h3 id="changes-in-1108">Changes in 11.0.8</h3>

<ul>
  <li>core: fix race resulting in crash on system session setup on some platforms</li>
  <li>python: fix deadlock on interpreter shutdown</li>
</ul>

<h3 id="changes-in-1109">Changes in 11.0.9</h3>

<ul>
  <li>java: fix issue preventing <em>Java.registerClass()</em> during early instrumentation</li>
</ul>

<h3 id="changes-in-11010">Changes in 11.0.10</h3>

<ul>
  <li>core: fix crash when enumerating imports/exports of ELF modules with an empty
DT_GNU_HASH</li>
</ul>

<h3 id="changes-in-11011">Changes in 11.0.11</h3>

<ul>
  <li>java: fix type compatibility checking, which typically resulted in the wrong
overload getting called, in turn causing the VM to abort()</li>
</ul>

<h3 id="changes-in-11012">Changes in 11.0.12</h3>

<ul>
  <li>core: fix compatibility issues with the latest macOS Mojave and iOS 12 betas</li>
  <li>core: improve the iOS <em>Kernel</em> API available in the system session, i.e. PID 0</li>
  <li>frida-trace: fix crash when tracer scripts <em>send()</em> arbitrary data</li>
</ul>

<h3 id="changes-in-11013">Changes in 11.0.13</h3>

<ul>
  <li>core: fix hang on teardown of script that was never <em>load()</em>ed</li>
</ul>

<h3 id="eof">EOF</h3>

<p>So that’s about it. If you didn’t read about the Frida 10.8 release that
happened last week, make sure you go read about it <a href="../2018/04/28/frida-10-8-released/index.html">here</a>.</p>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2018/04/28/frida-10-8-released/index.html">
      Frida 10.8 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      28 Apr 2018
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Get ready for a major upgrade. This time we have solved our three longest
standing limitations – all in one release.</p>

<h3 id="limitation-1-fork">Limitation #1: fork()</h3>

<p>As a quick refresher, this old-school UNIX API clones the entire process and
returns the child’s process ID to the parent, and zero to the child. The child
gets its own copy of the parent’s address space, usually at a very small cost
due to copy-on-write.</p>

<p>Dealing with this one gets tricky once multiple threads are involved. Only the
thread calling <em>fork()</em> survives in the child process, so if any of the other
threads happen to be holding locks, those locks will still be held in the child,
and nobody is going to release them.</p>

<p>Essentially this means that any application doing both forking and
multi-threading will have to be really carefully designed. Even though most
applications that fork are single-threaded, Frida effectively makes them
multi-threaded by injecting its agent into them. Another aspect is
file-descriptors, which are shared, so those also have to be carefully managed.</p>

<p>I’m super-excited to announce that we are finally able to detect that a <em>fork()</em>
is about to happen, temporarily stop our threads, pause our communications
channel, and start things back up afterwards. You are then able to apply the
desired instrumentation to the child, if any, before letting it continue
running.</p>

<h3 id="limitation-2-execve-posix_spawn-createprocess-and-friends">Limitation #2: execve(), posix_spawn(), CreateProcess(), and friends</h3>

<p>Or in plain English: programs that start other programs, either by replacing
themselves entirely, e.g. <em>execve()</em>, or by spawning a child process, e.g.
<em>posix_spawn()</em> without <em>POSIX_SPAWN_SETEXEC</em>.</p>

<p>Just like after a <em>fork()</em> happened you are now able to apply instrumentation
and control when the child process starts running its first instructions.</p>

<h3 id="limitation-3-dealing-with-sudden-process-termination">Limitation #3: dealing with sudden process termination</h3>

<p>An aspect that’s caused a lot of confusion in the past is how one might hand off
some data to Frida’s <em>send()</em> API, and if the process is about to terminate,
said data might not actually make it to the other side.</p>

<p>Up until now the prescribed solution was always to hook <em>exit()</em>, <em>abort()</em> etc.
so you can do a <em>send()</em> plus <em>recv().wait()</em> ping-pong to flush any data still
in transit. In retrospect this wasn’t such a great idea, as it makes it hard to
do this correctly across multiple platforms. We now have a way better solution.</p>

<p>So with that, let’s talk about the new APIs and features.</p>

<h3 id="child-gating">Child gating</h3>

<p>This is how we address the first two. The <em>Session</em> object, the one providing
<em>create_script()</em>, now also has <em>enable_child_gating()</em> and
<em>disable_child_gating()</em>. By default Frida will behave just like before, and
you will have to opt-in to this new behavior by calling <em>enable_child_gating()</em>.</p>

<p>From that point on, any child process is going to end up suspended, and you will
be responsible for calling <em>resume()</em> with its PID. The <em>Device</em> object now also
provides a signal named <em>delivered</em> which you should attach a callback to in
order to be notified of any new children that appear. That is the point where
you should be applying the desired instrumentation, if any, before calling
<em>resume()</em>. The <em>Device</em> object also has a new method named
<em>enumerate_pending_children()</em> which can be used to get a full list of pending
children. Processes will remain suspended and part of that list until they’re
resumed by you, or eventually killed.</p>

<p>So that’s the theory. Let’s have a look at a practical <a href="https://github.com/frida/frida-python/blob/c846da1191e50e017235f29580c737f5b8555d9a/examples/child_gating.py">example</a>, using
Frida’s Python bindings:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">frida</span>
<span class="kn">from</span> <span class="nn">frida.application</span> <span class="kn">import</span> <span class="n">Reactor</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="k">class</span> <span class="nc">Application</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_stop_requested</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_reactor</span> <span class="o">=</span> <span class="n">Reactor</span><span class="p">(</span><span class="n">run_until_return</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_stop_requested</span><span class="p">.</span><span class="n">wait</span><span class="p">())</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">get_local_device</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">_device</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">"delivered"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">child</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_reactor</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_on_delivered</span><span class="p">(</span><span class="n">child</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_reactor</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_start</span><span class="p">())</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_reactor</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="s">"-c"</span><span class="p">,</span> <span class="s">"cat /etc/hosts"</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"✔ spawn(argv={})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">argv</span><span class="p">))</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_device</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_instrument</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_stop_if_idle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_stop_requested</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"✔ attach(pid={})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_device</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">session</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">"detached"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">reason</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_reactor</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_on_detached</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">reason</span><span class="p">)))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"✔ enable_child_gating()"</span><span class="p">)</span>
        <span class="n">session</span><span class="p">.</span><span class="n">enable_child_gating</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"✔ create_script()"</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">create_script</span><span class="p">(</span><span class="s">"""
Interceptor.attach(Module.getExportByName(null, 'open'), {
  onEnter(args) {
    send({
      type: 'open',
      path: Memory.readUtf8String(args[0])
    });
  }
});
"""</span><span class="p">)</span>
        <span class="n">script</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s">"message"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">message</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_reactor</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_on_message</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">message</span><span class="p">)))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"✔ load()"</span><span class="p">)</span>
        <span class="n">script</span><span class="p">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"✔ resume(pid={})"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_device</span><span class="p">.</span><span class="n">resume</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_delivered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"⚡ delivered: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_instrument</span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_detached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"⚡ detached: pid={}, reason='{}'"</span>
            <span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_sessions</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_reactor</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_stop_if_idle</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"⚡ message: pid={}, payload={}"</span>
            <span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">message</span><span class="p">[</span><span class="s">"payload"</span><span class="p">]))</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">()</span>
<span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">()</span></code></pre></figure>

<p>And action:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python3 example.py
✔ spawn<span class="o">(</span><span class="nv">argv</span><span class="o">=[</span><span class="s1">'/bin/sh'</span>, <span class="s1">'-c'</span>, <span class="s1">'cat /etc/hosts'</span><span class="o">])</span>
✔ attach<span class="o">(</span><span class="nv">pid</span><span class="o">=</span>42401<span class="o">)</span>
✔ enable_child_gating<span class="o">()</span>
✔ create_script<span class="o">()</span>
✔ load<span class="o">()</span>
✔ resume<span class="o">(</span><span class="nv">pid</span><span class="o">=</span>42401<span class="o">)</span>
⚡ message: <span class="nv">pid</span><span class="o">=</span>42401,
↪payload<span class="o">={</span><span class="s1">'type'</span>: <span class="s1">'open'</span>, <span class="s1">'path'</span>: <span class="s1">'/dev/tty'</span><span class="o">}</span>
⚡ detached: <span class="nv">pid</span><span class="o">=</span>42401, <span class="nv">reason</span><span class="o">=</span><span class="s1">'process-replaced'</span>
⚡ delivered: Child<span class="o">(</span><span class="nv">pid</span><span class="o">=</span>42401, <span class="nv">parent_pid</span><span class="o">=</span>42401,
↪path<span class="o">=</span><span class="s2">"/bin/cat"</span>, <span class="nv">argv</span><span class="o">=[</span><span class="s1">'cat'</span>, <span class="s1">'/etc/hosts'</span><span class="o">]</span>,
↪envp<span class="o">=[</span><span class="s1">'SHELL=/bin/bash'</span>, <span class="s1">'TERM=xterm-256color'</span>, …],
↪origin<span class="o">=</span><span class="nb">exec</span><span class="o">)</span>
✔ attach<span class="o">(</span><span class="nv">pid</span><span class="o">=</span>42401<span class="o">)</span>
✔ enable_child_gating<span class="o">()</span>
✔ create_script<span class="o">()</span>
✔ load<span class="o">()</span>
✔ resume<span class="o">(</span><span class="nv">pid</span><span class="o">=</span>42401<span class="o">)</span>
⚡ message: <span class="nv">pid</span><span class="o">=</span>42401,
↪payload<span class="o">={</span><span class="s1">'type'</span>: <span class="s1">'open'</span>, <span class="s1">'path'</span>: <span class="s1">'/etc/hosts'</span><span class="o">}</span>
⚡ detached: <span class="nv">pid</span><span class="o">=</span>42401, <span class="nv">reason</span><span class="o">=</span><span class="s1">'process-terminated'</span>
<span class="err">$</span></code></pre></figure>

<h3 id="flush-before-exit">Flush-before-exit</h3>

<p>As for the third limitation, namely dealing with sudden process termination,
Frida will now intercept the most common process termination APIs and take
care of flushing any pending data for you.</p>

<p>However, for advanced agents that optimize throughput by buffering data and only
doing <em>send()</em> periodically, there is now a way to run your own code when the
process terminates, or the script is unloaded. All you need to do is to define
an <a href="../../docs/javascript-api/index.html#rpc">RPC</a> export named <em>dispose</em>. E.g.:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">rpc</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">dispose</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">send</span><span class="p">(</span><span class="nx">bufferedData</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></figure>

<h3 id="in-closing">In closing</h3>

<p>Building on the brand new <em>fork()</em>-handling in Frida, there is also a fully
reworked Android app launching implementation. The <em>frida-loader-{32,64}.so</em>
helper agents are now gone, and our behind-the-scenes Zygote instrumentation
is now leveraging the brand new child gating to do all of the heavy lifting.
This means you can also instrument Zygote for your own needs. Just remember to
<em>enable_child_gating()</em> and <em>resume()</em> any children that you don’t care about.</p>

<p>So that’s pretty much it for this release. Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2018/03/13/frida-10-7-released/index.html">
      Frida 10.7 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      13 Mar 2018
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>iOS users rejoice: Frida is now compatible with the latest <a href="https://coolstar.org/electra/">Electra</a>
jailbreak on iOS 11! At the time of this writing that means 1.0.4, but
now that Electra seems to have stabilized it should be safe to assume
that we’ll also be compatible with future updates. Just make sure you’re
not running anything older than 1.0.4.</p>

<p>In other news, our Android support has improved significantly over the
last releases, so if you’re even slightly behind: go grab the latest
10.7.x right away.</p>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2017/09/29/frida-10-6-released/index.html">
      Frida 10.6 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      29 Sep 2017
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s time for some big updates to Frida’s <a href="../../docs/gadget/index.html">Gadget</a>.</p>

<p>This component is really useful when dealing with jailed iOS and Android
devices, but is now also able to cover a lot of other scenarios.</p>

<p>Its environment variables are now gone, and have been replaced by an optional
configuration file. Because some apps may look for loaded libraries with “Frida”
in their name as part of their “anti-debug” defenses, we now allow you to rename
Gadget’s binary however you like. Along with this it now also supports three
different interaction types.</p>

<p>It can listen on a TCP port, like before, and it can also load scripts from the
filesystem and run fully autonomously. The latter part used to be really limited
but is now really flexible, as you can even tell it to load scripts from a
directory, where each script may have filters. This is pretty useful for
system-wide tampering, and should allow for even more interesting use-cases.</p>

<p>So without further ado, I would urge you all to check out the brand new docs
available <a href="../../docs/gadget/index.html">here</a>.</p>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2017/08/25/frida-10-5-released/index.html">
      Frida 10.5 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      25 Aug 2017
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>The midnight oil has been burning and countless cups of coffee have been
consumed here at <a href="https://www.nowsecure.com/">NowSecure</a>, and boy do we have news for you this time.</p>

<p>Continuing in the spirit of last release’ low-level bag of goodies, we’ll be
moving one level up the stack this time. We are going to introduce a brand new
way to use new CodeWriter APIs, enabling you to weave in your own instructions
into the machine code executed by any thread of your choosing. We’re talking
lazy dynamic recompilation on a per-thread basis, with precise control of the
compilation process.</p>

<p>But first a little background. Most people using Frida are probably using the
<a href="../../docs/javascript-api/index.html#interceptor">Interceptor</a> API to perform inline hooking, and/or doing method swizzling or
replacement through the <a href="../../docs/javascript-api/index.html#objc">ObjC</a> and <a href="../../docs/javascript-api/index.html#java">Java</a> APIs. The idea is typically to
modify some interesting API that you expect to be called, and be able to divert
execution to your own code in order to observe, augment, or fully replace
application behavior.</p>

<p>One drawback to such approaches is that code or data is modified, and such
changes can be trivially detected. This is fine though, as being invisible to
the hosting process’ own code is always going to be a cat and mouse game when
doing in-process instrumentation.</p>

<p>These techniques are however quite limited when trying to answer the question
of “behind this private API, which other APIs actually get called for a given
input?”. Or, when doing reversing and fuzzing, you might want to know where
execution diverges between two known inputs to a given function. Another example
is measuring code coverage. You could use Interceptor’s support for
instruction-level probes, first using a static analysis tool to find all the
basic blocks and then using Frida to put single-shot probes all over the place.</p>

<p>Enter Stalker. It’s not a new API, but it’s been fairly limited in what it
allowed you to do. Think of it as a per-thread code-tracer, where the thread’s
original machine code is dynamically recompiled to new memory locations in
order to weave in instrumentation between the original instructions.</p>

<p>It does this recompilation lazily, one basic-block at a time. Considering that
a lot of self-modifying code exists, it is careful about caching compiled blocks
in case the original code changes after the fact.</p>

<p>Stalker also goes to great lengths to recompile the code such that
side-effects are identical. E.g. if the original instruction is a CALL it will
make sure that the address of the original next instruction is what’s pushed on
the stack, and not the address of the next recompiled instruction.</p>

<p>Anyway, Stalker has historically been like a pet project inside of a pet
project. A lot of fun, but other parts of Frida received most of my attention
over the years. There have been some awesome exceptions though. Me and
<a href="https://twitter.com/karltk">@karltk</a> did some <a href="http://blog.kalleberg.org/post/833101026/live-x86-code-instrumentation-with-frida">fun pair-programming sessions</a> many years ago when we
sat down and decided to get Stalker working well on hostile code. At some
later point I put together <a href="https://www.youtube.com/watch?v=hzDsxtcRavY">CryptoShark</a> in order get people excited about its
potential. Some time went by and suddenly Stalker received a critical bug-fix
contributed by <a href="https://twitter.com/elvanderb">Eloi Vanderbeken</a>. Early this year, <a href="https://twitter.com/AKIannillo">Antonio Ken Iannillo</a>
jumped on board and ported it to arm64. Then, very recently, <a href="https://github.com/erik-smit">Erik Smit</a>
showed up and fixed a critical bug where we would produce invalid code for
REP-prefixed JCC instructions. Yay!</p>

<p>Stalker’s API has so far been really limited. You can tell it to follow a
thread, including the thread you’re in, which is useful in combination with
inline hooking, i.e. Interceptor. The only two things you could do was:</p>

<ol>
  <li>Tell it which events you’re interested in, e.g. <code class="language-plaintext highlighter-rouge">call: true</code>, which will
produce one event per CALL instruction. This means Stalker will add some
logging code before each such instruction, and that would log where the
CALL happened, its target, and its stack depth. The other event types are
very similar.</li>
  <li>Add your own call probes for specific targets, giving you a synchronous
callback into JavaScript when a CALL is made to a specific target.</li>
</ol>

<p>I’m super-excited to announce that we’ve just introduced a third thing you
can do with this API, and this one is a game changer. You can now customize
the recompilation process, and it’s really easy:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">appModule</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">enumerateModulesSync</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
<span class="kd">const</span> <span class="nx">appStart</span> <span class="o">=</span> <span class="nx">appModule</span><span class="p">.</span><span class="nx">base</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">appEnd</span> <span class="o">=</span> <span class="nx">appStart</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">appModule</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span>

<span class="nx">Process</span><span class="p">.</span><span class="nx">enumerateThreadsSync</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">thread</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Stalking </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">thread</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

  <span class="nx">Stalker</span><span class="p">.</span><span class="nx">follow</span><span class="p">(</span><span class="nx">thread</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">transform</span><span class="p">(</span><span class="nx">iterator</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">instruction</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>

      <span class="kd">const</span> <span class="nx">startAddress</span> <span class="o">=</span> <span class="nx">instruction</span><span class="p">.</span><span class="nx">address</span><span class="p">;</span>
      <span class="kd">const</span> <span class="nx">isAppCode</span> <span class="o">=</span> <span class="nx">startAddress</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">appStart</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
          <span class="nx">startAddress</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">appEnd</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

      <span class="k">do</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isAppCode</span> <span class="o">&amp;&amp;</span> <span class="nx">instruction</span><span class="p">.</span><span class="nx">mnemonic</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">ret</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">iterator</span><span class="p">.</span><span class="nx">putCmpRegI32</span><span class="p">(</span><span class="dl">'</span><span class="s1">eax</span><span class="dl">'</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
          <span class="nx">iterator</span><span class="p">.</span><span class="nx">putJccShortLabel</span><span class="p">(</span><span class="dl">'</span><span class="s1">jb</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">nope</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-hint</span><span class="dl">'</span><span class="p">);</span>

          <span class="nx">iterator</span><span class="p">.</span><span class="nx">putCmpRegI32</span><span class="p">(</span><span class="dl">'</span><span class="s1">eax</span><span class="dl">'</span><span class="p">,</span> <span class="mi">90</span><span class="p">);</span>
          <span class="nx">iterator</span><span class="p">.</span><span class="nx">putJccShortLabel</span><span class="p">(</span><span class="dl">'</span><span class="s1">ja</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">nope</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-hint</span><span class="dl">'</span><span class="p">);</span>

          <span class="nx">iterator</span><span class="p">.</span><span class="nx">putCallout</span><span class="p">(</span><span class="nx">onMatch</span><span class="p">);</span>

          <span class="nx">iterator</span><span class="p">.</span><span class="nx">putLabel</span><span class="p">(</span><span class="dl">'</span><span class="s1">nope</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">iterator</span><span class="p">.</span><span class="nx">keep</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="nx">instruction</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">onMatch</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Match! pc=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">context</span><span class="p">.</span><span class="nx">pc</span> <span class="o">+</span>
      <span class="dl">'</span><span class="s1"> rax=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">context</span><span class="p">.</span><span class="nx">rax</span><span class="p">.</span><span class="nx">toInt32</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">transform</code> callback gets called synchronously whenever a new basic block
is about to be compiled. It gives you an iterator that you then use to drive
the recompilation-process forward, one instruction at a time. The returned
<a href="../../docs/javascript-api/index.html#instruction">Instruction</a> tells you what you need to know about the instruction that’s
about to be recompiled. You then call <code class="language-plaintext highlighter-rouge">keep()</code> to allow Stalker to recompile
it as it normally would. This means you can omit this call if you want to skip
some instructions, e.g. because you’ve replaced them with your own code. The
iterator also allows you to insert your own instructions, as it exposes the full
CodeWriter API of the current architecture, e.g. <a href="../../docs/javascript-api/index.html#x86writer">X86Writer</a>.</p>

<p>The example above determines where the application’s own code is in memory, and
adds a few extra instructions before every RET instruction in any code belonging
to the application itself. This code checks if <code class="language-plaintext highlighter-rouge">eax</code> contains a value between 60
and 90, and if it does, calls out to JavaScript to let it implement arbitrarily
complex logic. This callback can read and modify registers as it pleases.
What’s nice about this approach is that you can insert code into hot code-paths
and selectively call into JavaScript, making it easy to do really fast checks in
machine code but offload more complex tasks to a higher level language. You can
also <code class="language-plaintext highlighter-rouge">Memory.alloc()</code> and have the generated code write directly there, without
entering into JavaScript at all.</p>

<p>So that’s the big new thing in 10.5. Special thanks to <a href="https://twitter.com/asabil">@asabil</a> who helped
shape this new API.</p>

<p>In closing, the only other big change is that the Instruction API now exposes
a lot more details of the underlying <a href="http://www.capstone-engine.org/">Capstone</a> instruction. Stalker also
uses a lot less memory on both x86 and arm64, and is also more reliable. Lastly,
<a href="../../docs/javascript-api/index.html#process">Process.setExceptionHandler()</a> is now a documented API, along with our
<a href="../../docs/javascript-api/index.html#sqlitedatabase">SQLite API</a>.</p>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2017/08/15/frida-10-4-released/index.html">
      Frida 10.4 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      15 Aug 2017
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Frida provides quite a few building blocks that make it easy to do portable
instrumentation across many OSes and architectures. One area that’s been lacking
has been in non-portable use-cases. While we did provide some primitives like
<em>Memory.alloc(Process.pageSize)</em> and <em>Memory.patchCode()</em>, making it possible to
allocate and modify in-memory code, there wasn’t anything to help you actually
generate code. Or copy code from one memory location to another.</p>

<p>Considering that Frida needs to generate and transform quite a bit of machine
code for its own needs, e.g. to implement <em>Interceptor</em> and <em>Stalker</em>, it should
come as no surprise that we already have C APIs to do these things across six
different instruction set flavors. Initially these APIs were so barebones that I
didn’t see much value in exposing them to JavaScript, but after many years of
interesting internal use-cases they’ve evolved to the point where the essential
bits are now covered pretty well.</p>

<p>So with 10.4 we are finally exposing all of these APIs to JavaScript. It’s also
worth mentioning that these new bindings are auto-generated, so future additions
will be effortless.</p>

<p>Let’s take a look at an example on x86:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">getLivesLeft</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="dl">'</span><span class="s1">game-engine.so</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">get_lives_left</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">maxPatchSize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span> <span class="c1">// Do not write out of bounds, may be</span>
                         <span class="c1">// a temporary buffer!</span>
<span class="nx">Memory</span><span class="p">.</span><span class="nx">patchCode</span><span class="p">(</span><span class="nx">getLivesLeft</span><span class="p">,</span> <span class="nx">maxPatchSize</span><span class="p">,</span> <span class="nx">code</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">cw</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">X86Writer</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="p">{</span> <span class="na">pc</span><span class="p">:</span> <span class="nx">getLivesLeft</span> <span class="p">});</span>
  <span class="nx">cw</span><span class="p">.</span><span class="nx">putMovRegU32</span><span class="p">(</span><span class="dl">'</span><span class="s1">eax</span><span class="dl">'</span><span class="p">,</span> <span class="mi">9999</span><span class="p">);</span>
  <span class="nx">cw</span><span class="p">.</span><span class="nx">putRet</span><span class="p">();</span>
  <span class="nx">cw</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
<span class="p">});</span></code></pre></figure>

<p>Which means we replaced the beginning of our target function with simply:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="mi">9999</span>
<span class="nf">ret</span></code></pre></figure>

<p>I.e. assuming the return type is <code class="language-plaintext highlighter-rouge">int</code>, we just replaced the function body with
<code class="language-plaintext highlighter-rouge">return 9999;</code>.</p>

<p>As a side-note you could also use <em>Memory.protect()</em> to change the page
protection and then go ahead and write code all over the place, but
<em>Memory.patchCode()</em> is very handy because it also</p>

<ul>
  <li>ensures CPU caches are flushed;</li>
  <li>takes care of code-signing corner-cases on iOS.</li>
</ul>

<p>So that was a simple example. Let’s try something a bit crazier:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">multiply</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NativeCallback</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">a</span> <span class="o">*</span> <span class="nx">b</span><span class="p">;</span>
<span class="p">},</span> <span class="dl">'</span><span class="s1">int</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">int</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">int</span><span class="dl">'</span><span class="p">]);</span>

<span class="kd">const</span> <span class="nx">impl</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">alloc</span><span class="p">(</span><span class="nx">Process</span><span class="p">.</span><span class="nx">pageSize</span><span class="p">);</span>

<span class="nx">Memory</span><span class="p">.</span><span class="nx">patchCode</span><span class="p">(</span><span class="nx">impl</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="nx">code</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">cw</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">X86Writer</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="p">{</span> <span class="na">pc</span><span class="p">:</span> <span class="nx">impl</span> <span class="p">});</span>

  <span class="nx">cw</span><span class="p">.</span><span class="nx">putMovRegU32</span><span class="p">(</span><span class="dl">'</span><span class="s1">eax</span><span class="dl">'</span><span class="p">,</span> <span class="mi">42</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">stackAlignOffset</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">pointerSize</span><span class="p">;</span>
  <span class="nx">cw</span><span class="p">.</span><span class="nx">putSubRegImm</span><span class="p">(</span><span class="dl">'</span><span class="s1">xsp</span><span class="dl">'</span><span class="p">,</span> <span class="nx">stackAlignOffset</span><span class="p">);</span>

  <span class="nx">cw</span><span class="p">.</span><span class="nx">putCallAddressWithArguments</span><span class="p">(</span><span class="nx">multiply</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">eax</span><span class="dl">'</span><span class="p">,</span> <span class="mi">7</span><span class="p">]);</span>

  <span class="nx">cw</span><span class="p">.</span><span class="nx">putAddRegImm</span><span class="p">(</span><span class="dl">'</span><span class="s1">xsp</span><span class="dl">'</span><span class="p">,</span> <span class="nx">stackAlignOffset</span><span class="p">);</span>

  <span class="nx">cw</span><span class="p">.</span><span class="nx">putJmpShortLabel</span><span class="p">(</span><span class="dl">'</span><span class="s1">done</span><span class="dl">'</span><span class="p">);</span>

  <span class="nx">cw</span><span class="p">.</span><span class="nx">putMovRegU32</span><span class="p">(</span><span class="dl">'</span><span class="s1">eax</span><span class="dl">'</span><span class="p">,</span> <span class="mi">43</span><span class="p">);</span>

  <span class="nx">cw</span><span class="p">.</span><span class="nx">putLabel</span><span class="p">(</span><span class="dl">'</span><span class="s1">done</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">cw</span><span class="p">.</span><span class="nx">putRet</span><span class="p">();</span>

  <span class="nx">cw</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NativeFunction</span><span class="p">(</span><span class="nx">impl</span><span class="p">,</span> <span class="dl">'</span><span class="s1">int</span><span class="dl">'</span><span class="p">,</span> <span class="p">[]);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">());</span></code></pre></figure>

<p>Though that’s quite a few hoops just to multiply <em>42</em> by <em>7</em>, the idea is to
illustrate how calling functions, even back into JavaScript, and jumping to
labels, is actually quite easy.</p>

<p>Finally, let’s look at how to copy instructions from one memory location to
another. Doing this correctly is typically a lot more complicated than a
straight <em>memcpy()</em>, as some instructions are position-dependent and need to
be adjusted based on their new locations in memory. Let’s look at how we can
solve this with Frida’s new relocator APIs:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">impl</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">alloc</span><span class="p">(</span><span class="nx">Process</span><span class="p">.</span><span class="nx">pageSize</span><span class="p">);</span>

<span class="nx">Memory</span><span class="p">.</span><span class="nx">patchCode</span><span class="p">(</span><span class="nx">impl</span><span class="p">,</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">pageSize</span><span class="p">,</span> <span class="nx">code</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">cw</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">X86Writer</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="p">{</span> <span class="na">pc</span><span class="p">:</span> <span class="nx">impl</span> <span class="p">});</span>

  <span class="kd">const</span> <span class="nx">libcPuts</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">puts</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">rl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">X86Relocator</span><span class="p">(</span><span class="nx">libcPuts</span><span class="p">,</span> <span class="nx">cw</span><span class="p">);</span>

  <span class="k">while</span> <span class="p">(</span><span class="nx">rl</span><span class="p">.</span><span class="nx">readOne</span><span class="p">()</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Relocating: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">rl</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
    <span class="nx">rl</span><span class="p">.</span><span class="nx">writeOne</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">cw</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">puts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NativeFunction</span><span class="p">(</span><span class="nx">impl</span><span class="p">,</span> <span class="dl">'</span><span class="s1">int</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">pointer</span><span class="dl">'</span><span class="p">]);</span>
<span class="nx">puts</span><span class="p">(</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">allocUtf8String</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hello!</span><span class="dl">'</span><span class="p">));</span></code></pre></figure>

<p>We just made our own replica of <em>puts()</em> in just a few lines of code. Neat!</p>

<p>Note that you can also insert your own instructions, and use <em>skipOne()</em> to
selectively skip instructions in case you want to do custom instrumentation.
(This is how Stalker works.)</p>

<p>Anyway, that’s the gist of it. You can find the brand new API references at:</p>

<ul>
  <li>x86
    <ul>
      <li><a href="../../docs/javascript-api/index.html#x86writer">X86Writer</a></li>
      <li><a href="../../docs/javascript-api/index.html#x86relocator">X86Relocator</a></li>
    </ul>
  </li>
  <li>arm
    <ul>
      <li><a href="../../docs/javascript-api/index.html#armwriter">ArmWriter</a></li>
      <li><a href="../../docs/javascript-api/index.html#armrelocator">ArmRelocator</a></li>
      <li><a href="../../docs/javascript-api/index.html#thumbwriter">ThumbWriter</a></li>
      <li><a href="../../docs/javascript-api/index.html#thumbrelocator">ThumbRelocator</a></li>
    </ul>
  </li>
  <li>arm64
    <ul>
      <li><a href="../../docs/javascript-api/index.html#arm64writer">Arm64Writer</a></li>
      <li><a href="../../docs/javascript-api/index.html#arm64relocator">Arm64Relocator</a></li>
    </ul>
  </li>
  <li>mips
    <ul>
      <li><a href="../../docs/javascript-api/index.html#mipswriter">MipsWriter</a></li>
      <li><a href="../../docs/javascript-api/index.html#mipsrelocator">MipsRelocator</a></li>
    </ul>
  </li>
</ul>

<p>Also note that <em>Process.arch</em> is convenient for determining which
writer/relocator to use. On that note you may wonder why there’s just a single
implementation for 32- and 64-bit x86. The reason is that these instruction sets
are so close that it made sense to have a unified implementation. This also
makes it easier to write somewhat portable code, as some meta register-names are
available. E.g. <code class="language-plaintext highlighter-rouge">xax</code> resolves to <code class="language-plaintext highlighter-rouge">eax</code> vs <code class="language-plaintext highlighter-rouge">rax</code> depending on the kind of
process you are in.</p>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2017/05/02/frida-10-0-released/index.html">
      Frida 10.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      02 May 2017
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>This time we’re kicking it up a notch. We’re bringing you stability
improvements and state of the art JavaScript support.</p>

<p>Let’s talk about the stability improvements first. We fixed a heap
corruption affecting all Linux users. This one was particularly hard to
track down, but <a href="http://rr-project.org/">rr</a> saved the day. The other issue was a crash on
unload in the Duktape runtime, affecting all OSes.</p>

<p>Dependencies were also upgraded, so as of Frida 10.0.0 you can now enjoy
V8 6.0.124, released just days ago. We also upgraded Duktape to the
latest 2.1.x. The Duktape upgrade resulted in slight changes to the
bytecode semantics, which meant we had to break our API slightly.
Instead of specifying a script’s name at load time, it is now specified
when compiling it to bytecode, as this metadata is now included in the
bytecode. This makes a lot more sense, so it was a welcome change.</p>

<p>Beside V8 and Duktape we’re also using the latest GLib, Vala compiler,
etc. These upgrades also included JSON-GLib, which recently ditched
autotools in favor of <a href="http://mesonbuild.com/">Meson</a>. This is excellent news, as we’re also
planning on moving to Meson down the road, so we’ve now done the
necessary groundwork for making this happen.</p>

<p>So that’s about it. This upgrade should not require any changes to
existing code – unless of course you are among the few using the
bytecode API.</p>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2017/01/09/frida-9-0-released/index.html">
      Frida 9.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      09 Jan 2017
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Some big changes this time. We now use our <a href="http://duktape.org/">Duktape</a>-based JavaScript runtime
by default on all platforms, iOS app launching no longer piggybacks on Cydia
Substrate, and we are bringing some massive performance improvements. That, and
some bugfixes.</p>

<p>Let’s talk about Duktape first. Frida’s first JS runtime was based on <a href="https://developers.google.com/v8/">V8</a>,
and I’m really happy about that choice. It is however quite obvious that there
are use-cases where it is a bad fit.</p>

<p>Some systems, e.g. iOS, don’t allow RWX memory<sup id="ios-rwx-sup"><a href="index.html#ios-rwx">1</a></sup>,
and V8 won’t run without that. Another example is resource-constrained embedded
systems where there just isn’t enough memory. And, as reported by users from
time to time, some processes decide to configure their threads to have tiny
stacks. V8 is however quite stack-hungry, so if you hook a function called by
any of those threads, it won’t necessarily be able to enter V8, and your hooks
appear to be ignored<sup id="v8-stack-sup"><a href="index.html#v8-stack">2</a></sup>.</p>

<p>Another aspect is that V8 is way more expensive than Duktape for the native ⇔
JS transitions, so if your Frida agent is all about API hooks, and your hooks
are really small, you might actually be better off with Duktape. Garbage
collection is also more predictable with Duktape, which is good for hooking
time-sensitive code.</p>

<p>That said, if your agent is heavy on JavaScript, V8 will be way faster. It also
comes with native ES6 support, although this isn’t too big a deal since
non-trivial agents should be using <a href="https://github.com/frida/frida-compile">frida-compile</a>, which compiles your code
to ES5.</p>

<p>So the V8 runtime is not going away, and it will remain a first-class citizen.
The only thing that’s changing is that we pick Duktape by default, so that you
are guaranteed to get the same runtime on all platforms, with a high probability
that it’s going to work.</p>

<p>However, if your use-case is JS-heavy, all you have to do is call
<em>Session#enable_jit()</em> before the first script is created, and V8 will be used.
For our CLI tools you may pass <em>–enable-jit</em> to get the same effect.</p>

<p>That was Duktape. What’s the story about app launching and Substrate, then?
Well, up until now our iOS app launching was piggybacking on Substrate. This was
a pragmatic solution in order to avoid going into interoperability scenarios
where Frida and Substrate would both hook <em>posix_spawn()</em> in launchd and
xpcproxy, and step on each other.</p>

<p>It was however on my long-term TODO to fix this, as it added a lot of complexity
in other areas. E.g. an out-of-band callback mechanism so our Substrate plugin
could talk back to us at load time, having to manage temporary files, etc.
In addition to that, it meant we were depending on a closed source third-party
component, even though it was a soft-dependency only needed for iOS app
launching. But still, it was the only part of Frida that indirectly required
permanent modifications to the running system, and we really want to avoid
that.</p>

<p>Let’s have a look at how the new app launching works. Imagine that you ran
this on your host machine that’s got a jailbroken iOS device connected to it
over USB:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida-trace <span class="nt">-U</span> <span class="nt">-f</span> com.atebits.Tweetie2 <span class="nt">-i</span> open</code></pre></figure>

<p>We’re telling it to launch Twitter’s iOS app and trace functions named <em>open</em>.
As a side-note, if you’re curious about the details, frida-trace is written in
Python and is less than 900 lines of <a href="https://github.com/frida/frida-python/blob/9c876f457cdee4d3dab6c05c8ab8c4bd72ca42d1/src/frida/tracer.py">code</a>, so it might be a good way to
learn more about building your own tools on top of Frida. Or perhaps you’d
like to improve frida-trace? Even better!</p>

<p>The first part that it does is that it gets hold of the first USB device and
launches the Twitter app there. This boils down to:</p>

<figure class="highlight"><pre><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">frida</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">get_usb_device</span><span class="p">()</span>
<span class="n">pid</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">spawn</span><span class="p">([</span><span class="s">"com.atebits.Tweetie2"</span><span class="p">])</span></code></pre></figure>

<p>What now happens behind the scenes is this:</p>

<ol>
  <li>We inject our <a href="https://github.com/frida/frida-core/blob/12be27ab171c8bac9b4a60db5b3957f30f4be938/src/darwin/agent/launchd.js">launchd.js</a> agent into launchd (if not done already).</li>
  <li>Call the agent’s RPC-exported <a href="https://github.com/frida/frida-core/blob/12be27ab171c8bac9b4a60db5b3957f30f4be938/src/darwin/agent/launchd.js#L18-L21">prepareForLaunch()</a> giving it the identifier
  of the app we’re about to launch.</li>
  <li>Call <a href="https://github.com/frida/frida-core/blob/12be27ab171c8bac9b4a60db5b3957f30f4be938/src/darwin/frida-helper-backend-glue.m#L560-L563">SBSLaunchApplicationWithIdentifierAndLaunchOptions()</a> so SpringBoard
  launches the app.</li>
  <li>Our launchd.js agent then intercept launchd’s <em>__posix_spawn()</em> and adds
  <a href="https://github.com/frida/frida-core/blob/12be27ab171c8bac9b4a60db5b3957f30f4be938/src/darwin/agent/launchd.js#L60">POSIX_SPAWN_START_SUSPENDED</a>, and <a href="https://github.com/frida/frida-core/blob/12be27ab171c8bac9b4a60db5b3957f30f4be938/src/darwin/agent/launchd.js#L85">signals back</a> the identifier and PID.
  This is the <em>/usr/libexec/xpcproxy</em> helper that will perform an exec()-style
  transition to become the app.</li>
  <li>We then inject our <a href="https://github.com/frida/frida-core/blob/12be27ab171c8bac9b4a60db5b3957f30f4be938/src/darwin/agent/xpcproxy.js">xpcproxy.js</a> agent into this so it can hook
  <em>__posix_spawn()</em> and add <em>POSIX_SPAWN_START_SUSPENDED</em> just like our launchd
  agent did. This one will however also have <em>POSIX_SPAWN_SETEXEC</em>, so that
  means it will replace itself with the app to be launched.</li>
  <li>We <em>resume()</em> the xpcproxy process and <a href="https://github.com/frida/frida-core/blob/12be27ab171c8bac9b4a60db5b3957f30f4be938/src/darwin/darwin-host-session.vala#L476-L478">wait for the exec</a> to happen and the
  process to be suspended.</li>
</ol>

<p>At this point we let the <em>device.spawn()</em> return with the PID of the app that
was just launched. The app’s process has been created, and the main thread is
suspended at dyld’s entrypoint. frida-trace will then want to attach to it
so it can load its agent that hooks <em>open</em>. So it goes ahead and does something
similar to this:</p>

<figure class="highlight"><pre><code class="language-py" data-lang="py"><span class="n">session</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<span class="n">script</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">create_script</span><span class="p">(</span><span class="s">"""
Interceptor.attach(Module.getExportByName(null, 'open'), {
  onEnter() {
    console.log('open()');
  }
});
"""</span><span class="p">)</span>
<span class="n">script</span><span class="p">.</span><span class="n">load</span><span class="p">()</span></code></pre></figure>

<p>Now that it has applied the instrumentation, it will ask Frida to resume
the process so the main thread can call <em>main()</em> and have some fun:</p>

<figure class="highlight"><pre><code class="language-py" data-lang="py"><span class="n">device</span><span class="p">.</span><span class="n">resume</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span></code></pre></figure>

<p>Note that I did skip over a few details here, as the <em>attach()</em> operation is
actually a bit more complicated due to how uninitialized the process is, but
you can read more about that <a href="https://github.com/frida/frida-core/blob/12be27ab171c8bac9b4a60db5b3957f30f4be938/src/darwin/frida-helper-backend-glue.m#L835-L861">here</a>.</p>

<p>Finally, let’s talk about footprint and performance. First, let’s examine how
much disk space is required when Frida is installed on an iOS device and is
in a fully operational state:</p>

<iframe width="600" height="400" src="https://live.amcharts.com/RmODB/embed/" frameborder="0"></iframe>

<p>That’s the 64-bit version, which is only 1.87 MB xz-compressed. The 32-bit
version is obviously even smaller. Quite a few optimizations at play here:</p>

<ul>
  <li>We used to write the frida-helper binary out to a temporary file and spawn it.
The meat of the frida-helper program is now statically linked into
frida-server, and its entitlements have been boosted along with it. This
binary is only necessary when Frida is used as a plugin in an unknown process,
i.e. where we cannot make any guarantees about entitlements and code-signing.
In the frida-server case, however, it is able to guarantee that all such
constraints are met.</li>
  <li>The library that we inject into processes to be instrumented,
<em>frida-agent.dylib</em>, is no longer written out to a temporary file. We use
our own out-of-process dynamic linker to map it from frida-server’s memory
and directly into the address space of the target process. These mappings
are made copy-on-write, so that means it is as memory-efficient as the old
<em>dlopen()</em> approach was.</li>
  <li>V8 was disabled for the iOS binaries as it’s only really usable on old
jailbreaks where the kernel is patched to allow RWX pages.
(If V8 is important to your use-case, you can build it like this:
 <code class="language-plaintext highlighter-rouge">make server-ios FRIDA_DIET=no</code>)</li>
  <li>The iOS package has been split into two, “Frida” for 64-bit devices, and
“Frida for 32-bit devices” for old devices.</li>
  <li>Getting rid of the Substrate dependency for iOS app launching also meant
we got rid of FridaLoader.dylib. This is however a very minor improvement.</li>
</ul>

<p>Alright, so that’s disk footprint. How about memory usage?</p>

<iframe width="600" height="400" src="https://live.amcharts.com/jJkYT/embed/" frameborder="0"></iframe>

<p>Nice. How about performance? Let’s have a look:</p>

<iframe width="600" height="400" src="https://live.amcharts.com/5ZTI5/embed/" frameborder="0"></iframe>

<p>Note that these measurements include the time spent communicating from the
macOS host to the iOS device over USB.</p>

<p>Enjoy!</p>

<p><b id="ios-rwx">1</b> Except if the process has an entitlement, although that’s
limited to just one region. <a href="index.html#ios-rwx-sup">↩</a></p>

<p><b id="v8-stack">2</b>: It is technically possible to work around this by
having a per-thread side-stack that we switch to before calling into V8. We
did actually have this partially implemented in the past. Might be something
we should revive in the longer term. <a href="index.html#v8-stack-sup">↩</a></p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2016/10/25/frida-8-1-released/index.html">
      Frida 8.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      25 Oct 2016
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s time for a release, and this time we have some big new things for those of
you building Frida-based tools, plus a few additional goodies. Let’s start with
the first part.</p>

<p>There’s no doubt that Frida’s <a href="../../docs/javascript-api/index.html">JavaScript API</a> is fairly low-level and only
meant to provide low-level building blocks that don’t pertain to just one
specific use-case. If your use-case involves grabbing screenshots on iOS, for
example, this is not functionality one would expect to find in Frida itself.</p>

<p>You may then wonder how different tools with common features are supposed to
share agent code with each other, and luckily the answer is not “copy paste”.
We have a growing <a href="https://www.npmjs.com/search?q=frida">ecosystem</a> of Frida-specific libraries, like
<a href="https://www.npmjs.com/package/frida-screenshot">frida-screenshot</a>, <a href="https://www.npmjs.com/package/frida-uikit">frida-uikit</a>, <a href="https://www.npmjs.com/package/frida-trace">frida-trace</a>, etc.</p>

<p>Perhaps some of you would be interested in APIs for instrumenting backend
software written in Java, .NET, Python, Ruby, or Perl, or perhaps you would want
to trace crypto APIs across different OSes and libraries, or some other cool
idea. I would then highly recommend that you publish your module to npm, perhaps
naming your module <em>frida-$name</em> to make it easy to discover.</p>

<p>Now you might be asking “but Frida does not support <em>require()</em>, how can I even
split my agent code into multiple files in the first place?”. I’m glad you
asked! This is where a handy little CLI tool called <a href="https://www.npmjs.com/package/frida-compile">frida-compile</a> enters
the picture.</p>

<p>You give it a <em>.js</em> file as input and it will take care of bundling up any other
files it depends on into just one file. But unlike a homegrown concatenation
solution using <em>cat</em>, the final result also gets an embedded source map, which
means filenames and line numbers in stack traces are meaningful. Modules are
also separated into separate closures so variables are contained and never
collide. You can also use the latest JavaScript syntax, like
<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Functions/Arrow_functions">arrow functions</a>, <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment">destructuring</a>, and <a href="https://github.com/tj/co">generator functions</a>, as it
compiles the code down to ES5 syntax for you. This means that your code also
runs on our Duktape-based runtime, which you are forced to use if you use Frida
on a jailed iOS device, or on a jailbroken iOS device running iOS &gt;= 9.</p>

<p>In order to give you a short feedback loop while developing, frida-compile also
provides a watch mode through <em>-w</em>, so you get instant incremental builds as you
develop your agent.</p>

<p>Anyway, enough theory. Let’s look at how we can use an off-the-shelf web
application framework from npm, and inject that into any process.</p>

<p>First, make sure you have the latest version of Node.js installed. Next, create
an empty directory and paste this into a file named “package.json”:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hello-frida"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"prepublish"</span><span class="p">:</span><span class="w"> </span><span class="s2">"npm run build"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"build"</span><span class="p">:</span><span class="w"> </span><span class="s2">"frida-compile agent -o _agent.js"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"watch"</span><span class="p">:</span><span class="w"> </span><span class="s2">"frida-compile agent -o _agent.js -w"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"devDependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"express"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4.14.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"frida-compile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^2.0.6"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Then in agent.js, paste the following code:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">app</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/ranges</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Process</span><span class="p">.</span><span class="nx">enumerateRangesSync</span><span class="p">({</span>
      <span class="na">protection</span><span class="p">:</span> <span class="dl">'</span><span class="s1">---</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">coalesce</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}));</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/modules</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Process</span><span class="p">.</span><span class="nx">enumerateModulesSync</span><span class="p">());</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/modules/:name</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Process</span><span class="p">.</span><span class="nx">getModuleByName</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/modules/:name/exports</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nx">enumerateExportsSync</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">));</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/modules/:name/imports</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nx">enumerateImportsSync</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">));</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/objc/classes</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">available</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Objective-C runtime not available in this process</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/threads</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Process</span><span class="p">.</span><span class="nx">enumerateThreadsSync</span><span class="p">());</span>
  <span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">1337</span><span class="p">);</span></code></pre></figure>

<p>Install frida-compile and build your agent in one step:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install</span></code></pre></figure>

<p>Then load the generated <em>_agent.js</em> into a running process:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida Spotify <span class="nt">-l</span> _agent.js</code></pre></figure>

<p>You can now hit it with HTTP requests:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl http://127.0.0.1:1337/ranges
<span class="nv">$ </span>curl http://127.0.0.1:1337/modules
<span class="nv">$ </span>curl http://127.0.0.1:1337/modules/libSystem.B.dylib
<span class="nv">$ </span>curl http://127.0.0.1:1337/modules/libSystem.B.dylib/exports
<span class="nv">$ </span>curl http://127.0.0.1:1337/modules/libSystem.B.dylib/imports
<span class="nv">$ </span>curl http://127.0.0.1:1337/objc/classes
<span class="nv">$ </span>curl http://127.0.0.1:1337/threads</code></pre></figure>

<p>Sweet. We just built a process inspection REST API with 7 different endpoints in
fewer than 50 lines of code. What’s pretty cool about this is that we used an
off-the-shelf web application framework written for Node.js. You can actually
use any existing modules that rely on Node.js’ built-in <a href="https://nodejs.org/api/net.html">net</a> and <a href="https://nodejs.org/api/http.html">http</a>
modules. Like an <a href="https://github.com/frida/frida-net/tree/master/examples/ftp-server">FTP server</a>, <a href="https://github.com/frida/frida-net/tree/master/examples/irc-client">IRC client</a>, or <a href="https://github.com/frida/frida-net/tree/master/examples/nsq-client">NSQ client</a>.</p>

<p>So up until this release you could use Frida-specific modules like those
mentioned earlier. You could also use thousands of other modules from npm, as
most of them don’t do any I/O. Now with this release you also get access to
all <em>net</em> and <em>http</em> based modules, which opens up Frida for even more cool
use-cases.</p>

<p>In case you are curious how this was implemented, I added <em>Socket.listen()</em>
and <em>Socket.connect()</em> to Frida. These are minimal wrappers on top of <a href="https://developer.gnome.org/gio/stable/">GIO</a>’s
<a href="https://developer.gnome.org/gio/stable/GSocketListener.html">SocketListener</a> and <a href="https://developer.gnome.org/gio/stable/GSocketClient.html">SocketClient</a>, which are already part of Frida’s
technology stack and used by Frida for its own needs. So that means our
footprint stays the same with no dependencies added. Because frida-compile
uses <a href="http://browserify.org/">browserify</a> behind the scenes, all we had to do was <a href="https://github.com/frida/frida-compile/blob/1eeb38d9453f812e7b404e83cb9b5d0e5dc26241/index.js#L22-L23">plug in</a> our own
builtins for <em>net</em> and <em>http</em>. I simply ported the original <em>net</em> and <em>http</em>
modules from Node.js itself.</p>

<p>This release also brings some other goodies. One long-standing limitation with
<em>NativeFunction</em> is that calling a system API that requires you to read <em>errno</em>
(UNIX) or call <em>GetLastError()</em> (Windows) would be tricky to deal with. The
challenge is that Frida’s own code might clobber the current thread’s error
state between your <em>NativeFunction</em> call and when you try to read out the
error state.</p>

<p>Enter <em>SystemFunction</em>. It is exactly like <em>NativeFunction</em>, except that the
call returns an object wrapping the returned value and the error state right
afterwards. Here’s an example:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">open</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SystemFunction</span><span class="p">(</span>
    <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">open</span><span class="dl">'</span><span class="p">),</span>
    <span class="dl">'</span><span class="s1">int</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">[</span><span class="dl">'</span><span class="s1">pointer</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">int</span><span class="dl">'</span><span class="p">]);</span>
<span class="kd">const</span> <span class="nx">O_RDONLY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">allocUtf8String</span><span class="p">(</span><span class="dl">'</span><span class="s1">/inexistent</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">open</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">O_RDONLY</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
<span class="cm">/*
 * Which on Darwin typically results in the following output:
 *
 * {
 *   "value": -1,
 *   "errno": 2
 * }
 *
 * Where 2 is ENOENT.
 */</span></code></pre></figure>

<p>This release also lets you read and modify this system error value from your
<em>NativeCallback</em> passed to <em>Interceptor.replace()</em>, which might come handy if
you are replacing system APIs. Note that you could already do this with
<em>Interceptor.attach()</em>, but that’s not an option in cases where you don’t want
the original function to get called.</p>

<p>Another big change worth mentioning is that our V8 runtime has been heavily
refactored. The code is now easier to understand and it is way less work to add
new features. Not just that, but our argument parsing is also handled by a
single code-path. This means that all of our APIs are much more resilient to bad
or missing arguments, so you get a JavaScript exception instead of having some
APIs do fewer checks and happily crash the target process in case you forgot an
argument.</p>

<p>Anyway, those are the highlights. Here’s a full summary of the changes:</p>

<p>8.1.0:</p>

<ul>
  <li>core: add <em>Socket.listen()</em> and <em>Socket.connect()</em></li>
  <li>core: add <em>setImmediate()</em> and <em>clearImmediate()</em></li>
  <li>core: improve <em>set{Timeout,Interval}()</em> to support passing arguments</li>
  <li>core: fix performance-related bug in Interceptor’s dirty state logic</li>
</ul>

<p>8.1.1:</p>

<ul>
  <li>core: add <em>Script.nextTick()</em></li>
</ul>

<p>8.1.2:</p>

<ul>
  <li>core: teach <em>Socket.listen()</em> and <em>Socket.connect()</em> about UNIX sockets</li>
  <li>core: fix handling of <em>this.errno</em> / <em>this.lastError</em> replacement functions</li>
  <li>core: add <em>SystemFunction</em> API to get <em>errno</em> / <em>lastError</em> on return</li>
  <li>core: fix crash on <em>close()</em> during I/O with the Stream APIs</li>
  <li>core: fix and consolidate argument handling in the V8 runtime</li>
</ul>

<p>8.1.3:</p>

<ul>
  <li>core: temporarily disable Mapper on macOS in order to confirm whether this was
      the root cause of reported stability issues</li>
  <li>core: add <em>.call()</em> and <em>.apply()</em> to NativeFunction</li>
  <li>objc: fix parsing of opaque struct types</li>
</ul>

<p>8.1.4:</p>

<ul>
  <li>core: fix crash in the V8 runtime caused by invalid use of <em>v8::Eternal</em></li>
  <li>frida-repl: add batch mode support through <em>-e</em> and <em>-q</em></li>
</ul>

<p>8.1.5:</p>

<ul>
  <li>node: generate prebuilds for 6.0 (LTS) and 7.0 only</li>
</ul>

<p>8.1.6:</p>

<ul>
  <li>node: generate prebuilds for 4.0 and 5.0 in addition to 6.0 and 7.0</li>
</ul>

<p>8.1.7:</p>

<ul>
  <li>objc: fix infinite recursion when proxying some proxies</li>
  <li>objc: add support for proxying non-NSObject instances</li>
  <li>python: fix removal of signal callbacks that are member functions</li>
</ul>

<p>8.1.8:</p>

<ul>
  <li>core: implement hooking of single-instruction ARM functions</li>
  <li>core: plug leak in the handling of unhookable functions on some architectures</li>
  <li>core: fix <em>setImmediate()</em> callback processing behavior</li>
  <li>core: plug leak in <em>setTimeout()</em></li>
  <li>core: fix race condition in the handling of <em>setTimeout(0)</em> and
      <em>setImmediate()</em> in the Duktape runtime</li>
  <li>core: fix crash when processing tick callbacks in the Duktape runtime</li>
  <li>core: fix lifetime issue in the Duktape runtime</li>
  <li>core: fix the reported module sizes on Linux</li>
  <li>core: fix crash when launching apps on newer versions of Android</li>
  <li>core: fix handling of attempts to launch Android apps not installed</li>
  <li>core: improve compatibility with different versions and flavors of Android by
      detecting Dalvik and ART field offsets dynamically</li>
  <li>core: fix unload issue on newer versions of Android, which resulted in only
      the first <em>attach()</em> succeeding and subsequent attempts all timing out</li>
  <li>core: move <em>ObjC</em> and <em>Java</em> into their own modules published to npm, and use
      <em>frida-compile</em> to keep baking them into Frida’s built-in JS runtime</li>
  <li>java: improve ART compatibility by detecting ArtMethod field offsets
      dynamically</li>
  <li>node: update dependencies</li>
  <li>node: fix unhandled Promise rejection issues</li>
</ul>

<p>8.1.9:</p>

<ul>
  <li>core: fix use-after-free caused by race condition on script unload</li>
</ul>

<p>8.1.10:</p>

<ul>
  <li>core: make <em>ApiResolver</em> and <em>DebugSymbol</em> APIs preemptible to avoid deadlocks</li>
</ul>

<p>8.1.11:</p>

<ul>
  <li>core: use a Mach exception handler on macOS and iOS, allowing us to reliably
      catch exceptions in apps that already have a Mach exception handler of
      their own</li>
  <li>core: fix leak in <em>InvocationContext</em> copy-on-write logic in the Duktape
      runtime, used when storing data on <em>this</em> across <em>onEnter</em> and <em>onLeave</em></li>
</ul>

<p>8.1.12:</p>

<ul>
  <li>core: fix <em>Interceptor</em> argument replacement issue in the V8 runtime,
      resulting in the argument only being replaced the first time</li>
</ul>

<p>Enjoy!</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2016/10/04/frida-8-0-released/index.html">
      Frida 8.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      04 Oct 2016
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It is time to level up to the next major version.</p>

<p>First off is the long-standing issue where multiple Frida clients attached to
the same process were forced to coordinate so none of them would call <em>detach()</em>
while one of the others was still using the session.</p>

<p>This was probably not a big deal for most users of Frida. However, we also had
the same issue if one running <em>frida-server</em> was shared by multiple clients.
You might have <em>frida-trace</em> running in one terminal while using the REPL in
another, both attached to the same process, and you wouldn’t then expect one of
them calling <em>detach()</em> to result in the other one getting kicked out.</p>

<p>Some of you may have tried this and observed that it works as expected, but this
was due to some crazy logic in frida-server that would keep track of how many
clients were interested in the same process, so it could ignore a <em>detach()</em>
call if other clients were still subscribed to the same session. It also had
some logic to clean up a certain client’s resources, e.g. scripts, if it
suddenly disconnected.</p>

<p>Starting with 8.0 we have moved the session awareness into the agent, and kept
the client-facing API the same, but with one little detail changed. Each call to
<em>attach()</em> will now get its own Session, and the injected agent is aware of it.
This means you can call <em>detach()</em> at any time, and only the scripts created in
your session will be destroyed. Also, if your session is the last one alive,
Frida will unload its agent from the target process.</p>

<p>That was the big change of this release, but we didn’t stop there.</p>

<p>One important feature of Frida’s scripts is that you can exchange messages with
them. A script may call <em>send(message[, data])</em> to send a JSON-serializable
<em>message</em>, and optionally a binary blob of <em>data</em> next to it. The latter is so
you don’t have to spend CPU-cycles turning your binary data into text that you
include in the <em>message</em>.</p>

<p>It is also possible to communicate in the other direction, where the script
would call <em>recv(callback)</em> to get a <em>callback</em> when you <em>post_message()</em> to
it from your application. This allowed you to post a JSON-serializable <em>message</em>
to your script, but there was no support for sending a binary blob of <em>data</em>
next to it.</p>

<p>To address this shortcoming we renamed <em>post_message()</em> to <em>post()</em>, and gave it
an optional second argument allowing you to send a binary blob of <em>data</em> next to
it.</p>

<p>We also improved the C API by migrating from plain C arrays to <a href="https://developer.gnome.org/glib/stable/glib-Byte-Arrays.html#GBytes">GBytes</a>,
which means we are able to minimize how many times we copy the data as it flows
through our APIs.</p>

<p>So in closing, let’s summarize the changes:</p>

<p>8.0.0:</p>

<ul>
  <li>core: add support for multiple parallel sessions</li>
  <li>core: rename Script’s <em>post_message()</em> to <em>post()</em> and add support for passing
      out-of-band binary data to the script</li>
  <li>core: replace C arrays with <em>GBytes</em> to improve performance</li>
  <li>core: fix heap corruption caused by use-after-free in libgee</li>
  <li>core: fix multiple crashes</li>
  <li>core: fix exports enumeration crash on macOS Sierra</li>
  <li>core: add basic support for running on Valgrind</li>
  <li>core: bump the macOS requirement to 10.9 so we can rely on libc++</li>
  <li>node: update to the new 8.x API</li>
  <li>python: update to the new 8.x API</li>
  <li>swift: update to the new 8.x API</li>
  <li>swift: upgrade to Swift 3</li>
  <li>qml: update to the new 8.x API</li>
  <li>clr: update to the new 8.x API</li>
  <li>clr: plug leaks</li>
</ul>

<p>8.0.1:</p>

<ul>
  <li>node: fix <em>Script#post()</em></li>
</ul>

<p>8.0.2:</p>

<ul>
  <li>core: fix deadlock when calling <em>recv().wait()</em> from our JS thread</li>
</ul>

<p>8.0.3:</p>

<ul>
  <li>core: reduce Interceptor base overhead by up to 65%</li>
  <li>core: minimize Interceptor GC churn in our V8 runtime, using the same
      recycling and copy-on-write tricks as our Duktape runtime</li>
  <li>core: speed up <em>gum_process_get_current_thread_id()</em> on macOS and iOS</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2016/08/15/frida-7-3-released/index.html">
      Frida 7.3 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      15 Aug 2016
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s finally release o’clock, and this time around the focus has been on
improving quality. As it’s been a while since the last time we upgraded our
third-party dependencies, and I found myself tracking down a memory-leak in GLib
that had already been fixed upstream, I figured it was time to upgrade our
dependencies. So with this release I’m happy to announce that we’re now packing
the latest V8, GLib, Vala compiler, etc. Great care was also taken to eliminate
resource leaks, so you can attach to long-running processes without worrying
about memory allocations or OS handles piling up.</p>

<p>So in closing, let’s summarize the changes:</p>

<p>7.3.0:</p>

<ul>
  <li>core: upgrade to the latest V8, GLib, Vala, Android NDK, etc.</li>
  <li>core: plug resource leaks</li>
  <li>core: fix thread enumeration on Linux/x86-32</li>
  <li>core: (arm64) improve function hooking by adding support for relocating LDRPC
      with an FP/SIMD destination register</li>
</ul>

<p>7.3.1:</p>

<ul>
  <li>core: build Android binaries with PIE like we used to</li>
</ul>

<p>7.3.2:</p>

<ul>
  <li>core: add <em>Script.setGlobalAccessHandler()</em> for handling attempts to access
      undeclared global variables, which is useful for building REPLs</li>
</ul>

<p>7.3.3:</p>

<ul>
  <li>objc: convert <em>Number</em> to <em>NSNumber</em> when an object is expected</li>
  <li>objc: add support for auto-converting to an array of objects, useful when
      calling e.g. <em>+[NSArray arrayWithObjects:count:]</em></li>
</ul>

<p>7.3.4:</p>

<ul>
  <li>core: improve the unstable accessor API</li>
  <li>core: fix the Duktape globals accessor logic so it’s only applied to reads</li>
</ul>

<p>7.3.5:</p>

<ul>
  <li>core: improve <em>hexdump()</em> to support any <em>NativePointer</em>-conforming object</li>
  <li>objc: fix handling of the <em>L</em> type</li>
</ul>

<p>7.3.6:</p>

<ul>
  <li>core: fix regression in devkit header auto-generation logic</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2016/06/02/frida-7-2-released/index.html">
      Frida 7.2 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      02 Jun 2016
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Some of you may be aware that Frida has two JavaScript runtimes, one based
on <a href="https://developers.google.com/v8/">V8</a>, and another one based on <a href="http://duktape.org/">Duktape</a>.
We also used to have a runtime based on <a href="https://trac.webkit.org/wiki/JavaScriptCore">JavaScriptCore</a>,
but it got retired when our Duktape runtime proved better in all of the
situations where V8 wasn’t a good fit, e.g. on tiny embedded systems and
systems where RWX pages are forbidden.</p>

<p>Anyway, what is pretty neat is that Duktape has an API for compiling to
bytecode, allowing you to cache the compiled code and save precious startup time
when it’s time to instrument a new process. Starting with this release we now
have brand new API for compiling your JavaScript to bytecode, and of course
instantiating a script from it. This API is not yet supported in our V8 runtime,
but we should be able to implement it there after our next V8 upgrade, by using
the WebAssembly infrastructure that started appearing in the latest releases.</p>

<p>So without further ado, let’s take this new API for a spin with the Duktape
runtime by forcing Frida to favor Duktape through <em>Session.disable_jit()</em>.</p>

<p>From Node.js:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">co</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">frida</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">frida</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">co</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">systemSession</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">frida</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">yield</span> <span class="nx">systemSession</span><span class="p">.</span><span class="nx">disableJit</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">bytecode</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">systemSession</span><span class="p">.</span><span class="nx">compileScript</span><span class="p">(</span><span class="s2">`
    rpc.exports = {
      listThreads() {
        return Process.enumerateThreadsSync();
      }
    };
  `</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">frida</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="dl">'</span><span class="s1">Twitter</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">yield</span> <span class="nx">session</span><span class="p">.</span><span class="nx">disableJit</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">script</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">session</span><span class="p">.</span><span class="nx">createScriptFromBytes</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">);</span>
  <span class="k">yield</span> <span class="nx">script</span><span class="p">.</span><span class="nx">load</span><span class="p">();</span>

  <span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">script</span><span class="p">.</span><span class="nx">getExports</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">api.listThreads() =&gt;</span><span class="dl">'</span><span class="p">,</span> <span class="k">yield</span> <span class="nx">api</span><span class="p">.</span><span class="nx">listThreads</span><span class="p">());</span>

  <span class="k">yield</span> <span class="nx">script</span><span class="p">.</span><span class="nx">unload</span><span class="p">();</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure>

<p>And from Python:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">frida</span>

<span class="n">system_session</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">system_session</span><span class="p">.</span><span class="n">disable_jit</span><span class="p">()</span>
<span class="n">bytecode</span> <span class="o">=</span> <span class="n">system_session</span><span class="p">.</span><span class="n">compile_script</span><span class="p">(</span><span class="s">"""
rpc.exports = {
  listThreads() {
    return Process.enumerateThreadsSync();
  }
};
"""</span><span class="p">)</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="s">"Twitter"</span><span class="p">)</span>
<span class="n">session</span><span class="p">.</span><span class="n">disable_jit</span><span class="p">()</span>
<span class="n">script</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">create_script_from_bytes</span><span class="p">(</span><span class="n">bytecode</span><span class="p">)</span>
<span class="n">script</span><span class="p">.</span><span class="n">load</span><span class="p">()</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">script</span><span class="p">.</span><span class="n">exports</span>
<span class="k">print</span><span class="p">(</span><span class="s">"api.list_threads() =&gt;"</span><span class="p">,</span> <span class="n">api</span><span class="p">.</span><span class="n">list_threads</span><span class="p">())</span></code></pre></figure>

<p>Note that the same caveats as <a href="http://duktape.org/api.html#duk_load_function">specified in the Duktape documentation</a>
apply here, so make sure the code you’re trying to load is well-formed and
generated by the same version of Duktape. It may get upgraded when you upgrade
to a future version of Frida, but will at least be architecture-neutral; i.e.
you can compile to bytecode on a 64-bit x86 desktop and load it just fine in
a 32-bit iOS app on ARM.</p>

<p>So that’s bytecode compilation through the API, but you probably want to use the <a href="https://github.com/frida/frida-compile">frida-compile</a>
CLI tool for this instead:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>frida-compile
<span class="nv">$ </span>./node_modules/.bin/frida-compile agent.js <span class="nt">-o</span> agent.bin <span class="nt">-b</span></code></pre></figure>

<p>While developing you can also use it in watch mode by adding <em>-w</em>, which makes
it watch the inputs and perform fast incremental builds whenever one of them
changes.</p>

<p>Whether you’re using bytecode (<em>-b</em>) or not, frida-compile is highly recommended
as it also comes with a number of other benefits, letting you:</p>

<ul>
  <li>Split your script into multiple .js files by using <em>require()</em>.</li>
  <li>Leverage thousands of existing modules from npm, including some that are
Frida-specific. For example:
<a href="https://github.com/nowsecure/frida-trace">frida-trace</a>,
<a href="https://github.com/nowsecure/frida-uikit">frida-uikit</a>,
<a href="https://github.com/nowsecure/frida-screenshot">frida-screenshot</a>, etc.</li>
  <li>Use ES6 syntax and have your code compiled to ES5 so it’s compatible with
the Duktape runtime.</li>
</ul>

<p>So in closing, let’s summarize the changes:</p>

<p>7.2.0:</p>

<ul>
  <li>core: add support for compiling and loading to/from bytecode</li>
  <li>core: include error name and stack trace in RPC error replies</li>
  <li>node: add support for the new bytecode APIs</li>
  <li>node: augment RPC errors with <em>name</em> and <em>stack</em> when available</li>
  <li>node: port examples to ES6</li>
  <li>python: add support for the new bytecode APIs</li>
  <li>python: update to the revised RPC protocol</li>
</ul>

<p>7.2.1:</p>

<ul>
  <li>objc: add support for resolving methods on minimal Objective-C proxies</li>
</ul>

<p>7.2.2:</p>

<ul>
  <li>objc: fix handling of methods returning structs and floating point values</li>
</ul>

<p>7.2.3:</p>

<ul>
  <li>objc: expose the raw handle of Objective-C methods</li>
</ul>

<p>7.2.4:</p>

<ul>
  <li>core: fix deadlock that was easily reproducible on iOS 9</li>
  <li>java: improve Java.perform() robustness and handling of non-app processes</li>
</ul>

<p>7.2.5:</p>

<ul>
  <li>objc: fix handling of methods returning a struct in registers on x86-64</li>
</ul>

<p>7.2.6:</p>

<ul>
  <li>core: port Gum to MIPS</li>
  <li>core: avoid swallowing exception when a Proxy object misbehaves</li>
  <li>objc: add support for accessing Objective-C instance variables</li>
</ul>

<p>7.2.7:</p>

<ul>
  <li>core: port .so injector to MIPS</li>
  <li>core: enhance MIPS fuzzy backtracer with more branch-and-link instructions</li>
  <li>core: fix <em>UnixInputStream</em> and <em>UnixOutputStream</em> pollable behavior on TTYs,
      fixing hang on script unload</li>
  <li>core: remove “0x” prefix from <em>hexdump()</em> offsets</li>
</ul>

<p>7.2.8:</p>

<ul>
  <li>objc: fix parsing of type hints</li>
  <li>objc: add support for including type hints</li>
  <li>objc: make ObjC.Block’s <em>types</em> field public</li>
  <li>objc: add support for properly declaring <em>void *</em></li>
  <li>core: (MIPS) fix stack offset when getting/setting stack arguments</li>
</ul>

<p>7.2.9:</p>

<ul>
  <li>core: fix bug preventing registers from being written in the V8 runtime</li>
</ul>

<p>7.2.10:</p>

<ul>
  <li>core: add support for attaching to iOS Simulator processes</li>
  <li>core: fix Android class-resolving regression introduced in 7.2.4</li>
</ul>

<p>7.2.11:</p>

<ul>
  <li>core: always kill iOS apps through SpringBoard</li>
</ul>

<p>7.2.12:</p>

<ul>
  <li>objc: unregister Objective-C classes on unload and GC</li>
</ul>

<p>7.2.13:</p>

<ul>
  <li>core: fix application kill logic on iOS 9</li>
</ul>

<p>7.2.14:</p>

<ul>
  <li>core: make the Duktape runtime preemptible like the V8 runtime</li>
  <li>core: fix a few locking bugs in the V8 runtime</li>
</ul>

<p>7.2.15:</p>

<ul>
  <li>core: implement the <em>Kernel</em> API in the Duktape runtime also</li>
  <li>core: remove the dangerous <em>Kernel.enumerateThreads()</em> API</li>
</ul>

<p>7.2.16:</p>

<ul>
  <li>core: improve robustness when quickly reattaching to the same process</li>
  <li>core: fix deadlock when pending calls exist at detach time</li>
  <li>core: fix hooking regression on 32-bit ARM</li>
  <li>core: fix <em>dlsym()</em> deadlock in frida-gadget on Linux</li>
  <li>core: fix Windows build regression</li>
  <li>core: fix iOS 7 regression</li>
</ul>

<p>7.2.17:</p>

<ul>
  <li>core: fix session teardown regression</li>
</ul>

<p>7.2.18:</p>

<ul>
  <li>core: fix long-standing stability issue on iOS 9, where the injected bootstrap
      code was not pseudo-signed and caused processes to eventually lose their
      <em>CS_VALID</em> status</li>
  <li>core: speed up app launching on iOS by eliminating unnecessary disk I/O</li>
  <li>core: fix temporary directory clean-up on iOS</li>
</ul>

<p>7.2.19:</p>

<ul>
  <li>core: fix preemption-related lifetime-issue in the Duktape runtime</li>
</ul>

<p>7.2.20:</p>

<ul>
  <li>core: rework the V8 runtime to support fully asynchronous unloading</li>
  <li>core: rework the Duktape runtime to support fully asynchronous unloading</li>
  <li>core: make the Duktape runtime fully reentrant</li>
  <li>core: add <em>Script.pin()</em> and <em>Script.unpin()</em> for extending a script’s
      lifetime in critical moments, e.g. for callbacks expected from external
      APIs out of one’s control</li>
  <li>core: fix a timer-related leak in both the V8 and the Duktape runtime</li>
  <li>objc: keep script alive until callback scheduled by <em>ObjC.schedule()</em> has
      been executed</li>
  <li>objc: add a <em>dealloc</em> event to the ObjC proxy API</li>
</ul>

<p>7.2.21:</p>

<ul>
  <li>core: fix hang on <em>detach()</em></li>
</ul>

<p>7.2.22:</p>

<ul>
  <li>core: fix hang on script unload</li>
  <li>core: fix hang on abrupt connection loss during <em>detach()</em></li>
</ul>

<p>7.2.23:</p>

<ul>
  <li>core: fix two low-probability crashes during script unload</li>
</ul>

<p>7.2.24:</p>

<ul>
  <li>core: fix use-after-free in the Duktape runtime</li>
  <li>core: fix use-after-free bugs in ModuleApiResolver</li>
  <li>core: improve unload-behavior when an exception handler is set</li>
</ul>

<p>7.2.25:</p>

<ul>
  <li>core: fix app launching on iOS 9.3.3</li>
  <li>frida-server: fix “hang” on detach when another client is attached to the
              same process</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2016/04/04/frida-7-1-released/index.html">
      Frida 7.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      04 Apr 2016
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>If you’ve ever used Frida to spawn programs making use of stdio you might have
been frustrated by how the spawned process’ stdio state was rather undefined and
left you with very little control. Starting with this release we have started
addressing this, and programs are now always spawned with <em>stdin</em>, <em>stdout</em> and
<em>stderr</em> redirected, and you can even input your own data to <em>stdin</em> and get
the data being written to <em>stdout</em> and <em>stderr</em>. Frida’s CLI tools get this
for free as this is <a href="https://github.com/frida/frida-python/blob/4afd9debd489e3920b85cb6c542de10aabb0dcce/src/frida/application.py#L212">wired up</a>
in the <em>ConsoleApplication</em> base-class. If you’re not using <em>ConsoleApplication</em>
or you’re using a different language-binding, simply connect to the <em>output</em>
signal of the <em>Device</em> object and your handler will get three arguments each
time this signal is emitted: <em>pid</em>, <em>fd</em>, and <em>data</em>, in that order. Hit the
<em>input()</em> method on the same class to write to <em>stdin</em>. That’s all there is to
it.</p>

<p>Now that we have normalized the stdio behavior across platforms, we will
later be able to add API to disable stdio redirection.</p>

<p>Beside this and lots of bug-fixes we have also massively improved the support
for spawning plain programs on Darwin, on both Mac and iOS, where <em>spawn()</em> is
now lightning fast on both and no longer messes up the code-signing status on
iOS.</p>

<p>For those of you doing advanced instrumentation of Mac and iOS apps there’s now
also brand new API for dynamically creating your own Objective-C protocols at
runtime. We already supported creating new classes and proxy objects, and with
this new API you can do even more.</p>

<p>So in closing, here’s a summary of the changes:</p>

<p>7.1.0:</p>

<ul>
  <li>core: add <em>Device.input()</em> API for writing to <em>stdin</em> of spawned processes</li>
  <li>core: add <em>Device.output</em> signal for propagating output from spawned processes</li>
  <li>core: implement the new <em>spawn()</em> stdio behavior in the Windows, Darwin, and
      Linux backends</li>
  <li>core: downgrade to Capstone 3.x for now due to non-trivial regressions in 4.x</li>
  <li>node: add support for the new stdio API</li>
  <li>node: add missing return to error-path</li>
  <li>python: add support for the new stdio API</li>
</ul>

<p>7.1.1:</p>

<ul>
  <li>core: fix intermittent crash in <em>spawn()</em></li>
</ul>

<p>7.1.2:</p>

<ul>
  <li>core: rework the <em>spawn()</em> implementation on Darwin, now much faster and
      reliable</li>
  <li>core: add support for enumerating and looking up dynamic symbols on Darwin</li>
  <li>core: fix page size computation in the Darwin Mach-O parser</li>
</ul>

<p>7.1.3:</p>

<ul>
  <li>core: revert temporary hack</li>
</ul>

<p>7.1.4:</p>

<ul>
  <li>python: fix <em>ConsoleApplication</em> crash on EOF</li>
  <li>frida-trace: flush queued events before exiting</li>
</ul>

<p>7.1.5:</p>

<ul>
  <li>frida-repl: improve REPL autocompletion</li>
  <li>objc: add <em>ObjC.registerProtocol()</em> for dynamic protocol creation</li>
  <li>objc: fix handling of class name conflicts</li>
  <li>objc: allow proxies to be named</li>
</ul>

<p>7.1.6:</p>

<ul>
  <li>python: fix setup.py download fallback</li>
</ul>

<p>7.1.7:</p>

<ul>
  <li>python: improve the setup.py download fallback</li>
</ul>

<p>7.1.8:</p>

<ul>
  <li>python: fix the setup.py local fallback and look in home directory instead</li>
</ul>

<p>7.1.9:</p>

<ul>
  <li>core: fix handling of overlapping requests to attach to the same pid</li>
  <li>core: (Darwin) fix <em>spawn()</em> without <em>attach()</em></li>
  <li>core: (Darwin) fix crash when shutdown requests overlap</li>
  <li>frida-server: always recycle the same temporary directory</li>
</ul>

<p>7.1.10:</p>

<ul>
  <li>core: (Windows) upgrade from VS2013 to VS2015</li>
  <li>node: add prebuild for Node.js 6.x</li>
  <li>python: fix handling of unicode command-line arguments on Python 2.x</li>
  <li>qml: use libc++ instead of libstdc++ on Mac</li>
</ul>

<p>7.1.11:</p>

<ul>
  <li>core: provide a proper error message when the remote Frida is incompatible</li>
  <li>core: ignore attempts to detach from the system session</li>
  <li>core: guard against <em>create_script()</em> and <em>detach()</em> overlapping</li>
  <li>core: fix <em>setTimeout()</em> so the delay is optional and defaults to 0</li>
  <li>core: (V8 runtime) fix crash when closed <em>File</em> object gets GCed</li>
  <li>core: (Darwin) fix intermittent crash on teardown</li>
  <li>core: (QNX) fix implementation of <em>gum_module_find_export_by_name()</em></li>
  <li>core: (QNX) implement temporary TLS storage</li>
  <li>frida-repl: monitor the loaded script and auto-reload on change</li>
  <li>node: take <em>level</em> into account when handling log messages so <em>console.warn()</em>
      and <em>console.error()</em> go to <em>stderr</em> instead of <em>stdout</em></li>
  <li>node: do not let sessions keep the runtime alive</li>
</ul>

<p>7.1.12:</p>

<ul>
  <li>core: fix the return value of <em>Memory.readByteArray()</em> for size = 0</li>
</ul>

<p>7.1.13:</p>

<ul>
  <li>core: (Linux/Android) fix export address calculation for libraries with a
      preferred base</li>
  <li>core: fix <em>Java API not available</em> error on Android 6.0</li>
  <li>java: improve ART support by taking OS version and arch into account</li>
  <li>frida-repl: add <em>–no-pause</em> to not pause spawned process at startup</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2016/02/24/frida-7-0-released/index.html">
      Frida 7.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      24 Feb 2016
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s been a while since our last major release bump. This time we’re addressing
the long-standing issue where 64-bit integers were represented as JavaScript
Number values. This meant that values beyond 53 bits were problematic due to
the fact that the underlying representation is a double.</p>

<p>The 64-bit types in the <em>Memory</em>, <em>NativeFunction</em>, and <em>NativeCallback</em> APIs
are now properly represented by the newly introduced <a href="../../docs/javascript-api/index.html#int64">Int64</a>
and <a href="../../docs/javascript-api/index.html#uint64">UInt64</a> types, and their APIs are almost
identical to <a href="../../docs/javascript-api/index.html#nativepointer">NativePointer</a>.</p>

<p>Now let’s cross our fingers that int64/uint64 <a href="https://twitter.com/BrendanEich/status/526826278377099264">make it into ES7</a>.</p>

<p>So in closing, here’s a summary of the changes:</p>

<p>7.0.0:</p>

<ul>
  <li>core: rework handling of 64-bit integers</li>
  <li>core: improve strictness of constructors</li>
  <li>core: improve QNX support</li>
  <li>frida-repl: update the logo</li>
</ul>

<p>7.0.1:</p>

<ul>
  <li>core: fix Int64/UInt64 field capacity on 32-bit architectures</li>
</ul>

<p>7.0.2:</p>

<ul>
  <li>core: allow Int64 and UInt64 to be passed as-is to all relevant APIs</li>
  <li>core: fix handling of $protocols on ObjC instances</li>
</ul>

<p>7.0.3:</p>

<ul>
  <li>core: fix race-condition where listener gets destroyed mid-call</li>
  <li>core: fix handling of nested native exception scopes</li>
  <li>core: improve QNX support</li>
  <li>frida-repl: tweak the startup message</li>
</ul>

<p>7.0.4:</p>

<ul>
  <li>core: massively improve the function hooking success-rate on 32-bit ARM</li>
  <li>core: improve the function hooking success-rate on 64-bit ARM</li>
  <li>core: fix the <em>sp</em> value exposed by Interceptor on 32-bit ARM</li>
</ul>

<p>7.0.5:</p>

<ul>
  <li>core: spin the main CFRunLoop while waiting for <em>Device#resume()</em> when
      spawning iOS apps, allowing thread-sensitive early instrumentation to be
      applied from the main thread</li>
</ul>

<p>7.0.6:</p>

<ul>
  <li>core: fix hooking of half-word aligned functions on 32-bit ARM</li>
  <li>core: fix thread enumeration on Linux</li>
  <li>core: add simple <em>hexdump()</em> API to the Script runtimes</li>
  <li>core: make the Duktape runtime’s CpuContext serializable to JSON</li>
</ul>

<p>7.0.7:</p>

<ul>
  <li>core: allow passing a <em>NativePointer</em> to <em>hexdump()</em></li>
</ul>

<p>7.0.8:</p>

<ul>
  <li>core: fix handling of wrapper objects in <code class="language-plaintext highlighter-rouge">retval.replace()</code></li>
  <li>core: fix behavior of Memory.readUtf8String() when a size is specified</li>
  <li>core: add support for the new <em>task_for_pid(0)</em> method on the iOS 9.1 JB</li>
  <li>core: don’t use <em>cbnz</em> which is not available in ARM mode on some processors</li>
  <li>core: implement <em>enumerate_threads()</em> and <em>modify_thread()</em> for QNX</li>
</ul>

<p>7.0.9:</p>

<ul>
  <li>core: fix early crash in FridaGadget.dylib on iOS when running with
      <em>ios-deploy</em> and other environments where we are loaded before
      <em>CoreFoundation</em></li>
  <li>core: run a <em>CFRunLoop</em> in the main thread of <em>frida-helper</em> on Darwin,
      allowing system session scripts to make use of even more Apple APIs</li>
  <li>core: add stream APIs for working with GIO streams, for now only exposed
      through UnixInputStream and UnixOutputStream (UNIX), and
      Win32InputStream and Win32OutputStream (Windows)</li>
</ul>

<p>7.0.10:</p>

<ul>
  <li>core: fix deadlock on script unload when I/O operations are pending</li>
</ul>

<p>7.0.11:</p>

<ul>
  <li>core: spin the main CFRunLoop while FridaGadget.dylib is blocking waiting for
      <em>Device#resume()</em>, allowing thread-sensitive early instrumentation to be
      applied from the main thread</li>
  <li>java: fix method type sanity-check</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2016/02/01/frida-6-2-released/index.html">
      Frida 6.2 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      01 Feb 2016
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s release o’clock, and this time we’re bringing you massive performance
improvements on all platforms, a brand new API for looking up functions, and
major stability improvements on iOS 9.</p>

<p>Let’s talk about the latter subject first. Some of you may have noticed weird
bugs and deadlocks when using Frida on iOS 9. The root cause was simply that our
inline hooking was causing the process to lose the <em>CS_VALID</em> bit of its
<a href="https://github.com/frida/frida-gum/blob/ae22e0fa94970a9df140757e4aa0467e9deea9aa/tests/core/interceptor.c#L1111">code-signing status</a>.
This was not a problem on iOS 8 and older as jailbreaks were always able to
patch the kernel to loosen up on its code-signing requirements. Starting with
this release we have implemented some tricks to be able to do inline hooking
without breaking the code-signing status. For the technically curious this means
that we dynamically generate a .dylib as a temporary file, write out the new
versions of the memory pages that we’d like to modify, e.g. the libc memory page
containing <em>open()</em>, then pseudo-sign this binary, ask the kernel to <a href="https://github.com/frida/frida-gum/blob/ae22e0fa94970a9df140757e4aa0467e9deea9aa/gum/backend-darwin/gumcodesegment-darwin.c#L211">F_ADDFILESIGS</a>
to it, and finally <em>mmap()</em> from this file on top of the original memory pages.</p>

<p>This brings us to the next topic: performance. The tricks that I just talked
about do actually add quite a bit of extra overhead just to hook one single
function. It is also a very different approach from what we can do on systems
with support for read-write-execute memory-pages and relaxed code-signing
requirements, so this obviously meant that major architectural changes were
needed. I had also been thinking for a while about being able to apply a whole
batch of hooks in one go, allowing us to be more efficient and have more control
on exactly when hooks are activated.</p>

<p>Starting with this release, our Interceptor API now supports <a href="https://github.com/frida/frida-gum/blob/ae22e0fa94970a9df140757e4aa0467e9deea9aa/gum/guminterceptor.h#L78-L79">transactions</a>.
Simply call <em>begin_transaction()</em>, hook all the functions, and make them all
active in one go by calling <em>end_transaction()</em>. This results in a massive
performance boost, and you get all of this for free without any changes to your
existing code. This is because we implicitly begin a transaction whenever we’re
entering the JavaScript runtime, and end it when we’re leaving it (and just
before we <em>send()</em> a message or return from an RPC method). So unless you’re
attaching your hooks from timers or asynchronous APIs like <em>Memory.scan()</em>,
they will all be batched into a single transaction and get a performance boost.</p>

<p>Here’s how we stack up to CydiaSubstrate in terms of performance:</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/bfd9b65865e9f17914f2.js"> </script>

<p>Note that if you’re using our instrumentation engine from C or C++ you will
have to call <em>begin_transaction()</em> and <em>end_transaction()</em> yourself to get this
boost, but your code will still work even if you don’t, because every operation
will implicitly contain a transaction, and the API allows nesting those calls.</p>

<p>That was function hooking performance, but we didn’t stop there. If you’ve ever
used <em>frida-trace</em> to trace Objective-C APIs, or glob for functions across all
loaded libraries, you may have noticed that it could take quite a while to
resolve all the functions. If you combined this with early instrumentation it
could even take so long that we exceeded the system’s <a href="https://github.com/frida/frida/issues/103">launch timeout</a>.
All of this has now been optimized, and to give you an idea of the speed-up,
a typical Objective-C case that used to take seconds is now completing in a
few milliseconds.</p>

<p>Now to the final part of the news. Considering that dynamically discovering
functions to hook is such a common use-case, and not just something that
<em>frida-trace</em> does, we now have a <a href="../../docs/javascript-api/index.html#apiresolver">brand new API</a>
for just that:</p>

<p><img src="../../img/api-resolver-module.png" alt="ApiResolver #1" title="ApiResolver" /></p>

<p><img src="../../img/api-resolver-objc.png" alt="ApiResolver #2" title="ApiResolver" /></p>

<p>So in closing, here’s a summary of the changes:</p>

<p>6.2.0:</p>

<ul>
  <li>core: improve Interceptor to avoid breaking dynamic code-signing on iOS 9</li>
  <li>core: move to a transaction-based Interceptor API for improved performance</li>
  <li>core: fix crash when scheduled callbacks are freed late (V8 and Duktape)</li>
  <li>frida-trace: improve performance by removing <em>setTimeout()</em> logic, allowing
             many hooks to be applied in the same transaction</li>
  <li>frida-trace: batch log events in 50 ms chunks to improve performance</li>
</ul>

<p>6.2.1:</p>

<ul>
  <li>core: add <em>ApiResolver</em> API</li>
  <li>frida-trace: improve performance by using the new <em>ApiResolver</em> API</li>
</ul>

<p>6.2.2:</p>

<ul>
  <li>core: fix oops that prevented injection into Windows Store/Universal apps</li>
  <li>core: fix crash on teardown on 32-bit ARM</li>
  <li>core: add frida-inject, a tool to inject an agent into a running process with
      similar semantics to frida-gadget</li>
  <li>core: (Linux) prevent libdl from unloading to work around TLS destructor bug</li>
  <li>core: (Linux) fix race-condition on rapid uninject</li>
</ul>

<p>6.2.3:</p>

<ul>
  <li>core: fix source-map handling for eval code, which manifested itself as
      unhandled exceptions getting swallowed, e.g. when running frida-trace</li>
  <li>core: fix Python 3.x build system regression</li>
  <li>frida-trace: fix path escaping issue</li>
  <li>frida-trace: improve error-handling for bad handlers</li>
</ul>

<p>6.2.4:</p>

<ul>
  <li>frida-trace: monitor handlers instead of polling them</li>
</ul>

<p>6.2.5:</p>

<ul>
  <li>core: add support for hooking arbitrary instructions by calling
      <em>Interceptor.attach()</em> with a function instead of a callbacks object</li>
  <li>core: add support for detaching individual listeners added by
      <em>Interceptor.attach()</em>, even synchronously from their callbacks</li>
  <li>core: add <em>Memory.scanSync()</em></li>
  <li>core: fix clobber by improving <em>Interceptor</em> to preserve <em>r12</em> aka <em>IP</em> on ARM</li>
  <li>core: expose <em>r8</em> through <em>r12</em> to the JavaScript runtimes</li>
  <li>core: fix crash on architectures where unaligned word access is not supported</li>
  <li>frida-repl: simplify logic by using the RPC feature</li>
  <li>node: upgrade to prebuild 3.x</li>
</ul>

<p>6.2.6:</p>

<ul>
  <li>core: fix regression on non-jailbroken iOS systems</li>
  <li>core: fix Interceptor regression in the Duktape runtime</li>
  <li>core: fix module name of resolved imports</li>
  <li>core: add API for specifying which host to connect to</li>
  <li>core: improve QNX support and fix build regressions</li>
  <li>core: fix the frida-inject build system on Mac</li>
  <li>core: (Windows) fix crash when USB device location retrieval fails</li>
  <li>frida-server: allow overriding the default listen address</li>
  <li>frida-node: add <em>addRemoteDevice()</em> and <em>removeRemoteDevice()</em> to
            DeviceManager</li>
  <li>frida-python: add -H switch for specifying the host to connect to</li>
  <li>frida-python: add <em>add_remote_device()</em> and <em>remove_remote_device()</em> to
              DeviceManager</li>
  <li>frida-python: fix compatibility issues with the Duktape runtime</li>
  <li>frida-python: canonicalize the requested RPC method name</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2016/01/14/frida-6-1-released/index.html">
      Frida 6.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      14 Jan 2016
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Some time ago <a href="https://github.com/s1341">@s1341</a> ported Frida to QNX, and just a
few weeks back he was running into memory footprint issues when using Frida on
embedded ARM devices. This was right after he contributed pull-requests porting
Frida to linux-arm. We started realizing that it might be time for a new
JavaScript runtime, and agreed that <a href="http://duktape.org/">Duktape</a> seemed like a
great fit for our needs.</p>

<p>This runtime has now landed, all tests are passing, and it even beats our V8
runtime on the measured overhead for a call to a hooked function with an empty
<em>onEnter</em>/<em>onLeave</em> callback. To give you an idea:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">…/interceptor_on_enter_performance: V8 <span class="nv">min</span><span class="o">=</span>2 <span class="nv">max</span><span class="o">=</span>31 <span class="nv">avg</span><span class="o">=</span>2 OK
…/interceptor_on_enter_performance: DUK <span class="nv">min</span><span class="o">=</span>1 <span class="nv">max</span><span class="o">=</span>2 <span class="nv">avg</span><span class="o">=</span>1 OK</code></pre></figure>

<p>(Numbers are in microseconds, measured on a 4 GHz i7 running OS X 10.11.2.)</p>

<p>Anyway, even if that comparison isn’t entirely fair, as we do some clever
recycling and copy-on-write tricks that we don’t yet do in our V8 runtime, this
new runtime is already quite impressive. It also allows us to run on really tiny
devices, and the performance difference between a roaring JIT-powered monster
like V8 and a pure interpreter might not really matter for most users of Frida.</p>

<p>So starting with this release we are also including this brand new runtime
in all of our prebuilt binaries so you can try it out and tell us how it works
for you. It only adds a few hundred kilobytes of footprint, which is nothing
compared to the 6 MB that V8 adds per architecture slice. Please try it out
by passing <code class="language-plaintext highlighter-rouge">--disable-jit</code> to the CLI tools, or calling <code class="language-plaintext highlighter-rouge">session.disable_jit()</code>
before the first call to <code class="language-plaintext highlighter-rouge">session.create_script()</code>.</p>

<p>Considering that this new runtime also solves some issues that would require a
lot of work to fix in our JavaScriptCore runtime, like ignoring calls from
background threads and avoid poisoning the app’s heap, we decided to get rid
of that runtime and switch to this new Duktape-based runtime on OSes where V8
cannot currently run, like on iOS 9. We feature-detect this at runtime, so you
still get to use V8 on iOS 8 like before – unless you explicitly <code class="language-plaintext highlighter-rouge">--disable-jit</code>
as just mentioned.</p>

<p>So in closing, here’s a summary of the changes:</p>

<p>6.1.0:</p>

<ul>
  <li>core: replace the JavaScriptCore runtime with its successor built on Duktape</li>
  <li>core: add <em>disable_jit()</em> to allow users to try out the new Duktape engine</li>
  <li>core: fix crash on Linux when injecting into processes where <em>pthread_create</em>
      has never been called/bound yet</li>
  <li>core: add support for linux-armhf (e.g. Raspberry Pi)</li>
  <li>python: add <em>disable_jit()</em> to Session</li>
  <li>node: add <em>disableJit()</em> to Session</li>
  <li>CLI tools: add <em>–disable-jit</em> switch</li>
  <li>frida-repl: upgrade to latest prompt-toolkit</li>
  <li>frida-trace: fix crash when attempting to trace partially resolved imports</li>
  <li>frida-trace: stick to ES5 in the generated handlers for Duktape compatibility</li>
</ul>

<p>6.1.1:</p>

<ul>
  <li>core: fix synchronization logic and error-handling bugs in the Duktape runtime</li>
</ul>

<p>6.1.2:</p>

<ul>
  <li>core: fix Android regression resulting in crash on inject</li>
  <li>core: fix Python 3.x build regression</li>
  <li>clr: add <em>DisableJit()</em> to Session</li>
</ul>

<p>6.1.3:</p>

<ul>
  <li>core: give the iOS frida-helper all the entitlements that the Preferences app
      has, so system session scripts can read and write system configuration</li>
  <li>core: changes to support AppContainer ACL on temporary directory/files within</li>
  <li>node: fix pid check so it allows attaching to the system session</li>
</ul>

<p>6.1.4:</p>

<ul>
  <li>core: implement spawn() for console binaries on iOS</li>
  <li>core: improve support for hooking low-level OS APIs</li>
  <li>core: fix mapper issues preventing us from injecting into Mac processes
      where libraries frida-agent depends are not yet loaded</li>
  <li>core: make InvocationContext available to replaced functions also</li>
</ul>

<p>6.1.5:</p>

<ul>
  <li>core: add support for generator functions in scripts generated by frida-load</li>
  <li>frida-repl: fix race condition resulting in hang</li>
  <li>frida-repl: fix spurious error message on exit</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/11/11/frida-6-0-released/index.html">
      Frida 6.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      11 Nov 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Epic release this time, with brand new iOS 9 support and improvements all over
the place. For some more background, check out my blog posts <a href="https://www.nowsecure.com/blog/2015/11/16/ios-9-reverse-engineering-with-javascript/">here</a>
and <a href="https://www.nowsecure.com/blog/2015/11/23/ios-instrumentation-without-jailbreak/">here</a>.</p>

<p>There’s a lot of ground to cover here, but the summary is basically:</p>

<p>6.0.0:</p>

<ul>
  <li>core: add support for OS X El Capitan</li>
  <li>core: add support for iOS 9</li>
  <li>core: fix launchd plist permissions in Cydia package</li>
  <li>core: disable our dynamic linker on iOS for now</li>
  <li>core: add new JavaScript runtime based on JavaScriptCore, as we cannot
      use V8 on iOS 9 with the current jailbreak</li>
  <li>core: add brand new system session when attaching to <em>pid=0</em></li>
  <li>core: improve arm hooking, including support for early TBZ/TBNZ/IT/B.cond,
      and avoid relocating instructions that a later instruction loops back to</li>
  <li>core: fix relocation of LDR.W instructions on arm64</li>
  <li>core: abort when we’re stuck in an exception loop</li>
  <li>core: fix <em>AutoIgnorer</em>-related deadlocks</li>
  <li>core: drop our <em>.</em> prefix so temporary files are easier to discover</li>
  <li>python: add support for running without ES6 support</li>
  <li>python: tweak setup.py to allow offline installation</li>
  <li>python: lock the prompt-toolkit version to 0.38 for now</li>
  <li>frida-repl: fix display of raw buffers as returned by <em>Memory.readByteArray()</em></li>
  <li>frida-repl: fix crash in completion on error</li>
  <li>node: add support for DeviceManager’s <em>added</em> and <em>removed</em> signals</li>
  <li>node: add example showing how to watch available devices</li>
  <li>node: use prebuild instead of node-pre-gyp</li>
  <li>node: Babelify the source code read by <em>frida.load()</em></li>
  <li>node: remove <em>frida.load()</em> as it’s now in the frida-load module</li>
</ul>

<p>6.0.1:</p>

<ul>
  <li>python: stop providing 3.4 binaries and move to 3.5 instead</li>
  <li>node: fix Linux linking issue where we fail to pick up our libffi</li>
  <li>node: also produce prebuild for Node.js LTS</li>
</ul>

<p>6.0.2:</p>

<ul>
  <li>core: provide FridaGadget.dylib for instrumenting iOS apps without jailbreak</li>
  <li>core: add support for the iOS Simulator</li>
  <li>core: improve <em>MemoryAccessMonitor</em> to allow monitoring any combination of
      R, W or X operations on a page</li>
  <li>python: fix UTF-8 fields being accidentally exposed as <em>str</em> on Python 2.x</li>
</ul>

<p>6.0.3:</p>

<ul>
  <li>core: fix <em>spawn()</em> on OS X</li>
</ul>

<p>6.0.4:</p>

<ul>
  <li>core: add partial support for using the gadget standalone</li>
  <li>CLI tools: fix crash when the stdout encoding cannot represent all characters</li>
  <li>frida-trace: always treat handler scripts as UTF-8</li>
</ul>

<p>6.0.5:</p>

<ul>
  <li>core: add logical shift right and left operations to NativePointer</li>
  <li>core: improve Interceptor to support attaching to a replaced function</li>
  <li>core: add support for hooking tiny functions on 32-bit ARM</li>
  <li>core: emulate <em>{Get/Set}LastErrror</em> and TLS key access on Windows, allowing
      us to hook more low-level APIs</li>
</ul>

<p>6.0.6:</p>

<ul>
  <li>core: fix launchd / Jetsam issue on iOS 9</li>
  <li>core: fix iOS 9 code signing issue</li>
  <li>core: update security attributes on named pipe to allow us to inject into
      more Windows apps</li>
</ul>

<p>6.0.7:</p>

<ul>
  <li>core: add support for injecting into processes on linux-arm</li>
  <li>core: fix crashes related to the DebugSymbol API on Mac and iOS</li>
  <li>frida-trace: improve manpage parser</li>
</ul>

<p>6.0.8:</p>

<ul>
  <li>core: fix Linux compatibility issue caused by failing to link libstdc++
      statically</li>
</ul>

<p>6.0.9:</p>

<ul>
  <li>core: add support for running frida-gadget standalone</li>
  <li>core: add a temporary workaround for Windows compatibility regression</li>
  <li>core: port the Fruity backend to Linux, allowing direct access to connected
      iOS devices</li>
  <li>core: expose the InvocationContext <em>context</em> read-write in the JavaScriptCore
      runtime also</li>
  <li>core: fix issue with InvocationContext’s CpuContext getting GCed prematurely</li>
</ul>

<p>6.0.10:</p>

<p>Re-release of 6.0.9 with a Windows build regression fix.</p>

<p>6.0.11:</p>

<ul>
  <li>core: prevent stale HostSession objects in case of network errors</li>
  <li>CLI tools: assume UTF-8 when the stdout encoding is unknown</li>
  <li>node: fix double free caused by using the wrong Nan API</li>
</ul>

<p>6.0.12:</p>

<ul>
  <li>core: update security attributes on named pipe on Windows</li>
  <li>core: add CreateProcessW flags to prevent IFEO loop on Windows</li>
  <li>core: fix hooking of recursive functions on arm and arm64</li>
  <li>python: fix Python 3 line endings regression</li>
  <li>node: update prebuild dependency</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/09/17/frida-5-0-released/index.html">
      Frida 5.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      17 Sep 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Wow, another major release! We decided to change the Device API to give you
persistent IDs so you can easily tell different devices apart as they’re
hotplugged.</p>

<p>But that’s just the beginning of it, we’re also bringing a ton of other
improvements this time:</p>

<p>5.0.0:</p>

<ul>
  <li>core: change Device.id to represent individual devices across reconnects</li>
  <li>core: add new Droidy backend for interfacing with connected Android devices</li>
  <li>core: adjust confusing iPhone 5+ device name on Darwin</li>
  <li>core: normalize the fallback iOS device name for consistency with Android</li>
  <li>core: upgrade V8 to 4.5.103.30</li>
  <li>objc: include both class and instance methods in <em>$methods</em> and <em>$ownMethods</em></li>
  <li>python: add -D switch for specifying the device id to connect to</li>
  <li>python: add frida-ls-devices CLI tool for listing devices</li>
  <li>python: update to the new Device.id API</li>
  <li>python: add <em>get_local_device()</em> and improve API consistency with frida-node</li>
  <li>node: update to the new Device.id API</li>
  <li>node: improve the top-level facade API</li>
  <li>qml: update to the new Device.id API</li>
  <li>clr: update to the new Device.id API</li>
  <li>frida-ps: improve the output formatting</li>
</ul>

<p>5.0.1:</p>

<ul>
  <li>core: add support for source maps</li>
  <li>node: add frida.load() for turning a CommonJS module into a script</li>
  <li>node: upgrade Nan</li>
</ul>

<p>5.0.2:</p>

<ul>
  <li>core: add <em>console.warn()</em> and <em>console.error()</em></li>
  <li>core: add <em>Module.enumerateImports()</em> and implement on Darwin, Linux,
      and Windows</li>
  <li>core: allow <em>null</em> module name when calling <em>Module.findExportByName()</em></li>
  <li>core: move <em>Darwin.Module</em> and <em>Darwin.Mapper</em> from frida-core to frida-gum,
      allowing easy Mach-O parsing and out-of-process dynamic linking</li>
  <li>core: better handling of temporary files</li>
  <li>frida-trace: add support for conveniently tracing imported functions</li>
  <li>frida-trace: blacklist dyld_stub_binder from being traced</li>
  <li>python: avoid logging getting overwritten by the status message changing</li>
</ul>

<p>5.0.3:</p>

<ul>
  <li>core: improve arm64 hooking, including support for hooking short functions</li>
</ul>

<p>5.0.4:</p>

<ul>
  <li>core: improve arm64 hooking, also taking care to avoid relocating instructions
      that other instructions depend on, including the next instruction after
      a BL/BLR/SVC instruction</li>
  <li>core: port <em>Arm64Writer</em> and <em>Arm64Relocator</em> to Capstone</li>
</ul>

<p>5.0.5:</p>

<ul>
  <li>core: fix crash on teardown by using new API provided by our GLib patch</li>
  <li>core: fix module name resolving on Linux</li>
  <li>core: improve ELF handling to also consider <em>ET_EXEC</em> images as valid modules</li>
  <li>core: improve arm64 hooking</li>
  <li>core: port <em>{Arm,Thumb}Writer</em> and <em>{Arm,Thumb}Relocator</em> to Capstone</li>
  <li>python: fix tests on OS X 10.11</li>
  <li>node: fix tests on OS X 10.11</li>
</ul>

<p>5.0.6:</p>

<ul>
  <li>core: turn NativeFunction invocation crash into a JS exception when possible</li>
  <li>core: add <em>Process.setExceptionHandler()</em> for handling native exceptions from
      JS</li>
  <li>core: install a default exception handler that emits error messages</li>
  <li>core: prevent apps from overriding our exception handler if we install ours
      early in the process life-time</li>
  <li>core: gracefully handle it if we cannot replace native functions</li>
  <li>core: allow RPC exports to return ArrayBuffer values</li>
  <li>python: add support for rpc methods returning ArrayBuffer objects</li>
  <li>node: add support for rpc methods returning ArrayBuffer objects</li>
</ul>

<p>5.0.7:</p>

<ul>
  <li>core: don’t install a default exception handler for now</li>
</ul>

<p>5.0.8:</p>

<p>Re-release of 5.0.7 due to build machine issues.</p>

<p>5.0.9:</p>

<ul>
  <li>python: update setup.py to match new build server configuration</li>
</ul>

<p>5.0.10:</p>

<ul>
  <li>core: fix instrumentation of arm64 functions with early usage of IP registers</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/09/10/frida-4-5-released/index.html">
      Frida 4.5 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      10 Sep 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Time for another packed release. This time we’re bringing a brand new spawn
gating API that lets you catch processes spawned by the system, and tons of
Android improvements and improvements all over the place.</p>

<p>So without further ado, the list of changes:</p>

<p>4.5.0:</p>

<ul>
  <li>core: add <em>Process.pageSize</em> constant</li>
  <li>core: let <em>Memory.alloc()</em> allocate raw pages when size &gt;= page size</li>
  <li>core: fix NativeFunction’s handling of small return types</li>
  <li>core: fix PC alignment when rewriting BLX instructions</li>
  <li>core: add spawn gating API</li>
  <li>core: implement <em>get_frontmost_application()</em> on Android</li>
  <li>core: implement <em>enumerate_applications()</em> on Android</li>
  <li>core: add support for spawning Android apps</li>
  <li>core: add support for injecting into arm64 processes on Android</li>
  <li>core: add support for Android M</li>
  <li>core: patch the kernel’s live SELinux policy</li>
  <li>core: integrate with SuperSU to work around restrictions on Samsung kernels</li>
  <li>core: work around broken sigsetjmp on Android, and many other Android fixes</li>
  <li>core: fix crash when enumerating modules on Linux</li>
  <li>core: optimize exports enumeration for remote processes on Darwin</li>
  <li>dalvik: port to ART and deprecate <em>Dalvik</em> name, now known as <em>Java</em></li>
  <li>java: add <em>Java.openClassFile()</em> to allow loading classes at runtime</li>
  <li>java: fixes for array conversions and field setters</li>
  <li>python: add support for the new spawn gating API</li>
  <li>python: allow script source and name to be unicode on Python 2.x also</li>
  <li>python: fix error-propagation in Python 3.x</li>
  <li>python: fix the Linux download URL computation</li>
  <li>node: add support for the new spawn gating API</li>
  <li>node: port to Nan 2.x</li>
</ul>

<p>4.5.1:</p>

<ul>
  <li>core: fix <code class="language-plaintext highlighter-rouge">ensure_host_session()</code> error propagation</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/07/31/frida-4-4-released/index.html">
      Frida 4.4 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      31 Jul 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>With 4.4 out the door, we can now offer you a brand new <a href="../../docs/javascript-api/index.html#rpc">RPC API</a>
that makes it super-easy to communicate with your scripts and have them expose
services to your application. We also got some amazing contributions from
<a href="https://github.com/SomeoneWeird">Adam Brady</a>, who just ported frida-node to
<a href="https://github.com/nodejs/nan">Nan</a>, making it easy to build it for multiple
versions of Node.js.</p>

<p>So to summarize this release:</p>

<ul>
  <li>core: add new RPC API</li>
  <li>python: add support for calling RPC exports</li>
  <li>node: add support for calling RPC exports</li>
  <li>node: allow posted message value to be anything serializable to JSON</li>
  <li>node: port to Nan</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/07/15/frida-4-3-released/index.html">
      Frida 4.3 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      15 Jul 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s release o’clock, and this time we have a slew of improvements all over
the place. In brief:</p>

<p>4.3.0:</p>

<ul>
  <li>core: add support for getting details about the frontmost application,
      initially only for iOS</li>
  <li>python: add <em>Device.get_frontmost_application()</em></li>
  <li>node: add <em>Device.getFrontmostApplication()</em></li>
</ul>

<p>4.3.1:</p>

<ul>
  <li>core: add support for relocating PC-relative <em>CBZ</em> on arm64</li>
  <li>frida-repl: fix crash and loading of script on Py3k</li>
</ul>

<p>4.3.2:</p>

<ul>
  <li>core: add support for launching an iOS app with a URL</li>
  <li>dalvik: fix bug in field caching</li>
  <li>frida-trace: color and indent events based on thread ID and depth</li>
  <li>frida-ps: fix application listing on Py3k</li>
</ul>

<p>4.3.3:</p>

<ul>
  <li>core: re-enable the Darwin mapper after accidentally disabling it</li>
</ul>

<p>4.3.4:</p>

<ul>
  <li>core: gracefully handle attempts to replace functions</li>
  <li>core: throw an exception when Interceptor’s <em>attach()</em> and <em>replace()</em> fail</li>
  <li>core: fix clean-up of agent sessions</li>
  <li>core: fix assertion logging and log to CFLog on Darwin</li>
  <li>dalvik: add <em>Dalvik.synchronized()</em>, <em>Dalvik.scheduleOnMainThread()</em> and
        <em>Dalvik.isMainThread()</em></li>
  <li>dalvik: port <em>Dalvik.androidVersion</em> and <em>Dalvik.choose()</em> to Android 4.2.2</li>
  <li>python: fix the PyPI download URL for windows-i386</li>
  <li>frida-trace: handle <em>attach()</em> failures gracefully</li>
</ul>

<p>4.3.5:</p>

<ul>
  <li>frida-server: better resource tracking</li>
</ul>

<p>4.3.6:</p>

<ul>
  <li>core: fix for arm64 function hooking</li>
  <li>dalvik: fix for <em>Dalvik.enumerateLoadedClasses()</em></li>
</ul>

<p>4.3.7:</p>

<ul>
  <li>objc: add <em>ObjC.Block</em> for implementing and interacting with blocks</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/06/18/frida-4-2-released/index.html">
      Frida 4.2 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      18 Jun 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>The Frida co-conspirators have been cracking away on several fronts, so much
lately that I figured it was worth jotting this down to get the word out.</p>

<p>In Dalvik land, <a href="https://github.com/marc1006">@marc1006</a> contributed a really
neat new feature – the ability to do object carving, essentially scanning the
heap for objects of a certain type. Check this out:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">strings</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">Dalvik</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="dl">'</span><span class="s1">java.lang.String</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">onMatch</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">strings</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">onComplete</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Found </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="dl">'</span><span class="s1"> strings!</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p>Meanwhile, <a href="https://github.com/Tyilo">@Tyilo</a> has been rocking out adding the
same feature for Objective-C:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">strings</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">ObjC</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">NSString</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">onMatch</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">strings</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">onComplete</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Found </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="dl">'</span><span class="s1"> strings!</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p>In other mobile news, <a href="https://github.com/trufae">@pancake</a> added support for
enumerating applications on Firefox OS. Sweet!</p>

<p>While all of this was going on, <a href="https://github.com/s1341">@s1341</a> has been
hard at work stabilizing the QNX port, and it’s reportedly working really well
now.</p>

<p>On my end I have been applying Frida to interesting challenges at
<a href="https://www.nowsecure.com/">NowSecure</a>, and ran into quite a few bugs and
limitations in the Objective-C integration. There’s now support for overriding
methods that deal with struct types passed by value, e.g. <code class="language-plaintext highlighter-rouge">-[UIView drawRect:]</code>,
which means <code class="language-plaintext highlighter-rouge">NativeFunction</code> and <code class="language-plaintext highlighter-rouge">NativeCallback</code> also support these; so for
declaring a struct simply start an array with the fields’ types specified
sequentially. You can even nest them. So for the <code class="language-plaintext highlighter-rouge">- drawRect:</code> case where a
struct is passed by value, and that struct is made out of two other structs,
you’d declare it like this:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NativeFunction</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="dl">'</span><span class="s1">0x1234</span><span class="dl">'</span><span class="p">),</span> <span class="dl">'</span><span class="s1">void</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">[[[</span><span class="dl">'</span><span class="s1">double</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">double</span><span class="dl">'</span><span class="p">],</span> <span class="p">[</span><span class="dl">'</span><span class="s1">double</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">double</span><span class="dl">'</span><span class="p">]]]);</span></code></pre></figure>

<p>Another thing worth mentioning is that a long-standing issue especially visible
when instrumenting 32-bit iOS apps, but affecting all platforms, has finally
<a href="https://github.com/frida/frida-gum/commit/2f02e911edc4a5df80051fdaed72e0281ea751e7">been fixed</a>.</p>

<p>So let’s run quickly through all the changes:</p>

<p>4.1.8:</p>

<ul>
  <li>core: add support for enumerating applications on Firefox OS</li>
  <li>core: add <em>NativePointer.toMatchPattern()</em> for use with <em>Memory.scan()</em></li>
  <li>core: fix QNX injector race condition</li>
  <li>objc: massively improved handling of types</li>
  <li>objc: fix implicit conversion from JS string to NSString</li>
  <li>objc: fix crash during registration of second proxy or unnamed class</li>
  <li>objc: new <em>ObjC.Object</em> properties: <em>$className</em> and <em>$super</em></li>
  <li>dalvik: add <em>Dalvik.choose()</em> for object carving</li>
</ul>

<p>4.1.9:</p>

<ul>
  <li>core: <em>NativeFunction</em> and <em>NativeCallback</em> now support functions passing
      struct types by value</li>
  <li>core: fix accidental case-sensitivity in <em>Process.getModuleByName()</em></li>
  <li>dalvik: new object property: <em>$className</em></li>
</ul>

<p>4.2.0:</p>

<ul>
  <li>core: add <em>this.returnAddress</em> to <em>Interceptor</em>’s <em>onEnter</em> and <em>onLeave</em>
      callbacks</li>
  <li>objc: add <em>ObjC.choose()</em> for object carving</li>
</ul>

<p>4.2.1:</p>

<ul>
  <li>core: fix exports enumeration of stripped libraries on QNX</li>
  <li>objc: new <em>ObjC.Object</em> property: <em>$kind</em>, a string that is either <em>instance</em>,
      <em>class</em> or <em>meta-class</em></li>
  <li>objc: fix the <em>$class</em> property so it also does the right thing for classes</li>
  <li>objc: fix crash when looking up inexistent method</li>
  <li>python: ensure graceful teardown of the reactor thread</li>
  <li>frida-discover: fix regression</li>
  <li>frida-repl: fix hang when target crashes during evaluation of expression</li>
</ul>

<p>4.2.2:</p>

<ul>
  <li>core: fix exception handling weirdness; very visible on ios-arm</li>
  <li>core: QNX stability improvements</li>
  <li>objc: add <em>ObjC.api</em> for direct access to the Objective-C runtime’s API</li>
  <li>objc: new <em>ObjC.Object</em> properties: <em>equals</em>, <em>$superClass</em> and <em>$methods</em></li>
  <li>objc: fix iOS 7 compatibility</li>
  <li>objc: fix <em>toJSON()</em> of <em>ObjC.classes</em> and <em>ObjC.protocols</em></li>
  <li>dalvik: fix handling of <em>java.lang.CharSequence</em></li>
  <li>frida-repl: add <em>%time</em> command for easy profiling</li>
</ul>

<p>4.2.3:</p>

<ul>
  <li>core: fix crash when handling exceptions without a message object</li>
  <li>core: fix the life-time of CpuContext JS wrappers</li>
  <li>core: expose the file mapping info to <em>Process.enumerateRanges()</em></li>
  <li>core: make it possible to coalesce neighboring ranges when enumerating</li>
  <li>core: add convenience API for looking up modules and ranges</li>
  <li>core: make the QNX mprotect read in a loop instead of just the once</li>
  <li>dalvik: avoid crashing the process if a type conversion fails</li>
  <li>dalvik: allow <em>null</em> as call parameter</li>
  <li>objc: fix conversion of structs with simple field types</li>
  <li>objc: speed up implicit string conversion by caching wrapper object</li>
</ul>

<p>4.2.4:</p>

<ul>
  <li>objc: fix crash when interacting with not-yet-realized classes</li>
</ul>

<p>4.2.5:</p>

<ul>
  <li>core: optimize Interceptor callback logic and make it twice as fast when
      <em>onEnter</em> and <em>onLeave</em> aren’t both specified</li>
  <li>core: fix return-address seen by the invocation-context on arm64</li>
  <li>core: add a fuzzy backtracer for arm64</li>
</ul>

<p>4.2.6:</p>

<ul>
  <li>core: fix access to arguments 4 through 7 on arm64</li>
  <li>core: add <em>Memory.readFloat()</em>, <em>Memory.writeFloat()</em>, <em>Memory.readDouble()</em>
      and <em>Memory.writeDouble()</em></li>
  <li>dalvik: improved type checking</li>
  <li>qnx: implement side-stack for calling <em>onEnter()</em>/<em>onLeave()</em> with the
     stack-hungry V8 engine</li>
</ul>

<p>4.2.7:</p>

<ul>
  <li>core: Darwin backend bug-fixes</li>
  <li>core: optimize handling of the <em>send()</em> data payload</li>
  <li>core: add APIs for interacting with the iOS kernel through <em>task_for_pid(0)</em>,
      only available in the <em>attach(pid=0)</em> session</li>
  <li>core: side-stack support for replaced functions on QNX</li>
  <li>objc: add <em>getOwnPropertyNames()</em> to ObjC.classes</li>
  <li>frida-repl: improved completion</li>
</ul>

<p>4.2.8:</p>

<ul>
  <li>python: fix Py3k regression</li>
</ul>

<p>4.2.9:</p>

<ul>
  <li>objc: add <em>$ownMethods</em> to <em>ObjC.Object</em></li>
  <li>dalvik: add support for primitive arrays and object arrays</li>
  <li>python: improve compatibility between Python 2 and 3</li>
  <li>frida-repl: better magic commands</li>
</ul>

<p>4.2.10:</p>

<ul>
  <li>core: fix Interceptor vector register clobbering issue on arm64</li>
  <li>core: improve temporary directory handling on Android</li>
</ul>

<p>4.2.11:</p>

<ul>
  <li>dalvik: add support for accessing instance and static fields</li>
  <li>dalvik: type conversion improvements</li>
  <li>python: resolve python runtime lazily on Mac to allow our binaries to work
        with multiple Python distributions</li>
  <li>python: pip support</li>
</ul>

<p>4.2.12:</p>

<ul>
  <li>python: fix Py3k regressions</li>
</ul>

<p>That’s all for now. Please help spread the word by sharing this post across
the inter-webs. We’re still quite small as an open source project, so
word-of-mouth marketing means a lot to us.</p>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/06/09/frida-4-1-released/index.html">
      Frida 4.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      09 Jun 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s release o’clock, and this time we’re taking the iOS support to the next
level while also bringing some solid quality improvements. I’m also really
excited to announce that I’ve recently joined <a href="https://www.nowsecure.com/">NowSecure</a>,
and the awesomeness of this release is no conincidence.</p>

<p>Let’s start with a brand new iOS feature. It’s now possible to list installed
apps, which <em>frida-ps</em> can do for you:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>frida-ps <span class="nt">-U</span> <span class="nt">-a</span>
  PID NAME        IDENTIFIER
10582 Facebook    com.facebook.Facebook
11066 IRCCloud    com.irccloud.IRCCloud
  451 Mail        com.apple.mobilemail
10339 Mailbox     com.orchestra.v2
 6866 Messages    com.apple.MobileSMS
10626 Messenger   com.facebook.Messenger
11043 Settings    com.apple.Preferences
10542 Skype       com.skype.skype
11218 Slack       com.tinyspeck.chatlyio
11052 Snapchat    com.toyopagroup.picaboo
<span class="err">$</span></code></pre></figure>

<p>Add the <code class="language-plaintext highlighter-rouge">-i</code> switch and it will also include all installed applications, and
not just those of them that are currently running.</p>

<p>This is also available from your language binding of choice, e.g. from Python:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">frida</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">iphone</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">get_usb_device</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">iphone</span><span class="p">.</span><span class="n">enumerate_applications</span><span class="p">())))</span>
<span class="n">Application</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="s">"com.google.ios.youtube"</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"YouTube"</span><span class="p">)</span>
<span class="n">Application</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="s">"com.toyopagroup.picaboo"</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"Snapchat"</span><span class="p">)</span>
<span class="n">Application</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="s">"com.skype.skype"</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"Skype"</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="mi">10542</span><span class="p">)</span>
<span class="err">…</span>
<span class="o">&gt;&gt;&gt;</span></code></pre></figure>

<p>That’s cool, but wouldn’t you like to do early instrumentation of those apps?
Now you can do that too, by just asking us to spawn an app identifier:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>frida-trace <span class="nt">-U</span> <span class="nt">-f</span> com.toyopagroup.picaboo <span class="nt">-I</span> <span class="s2">"libcommonCrypto*"</span></code></pre></figure>

<p>Or at the API level:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">frida</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">iphone</span> <span class="o">=</span> <span class="n">frida</span><span class="p">.</span><span class="n">get_usb_device</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">iphone</span><span class="p">.</span><span class="n">spawn</span><span class="p">([</span><span class="s">"com.toyopagroup.picaboo"</span><span class="p">])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">snapchat</span> <span class="o">=</span> <span class="n">iphone</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="err">…</span><span class="nb">apply</span> <span class="n">instrumentation</span><span class="err">…</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">iphone</span><span class="p">.</span><span class="n">resume</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span></code></pre></figure>

<p>Note that we piggy-back on <em>Cydia Substrate</em> for the early launch part in order
to maximize interoperability; after all it’s not too good if multiple frameworks
all inject code into <em>launchd</em> and risk stepping on each others’ toes. This
dependency is however a soft one, so we’ll throw an exception if Substrate isn’t
installed when trying to call <code class="language-plaintext highlighter-rouge">spawn()</code> with an app identifier.</p>

<p>So, early instrumentation of iOS apps is pretty cool. But, those applications
are typically consuming tons of Objective-C APIs, and if we want to instrument
them we often find ourselves having to create new Objective-C classes in order
to create delegates to insert between the application and the API. Wouldn’t it
be nice if such Objective-C classes could be created in pure JavaScript? Now
they can:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">MyConnectionDelegateProxy</span> <span class="o">=</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">registerClass</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">MyConnectionDelegateProxy</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">super</span><span class="p">:</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">NSObject</span><span class="p">,</span>
  <span class="na">protocols</span><span class="p">:</span> <span class="p">[</span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">protocols</span><span class="p">.</span><span class="nx">NSURLConnectionDataDelegate</span><span class="p">],</span>
  <span class="na">methods</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">- init</span><span class="dl">'</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="k">super</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">self</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ObjC</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">foo</span><span class="p">:</span> <span class="mi">1234</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="dl">'</span><span class="s1">- dealloc</span><span class="dl">'</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">ObjC</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nb">self</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="k">super</span><span class="p">.</span><span class="nx">dealloc</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="dl">'</span><span class="s1">- connection:didReceiveResponse:</span><span class="dl">'</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* this.data.foo === 1234 */</span>
    <span class="p">},</span>
    <span class="cm">/*
     * But those previous methods are declared assuming that
     * either the super-class or a protocol we conform to has
     * the same method so we can grab its type information.
     * However, if that's not the case, you would write it
     * like this:
     */</span>
    <span class="dl">'</span><span class="s1">- connection:didReceiveResponse:</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">retType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">void</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">argTypes</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">],</span>
      <span class="nx">implementation</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="cm">/* Or grab it from an existing class: */</span>
    <span class="dl">'</span><span class="s1">- connection:didReceiveResponse:</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">types</span><span class="p">:</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span>
          <span class="p">.</span><span class="nx">Foo</span><span class="p">[</span><span class="dl">'</span><span class="s1">- connection:didReceiveResponse:</span><span class="dl">'</span><span class="p">].</span><span class="nx">types</span><span class="p">,</span>
      <span class="nx">implementation</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="cm">/* Or from an existing protocol: */</span>
    <span class="dl">'</span><span class="s1">- connection:didReceiveResponse:</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">types</span><span class="p">:</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">protocols</span><span class="p">.</span><span class="nx">NSURLConnectionDataDelegate</span>
          <span class="p">.</span><span class="nx">methods</span><span class="p">[</span><span class="dl">'</span><span class="s1">- connection:didReceiveResponse:</span><span class="dl">'</span><span class="p">].</span><span class="nx">types</span><span class="p">,</span>
      <span class="nx">implementation</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="cm">/* Or write the signature by hand if you really want to: */</span>
    <span class="dl">'</span><span class="s1">- connection:didReceiveResponse:</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">types</span><span class="p">:</span> <span class="dl">'</span><span class="s1">v32@0:8@16@24</span><span class="dl">'</span><span class="p">,</span>
      <span class="nx">implementation</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">proxy</span> <span class="o">=</span> <span class="nx">MyConnectionDelegateProxy</span><span class="p">.</span><span class="nx">alloc</span><span class="p">().</span><span class="nx">init</span><span class="p">();</span>
<span class="cm">/* use `proxy`, and later: */</span>
<span class="nx">proxy</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span></code></pre></figure>

<p>Though most of the time you’d like to build a proxy object where you
pass on everything and only do some logging for the few methods you
actually care about. Check this out:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">MyConnectionDelegateProxy</span> <span class="o">=</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">registerProxy</span><span class="p">({</span>
  <span class="na">protocols</span><span class="p">:</span> <span class="p">[</span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">protocols</span><span class="p">.</span><span class="nx">NSURLConnectionDataDelegate</span><span class="p">],</span>
  <span class="na">methods</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">- connection:didReceiveResponse:</span><span class="dl">'</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* fancy logging code here */</span>
      <span class="cm">/* this.data.foo === 1234 */</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">target</span>
          <span class="p">.</span><span class="nx">connection_didReceiveResponse_</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">resp</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="dl">'</span><span class="s1">- connection:didReceiveData:</span><span class="dl">'</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* other logging code here */</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">target</span>
          <span class="p">.</span><span class="nx">connection_didReceiveData_</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">events</span><span class="p">:</span> <span class="p">{</span>
    <span class="nx">forward</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">*** forwarding: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">NSURLConnection</span><span class="p">[</span>
    <span class="dl">'</span><span class="s1">- initWithRequest:delegate:startImmediately:</span><span class="dl">'</span><span class="p">];</span>
<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">method</span><span class="p">.</span><span class="nx">implementation</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyConnectionDelegateProxy</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">{</span>
      <span class="na">foo</span><span class="p">:</span> <span class="mi">1234</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p>So that’s Objective-C. The Dalvik integration also got some sweet new API for
enumerating loaded classes thanks to <a href="https://github.com/marc1006">@marc1006</a>,
who also fixed our handling of static methods and being able to return booleans
from overriden implementations.</p>

<p>We also got lots of awesome improvements from <a href="https://github.com/Tyilo">@Tyilo</a>
who helped improve the ObjC integration, beat the REPL into better shape, added
APIs for enumerating malloc ranges, and added some convenience APIs to
<em>NativePointer</em>.</p>

<p>While all of this was going on, <a href="https://github.com/s1341">@s1341</a> has been
hard at work doing an amazing job porting Frida to QNX, which is now really
close to working like a charm.</p>

<p>Let’s run through the remaining changes:</p>

<p>4.0.1:</p>

<ul>
  <li>objc: support for more types</li>
  <li>frida-trace: fix ObjC tracing regression</li>
</ul>

<p>4.0.2:</p>

<ul>
  <li>frida-node: fix encoding of the <em>pixels</em> property</li>
</ul>

<p>4.0.3:</p>

<ul>
  <li>frida-repl: fix Windows regression</li>
</ul>

<p>4.0.5:</p>

<ul>
  <li>objc: support for more types and better type checking</li>
  <li>objc: arm64 now working properly</li>
  <li>frida-repl: allow variables to be created</li>
</ul>

<p>4.0.6:</p>

<ul>
  <li>platform: support passing a plain array of data to <em>send()</em></li>
  <li>arm: support for relocating <em>cbz</em>/<em>cbnz</em> instructions</li>
</ul>

<p>4.1.0:</p>

<ul>
  <li>platform: fix spawning of child processes that write to stdout</li>
  <li>platform: fix NativeCallback’s handling of <em>bool</em>/<em>int8</em>/<em>uint8</em> return
values (this was preventing Dalvik method overrides from being able to
return <em>false</em>).</li>
  <li>platform: allow <em>Memory.readByteArray()</em> with length &lt; 1</li>
  <li>arm: support for relocating the <em>ldrpc t2</em> instruction</li>
  <li>arm: improved redirect resolver</li>
  <li>arm64: fix relocation of the <em>adrp</em> instruction</li>
  <li>arm64: support for relocating PC-relative <em>ldr</em> instruction</li>
  <li>dalvik: add <em>Dalvik.enumerateLoadedClasses()</em></li>
  <li>dalvik: fix handling of static methods</li>
  <li>python: fix <em>console.log()</em> on Windows</li>
  <li>frida-repl: bugfixes and improvements</li>
  <li>frida-trace: glob support for tracing ObjC methods</li>
</ul>

<p>4.1.1:</p>

<ul>
  <li>platform: add missing pid field in <em>enumerate_applications()</em></li>
</ul>

<p>4.1.2:</p>

<ul>
  <li>objc: class and proxy creation APIs</li>
  <li>objc: new <em>ObjC.protocols</em> API for enumerating protocols</li>
</ul>

<p>4.1.3:</p>

<ul>
  <li>platform: improved concurrency by releasing V8 lock while calling
NativeFunction</li>
  <li>platform: add <em>Process.getModuleByName(name)</em></li>
  <li>platform: faster and more robust detach</li>
  <li>python: stability improvements in CLI tools</li>
  <li>frida-repl: replace <em>readline</em> with <em>prompt-toolkit</em></li>
</ul>

<p>4.1.4:</p>

<ul>
  <li>platform: faster and more robust teardown</li>
  <li>frida-server: clean up on <em>SIGINT</em> and <em>SIGTERM</em></li>
</ul>

<p>4.1.5:</p>

<ul>
  <li>frida-ps: add support for listing applications</li>
</ul>

<p>4.1.6:</p>

<ul>
  <li>platform: fix crash on spawn on Mac, iOS and Linux</li>
  <li>platform: add <em>NativePointer.compare()</em> and <em>NativePointer.equals()</em></li>
  <li>platform: add <em>Process.enumerateMallocRanges{,Sync}()</em></li>
  <li>frida-trace: switch from Enter to Ctrl+C for stopping</li>
  <li>frida-trace: fix spawning of iOS apps</li>
  <li>frida-repl: add prototype names to autocomplete</li>
</ul>

<p>4.1.7:</p>

<ul>
  <li>python: CLI tools stability improvements</li>
</ul>

<p>That’s all for now. Please help spread the word by sharing this post across
the inter-webs. We’re still quite small as an open source project, so
word-of-mouth marketing means a lot to us.</p>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/05/09/frida-4-0-0-released/index.html">
      Frida 4.0.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      09 May 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s time for an insane release with tons of improvements.</p>

<p>Let’s start with a user-facing change. The CLI tool called <em>frida-repl</em> has
been renamed to just <em>frida</em>, and now does tab completion! This and some other
awesome REPL goodies were contributed by <a href="https://github.com/fitblip">@fitblip</a>.</p>

<p>There is also integrated support for launching scripts straight from the shell:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>frida Calculator <span class="nt">-l</span> calc.js
    _____
   <span class="o">(</span>_____<span class="o">)</span>
    |   |    Frida 4.0.0 - A world-class dynamic
    |   |                  instrumentation framework
    |<span class="sb">`</span>-<span class="s1">'|
    |   |    Commands:
    |   |        help      -&gt; Displays the help system
    |   |        object?   -&gt; Display information about '</span>object<span class="s1">'
    |   |        exit/quit -&gt; Exit
    |   |
    |   |    More info at https://frida.re/docs/home/
    `._.'</span>

<span class="c"># The code in calc.js has now been loaded and executed</span>
<span class="o">[</span>Local::ProcName::Calculator]-&gt;
<span class="c"># Reload it from file at any time</span>
<span class="o">[</span>Local::ProcName::Calculator]-&gt; %reload
<span class="o">[</span>Local::ProcName::Calculator]-&gt;</code></pre></figure>

<p>Or, perhaps you’re tired of console.log() and would like to set some breakpoints
in your scripts to help you understand what’s going on? Now you can, because
Frida just got an integrated Node.js-compatible debugger.</p>

<p>(Cue “Yo Dawg” meme here.)</p>

<p>Yep yep, but it is actually quite useful, and all of the CLI tools provide
the <code class="language-plaintext highlighter-rouge">--debug</code> switch to enable it:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Connect Frida to a locally-running Calculator.app</span>
<span class="c"># and load calc.js with the debugger enabled</span>
<span class="nv">$ </span>frida Calculator <span class="nt">-l</span> calc.js <span class="nt">--debug</span>
    _____
   <span class="o">(</span>_____<span class="o">)</span>
    |   |    Frida 4.0.0 - A world-class dynamic
    |   |                  instrumentation framework
    |<span class="sb">`</span>-<span class="s1">'|
    |   |    Commands:
    |   |        help      -&gt; Displays the help system
    |   |        object?   -&gt; Display information about '</span>object<span class="s1">'
    |   |        exit/quit -&gt; Exit
    |   |
    |   |    More info at https://frida.re/docs/home/
    `._.'</span>

Debugger listening on port 5858
<span class="c"># We can now run node-inspector and start debugging calc.js</span>
<span class="o">[</span>Local::ProcName::Calculator]-&gt;</code></pre></figure>

<p>Here’s what it looks like:</p>

<p><img src="../../img/frida-debug.png" alt="Frida Debugger Session" title="Frida Debugger Session" /></p>

<p>Ever found yourself wanting to <em>frida-trace</em> Objective-C APIs straight from
the shell? Thanks to <a href="https://github.com/Tyilo">@Tyilo</a> you now can:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Trace ObjC method calls in Safari</span>
<span class="nv">$ </span>frida-trace <span class="nt">-m</span> <span class="s1">'-[NSView drawRect:]'</span> Safari</code></pre></figure>

<p>There are also other goodies, like brand new support for generating backtraces
and using debug symbols to symbolicate addresses:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="dl">'</span><span class="s1">libcommonCrypto.dylib</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">CCCryptorCreate</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">CCCryptorCreate called from:</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span>
            <span class="nx">Thread</span><span class="p">.</span><span class="nx">backtrace</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span> <span class="nx">Backtracer</span><span class="p">.</span><span class="nx">ACCURATE</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">DebugSymbol</span><span class="p">.</span><span class="nx">fromAddress</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">)</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p>Or perhaps you’re on Windows and trying to figure out who’s accessing certain
memory regions? Yeah? Well check out the brand new
<a href="../../docs/javascript-api/index.html#memoryaccessmonitor">MemoryAccessMonitor</a>. Technically
this code isn’t new, but it just hasn’t been exposed to the JavaScript API
until now.</p>

<p>Another nice feature is that starting with this release it is no longer
necessary to forward multiple TCP ports when using <code class="language-plaintext highlighter-rouge">frida-server</code> running
on another device, e.g. Android.</p>

<p>There is now also much better error feedback propagated all the way from a
remote process to different exceptions in for example Python. With the previous
release attaching to an inexistent pid on Mac would give you:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="nb">SystemError</span><span class="p">:</span> <span class="n">GDBus</span><span class="p">.</span><span class="n">Error</span><span class="p">:</span><span class="n">org</span><span class="p">.</span><span class="n">gtk</span><span class="p">.</span><span class="n">GDBus</span><span class="p">.</span><span class="n">UnmappedGError</span><span class="p">.</span><span class="n">Quark</span><span class="p">.</span><span class="n">_g_2</span><span class="err">↩</span>
<span class="n">dio_2derror_2dquark</span><span class="p">.</span><span class="n">Code0</span><span class="p">:</span> <span class="n">task_for_pid</span><span class="p">()</span> <span class="k">for</span> <span class="n">remote</span> <span class="n">pid</span> <span class="n">failed</span> <span class="n">w</span><span class="err">↩</span>
<span class="n">hile</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">make</span> <span class="n">pipe</span> <span class="n">endpoints</span><span class="p">:</span> <span class="p">(</span><span class="n">os</span><span class="o">/</span><span class="n">kern</span><span class="p">)</span> <span class="n">failure</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span></code></pre></figure>

<p>Whoah, madness. This is now simply:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">frida</span><span class="p">.</span><span class="n">ProcessNotFoundError</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">find</span> <span class="n">process</span> <span class="k">with</span> <span class="n">pid</span> <span class="mi">1234</span></code></pre></figure>

<p>That’s better. Let’s talk about performance. Perhaps you used frida-trace and
wondered why it spent so much time “Resolving functions…”? On a typical iOS
app resolving just one function would typically take about 8 seconds.
This is now down to ~1 second. While there were some optimizations possible,
I quickly realized that no matter how fast we make the enumeration of function
exports, we would still need to transfer the data, and the transfer time alone
could be unreasonable. Solution? Just move the logic to the target process and
transfer the logic instead of the data. Simple.
Also, the Dalvik and ObjC interfaces have been optimized so seconds have been
reduced to milliseconds. The short story here is further laziness in when we
interrogate the language runtimes. We took this quite far in the ObjC interface,
where we now use ES6 proxies to provide a more idiomatic and efficient API.</p>

<p>That brings us to the next topic. The ObjC interface has changed a bit.
Essentially:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">NSString</span> <span class="o">=</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">"</span><span class="s2">NSString</span><span class="dl">"</span><span class="p">);</span></code></pre></figure>

<p>is now:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">NSString</span> <span class="o">=</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">NSString</span><span class="p">;</span></code></pre></figure>

<p>You still use <code class="language-plaintext highlighter-rouge">ObjC.classes</code> for enumerating the currently loaded classes,
but this is now behaving like an object mapping class name to a JavaScript ObjC
binding.</p>

<p>Also, there’s no more casting, so instead of:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">NSSound</span> <span class="o">=</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">NSSound</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sound</span> <span class="o">=</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">cast</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="dl">"</span><span class="s2">0x1234</span><span class="dl">"</span><span class="p">),</span> <span class="nx">NSSound</span><span class="p">);</span></code></pre></figure>

<p>You just go:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">sound</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="dl">"</span><span class="s2">0x1234</span><span class="dl">"</span><span class="p">));</span></code></pre></figure>

<p>Yep, no more class hierarchies trying to mimic the ObjC one. Just a fully
dynamic wrapper where method wrappers are built on the first access, and
the list of methods isn’t fetched unless you try to enumerate the object’s
properties.</p>

<p>Anyway, this is getting long, so let’s summarize the other key changes:</p>

<ul>
  <li>The Dalvik interface now handles varargs methods. Thanks to
<a href="https://github.com/dmchell">@dmchell</a> for reporting and helping track this
down.</li>
  <li><em>NativePointer</em> also provides <code class="language-plaintext highlighter-rouge">.and()</code>, <code class="language-plaintext highlighter-rouge">.or()</code> and <code class="language-plaintext highlighter-rouge">.xor()</code> thanks to
<a href="https://github.com/Tyilo">@Tyilo</a>.</li>
  <li>The Interceptor’s <em>onEnter</em>/<em>onLeave</em> callbacks used to expose the CPU
registers through <code class="language-plaintext highlighter-rouge">this.registers</code>, which has been renamed to <code class="language-plaintext highlighter-rouge">this.context</code>,
and now allows you to write to the registers as well.</li>
  <li><em>Process.enumerateThreads()</em>’s thread objects got their CPU context field
renamed from <code class="language-plaintext highlighter-rouge">registers</code> to <code class="language-plaintext highlighter-rouge">context</code> for consistency.</li>
  <li>Synchronous versions of enumerateFoo() API available as enumerateFoo<strong>Sync</strong>()
methods that simply return an array with all of the items.</li>
  <li><code class="language-plaintext highlighter-rouge">Memory.readCString()</code> is now available for reading ASCII C strings.</li>
  <li><code class="language-plaintext highlighter-rouge">Frida.version</code> can be interrogated to check which version you’re running,
and this is also provided on the <em>frida-core</em> end, which for example is
exposed by <em>frida-python</em> through <code class="language-plaintext highlighter-rouge">frida.__version__</code>.</li>
  <li><em>Stalker</em> now supports the <em>jecxz</em> and <em>jrcxz</em> instructions. This is good news
for <a href="https://github.com/frida/cryptoshark">CryptoShark</a>, which should soon
provide some updated binaries to bundle the latest version of Frida.</li>
  <li>V8 has been updated to 4.3.62, and a lot of ES6 features have been enabled.</li>
  <li>We’re now using a development version of the upcoming Capstone 4.0.</li>
  <li>All third-party dependencies have been updated to the latest and greatest.</li>
  <li>Windows XP is now supported. This is not a joke. I realized that we didn’t
actually use any post-XP APIs, and as I had to rebuild the dependencies on
Windows I figured we might as well just lower our OS requirements to help
those of you still instrumenting software on XP.</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/03/20/frida-3-0-0-released/index.html">
      Frida 3.0.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      20 Mar 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>You may have wondered:</p>

<blockquote>
  <p>Why a Python API, but JavaScript debugging logic?</p>
</blockquote>

<p>Well, you can now do this:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>npm <span class="nb">install </span>frida</code></pre></figure>

<p>We just brought you brand new <a href="https://github.com/frida/frida-node">Node.js bindings</a>,
and they are fully asynchronous:</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/6ecae99945ccba47427a.js"> </script>

<p>Check out the <a href="https://github.com/frida/frida-node/blob/46a5f92203ab86978a2af68d6c926d6d2b63fbe7/examples/interactive.js">examples</a>
to get an idea what the API looks like. It’s pretty much a 1:1 mapping of the
API provided by the Python bindings, but following Node.js / JavaScript
conventions like camelCased method-names, methods returning ES6 <em>Promise</em>
objects instead of blocking, etc.</p>

<p>Now, combine this with <a href="https://github.com/nwjs/nw.js/">NW.js</a> and you can build
your own desktop apps with HTML, CSS, and JavaScript all the way through.</p>

<p>So, brand new Node.js bindings; awesome! We did not stop there, however.
But first, a few words about the future. I am excited to announce that I have
just started a company with the goal of sponsoring part-time development of
Frida. By offering reverse-engineering and software development expertise,
the goal is to generate enough revenue to pay my bills and leave some time
to work on Frida. Longer term I’m hoping there will also be demand for help
adding features or integrating Frida into third-party products.
In the meantime, however, if you know someone looking for reverse-engineering
or software development expertise, I would really appreciate it if you could
kindly refer them to get in touch. Please see <a href="https://github.com/oleavr/cv/raw/master/oleavr.pdf">my CV</a>
for details.</p>

<p>That aside, let’s get back to the release. Next up: 32-bit Linux support!
Even <em>Stalker</em> has been ported. Not just that, the Linux backend can even do
cross-architecture injection like we do on the other platforms. This means a
64-bit Frida process, e.g. your Python interpreter, can inject into a 32-bit
process. The other direction works too.</p>

<p>Another awesome update is that <a href="https://github.com/Tyilo">Tyilo</a> contributed
<a href="https://github.com/frida/frida-python/commit/daf1a310670588e5672af2205658598be342c2e2">improvements</a>
to <em>frida-trace</em> so it now uses man-pages for auto-generating the log handlers.
Awesome, huh? But there’s even more goodies:</p>

<ul>
  <li><em>frida-server</em> ports are now recycled, so if you’re using Frida on Android
you won’t have to keep forwarding ports unless you’re actually attaching to
multiple processes at the same time.</li>
  <li>Linux and Android <code class="language-plaintext highlighter-rouge">spawn()</code> support has been improved to also support PIE
binaries.</li>
  <li>Android stability and compatibility improvements.</li>
  <li>Mac and Linux build system have been revamped, and make it easy to build just
the parts that you care about; and maybe even some components you didn’t even
know were there that were previously not built by default.</li>
  <li>Python bindings have a minor simplification so instead of
<code class="language-plaintext highlighter-rouge">frida.attach(pid).session.create_script()</code> it’s simply just
<code class="language-plaintext highlighter-rouge">frida.attach(pid).create_script()</code>. This is just like in the brand
new Node.js bindings, and the reason we had to bump the major version.</li>
</ul>

<p>That’s the gist of it. Please help spread the word by sharing this post across
the inter-webs. We’re still quite small as an open source project, so
word-of-mouth marketing means a lot to us.</p>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/03/01/frida-2-0-2-released/index.html">
      Frida 2.0.2 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      01 Mar 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Thanks to your excellent feedback we just eliminated a crasher when using
Frida on Windows with certain iOS device configurations. As this is a very
important use-case we decided to do a hotfix release without any other changes.</p>

<p>Please keep the bug-reports coming!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/03/01/frida-2-0-1-released/index.html">
      Frida 2.0.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      01 Mar 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Just a quick bug-fix release to remedy an iOS issue that slipped through the
final testing of 2.0.0. Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/03/01/frida-2-0-0-released/index.html">
      Frida 2.0.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      01 Mar 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s time for a new and exciting release! Key changes include:</p>

<ul>
  <li>No more kernel panics on Mac and iOS! Read the full story
<a href="https://medium.com/@oleavr/diy-kernel-panic-os-x-and-ios-in-10-loc-c250d9649159">here</a>.</li>
  <li>Mac and iOS injector performs manual mapping of Frida’s dylib. This means
we’re able to attach to heavily sandboxed processes.</li>
  <li>The CLI tools like <em>frida-trace</em>, <em>frida-repl</em>, etc., have brand new support
for spawning processes:</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida-trace <span class="nt">-i</span> <span class="s1">'open*'</span> <span class="nt">-i</span> <span class="s1">'read*'</span> /bin/cat /etc/resolv.conf
    27 ms	open<span class="nv">$NOCANCEL</span><span class="o">()</span>
    28 ms	<span class="nb">read</span><span class="nv">$NOCANCEL</span><span class="o">()</span>
    28 ms	<span class="nb">read</span><span class="nv">$NOCANCEL</span><span class="o">()</span>
    28 ms	<span class="nb">read</span><span class="nv">$NOCANCEL</span><span class="o">()</span>
Target process terminated.
Stopping...
<span class="err">$</span></code></pre></figure>

<ul>
  <li>Usability improvements in <em>frida-repl</em> and <em>frida-discover</em>.</li>
  <li>First call to <code class="language-plaintext highlighter-rouge">DeviceManager.enumerate_devices()</code> does a better job and
also gives you the currently connected iOS devices, so for simple applications
or scripts you no longer have to subscribe to updates if you require the
device to already be present.</li>
  <li>The python API now provides you with <code class="language-plaintext highlighter-rouge">frida.get_usb_device(timeout = 0)</code> and
<code class="language-plaintext highlighter-rouge">frida.get_remote_device()</code> for easy access to iOS and remote/Android
devices.</li>
  <li>The <code class="language-plaintext highlighter-rouge">onEnter</code> and <code class="language-plaintext highlighter-rouge">onLeave</code> callbacks passed to <code class="language-plaintext highlighter-rouge">Interceptor.attach()</code> may
access <code class="language-plaintext highlighter-rouge">this.registers</code> to inspect CPU registers, which is really useful
when dealing with custom calling conventions.</li>
  <li><code class="language-plaintext highlighter-rouge">console.log()</code> logs to the console on your application’s side instead of
the target process. This change is actually why we had to bump the major
version for this release.</li>
  <li>Android 5.0 compatibility, modulo ART support.</li>
  <li>Brand new support for Android/x86. Everything works except the Dalvik
integration; please get in touch if you’d like to help out with a pull-request
to fix that!</li>
</ul>

<p>Want to help out? Have a look at our <a href="../../docs/gsoc-ideas-2015/index.html">GSoC 2015 Ideas Page</a>
to get an overview of where we’d like to go next.</p>

<p>Enjoy!</p>

<p><strong>Update 2am:</strong> An iOS issue slipped through the final testing, so we
just pushed 2.0.1 to remedy this.</p>

<p><strong>Update 11pm:</strong> Thanks to your excellent feedback we found a critical
bug when using Frida on Windows with certain iOS device configurations.
Please upgrade to 2.0.2 and let us know if you run into any issues.</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2015/02/23/frida-1-8-0-released/index.html">
      Frida 1.8.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      23 Feb 2015
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p><strong>This release introduced a serious regression on iOS and was quickly pulled
from our Cydia repo, though it was available for Mac, Linux and Android while
waiting to be replaced by <a href="../2015/03/01/frida-2-0-0-released/index.html">2.0.0</a>.</strong></p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/11/18/frida-1-6-8-released/index.html">
      Frida 1.6.8 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      18 Nov 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Just a minor bug-fix release to fix <code class="language-plaintext highlighter-rouge">spawn()</code> on Mac, and resolve some
teardown issues. Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/11/03/frida-1-6-7-released/index.html">
      Frida 1.6.7 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      03 Nov 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Tired of waiting for Frida to attach to 32-bit processes on 64-bit Mac
or iOS systems? Or perhaps <code class="language-plaintext highlighter-rouge">frida-trace</code> takes a while to resolve functions?
If any of the above, or none of it, then this release is for you!</p>

<p>Attaching to 32-bit processes on Mac/iOS hosts has been optimized, and instead
of seconds this is now a matter of milliseconds. That’s however specific to
Darwin OSes; this release also speeds up enumeration of module exports on
all OSes. This is now 75% faster, and should be very noticable when using
<code class="language-plaintext highlighter-rouge">frida-trace</code> and waiting for it to resolve functions.</p>

<p>Also, as an added bonus, teardown while attached to multiple processes no
longer crashes on Darwin and Linux.</p>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/11/03/frida-1-6-6-released/index.html">
      Frida 1.6.6 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      03 Nov 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p><strong>This release introduced a serious regression and was quickly pulled and
replaced by <a href="../2014/11/03/frida-1-6-7-released/index.html">1.6.7</a>.</strong></p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/10/29/frida-1-6-5-released/index.html">
      Frida 1.6.5 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      29 Oct 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s release o’clock, and time for some bug fixes:</p>

<ul>
  <li>iOS 8.1 is now supported, and the ARM64 support is better than ever.</li>
  <li>The iOS USB transport no longer disconnects when sending a burst of data to
the device. This would typically happen when using <code class="language-plaintext highlighter-rouge">frida-trace</code> and tracing
a bunch of functions, resulting in a burst of data being sent over the wire.
This was actually <a href="https://bugzilla.gnome.org/show_bug.cgi?id=11059">a generic networking issue affecting Mac and iOS</a>,
but was very reproducible when using Frida with a tethered iOS device.</li>
  <li>Eliminated crashes on shutdown of the Python interpreter.</li>
  <li>The <code class="language-plaintext highlighter-rouge">onEnter</code> and <code class="language-plaintext highlighter-rouge">onLeave</code> callbacks in <code class="language-plaintext highlighter-rouge">frida-trace</code> scripts are now called
with <code class="language-plaintext highlighter-rouge">this</code> bound to the correct object, which means that it’s bound to an
object specific to that thread and invocation, and not an object shared by
all threads and invocations.</li>
</ul>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/10/19/frida-1-6-4-released/index.html">
      Frida 1.6.4 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      19 Oct 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s time for a bug-fix release!</p>

<p>Stalker improvements:</p>

<ul>
  <li>The engine no longer pre-allocates a fixed chunk of 256 MB per thread being
traced, and now grows this dynamically in a reentrancy-safe manner.</li>
  <li>Eliminated a bug in the cache lookup logic where certain blocks would always
result in a cache miss. Those blocks thus got recompiled every time they
were about to get executed, slowing down execution and clogging up the cache
with more and more entries, and eventually running out of memory.</li>
  <li>Relocation of RIP-relative <code class="language-plaintext highlighter-rouge">cmpxchg</code> instruction is now handled correctly.</li>
</ul>

<p>Better Dalvik integration (Android):</p>

<ul>
  <li>App’s own classes can now be loaded.</li>
  <li>Several marshalling bugs have been fixed.</li>
</ul>

<p>Script runtime:</p>

<ul>
  <li>More than one NativeFunction with the same target address no longer results
in use-after-free.</li>
</ul>

<p>Also, <a href="https://github.com/frida/cryptoshark">CryptoShark 0.1.2</a> is out,
with an upgraded Frida engine and lots of performance improvements so the GUI
is able to keep up with the Stalker. Go get it while it’s hot!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/08/25/frida-1-6-3-released/index.html">
      Frida 1.6.3 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      25 Aug 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>This latest release includes a bunch of enhancements and bug fixes.
Some of the highlights:</p>

<ul>
  <li>
    <p>The remainder of Frida’s internals have been migrated from udis86 to
Capstone, which means that our Stalker is now able to trace binaries with
very recent x86 instructions. Part of this work also included battle-testing
it on 32- and 64-bit binaries on Windows and Mac, and all known issues have
now been resolved.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Memory.protect()</code> has been added to the JavaScript API, allowing you to
easily change page protections. For example:</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">Memory</span><span class="p">.</span><span class="nx">protect</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="dl">"</span><span class="s2">0x1234</span><span class="dl">"</span><span class="p">),</span> <span class="mi">4096</span><span class="p">,</span> <span class="dl">'</span><span class="s1">rw-</span><span class="dl">'</span><span class="p">);</span></code></pre></figure>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Process.enumerateThreads()</code> omits Frida’s own threads so you don’t have to
worry about them.</p>
  </li>
  <li>
    <p>Python 3 binaries are now built against Python 3.4.</p>
  </li>
</ul>

<p>So with this release out, let’s talk about <a href="https://github.com/frida/cryptoshark">CryptoShark</a>:</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/hzDsxtcRavY?rel=0" frameborder="0" allowfullscreen=""></iframe>

<p>Grab a pre-built Windows binary <a href="https://build.frida.re/frida/windows/Win32-Release/bin/cryptoshark-0.1.1.exe">here</a>,
or build it from source if you’d like to try it out on Mac or Linux.</p>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/08/03/frida-1-6-2-released/index.html">
      Frida 1.6.2 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      03 Aug 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s release o’clock, and this time we’re bringing you more than just bugfixes.
Meet <code class="language-plaintext highlighter-rouge">Instruction.parse()</code>:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">Instruction</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="dl">'</span><span class="s1">0x1234</span><span class="dl">'</span><span class="p">));</span>
<span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">Instruction</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">next</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span></code></pre></figure>

<p>Output:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="nf">push</span> <span class="nb">rbp</span>
<span class="nf">mov</span> <span class="nb">rbp</span><span class="p">,</span> <span class="nb">rsp</span></code></pre></figure>

<p>How is this implemented you ask? That’s the cool part. Frida already uses the
amazing <a href="https://www.capstone-engine.org/">Capstone disassembly framework</a>
behind the scenes, and thus it makes perfect sense to make it available to the
JavaScript runtime. Have a look at the
<a href="../../docs/javascript-api/index.html">JavaScript API Reference</a> for all
the details.</p>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/07/26/frida-1-6-1-released/index.html">
      Frida 1.6.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      26 Jul 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s time for a bugfix release. Highlights:</p>

<ul>
  <li>Compatibility with the Pangu iOS jailbreak on ARM64. The issue is that RWX
pages are not available like they used to be with the evad3rs jailbreak.</li>
  <li>Fix occasional target process crash when detaching.</li>
  <li>Fix crash when trying to attach to a process the second time after failing
to establish the first time. This primarily affected Android users, but could
happen on any OS when using <code class="language-plaintext highlighter-rouge">frida-server</code>.</li>
  <li>Faster and more reliable injection on Linux/x86-64 and Android/ARM.</li>
  <li>Fix issues preventing hooking of HeapFree and friends on Windows.</li>
  <li>Upgraded GLib, libgee, json-glib and Vala dependencies for improved
performance and bugfixes.</li>
  <li>No more resource leaks. Please report if you find any.</li>
</ul>

<p>Also new since 1.6.0, as covered in my <a href="https://medium.com/@oleavr/build-a-debugger-in-5-minutes-1-5-51dce98c3544">blog post</a>, there is now a full-
featured <a href="https://github.com/frida/frida-qml">binding for Qml</a>. This should be of interest to those of you
building graphical cross-platform tools.</p>


  </div>
</article>


  <article>
  <h2>
    <a href="../2014/05/30/frida-1-6-0-released/index.html">
      Frida 1.6.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      30 May 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>As some of you may have noticed, Frida recently got brand new Android support,
allowing you to easily instrument code just like on Windows, Mac, Linux and iOS.
This may sound cool and all, but Android does run a lot of Java code, which
means you’d only be able to observe the native side-effects of whatever
that code was doing. You could of course use Frida’s FFI API to poke your way
into the VM, but hey, shouldn’t Frida just do that dirty plumbing for you?
Of course it should!</p>

<p>Here’s what it looks like in action:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">Dalvik</span><span class="p">.</span><span class="nx">perform</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">Activity</span> <span class="o">=</span> <span class="nx">Dalvik</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">android.app.Activity</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">Activity</span><span class="p">.</span><span class="nx">onResume</span><span class="p">.</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">onResume() got called! Let</span><span class="dl">'</span><span class="nx">s</span> <span class="nx">call</span> <span class="nx">the</span> <span class="nx">original</span> <span class="nx">implementation</span><span class="dl">'</span><span class="s1">);
        this.onResume();
    };
});</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">Dalvik.perform()</code> call takes care of attaching your thread to the VM,
and isn’t necessary in callbacks from Java. Also, the first time you call
<code class="language-plaintext highlighter-rouge">Dalvik.use()</code> with a given class name, Frida will interrogate the VM and
build a JavaScript wrapper on-the-fly. Above we ask for the
<a href="https://developer.android.com/reference/android/app/Activity.html">Activity</a>
class and replace its implementation of <code class="language-plaintext highlighter-rouge">onResume</code> with our own version,
and proceed to calling the original implementation after sending a message
to the debugger (running on your Windows, Mac or Linux machine). You could
of course choose to not call the original implementation at all, and emulate
its behavior. Or, perhaps you’d like to simulate an error scenario:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">Dalvik</span><span class="p">.</span><span class="nx">perform</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">Activity</span> <span class="o">=</span> <span class="nx">Dalvik</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">android.app.Activity</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">Exception</span> <span class="o">=</span> <span class="nx">Dalvik</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">java.lang.Exception</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">Activity</span><span class="p">.</span><span class="nx">onResume</span><span class="p">.</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">Exception</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="dl">'</span><span class="s1">Oh noes!</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">});</span></code></pre></figure>

<p>So there you just instantiated a Java Exception and threw it straight from
your JavaScript implementation of <code class="language-plaintext highlighter-rouge">Activity.onResume</code>.</p>

<p>This release also comes with some other runtime goodies:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Memory.copy(dst, src, n)</code>: just like memcpy</li>
  <li><code class="language-plaintext highlighter-rouge">Memory.dup(mem, size)</code>: short-hand for <code class="language-plaintext highlighter-rouge">Memory.alloc()</code> followed by
<code class="language-plaintext highlighter-rouge">Memory.copy()</code></li>
  <li><code class="language-plaintext highlighter-rouge">Memory.writeXXX()</code>: the missing <code class="language-plaintext highlighter-rouge">Memory.read()</code> counterparts: S8, S16, U16,
S32, U32, S64, U64, ByteArray, Utf16String and AnsiString</li>
  <li><code class="language-plaintext highlighter-rouge">Process.pointerSize</code> to make your scripts more portable</li>
  <li><code class="language-plaintext highlighter-rouge">NativePointer</code> instances now have a convenient <code class="language-plaintext highlighter-rouge">isNull()</code> method</li>
  <li><code class="language-plaintext highlighter-rouge">NULL</code> constant so you don’t have to do <code class="language-plaintext highlighter-rouge">ptr("0")</code> all over the place</li>
  <li><code class="language-plaintext highlighter-rouge">WeakRef.bind(value, fn)</code> and <code class="language-plaintext highlighter-rouge">WeakRef.unbind(id)</code> for the hardcore:
The former monitors <code class="language-plaintext highlighter-rouge">value</code> so <code class="language-plaintext highlighter-rouge">fn</code> gets called as soon as <code class="language-plaintext highlighter-rouge">value</code> has been
garbage-collected, or the script is about to get unloaded. It returns an
id that you can pass to <code class="language-plaintext highlighter-rouge">unbind()</code> for explicit cleanup.
This API is useful if you’re building a language-binding, where you need to
free native resources when a JS value is no longer needed.</li>
</ul>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/05/14/frida-1-4-2-released/index.html">
      Frida 1.4.2 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      14 May 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Just a quick bugfix release to squash
<a href="https://github.com/frida/frida-core/issues/5">this annoying bug</a>, which is
reproducible on all supported x86 OSes. Thanks for Guillaume for tracking
this one down.</p>

<p>As a bonus, frida-repl now also works on Windows. Happy REPLing!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/05/14/frida-1-4-1-released/index.html">
      Frida 1.4.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      14 May 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Interested in spawning processes on Windows or Linux, and not just on Mac? Or
maybe you’ve been bitten by the Linux injector crashing your processes instead
of letting you inject into them? Or maybe you had a function name that was so
long that frida-trace overflowed the max filename length on Windows? Well, if
any of the above, or none of it, then Frida 1.4.1 is for you!</p>

<p>Thanks to Guillaume and Pedro for making this release awesome. Keep those pull-
requests and bug reports coming!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/05/04/frida-1-4-0-released/index.html">
      Frida 1.4.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      04 May 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Did anyone say Android? Frida 1.4.0 is out, with brand new Android support!
Have a look at the documentation <a href="../../docs/android/index.html">here</a>
to get started. Also new in this release is that Frida is now powered by
the amazing <a href="http://www.capstone-engine.org/">Capstone Disassembly Engine</a>,
which means our cross-platform code instrumentation is even more powerful.
It also paves the way for taking the x86-only <a href="https://github.com/frida/frida-gum/blob/41dbb1d27a784fd8b5e233929a317cd41beb9c2d/tests/core/arch-x86/stalker-x86.c#L78">stealth tracing</a>
to new architectures in future releases.</p>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/04/21/frida-1-2-1-released/index.html">
      Frida 1.2.1 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      21 Apr 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Had some fun tracing Apple’s crypto APIs, which lead to the discovery of
a few bugs. So here’s 1.2.1 bringing some critical ARM-related bugfixes:</p>

<ul>
  <li>ARM32: Fix crashes caused by register clobber issue in V8 on ARM32 due to
an ABI difference regarding <code class="language-plaintext highlighter-rouge">r9</code> in Apple’s ABI compared to AAPCS.</li>
  <li>ARM32: Fix ARM32/Thumb relocator branch rewriting for immediate same-mode
branches.</li>
  <li>ARM64: Improve ARM64 relocator to support rewriting <code class="language-plaintext highlighter-rouge">b</code> and <code class="language-plaintext highlighter-rouge">bl</code>.</li>
</ul>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/04/17/frida-1-2-0-released/index.html">
      Frida 1.2.0 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      17 Apr 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>It’s release-o-clock, and Frida 1.2.0 is finally out! Bugfixes aside, this
release introduces brand new ARM64 support, which is quite useful for those of
you using Frida on your iPhone 5S or iPad Air. You can now inject into both 64-
and 32-bit processes, just like on Mac and Windows.</p>

<p>This release also improves stability on ARM32, where attaching to short
functions used to result in undefined behavior.</p>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/03/09/frida-1-0-11-released/index.html">
      Frida 1.0.11 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      09 Mar 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Some of you experienced issues injecting into processes on Windows, as well as
crashes on iOS. Here’s a new release bringing some serious improvements to
Frida’s internals:</p>

<ul>
  <li>V8 has been upgraded to 3.25 in order to fix the iOS stability issues. This
also means new features (like ECMAScript 6) and improved performance on all
platforms. Another nice aspect is that Frida now depends on a V8 version
that runs on 64-bit ARM, which paves the way for porting Frida itself to
AArch64.</li>
  <li>The Windows injector has learned some new tricks and will get you into even
more processes. A configuration error was also discovered in the Windows
build system, which explains why some of you were unable to inject into
some processes.</li>
  <li>For those of you building Frida on Windows, the build system there now
depends on VS2013. This means XP is no longer supported, though it is still
possible to build with the <code class="language-plaintext highlighter-rouge">v120_xp</code> toolchain if any of you still depend
on that, so let me know if this is a deal-breaker for you.</li>
  <li>The recently added support for <code class="language-plaintext highlighter-rouge">this.lastError</code> (Windows) is now working
correctly.</li>
</ul>

<p>That’s all for now. Let us know what you think, and if you like Frida, please
help spread the word! :)</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/02/16/frida-1-0-10-released/index.html">
      Frida 1.0.10 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      16 Feb 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>This release brings a few improvements:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Interceptor</code> is now compatible with a lot more functions on iOS/ARM.</li>
  <li>A new CLI tool called <code class="language-plaintext highlighter-rouge">frida-repl</code> provides you with a basic REPL to
experiment with the JavaScript API from inside a target process.</li>
  <li><code class="language-plaintext highlighter-rouge">onLeave</code> callback passed to <code class="language-plaintext highlighter-rouge">Interceptor.attach()</code> is now able to replace
the return value by calling <code class="language-plaintext highlighter-rouge">retval.replace()</code>.</li>
  <li>Both <code class="language-plaintext highlighter-rouge">onEnter</code> and <code class="language-plaintext highlighter-rouge">onLeave</code> callbacks passed to <code class="language-plaintext highlighter-rouge">Interceptor.attach()</code> can
access <code class="language-plaintext highlighter-rouge">this.errno</code> (UNIX) or <code class="language-plaintext highlighter-rouge">this.lastError</code> (Windows) to inspect or
manipulate the current thread’s last system error.</li>
</ul>

<p>Here’s how you can combine the latter three to simulate network conditions for
a specific process running on your Mac:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">~ <span class="nv">$ </span>frida-repl TargetApp</code></pre></figure>

<p>Then paste in:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">callbacks</span> <span class="o">=</span> <span class="p">{</span> <span class="o">\</span>
    <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span> <span class="o">\</span>
        <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// Avoid side-effects on socket \</span>
    <span class="p">},</span> <span class="o">\</span>
    <span class="nx">onLeave</span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span> <span class="o">\</span>
        <span class="kd">const</span> <span class="nx">ECONNREFUSED</span> <span class="o">=</span> <span class="mi">61</span><span class="p">;</span> <span class="o">\</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">errno</span> <span class="o">=</span> <span class="nx">ECONNREFUSED</span><span class="p">;</span> <span class="o">\</span>
        <span class="nx">retval</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="o">\</span>
    <span class="p">}</span> <span class="o">\</span>
<span class="p">};</span> <span class="o">\</span>
<span class="nx">Module</span><span class="p">.</span><span class="nx">enumerateExports</span><span class="p">(</span><span class="dl">"</span><span class="s2">libsystem_kernel.dylib</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="o">\</span>
    <span class="nx">onMatch</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span> <span class="p">{</span> <span class="o">\</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">exp</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">connect</span><span class="dl">"</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">connectx</span><span class="dl">"</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="o">\</span>
            <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">exp</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span> <span class="nx">callbacks</span><span class="p">);</span> <span class="o">\</span>
        <span class="p">}</span> <span class="o">\</span>
    <span class="p">},</span> <span class="o">\</span>
    <span class="nx">onComplete</span><span class="p">()</span> <span class="p">{}</span> <span class="o">\</span>
<span class="p">});</span></code></pre></figure>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/01/25/frida-1-0-9-released/index.html">
      Frida 1.0.9 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      25 Jan 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>Another release — this time with some new features:</p>

<ul>
  <li>Objective-C integration for Mac and iOS. Here’s an example to whet your
appetite:</li>
</ul>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">UIAlertView</span> <span class="o">=</span> <span class="nx">ObjC</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">UIAlertView</span><span class="dl">'</span><span class="p">);</span> <span class="cm">/* iOS */</span>
<span class="nx">ObjC</span><span class="p">.</span><span class="nx">schedule</span><span class="p">(</span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">mainQueue</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">UIAlertView</span><span class="p">.</span><span class="nx">alloc</span><span class="p">().</span><span class="nx">initWithTitle_message_delegate_cancelButtonTitle_otherButtonTitles_</span><span class="p">(</span>
        <span class="dl">"</span><span class="s2">Frida</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">Hello from Frida</span><span class="dl">"</span><span class="p">,</span>
        <span class="nx">ptr</span><span class="p">(</span><span class="dl">"</span><span class="s2">0</span><span class="dl">"</span><span class="p">),</span>
        <span class="dl">"</span><span class="s2">OK</span><span class="dl">"</span><span class="p">,</span>
        <span class="nx">ptr</span><span class="p">(</span><span class="dl">"</span><span class="s2">0</span><span class="dl">"</span><span class="p">));</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
<span class="p">});</span></code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Module.enumerateExports()</code> now also enumerates exported variables and not
just functions. The <code class="language-plaintext highlighter-rouge">onMatch</code> callback receives an <code class="language-plaintext highlighter-rouge">exp</code> object where the
<code class="language-plaintext highlighter-rouge">type</code> field is either <code class="language-plaintext highlighter-rouge">function</code> or <code class="language-plaintext highlighter-rouge">variable</code>.</li>
</ul>

<p>To get the full scoop on the ObjC integration, have a look at the
<a href="../../docs/javascript-api/index.html">JavaScript API reference</a>.</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/01/15/frida-1-0-8-released/index.html">
      Frida 1.0.8 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      15 Jan 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>We just rolled out a bugfix release:</p>
<ul>
  <li>Support injection into Mac App Store apps</li>
  <li>Eliminate iOS daemon auto-start issues</li>
  <li>No more iOS crashes shortly after injecting</li>
</ul>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/01/12/frida-1-0-7-released/index.html">
      Frida 1.0.7 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      12 Jan 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>This release brings USB device support in the command-line tools, and
adds <code class="language-plaintext highlighter-rouge">frida-ps</code> for enumerating processes both locally and remotely.</p>

<p>For example to enumerate processes on your tethered iOS device:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida-ps <span class="nt">-U</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">-U</code> switch is also accepted by <code class="language-plaintext highlighter-rouge">frida-trace</code> and <code class="language-plaintext highlighter-rouge">frida-discover</code>.</p>

<p>Docs how to set this up on your iOS device will soon be added to the website.</p>

<p>However, that’s not the most exciting part. Starting with this release,
Frida got its first contribution since the HN launch.
<a href="https://github.com/pmorici">Pete Morici</a> dived in and contributed support
for specifying module-relative functions in <code class="language-plaintext highlighter-rouge">frida-trace</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>frida-trace <span class="nt">-a</span> <span class="s1">'kernel32.dll+0x1234'</span></code></pre></figure>

<p>Enjoy!</p>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/01/11/frida-1-0-6-released/index.html">
      Frida 1.0.6 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      11 Jan 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>This release simplifies the licensing and fixes bugs reported by the community
since the HN launch.</p>

<p>Primarily:</p>
<ul>
  <li>Relicense remaining GPLv3+ Frida components to LGPLv2.1+ (same as frida-gum).</li>
  <li>Tracer works on 64-bit with function addresses in the upper range</li>
  <li>Linux build links with Frida’s own libraries instead of the build machine’s
corresponding libraries.</li>
</ul>

  </div>
</article>


  <article>
  <h2>
    <a href="../2014/01/05/frida-1-0-5-released/index.html">
      Frida 1.0.5 Released
    </a>
  </h2>
  <span class="post-category">
    
    <span class="label">release</span>
    
  </span>
  <div class="post-meta">
    <span class="post-date">
      05 Jan 2014
    </span>
    <a href="https://github.com/oleavr" class="post-author">
      <img src="https://github.com/oleavr.png" class="avatar" alt="oleavr"/>
      oleavr
    </a>
  </div>
  <div class="post-content">
    <p>This release improves <a href="https://github.com/frida/frida-python/blob/master/src/frida/tracer.py">frida-trace</a> with support for auto-generating,
loading and reloading function handlers from scripts on the filesystem.
Have a look at our <a href="https://frida.re/docs/quickstart">Quick-start guide</a> for a walkthrough.
Also new in this release is Py3k support, which is available from <a href="https://pypi.python.org/pypi/frida">PyPI</a> on
all platforms.</p>


  </div>
</article>



      </div>

    </div>
  </section>


  <footer>
  <div class="grid">
    <div class="unit whole align-right center-on-mobiles">
      <div class="sponsored-by">
        <h5>Sponsored by:</h5>
        <a href="https://www.nowsecure.com">
          <img src="../../img/nowsecure-logo.png" alt="NowSecure">
        </a>
      </div>
    </div>
  </div>
</footer>

  


  <!-- Google Analytics (http://google.com/analytics) -->
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46880695-1']);
    _gaq.push(['_setDomainName', 'https://frida.re']); // Multiple sub-domains
    _gaq.push(['_setAllowLinker', true]); // Multiple TLDs
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



</body>
</html>
